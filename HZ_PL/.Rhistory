setwd("~/Desktop/WUSTL/Holtzman_PeterLin")
load(paste0(RDSdir,"T_cells_V1p4.Robj"))
RDSdir <- "RDS/"
outdir <- "R_outs/"
library(Seurat)
library(tidyverse)
library(harmony) # for integration
load(paste0(RDSdir,"T_cells_V1p4.Robj"))
DimPlot(T_cells,group.by = "RNA_snn_res.0.6",label = T)
Idents(T_cells) <- "RNA_snn_res.0.6"
Idents(T_cells) <- "RNA_snn_res.0.6"
FeaturePlot(T_cells,features = "Klrb1c",label = T)
FeaturePlot(T_cells,features = "Cd3e",label = T)
NK <- subset(T_cells, idents = c(5,14))
T_cells <- subset(T_cells, idents = c(0:20)[!c(0:20) %in% c(5,14)])
DimPlot(T_cells,group.by = "RNA_snn_res.0.6",label = T)
DimPlot(NK,group.by = "RNA_snn_res.0.6",label = T)
save(T_cells, file = paste0(RDSdir,"T_cells_V1p5.Robj"))
save(NK, file = paste0(RDSdir,"NK_V1p5.Robj"))
PercentageFeatureSet(T_cells,pattern="^Rp[ls]") -> T_cells$percent.ribo
head(T_cells$percent.ribo)
T_cells <- FindVariableFeatures(object = T_cells, selection.method = 'mean.var.plot', mean.cutoff = c(0.0125, 5), dispersion.cutoff = c(0.5, Inf))
VariableFeatures(T_cells) <-  VariableFeatures(T_cells) [!grepl("^Tra|^Trb|^Igh|^Igk|Mamu-a", VariableFeatures(T_cells))]
VariableFeaturePlot(T_cells)
T_cells <- ScaleData(object = T_cells, features = VariableFeatures(object = T_cells), vars.to.regress = c("nCount_RNA", "percent.mt","percent.ribo"))
T_cells <- RunPCA(object = T_cells,
features =  VariableFeatures(object = T_cells),
dims = 1:50)
gc()
ElbowPlot(T_cells,ndims = 50)
T_cells <- RunUMAP(T_cells,dims = 1:30,reduction = "harmony") # use harmony embedding for downstream analysis
T_cells <- RunTSNE(T_cells,dims = 1:30,reduction = "harmony")
T_cells <- FindNeighbors(T_cells, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   # iterate over a range of resolutions
T_cells <- FindClusters(object = T_cells, resolution = res, print.output = 0, save.SNN = TRUE)
}
gc()
T_cells <- JoinLayers(T_cells) # required for seurat V5
DimPlot(T_cells,group.by = "RNA_snn_res.1",label = T)
FeaturePlot(T_cells,"percent.mt",label = T)
FeaturePlot(T_cells,"percent.ribo",label = T)
FeaturePlot(T_cells,"percent.mt",label = T)
FeaturePlot(T_cells,"percent.ribo",label = T)
FeaturePlot(T_cells,"nCount_RNA",label = T)
FeaturePlot(T_cells,"nFeature_RNA",label = T)
FeaturePlot(T_cells,"percent.mt",label = T)
FeaturePlot(T_cells,"percent.ribo",label = T)
FeaturePlot(T_cells,"log10_nCount_RNA",label = T)
FeaturePlot(T_cells,"log10_nFeature_RNA",label = T)
meta <- cbind(T_cells@meta.data, T_cells@reductions$umap@cell.embeddings)
View(meta)
VlnPlot(T_cells,features = "percent.mt", group.by = "genotype")
VlnPlot(T_cells,features = "percent.mt", group.by = "RNA_snn_res.1")
VlnPlot(T_cells,features = "percent.mt", group.by = "genotype",alpha = 0.5)
VlnPlot(T_cells,features = "percent.mt", group.by = "RNA_snn_res.1",alpha = 0.5)
VlnPlot(T_cells,features = "percent.mt", group.by = "genotype",alpha = 0.1)
VlnPlot(T_cells,features = "percent.mt", group.by = "RNA_snn_res.1",alpha = 0.1)
ggplot(meta)+
geom_histogram(aes(x = percent.mt))+
facet_wrap(~genotype)
ggplot(meta)+
geom_histogram(aes(x = percent.ribo))+
facet_wrap(~genotype)
ggplot(meta)+
geom_point(aes(x = percent.mt, y = nFeature_RNA, color = RNA_snn_res.1))+facet_wrap(~genotype)
ggplot(meta)+
geom_point(aes(x = percent.mt, y = nFeature_RNA, color = RNA_snn_res.1))+theme_classic()
library(RColorBrewer)
pal <- c(brewer.pal(n = 12,name = "Set3"),brewer.pal(n = 12,name = "Paired"),brewer.pal(n = 8,name = "Accent"))
pal[2] <- "darkred"
pal[9] <- "grey25"
pal[23] <- "turquoise4"
pal[19] <- colors()[60]
pal[13] <- "darkblue"
pal[28] <- colors()[16]
pal[31] <- colors()[54]
pal <- c(pal,colors()[c(85,84,83,89,45,31,41,42,26,29,10,139,107,108,120,109,119,121,143)])
VlnPlot(T_cells,features = "percent.mt", group.by = "genotype",alpha = 0.1)
VlnPlot(T_cells,features = "percent.mt", group.by = "RNA_snn_res.1",alpha = 0.1)
VlnPlot(T_cells,features = "Rpl32", group.by = "RNA_snn_res.1",alpha = 0.1)
ggplot(meta)+
geom_point(aes(x = percent.mt, y = nFeature_RNA, color = RNA_snn_res.1))+theme_classic()+scale_color_manual(values = pal)
ggplot(meta)+
geom_point(aes(x = percent.mt, y = mean(nFeature_RNA), color = RNA_snn_res.1))+theme_classic()+scale_color_manual(values = pal)
ggplot(meta)+
geom_point(aes(x = percent.mt, y = mean(nFeature_RNA), color = RNA_snn_res.1))+theme_classic()+scale_color_manual(values = pal)+facet_wrap(~RNA_snn_res.1, scales = "free")
ggplot(meta)+
geom_histogram(aes(x = percent.mt))+
facet_wrap(~RNA_snn_res.1)
ggplot(meta)+
geom_histogram(aes(x = percent.ribo))+
facet_wrap(~RNA_snn_res.1)
FeaturePlot(T_cells,"percent.mt",label = T)
FeaturePlot(T_cells,"percent.ribo",label = T)
FeaturePlot(T_cells,"log10_nCount_RNA",label = T)
FeaturePlot(T_cells,"log10_nFeature_RNA",label = T)
FeaturePlot(T_cells,"Mki67",label = T)
DotPlot(T_cells,features = c("Ptprc","Cd3e","Cd4","Foxp3","Gata3","Rorc","Tbx21","Ctla4","Icos","Cd8","Ccr7","Sell","Tcf7","Lef1","Gzmb","Gzmk","Ifitm3","Isg15","Il2ra","Cd69","Tox","Tigit","Pdcd1","Klrb1c","Bcl6","Mki67"),cluster.idents = T)+RotatedAxis()
DotPlot(T_cells,features = c("Ptprc","Cd3e","Cd4","Foxp3","Gata3","Rorc","Tbx21","Ctla4","Icos","Cd8a","Ccr7","Sell","Tcf7","Lef1","Gzmb","Gzmk","Ifitm3","Isg15","Il2ra","Cd69","Tox","Tigit","Pdcd1","Klrb1c","Bcl6","Mki67"),cluster.idents = T)+RotatedAxis()
DotPlot(T_cells,features = c("Cd3e","Cd4","Foxp3","Gata3","Rorc","Tbx21","Ctla4","Icos","Cd8a","Ccr7","Sell","Tcf7","Lef1","Gzmb","Gzmk","Ifitm3","Isg15","Il2ra","Cd69","Tox","Tigit","Pdcd1","Klrb1c","Bcl6","Mki67"),cluster.idents = F)+RotatedAxis()
FeaturePlot(T_cells,features = c("Mki67"),label = T)
FeaturePlot(T_cells,features = c("Tox"),label = T)
FeaturePlot(T_cells,features = c("Gzmk"),label = T)
FeaturePlot(T_cells,features = c("Ccr7"),label = T)
FeaturePlot(T_cells,features = c("Tcf7"),label = T)
FeaturePlot(T_cells,features = c("Cd3e"),label = T)
FeaturePlot(T_cells,features = c("Cd8a"),label = T)
FeaturePlot(T_cells,features = c("Cd4"),label = T)
FeaturePlot(T_cells,features = c("Klrb1c"),label = T)
FeaturePlot(T_cells,features = c("Bcl3"),label = T)
FeaturePlot(T_cells,features = c("Cd69"),label = T)
FeaturePlot(T_cells,features = c("Entpd1"),label = T)
DotPlot(T_cells,features = c("Cd4","Foxp3","Gata3","Rorc","Tbx21","Ctla4","Icos","Cd8a","Ccr7","Sell","Tcf7","Lef1","Gzmb","Gzmk","Ifitm3","Isg15","Il2ra","Cd69","Tox","Tigit","Pdcd1","Klrb1c","Bcl6","Mki67"),cluster.idents = F)+RotatedAxis()
DotPlot(T_cells,features = c("Cd4","Foxp3","Gata3","Rorc","Trdv1","Tbx21","Ctla4","Icos","Cd8a","Ccr7","Sell","Tcf7","Lef1","Gzmb","Gzmk","Ifitm3","Isg15","Il2ra","Cd69","Tox","Tigit","Pdcd1","Klrb1c","Bcl6","Mki67"),cluster.idents = F)+RotatedAxis()
DotPlot(T_cells,features = c("Cd4","Foxp3","Gata3","Rorc","Trdv1","Tbx21","Ctla4","Icos","Cd8a","Ccr7","Sell","Tcf7","Lef1","Gzmb","Gzmk","Ifitm3","Isg15","Il2ra","Cd69","Tox","Tigit","Pdcd1","Klrb1c","Bcl6","Mki67"),group.by = "RNA_snn_res.0.1",cluster.idents = F)+RotatedAxis()
DimPlot(T_cells,group.by = "RNA_snn_res.1",label = T)
DimPlot(T_cells,group.by = "RNA_snn_res.0.1",label = T)
FeaturePlot(T_cells,features = c("Rorc"),label = T)
save(T_cells,file = paste0(RDSdir,"T_cells_V1p5.Robj"))
T_cells <- subset(T_cells, subset = percent.mt < 3)
T_cells <- FindVariableFeatures(object = T_cells, selection.method = 'mean.var.plot', mean.cutoff = c(0.0125, 5), dispersion.cutoff = c(0.5, Inf))
VariableFeatures(T_cells) <-  VariableFeatures(T_cells) [!grepl("^Tra|^Trb|^Igh|^Igk|Mamu-a", VariableFeatures(T_cells))]
VariableFeaturePlot(T_cells)
T_cells <- ScaleData(object = T_cells, features = VariableFeatures(object = T_cells), vars.to.regress = c("nCount_RNA", "percent.mt","percent.ribo"))
T_cells <- RunPCA(object = T_cells,
features =  VariableFeatures(object = T_cells),
dims = 1:50)
gc()
ElbowPlot(T_cells,ndims = 50)
T_cells <- RunUMAP(T_cells,dims = 1:30,reduction = "harmony") # use harmony embedding for downstream analysis
T_cells <- RunTSNE(T_cells,dims = 1:30,reduction = "harmony")
T_cells <- FindNeighbors(T_cells, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   # iterate over a range of resolutions
T_cells <- FindClusters(object = T_cells, resolution = res, print.output = 0, save.SNN = TRUE)
}
gc()
T_cells <- JoinLayers(T_cells) # required for seurat V5
DimPlot(T_cells,group.by = "RNA_snn_res.1",label = T)
DimPlot(T_cells,group.by = "RNA_snn_res.0.1",label = T)
FeaturePlot(T_cells,"percent.mt",label = T)
FeaturePlot(T_cells,"percent.ribo",label = T)
FeaturePlot(T_cells,"log10_nCount_RNA",label = T)
FeaturePlot(T_cells,"log10_nFeature_RNA",label = T)
FeaturePlot(T_cells,"Mki67",label = T)
