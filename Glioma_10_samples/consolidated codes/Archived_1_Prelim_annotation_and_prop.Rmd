---
title: "preliminary annotation and cluster proportion"
output: html_document
---

Note: this is an early version of annotation. I later decided to perform bottom-up annotation by dividing the dataset into compartments, annotate clusters from each compartment, and merge back annotated+cleaned dataset.This markdown file was used before the Feb 8 meeting.

```{r}
library(Seurat)
library(tidyverse)
```

```{r}
load(file = "data/GBM_RNA_10.Robj")
```

```{r}
DimPlot(whole,group.by = "RNA_snn_res.0.1")
```
### step 1: identify major compartments

Expected major compartments include immune cells, stromal, and glioma cells (3). Immune cells can be further divided into lymphoid and myeloid cells.

```{r}
Idents(whole) <- whole$RNA_snn_res.0.1
```

```{r}
DimPlot(whole,split.by = "progress",label = T)
```

#### checking glioma markers

```{r, message=FALSE, warning=FALSE}
FeaturePlot(whole,reduction = "umap",features = "Egfr",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) # classical GMB
FeaturePlot(whole,reduction = "umap",features = "Olig1",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
FeaturePlot(whole,reduction = "umap",features = "Olig2",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
FeaturePlot(whole,reduction = "umap",features = "Sox2",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
FeaturePlot(whole,reduction = "umap",features = "S100b",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
```
```{r}
FeaturePlot(whole,reduction = "umap",features = "Pten",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
FeaturePlot(whole,reduction = "umap",features = "Nf1",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
FeaturePlot(whole,reduction = "umap",features = "Idh1",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
```

```{r}
FeaturePlot(whole,reduction = "umap",features = "Pdgfb",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
FeaturePlot(whole,reduction = "umap",features = "Pdgfa",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
```

```{r}
FeaturePlot(whole,reduction = "umap",features = "Nes",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
```
```{r}
FeaturePlot(whole,reduction = "umap",features = "Pdgfra",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
```


We may also check glial/astrocyte lineage markers (GFAP, SOX9, HOPX, HEPACAM, and VIM) and proliferation marker

```{r}
FeaturePlot(whole,reduction = "umap",features = "Mki67",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
FeaturePlot(whole,reduction = "umap",features = "Gfap",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
FeaturePlot(whole,reduction = "umap",features = "Sox9",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
FeaturePlot(whole,reduction = "umap",features = "Hopx",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
FeaturePlot(whole,reduction = "umap",features = "Hepacam",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
FeaturePlot(whole,reduction = "umap",features = "Vim",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
```



#### checking immune cell markers

```{r, message=F}
FeaturePlot(whole,reduction = "umap",features = "Ptprc",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #Cd45
FeaturePlot(whole,reduction = "umap",features = "Cd3e",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #Cd3e for T cells
FeaturePlot(whole,reduction = "umap",features = "Adgre1",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #Cd3e for mono/mac
FeaturePlot(whole,reduction = "umap",features = "P2ry12",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #Cd3e for mono/mac
```
```{r}
VlnPlot(whole,features = "Ptprc",alpha = 0.1)
```
```{r}
FeaturePlot(whole,reduction = "umap",features = "Ly6c2",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) 
FeaturePlot(whole,reduction = "umap",features = "Ly6g",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) 
FeaturePlot(whole,reduction = "umap",features = "Tyrobp",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) 
FeaturePlot(whole,reduction = "umap",features = "Itgam",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) 
FeaturePlot(whole,reduction = "umap",features = "Itgax",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) 
```

```{r}
FeaturePlot(whole,reduction = "umap",features = "Apoe",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) 
FeaturePlot(whole,reduction = "umap",features = "Lyz2",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) 
```
```{r}
FeaturePlot(whole,reduction = "umap",features = "Mrc1",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) 
FeaturePlot(whole,reduction = "umap",features = "Cd163",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) 
```


#### checking stromal cell markers:

```{r}
FeaturePlot(whole,reduction = "umap",features = "Pecam1",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) 
FeaturePlot(whole,reduction = "umap",features = "Myct1",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) 
FeaturePlot(whole,reduction = "umap",features = "Igfbp5",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) 
FeaturePlot(whole,reduction = "umap",features = "Igfbp7",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple"))
FeaturePlot(whole,reduction = "umap",features = "Egfr",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) 
```

```{r}
FeaturePlot(whole,reduction = "umap",features = "Igfbp2",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple"))
```
Oligoden markers:

```{r}
FeaturePlot(whole,reduction = "umap",features = "Plp1",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple"))
FeaturePlot(whole,reduction = "umap",features = "Mog",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple"))
```

astrocyte:

```{r}
FeaturePlot(whole,reduction = "umap",features = "Aqp4",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple"))

```

```{r}
VlnPlot(whole,features = "Aqp4",alpha = 0.1)
```

```{r}
Glioma <- subset(whole,idents = c(1,2,14,15,17,31))
Immune_cells <- subset(whole,idents = c(0,3,4,7,6,10,16,29))
stromal <- subset(whole, idents = (0:31)[!((0:31) %in% c(1,2,14,15,17,31,0,3,4,7,6,10,16,29))])
```

Add preliminary annotation for proportion plot 

```{r}
whole@meta.data <- whole@meta.data %>% 
  mutate(RNA_snn_res.0.1 = as.character(RNA_snn_res.0.1)) %>%
  mutate(annotation_prelim = case_match(
    RNA_snn_res.0.1,
    "0" ~ "0:microglia",
    "1" ~ "1:glioma-like",
    "2" ~ "2:glioma-like",
    "3" ~ "3:microglia",
    "4" ~ "4:microglia",
    "5" ~ "5:Olig",
    "6" ~ "6:lymphoid+B",
    "7" ~ "7:microglia",
    "8" ~ "8:EC",
    "9" ~ "9:astrocytes",
    "10" ~ "10:BAM",
    "11" ~ "11:ciliated cell",
    "12" ~ "12:Dcx+ proneural",
    "13" ~ "13:astrocytes",
    "14" ~ "14:Pdgfra- glioma-like",
    "15" ~ "15:Mki67+ glioma-like",
    "16" ~ "16:myeloids",
    "17" ~ "17:Mki67+ glioma-like",
    "18" ~ "18:astrocytes",
    "19" ~ "19:EC",
    "20" ~ "20:EC",
    "21" ~ "21:EC",
    "22" ~ "22:EC",
    "23" ~ "23:Tmem119+Unknown",
    "24" ~ "24:neural",
    "25" ~ "25:proliferative neural",
    "26" ~ "26:astrocytes",
    "27" ~ "27:EC",
    "28" ~ "28:Unknown",
    "29" ~ "29:small Ptprc+",
    "30" ~ "30:Unknown",
    "31" ~ "31:Ptprc+ glioma-like/doublet-like"
    
  ) )
```



```{r}
save(whole,file = "data/GBM_RNA_10.Robj")
```


```{r}
outdir <- "output/"
cluster_prop_comp <- whole@meta.data %>% group_by(progress,annotation_prelim) %>%
  summarise(n = n()) %>% mutate(proportion = 100*n/sum(n))
p1 <- ggplot(cluster_prop_comp,aes(x = progress, y = proportion,fill = progress))+
  geom_bar(stat = "identity", position = 'dodge')+
  facet_wrap(~annotation_prelim,scales = "free")+guides(fill=guide_legend(title="Condition"))+ ylab("Percentage of all cells")+
  theme(
  plot.title = element_blank(),
  axis.title.x = element_blank())+RotatedAxis()
ggsave(filename = paste0(outdir,"Proportion_barplots_major_whole.pdf"), plot = p1, units = "cm",height = 60,width = 40)
p1 <- DimPlot(whole, split.by = "progress",group.by = "annotation_prelim")+guides(color = guide_legend(override.aes = list(size=4), ncol=2) )
ggsave(filename = paste0(outdir,"Progression_dimplot_major_whole.pdf"), plot = p1, units = "cm",height = 15,width = 40)
```





```{r}
save(Glioma, file = "data/GBM_RNA_10_glioma_V1.Robj")
save(Immune_cells, file = "data/GBM_RNA_10_imm_V1.Robj")
save(stromal, file = "data/GBM_RNA_10_stromal_V1.Robj")
```

### checking individual compartment

#### start from glioma clusters

```{r}
load("data/GBM_RNA_10_glioma_V1.Robj")
```

```{r}
DimPlot(Glioma)
```

```{r}
nrow(Glioma@meta.data)
```

```{r}
DimPlot(Glioma, split.by = "progress")
```
```{r}
FeaturePlot(whole,features = "Sox4",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) 
FeaturePlot(whole,features = "Vim",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) 
FeaturePlot(whole,features = "Ascl1",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) 
```

```{r}

```

