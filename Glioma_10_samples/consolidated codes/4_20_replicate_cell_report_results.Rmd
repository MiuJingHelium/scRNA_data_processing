---
title: "4-2_replicate cell report results"
output: html_document
date: "2024-06-30"
---

```{r}
# basic packages
library(Seurat)
library(tidyverse)
library(RColorBrewer)
library(ggrepel)
```

```{r}
load("data/GBM_RNA_10_immune_cells_V3_merged_alt.Robj")
```

```{r}
pal <- c(brewer.pal(n = 12,name = "Set3"),brewer.pal(n = 12,name = "Paired"),brewer.pal(n = 8,name = "Accent"))
pal[2] <- "darkred"
pal[9] <- "grey25"
pal[23] <- "turquoise4"
pal[19] <- colors()[60]
pal[13] <- "darkblue"
pal[28] <- colors()[16]
pal[31] <- colors()[54] 
pal <- c(pal,colors()[c(85,84,83,89,45,31,41,42,26,29,10,139,107,108,120,109,119,121,143)])
```

```{r}
immune$annotation_main <- factor(immune$annotation_main, levels = c("microglia","Macrophage","GAM","BAM","Mono-mac","Monocytes","migDC","cDC1","cDC2","pDC","B_cells","T_cells","CD4_T_cells","CD8_T_cells","gdT_cells","NKT","NK","Mast cells","Neutrophil","noise"))
```

```{r}
immune$progress <- factor(immune$progress, levels = c("No tumor","LGG","HGG"))
```


# Fig 1

```{r}
DimPlot(immune,group.by = "annotation_main",label = T,label.size = 2,label.box = T,repel = T,label.color = "white") + scale_color_manual(values = pal) + scale_fill_manual(values = pal)
```
Note that platelets and Erythrocytes are removed

```{r}
table(immune$annotation_main)
```


```{r}
DotPlot(immune,features = c("P2ry12","Gpr34","Dab2","Adgre1","Mrc1","Gpnmb","Axl","Ifitm2","Cd209a","Flt3","Xcr1","Sirpa","Cd3e","Cd4","Cd8a","Cd163l1","Klrb1c","Cd200r3","Camp","S100a8","Cd19","Alas2","Gp1bb"),group.by = "annotation_main",cluster.idents = F)+RotatedAxis()+scale_color_continuous(type = "viridis")


```
FeaturePlots

```{r}
FeaturePlot(immune,features = "P2ry12",label = T,label.size = 2)+
    scale_color_gradientn(colors = c("grey80","white","red2","brown"))
```


```{r}
Idents(immune) <- "annotation_main"
features <- c("P2ry12","Gpr34","Dab2","Adgre1","Mrc1","Gpnmb","Axl","Ifitm2","Cd209a","Flt3","Xcr1","Sirpa","Cd3e","Cd4","Cd8a","Cd163l1","Klrb1c","Cd200r3","Camp","S100a8","Cd19","Alas2","Gp1bb")

glist <- lapply(features, function(x){
  FeaturePlot(immune,features = x,label = T,label.size = 2,order = T,repel = T)+
    scale_color_gradientn(colors = c("grey80","white","red2","brown"))+
    theme(title = element_text(size = 4),
          axis.title.x = element_text(size = 3),
          axis.title.y = element_text(size = 3),
          legend.position="bottom")
})

```


```{r}
glist
```


```{r}
g <- gridExtra::grid.arrange(grobs = glist, nrow = 4)
ggsave("REPLICATE_immune_featureplots_ann_main.pdf",plot = g,width = 20,height = 20)
```





# Fig 2

```{r}
g <- DimPlot(immune,group.by = "annotation_main",label = T,label.size = 2,split.by = "progress",label.box = T,repel = T,label.color = "white") + scale_color_manual("Main Annotation",values = pal) + scale_fill_manual(values = pal) + theme(legend.position="bottom") +
  guides(color = guide_legend(ncol = 6,override.aes = list(size=2)))
g
ggsave("REPLICATE_immune_cells_split_by_progress_ann_main.pdf", plot = g, width = 15, height = 12)
```


```{r}
percentage <- immune@meta.data %>% group_by(annotation_main,progress,batch_ID) %>% count() %>% ungroup() %>% group_by(progress,batch_ID) %>%
  mutate(percentage = `n` / sum(`n`)) %>% ungroup %>% arrange(percentage) %>%
  mutate(labels = scales::percent(percentage))
```


```{r}
ggplot(percentage, aes(x = "", y = percentage, fill = annotation_main)) +
  geom_col(color = "black") +
  geom_label_repel(aes(label = labels),
            position = position_stack(vjust = 0.5),
            show.legend = FALSE,max.overlaps = 15) +
  guides(fill = guide_legend(title = "Main Annotation",ncol = 2)) +
  scale_fill_manual(values = pal) +
  facet_wrap(~progress+batch_ID) +
  coord_polar(theta = "y") +
  theme_void()
```

Too many microglia? I think more microglia might be there...

```{r}
g <- ggplot(percentage, aes(x = "", y = percentage, fill = annotation_main)) +
  geom_col(color = "black") +
  geom_label_repel(aes(label = labels),
            position = position_stack(vjust = 0.5),
            show.legend = FALSE,max.overlaps = 15) +
  guides(fill = guide_legend(title = "Main Annotation",ncol = 2)) +
  scale_fill_manual(values = pal) +
  facet_wrap(~progress) +
  coord_polar(theta = "y") +
  theme_void()
g
ggsave("REPLICATE_immune_cells_percentage_ann_main.pdf", plot = g, width = 15, height = 12)
```

# Supp Fig 2

```{r}
percentage <- immune@meta.data %>% group_by(annotation_main,progress) %>% count() %>% ungroup() %>% group_by(annotation_main) %>%
  mutate(percentage = `n` / sum(`n`)) %>% ungroup() %>% arrange(percentage) %>%
  mutate(labels = scales::percent(percentage))
```

```{r}
ggplot(percentage)+
  geom_bar(aes(x = annotation_main, y = percentage, fill = progress),stat = "identity")+scale_fill_manual(values = pal[c(1,6,17)])+theme(axis.text.x = element_text(angle = 90))
```
```{r}
percentage <- immune@meta.data %>% group_by(annotation_V2,progress) %>% count() %>% ungroup() %>% group_by(annotation_V2) %>%
  mutate(percentage = `n` / sum(`n`)) %>% ungroup() %>% arrange(percentage) %>%
  mutate(labels = scales::percent(percentage))
```

```{r}
ggplot(percentage)+
  geom_bar(aes(x = annotation_V2, y = percentage, fill = progress),stat = "identity")+scale_fill_manual(values = pal[c(1,6,17)])+theme(axis.text.x = element_text(angle = 90))
```

```{r}
table(immune$annotation_V2)
```

```{r}
table(immune$annotation_main)
```


```{r}
# MG MP plot
DotPlot(subset(immune, subset = annotation_main %in% c("microglia","Macrophage","GAM","BAM","Mono-mac","Monocytes")),features = rev(c("Tmem119","P2ry12","P2ry13","Cx3cr1","Cst3","Pros1","Ccl3","Ccl4","Jun","Junb","Jund","Fos","Socs3","Il1b")),group.by = "annotation_V2",cluster.idents = T) +RotatedAxis()+coord_flip() + scale_color_gradientn(colours = c("darkblue","beige","red2"))
# c("BAM-like_Sparc+","Chst2_high_MG","Classical_monocytes","Complement_GBP_BAM","Fosb_Dusp1_high_MG","GAM","Ifn-responsive_MG","Il7r_Hspa1a_high_MG","intM","MHC2_high_BAM","MHC2_low_BAM","Non-classical_monocytes","Nr4a1_Fos_high_MG","PAM","Slamf9_macrophage","Trem2_Ccr6_high_MG","unknown_MG")
```

```{r}
# GAM plots
g <- DotPlot(subset(immune, subset = annotation_main %in% c("GAM")),features = rev(c("Mrc1","Msr1","Tgfb1","Tgfb2","Pkm","Cd163","Axl","Arg1","Mif","Cd74","Stat3","Stat6","Lgals3","Id2","Apoe","Apoc1","Ccl4","Cxcl16","Pdcd1","Cd274","Pdcd1lg2","Btk","Mt1","Ctsb","Ctsd","Spp1","Vegfa","Vegfb","Cxcl10","Cxcl9","Ccr5","Ccl5","Adgre1","Stat1","Tnf","H2-Aa","Tlr2","Tlr4","Cd86","Il1b")),group.by = "progress",cluster.idents = F) +RotatedAxis()+coord_flip() + scale_color_gradientn(colours = c("darkblue","beige","red2"))
g
ggsave("REPLICATE_FIGURES/REPLICATE_Supp_Fig2D.pdf",plot = g, width = 6, height = 12)
```

```{r}
# More Plots
clusters <- c("BAM-like_Sparc+","Chst2_high_MG","Classical_monocytes","Complement_GBP_BAM","Fosb_Dusp1_high_MG","Ifn-responsive_MG","Il7r_Hspa1a_high_MG","intM","MHC2_high_BAM","MHC2_low_BAM","Non-classical_monocytes","Nr4a1_Fos_high_MG","PAM","Slamf9_macrophage","Trem2_Ccr6_high_MG","unknown_MG")

for (i in clusters){
  g <- DotPlot(subset(immune, subset = annotation_V2 %in% c(i)),features = rev(c("Mrc1","Msr1","Tgfb1","Tgfb2","Pkm","Cd163","Axl","Arg1","Mif","Cd74","Stat3","Stat6","Lgals3","Id2","Apoe","Apoc1","Ccl4","Cxcl16","Pdcd1","Cd274","Pdcd1lg2","Btk","Mt1","Ctsb","Ctsd","Spp1","Vegfa","Vegfb","Cxcl10","Cxcl9","Ccr5","Ccl5","Adgre1","Stat1","Tnf","H2-Aa","Tlr2","Tlr4","Cd86","Il1b")),group.by = "progress",cluster.idents = F) +RotatedAxis()+coord_flip() + scale_color_gradientn(colours = c("darkblue","beige","red2"))
g
ggsave(paste0("REPLICATE_FIGURES/REPLICATE_Supp_Fig2E-F_",i,".pdf"),plot = g, width = 6, height = 12)
}


```

# Fig 3

## 3A 

```{r}
clusters <- c("GAM","Classical_monocytes","Complement_GBP_BAM","intM","MHC2_high_BAM","MHC2_low_BAM","Non-classical_monocytes","Slamf9_macrophage")
bulk <- AggregateExpression(subset(immune, subset = annotation_V2 %in% clusters),group.by = "annotation_V2",return.seurat = T)
```

```{r}

g <- DoHeatmap(subset(immune, subset = annotation_V2 %in% clusters),group.by = "annotation_V2",slot = "scale.data", features = c("Tgfbi","Cd14","Itga4","Cd163","Ifitm3","Adgre1","Trem2","Cd9","Cd81","Hvcn1","Spp1","Ctsb","Ctsd","Ctsz","Lgals3","Cd63","Cd68","Syngr1","Timp2","C1qa","C1qb","C1qc"),disp.min = -2,disp.max = 2,size = 2,draw.lines = F)+ 
  scale_fill_gradientn(colours = c("darkblue","white","red2"))+
  theme(legend.position = "bottom")
g
ggsave("REPLICATE_FIGURES/REPLICATE_Fig3A.pdf",plot = g, width = 15,height = 6)

```
```{r}
g <- DoHeatmap(bulk,group.by = "annotation_V2",slot = "scale.data", features = c("Tgfbi","Cd14","Itga4","Cd163","Ifitm3","Adgre1","Trem2","Cd9","Cd81","Hvcn1","Spp1","Ctsb","Ctsd","Ctsz","Lgals3","Cd63","Cd68","Syngr1","Timp2","C1qa","C1qb","C1qc"),size = 2,draw.lines = F)+ 
  scale_fill_gradientn(colours = c("darkblue","white","red2"))+
  theme(legend.position = "bottom")
g
ggsave("REPLICATE_FIGURES/REPLICATE_Fig3A_bulk.pdf",plot = g, width = 15,height = 6)
```
Some problem with heatmap... but could because of previously microglia were included.

## 3C

require pairwise DE of GAM (LGG v.s. NT; HGG v.s. LGG)

```{r}

```

## Fig 3D

```{r}
p1 <- VlnPlot(subset(immune, subset = annotation_main %in% c("GAM","Macrophage","Mono-mac","BAM")),features = c("Cd74"),cols = pal,group.by = "progress",split.by = "annotation_V2",ncol = 2,fill.by = "ident")+
  guides(fill = guide_legend(title = "Annotation",ncol = 2))+
  theme(legend.position = "bottom")
p2 <- VlnPlot(subset(immune, subset = annotation_main %in% c("GAM","Macrophage","Mono-mac","BAM")),features = c("Mif"),cols = pal,group.by = "progress",split.by = "annotation_V2",ncol = 2,fill.by = "ident")+
  guides(fill = guide_legend(title = "Annotation",ncol = 2))+
  theme(legend.position = "bottom")
p3 <- VlnPlot(subset(immune, subset = annotation_main %in% c("GAM","Macrophage","Mono-mac","BAM")),features = c("Id2"),cols = pal,group.by = "progress",split.by = "annotation_V2",ncol = 2,fill.by = "ident")+
  guides(fill = guide_legend(title = "Annotation",ncol = 2))+
  theme(legend.position = "bottom")
p4 <- VlnPlot(subset(immune, subset = annotation_main %in% c("GAM","Macrophage","Mono-mac","BAM")),features = c("Lgals3"),cols = pal,group.by = "progress",split.by = "annotation_V2",ncol = 2,fill.by = "ident")+
  guides(fill = guide_legend(title = "Annotation",ncol = 2))+
  theme(legend.position = "bottom")
g <- cowplot::plot_grid(p1, p2,p3,p4)

ggsave("REPLICATE_FIGURES/REPLICATE_Fig3D.pdf",plot = g, width = 18,height = 18)
```

```{r}
VlnPlot(subset(immune, subset = annotation_main %in% c("GAM","Macrophage","Mono-mac","BAM")),features = c("Cd74","Mif","Id2","Lgals3"),cols = pal[c(1,6,17)],group.by = "progress",ncol = 2)
```
 
# Supp Fig 4

## S4A

```{r}
clusters <- c("GAM","Classical_monocytes","Complement_GBP_BAM","intM","MHC2_high_BAM","MHC2_low_BAM","Non-classical_monocytes","Slamf9_macrophage")
bulk <- AggregateExpression(subset(immune, subset = annotation_V2 %in% clusters),group.by = "progress",return.seurat = T)
g <- DoHeatmap(bulk,group.by = "progress",slot = "scale.data", features = c("Apoe","Apoc1","Timp2","Fabp5","Lyz2","Cst7","Plin2","Ftl1","Lgals3bp","C4b","Igf1","Abca1","Spp1","Lgals3","Gpnmb","Hbb-bs","Hmox1","H2-Ab1","H2-Aa","Cxcl9","Cd74","Hspa1b","Ccl5","Cxcl10","Csf1r"),size = 2,draw.lines = F)+ 
  scale_fill_gradientn(colours = c("darkblue","white","red2"))+
  theme(legend.position = "bottom")
g
```
```{r}
clusters <- c("GAM","Classical_monocytes","Complement_GBP_BAM","intM","MHC2_high_BAM","MHC2_low_BAM","Non-classical_monocytes","Slamf9_macrophage")
bulk <- AggregateExpression(subset(immune, subset = annotation_V2 =="GAM"),group.by = "progress",return.seurat = T)
bulk$progress <- factor(bulk$progress, level = c("No tumor","LGG","HGG"))
g <- DoHeatmap(bulk,group.by = "progress",slot = "scale.data", features = c("Apoe","Apoc1","Timp2","Fabp5","Lyz2","Cst7","Plin2","Ftl1","Lgals3bp","C4b","Igf1","Abca1","Spp1","Lgals3","Gpnmb","Hbb-bs","Hmox1","H2-Ab1","H2-Aa","Cxcl9","Cd74","Hspa1b","Ccl5","Cxcl10","Csf1r"),size = 2,draw.lines = F)+ 
  scale_fill_gradientn(colours = c("darkblue","white","red2"))+
  theme(legend.position = "bottom")
g
```

# Supp Fig 5

macrophage by progress

```{r}
clusters <- c("Complement_GBP_BAM","MHC2_high_BAM","MHC2_low_BAM","Slamf9_macrophage")
bulk <- AggregateExpression(subset(immune, subset = annotation_V2 =="GAM"),group.by = "progress",return.seurat = T)
bulk$progress <- factor(bulk$progress, level = c("No tumor","LGG","HGG"))
g <- DoHeatmap(bulk,group.by = "progress",slot = "scale.data", features = c("Apoe","Apoc1","Timp2","Fabp5","Lyz2","Cd9","Cst7","Plin2","Ftl1","Lgals3bp","C4b","Igf1","Abca1","Spp1","Lgals3","Gpnmb","Hbb-bs","Hmox1","H2-Ab1","H2-Aa","Cxcl9","Cd74","Hspa1b","Ccl5","Cxcl10","Csf1r"),size = 2,draw.lines = F)+ 
  scale_fill_gradientn(colours = c("darkblue","white","red2"))+
  theme(legend.position = "bottom")
g
```
# Fig 5 and Fig S11: T cells

## S11 and Fig5A

```{r}
table(immune$annotation_main)
```


```{r}
clusters <- c("T_cells","CD4_T_cells","CD8_T_cells")
bulk <- AggregateExpression(subset(immune, subset = annotation_main %in% clusters),group.by = "progress",return.seurat = T)
bulk$progress <- factor(bulk$progress, level = c("No tumor","LGG","HGG"))
g <- DoHeatmap(bulk,group.by = "progress",slot = "scale.data", features = c("Cd8a","Cxcr6","Ifng","Ccl5","Fabp5","Apoe","Apoc1","Hmox1","Stat1","Ccl8"),size = 2,draw.lines = F)+ 
  scale_fill_gradientn(colours = c("darkblue","white","red2"))
g
```
## Fig5B

```{r}
clusters <- c("T_cells","CD4_T_cells","CD8_T_cells")
g <- DotPlot(subset(immune, subset = annotation_main %in% clusters),features = rev(c("Cd69","Cd27","Cd28","Ifng","Gzmb","Tbx21","Cd44","Tnf","Il2","Prf1","Gzmk","Ctla4","Pdcd1","Lgals3","Lag3","Havcr2","Gata3","Foxp3")),group.by = "progress",cluster.idents = F) +RotatedAxis()+coord_flip() + scale_color_gradientn(colours = c("darkblue","beige","red2"))
g
ggsave("REPLICATE_FIGURES/REPLICATE_Fig5B.pdf",plot = g, width = 6, height = 12)
```

## Fig 5C

```{r}
clusters <- c("T_cells","CD4_T_cells")
g <- DotPlot(subset(immune, subset = annotation_main %in% clusters),features = rev(c("Cd69","Cd27","Cd28","Ifng","Gzmb","Tbx21","Cd44","Tnf","Il2","Prf1","Gzmk","Ctla4","Pdcd1","Lgals3","Lag3","Havcr2","Gata3","Foxp3")),group.by = "progress",cluster.idents = F) +RotatedAxis()+coord_flip() + scale_color_gradientn(colours = c("darkblue","beige","red2"))
g
ggsave("REPLICATE_FIGURES/REPLICATE_Fig5C.pdf",plot = g, width = 6, height = 12)
```

## Fig 5D

```{r}
clusters <- c("T_cells","CD8_T_cells")
g <- DotPlot(subset(immune, subset = annotation_main %in% clusters),features = rev(c("Cd69","Cd27","Cd28","Ifng","Cxcr6","Cd44","Tnf","Gzmk","Il2","Prf1","Gzmb","Ctla4","Pdcd1","Lgals3","Lag3","Havcr2","Il10","Fas")),group.by = "progress",cluster.idents = F) +RotatedAxis()+coord_flip() + scale_color_gradientn(colours = c("darkblue","beige","red2"))
g
ggsave("REPLICATE_FIGURES/REPLICATE_Fig5D.pdf",plot = g, width = 6, height = 12)
```

# Fig S12 T cell featureplot

```{r}
p1 <- FeaturePlot(immune,features = "Cxcr6",split.by = "progress",cols = c("grey90","red2"),order = T)
p2 <- FeaturePlot(immune,features = "Ifng",split.by = "progress",cols = c("grey90","red2"),order = T)
p3 <- FeaturePlot(immune,features = "Cxcl9",split.by = "progress",cols = c("grey90","red2"),order = T)
p4 <- FeaturePlot(immune,features = "Cxcl10",split.by = "progress",cols = c("grey90","red2"),order = T)
p5 <- FeaturePlot(immune,features = "Ccl5",split.by = "progress",cols = c("grey90","red2"),order = T)
g <- cowplot::plot_grid(p1,p2,p3,p4,p5,nrow = 5)
ggsave("REPLICATE_FIGURES/REPLICATE_Supp_Fig12.pdf",plot = g, width = 8,height = 20)
```





