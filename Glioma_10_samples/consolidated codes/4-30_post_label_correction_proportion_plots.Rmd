---
title: "4-30_post_label_correction_proportion_plots"
output: html_document
date: "2024-07-15"
---

```{r}
library(tidyverse)
library(Seurat)
library(harmony)
# library(fmsb) # for radar chart
library(ggradar)
library(RColorBrewer)
```

```{r}
indir <- "data/"
outdir <- "proportion_plots_V3_alt/"
if (!dir.exists(outdir)){
  dir.create(outdir)
} 
```

```{r}
pal <- c(brewer.pal(n = 12,name = "Set3"),brewer.pal(n = 12,name = "Paired"),brewer.pal(n = 8,name = "Accent"))
pal[2] <- "darkred"
pal[9] <- "grey25"
pal[23] <- "turquoise4"
pal[19] <- colors()[60]
pal[13] <- "darkblue"
pal[28] <- colors()[16]
pal[31] <- colors()[54] 
pal <- c(pal,colors()[c(85,84,83,89,45,31,41,42,26,29,10,139,107,108,120,109,119,121,143)])
```



# create new metadata table for whole dataset

Also check label correctness, especially compartment, main, and cell type V2
```{r}
load("data/GBM_RNA_10_glioma_V3_alt.Robj")
load("data/GBM_RNA_10_microglia_V3p1_alt.Robj")
load("data/GBM_RNA_10_lymphoid_V3p1_alt.Robj")
load("data/GBM_RNA_10_myeloid_V3p2_alt.Robj")
load("data/GBM_RNA_10_vascular_V3_alt.Robj")
load("data/GBM_RNA_10_resident_V3_alt.Robj")
```

## check labels

The decision is to use a more specific cell type naming. Although people for argue for an overall more immunosuppressive role of myeloids, I would argue that the specific role and characteristics is subtype sepcific. Each immune responsive profile involves a combination of myeloids and lymphoids.

However, we still different layers of naming to enable different.
First layer: compartment (tissue level; or the highest level depending on the dataset), e.g. immune cells, glial, tumor.
Second layer: cell type; the order lower than compartment 
third layer: the main annotation
fourth layer: the subtypes.

```{r}
colnames(Glioma@meta.data)
colnames(microglia@meta.data)
colnames(lymphoid@meta.data)
colnames(myeloid@meta.data)
colnames(resident@meta.data)
colnames(vascular@meta.data)
```


### Glioma

```{r}
table(Glioma$annotation_main)
table(Glioma$compartment)
table(Glioma$cell_type)
```
Add V2 meta

```{r}
table(Glioma$annotation_V1)
```



Now there is a need to capitalize the labels and then update the lower level ones + cell_type V2.

```{r}
Glioma@meta.data <- Glioma@meta.data %>% 
  mutate(compartment = case_match(
    compartment,
    "neoplastic" ~ "Neoplastic",
    .default = compartment
  ),
  cell_type_V2 = case_match(
    cell_type,
    "neoplastic" ~ "Neoplastic",
    .default = "Neoplastic"
  ),
  annotation_main = case_match(
    annotation_V1,
    "tumor_1" ~ "LGG-HIGH_tumor",
    "tumor_2" ~ "HET_tumor",
    "tumor_3" ~ "HGG-HIGH_tumor",
    "tumor_4" ~ "NT-like_tumor",
    "tumor_5" ~ "HET_tumor",
    "tumor_6" ~ "LGG-HIGH_tumor",
    "tumor_7" ~ "LGG-HIGH_tumor",
    "tumor_8" ~ "LGG-HIGH_tumor",
    "tumor_9" ~ "HET_tumor",
    "tumor_10" ~ "HGG-HIGH_tumor",
    "tumor_11" ~ "HET_tumor",
    "tumor_12" ~ "LGG-HIGH_tumor",
    "tumor_13" ~ "LGG-HIGH_tumor"
  ),
  annotation_V2 = case_match(
    annotation_V1,
    "tumor_1" ~ "LGG-HIGH_Tumor_1",
    "tumor_2" ~ "HET_Tumor_2",
    "tumor_3" ~ "HGG-HIGH_Tumor_3",
    "tumor_4" ~ "NT-like_Tumor_4",
    "tumor_5" ~ "HET_Tumor_5",
    "tumor_6" ~ "LGG-HIGH_Tumor_6",
    "tumor_7" ~ "LGG-HIGH_Tumor_7",
    "tumor_8" ~ "LGG-HIGH_Tumor_8",
    "tumor_9" ~ "HET_Tumor_9",
    "tumor_10" ~ "HGG-HIGH_Tumor_10",
    "tumor_11" ~ "HET-HIGH_Tumor_11",
    "tumor_12" ~ "LGG-HIGH_Tumor_12",
    "tumor_13" ~ "LGG-HIGH_Tumor_13")
  )
```


```{r}
table(Glioma$compartment)
table(Glioma$cell_type_V2)
table(Glioma$annotation_main)
table(Glioma$annotation_V2)
```

```{r}
save(Glioma,file = "data/GBM_RNA_10_glioma_V3_alt.Robj")
```

Then remove monocle 3 data

```{r}
Glioma$monocle3_cluster <- NULL
Glioma$monocle3_trajectory <- NULL

```

```{r}
colnames(Glioma@meta.data)
```
```{r}
load("data/GBM_RNA_10_glioma_V3_alt.Robj")
```


### myeloid


```{r}
table(myeloid$compartment)
table(myeloid$cell_type)
table(myeloid$annotation_main)
table(myeloid$annotation_V2)
```

```{r}
myeloid@meta.data <- myeloid@meta.data %>% 
  mutate(compartment = case_match(
    compartment,
    "immune_cells" ~ "Immune",
    .default = "Immune"
  ),
  cell_type_V2 = case_match(
    cell_type,
    "myeloid" ~ "Myeloid",
    .default = "Myeloid"
  ),
  annotation_main = case_match(
    annotation_V2,
    "cDC1" ~ "DC",
    "cDC2" ~ "DC",
    "Classical_monocytes" ~ "Mono-mac",
    "Complement_GBP_BAM" ~ "Mono-mac",
    "GAM" ~ "Mono-mac",
    "intM" ~ "Mono-mac",
    "Mast cells" ~ "Mast cells",
    "MHC2_high_BAM" ~ "Mono-mac",
    "MHC2_low_BAM" ~ "Mono-mac",
    "migDC" ~ "DC",
    "Neutrophil" ~ "Neutrophil",
    "Non-classical_monocytes" ~ "Mono-mac",
    "pDC" ~ "DC",
    "Slamf9_macrophage" ~ "Mono-mac",
    .default = annotation_main
  )
  )
```


```{r}
table(myeloid$compartment)
table(myeloid$cell_type_V2)
table(myeloid$annotation_main)
table(myeloid$annotation_V2)
```

```{r}
colnames(myeloid@meta.data)
```

```{r}
save(myeloid,file = "data/GBM_RNA_10_myeloid_V3p2_alt.Robj")
```

```{r}
load("data/GBM_RNA_10_myeloid_V3p2_alt.Robj")
```

There is a need to separate macrophages and monocytes because monocytes can differentiate into DC (possibly) and should be arbituarily grouped with macrophages in general.

```{r}
table(myeloid$compartment)
table(myeloid$cell_type_V2)
table(myeloid$annotation_main)
table(myeloid$annotation_V2)
```

```{r}
myeloid@meta.data <- myeloid@meta.data %>% 
  mutate(compartment = case_match(
    compartment,
    "immune_cells" ~ "Immune",
    .default = "Immune"
  ),
  cell_type_V2 = case_match(
    cell_type,
    "myeloid" ~ "Myeloid",
    .default = "Myeloid"
  ),
  annotation_main = case_match(
    annotation_V2,
    "cDC1" ~ "DC",
    "cDC2" ~ "DC",
    "Classical_monocytes" ~ "Monocytes",
    "Complement_GBP_BAM" ~ "Macrophages",
    "GAM" ~ "Macrophages",
    "intM" ~ "MoMac",
    "Mast cells" ~ "Mast cells",
    "MHC2_high_BAM" ~ "Macrophages",
    "MHC2_low_BAM" ~ "Macrophages",
    "migDC" ~ "DC",
    "Neutrophil" ~ "Neutrophil",
    "Non-classical_monocytes" ~ "Monocytes",
    "pDC" ~ "DC",
    "Slamf9_macrophage" ~ "Macrophages",
    .default = annotation_main
  )
  )
```

```{r}
table(myeloid$compartment)
table(myeloid$cell_type_V2)
table(myeloid$annotation_main)
table(myeloid$annotation_V2)
```
```{r}
save(myeloid,file = "data/GBM_RNA_10_myeloid_V3p2_alt.Robj")
```


### lymphoid

```{r}

table(lymphoid$compartment)
table(lymphoid$cell_type)
table(lymphoid$cell_type_V2)
table(lymphoid$annotation_main)

```

Remove noise from the subset for plotting

```{r}
lymphoid <- subset(lymphoid,subset = cell_type_V2 == "Lymphoid")
```

```{r}
lymphoid@meta.data <- lymphoid@meta.data %>% 
  mutate(compartment = case_match(
    compartment,
    "immune_cells" ~ "Immune",
    .default = "Immune"
  )
  )
```

```{r}
table(lymphoid$compartment)
table(lymphoid$cell_type_V2)
table(lymphoid$annotation_main)
table(lymphoid$annotation_V2)
```

```{r}
save(lymphoid, file = "data/GBM_RNA_10_lymphoid_V3p2_alt.Robj")
```

```{r}
load("data/GBM_RNA_10_lymphoid_V3p2_alt.Robj")
```

I'll merge all T cells in annotation main: conventional T cells, gdT, and NKT. 

```{r}
colnames(lymphoid@meta.data)
```
```{r}
lymphoid@meta.data <- lymphoid@meta.data %>% 
  mutate(compartment = case_match(
    compartment,
    "immune_cells" ~ "Immune",
    .default = "Immune"
  ),
  annotation_main = case_match(
    annotation_V2,
    "0_activated_CD8" ~ "Conventional_T_cells",
    "1_activated_CD4" ~ "Conventional_T_cells",
    "gdT_cells" ~ "gdT_cells",
    "Ifn-responsive_T_cells" ~ "Conventional_T_cells",
    "Memory_B_1" ~ "B_cells",
    "Memory_B_2" ~ "B_cells",
    "Memory_B_3" ~ "B_cells",
    "Naive_T_cells" ~ "Conventional_T_cells",
    "NK" ~ "NK",
    "NKT" ~ "NKT",
    "Pdcd1_Cd44_high_activated_T" ~ "Conventional_T_cells",
    "Proliferating_T_cells" ~ "Conventional_T_cells",
    "Treg" ~ "Conventional_T_cells",
    .default = annotation_V2
  )
  )
```

```{r}
table(lymphoid$compartment)
table(lymphoid$cell_type_V2)
table(lymphoid$annotation_main)
table(lymphoid$annotation_V2)
```

```{r}
save(lymphoid, file = "data/GBM_RNA_10_lymphoid_V3p2_alt.Robj")
```



### microglia

Microglia has a different system of cell type naming from others...I'll correct that, but I will not group them with myeloid :)) It does not make sense to me in terms of the origin the cells. 

```{r}
table(microglia$compartment)
table(microglia$cell_type)
table(microglia$cell_type_V2)
table(microglia$annotation_main)
table(microglia$annotation_V2)
```
I need to swap annotation_main with cell_type_V2

```{r}
microglia@meta.data <- microglia@meta.data %>% 
  mutate(compartment = case_match(
    compartment,
    "immune_cells" ~ "Immune",
    .default = "Immune"
  )
  )
```


```{r}
temp_ann_main <- microglia$annotation_main
microglia$annotation_main <- microglia$cell_type_V2
microglia$cell_type_V2 <- temp_ann_main
```

```{r}
table(microglia$compartment)
table(microglia$cell_type_V2)
table(microglia$annotation_main)
table(microglia$annotation_V2)
```

```{r}
save(microglia, file = "data/GBM_RNA_10_microglia_V3p1_alt.Robj")
```

```{r}
colnames(microglia@meta.data)
```
```{r}
load("data/GBM_RNA_10_microglia_V3p1_alt.Robj")
```

### NG

```{r}

table(resident$compartment)
table(resident$cell_type)
table(resident$cell_type_V2)
table(resident$annotation_main)
table(resident$annotation_V2)
```


```{r}
resident@meta.data <- resident@meta.data %>% 
  mutate(annotation_V2 = case_match(
    annotation_V2,
    "Astrocyte_1" ~ "NT-HIGH_Astrocyte_1",
    "Astrocyte_2" ~ "HET_Astrocyte_2",
    "Astrocyte_3" ~ "NT-HIGH_Astrocyte_3",
    "Astrocyte_4" ~ "HET_Astrocyte_4",
    "Astrocyte_5" ~ "HGG-HIGH_Astrocyte_5",
    "Astrocyte_6" ~ "NT-HIGH_Astrocyte_6",
    "Astrocyte_7" ~ "HGG-HIGH_Astrocyte_7",
    "Ependymal_1" ~ "HGG-HIGH_Ependymal_1",
    "Ependymal_2" ~ "HGG-HIGH_Ependymal_2",
    "Neuron_1" ~ "NT-HIGH_Neuron_1",
    "Neuron_2" ~ "HGG-HIGH_Neuron_2",
    "Oligodendrocyte_1" ~ "LGG-HIGH_Oligodendrocyte_1",
    "Oligodendrocyte_2" ~ "LGG-HIGH_Oligodendrocyte_2",
    "Oligodendrocyte_3" ~ "HGG-HIGH_Oligodendrocyte_3",
    "Progenitor-like_1" ~ "NT-HIGH_Progenitor-like_1",
    "Progenitor-like_2" ~ "LGG-HIGH_Progenitor-like_2",
    "Unknown_Igfbp7_high" ~ "HET_Unknown_Igfbp7_high",
    .default = annotation_V2
  )
  )
```

```{r}
table(resident$compartment)
table(resident$cell_type_V2)
table(resident$annotation_main)
table(resident$annotation_V2)
```

```{r}
save(resident ,file = "data/GBM_RNA_10_resident_V3_alt.Robj")
```

```{r}
colnames(resident@meta.data)
```

I need to update the cell type labels because the hierarchy is incorrect. --> Glial, Neuronal, Unknown

```{r}
load("data/GBM_RNA_10_resident_V3_alt.Robj")
```

```{r}
resident@meta.data <- resident@meta.data %>% 
  mutate(cell_type_V2 = case_match(
    annotation_main,
    "Astrocyte" ~ "Glial",
    "Ependymal" ~ "Glial",
    "Neuron" ~ "Neuronal",
    "Oligodendrocyte" ~ "Glial",
    "Progenitor-like" ~ "Glial",
    "Unknown_Igfbp7_high" ~ "Unknown",
    .default = annotation_main
  )
  )
```

```{r}
table(resident$compartment)
table(resident$cell_type_V2)
table(resident$annotation_main)
table(resident$annotation_V2)
```

```{r}
save(resident ,file = "data/GBM_RNA_10_resident_V3_alt.Robj")
```


### VS

```{r}
table(vascular$compartment)
table(vascular$cell_type)
table(vascular$cell_type_V2)
table(vascular$annotation_main) # need to be more specific
table(vascular$annotation_V2)
```



```{r}
vascular@meta.data <- vascular@meta.data %>% 
  mutate(annotation_main = case_match(
    annotation_V2,
    "Arteriole_EC" ~ "Endothelial",
    "Capillary_EC_1" ~ "Endothelial",
    "Capillary_EC_2" ~ "Endothelial",
    "Capillary_EC_3" ~ "Endothelial",
    "Fibroblast_1" ~ "Fibroblast",
    "Fibroblast_2" ~ "Fibroblast",
    "Fibroblast_3_CAF" ~ "Perivascular_Fibroblast",
    "Pericytes" ~ "Pericytes",
    "Smooth_muscle" ~ "Smooth_muscle",
    .default = annotation_V2
  ),
  cell_type_V2 = case_match(
    annotation_V2,
    "Arteriole_EC" ~ "Endothelial",
    "Capillary_EC_1" ~ "Endothelial",
    "Capillary_EC_2" ~ "Endothelial",
    "Capillary_EC_3" ~ "Endothelial",
    "Fibroblast_1" ~ "Fibroblast",
    "Fibroblast_2" ~ "Fibroblast",
    "Fibroblast_3_CAF" ~ "Perivascular",
    "Pericytes" ~ "Perivascular",
    "Smooth_muscle" ~ "Perivascular",
    .default = annotation_V2
  )
  )
```

```{r}
table(vascular$compartment)
table(vascular$cell_type_V2)
table(vascular$annotation_main) # need to be more specific
table(vascular$annotation_V2)
```


```{r}
save(vascular, file ="data/GBM_RNA_10_vascular_V3_alt.Robj")
```


```{r}
colnames(vascular@meta.data)
```
```{r}
load("data/GBM_RNA_10_vascular_V3_alt.Robj")
```


Relabel cell type V2 to avoid the perivascular issue. However, the classification is a bit blurry regarding the difference between vascular and stromal cells, so I'll use EC, mural, and fibroblast. Fibroblasts and ECM consitute the adventitia, which exists in some vasculature as vascular associated cell types. 

```{r}
vascular@meta.data <- vascular@meta.data %>% 
  mutate(annotation_main = case_match(
    annotation_V2,
    "Arteriole_EC" ~ "Endothelial",
    "Capillary_EC_1" ~ "Endothelial",
    "Capillary_EC_2" ~ "Endothelial",
    "Capillary_EC_3" ~ "Endothelial",
    "Fibroblast_1" ~ "Fibroblast",
    "Fibroblast_2" ~ "Fibroblast",
    "Fibroblast_3_CAF" ~ "Perivascular_Fibroblast",
    "Pericytes" ~ "Pericytes",
    "Smooth_muscle" ~ "Smooth_muscle",
    .default = annotation_V2
  ),
  cell_type_V2 = case_match(
    annotation_V2,
    "Arteriole_EC" ~ "Endothelial",
    "Capillary_EC_1" ~ "Endothelial",
    "Capillary_EC_2" ~ "Endothelial",
    "Capillary_EC_3" ~ "Endothelial",
    "Fibroblast_1" ~ "Fibroblast",
    "Fibroblast_2" ~ "Fibroblast",
    "Fibroblast_3_CAF" ~ "Fibroblast",
    "Pericytes" ~ "Mural",
    "Smooth_muscle" ~ "Mural",
    .default = annotation_V2
  )
  )
```


```{r}
table(vascular$compartment)
table(vascular$cell_type_V2)
table(vascular$annotation_main) 
table(vascular$annotation_V2)
```

```{r}
save(vascular, file ="data/GBM_RNA_10_vascular_V3_alt.Robj")
```


# create new whole object and whole metadata

```{r}
whole <- merge(Glioma,y = c(lymphoid,myeloid,microglia,resident,vascular))
```

```{r}
whole <- NormalizeData(whole,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
whole <- FindVariableFeatures(object = whole, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(whole) <-  VariableFeatures(whole) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(whole))]
VariableFeaturePlot(whole,selection.method = "mean.var.plot")

whole <- ScaleData(object = whole, features = VariableFeatures(object = whole), vars.to.regress = c("nCount_RNA", "percent.mt"))
whole <- RunPCA(object = whole,
                features =  VariableFeatures(object = whole),
                dims = 1:50)
gc()

ElbowPlot(whole,ndims = 50)
```



```{r}
whole <- RunHarmony(object = whole, group.by.vars = c("batch_ID"), max.iter.harmony = 20)
whole <- RunUMAP(whole,dims = 1:40,reduction = "harmony")
whole <- RunTSNE(whole,dims = 1:40,reduction = "harmony")

whole <- FindNeighbors(whole, dims = 1:40,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  whole <- FindClusters(object = whole, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
whole <- JoinLayers(whole)
```

```{r}
p1 <- DimPlot(whole,group.by = "cell_type_V2")+scale_color_manual(values = pal)
p2 <- DimPlot(whole,group.by = "annotation_main",label = T,label.box = T,repel = T,label.color = "white")+scale_color_manual(values = pal)+scale_fill_manual(values = pal)
ggsave("whole_V3_cell_type_v2_umap.pdf",plot = p1, width = 10,height = 10)
ggsave("whole_V3_ann_main_umap.pdf",plot = p2, width = 15,height = 12)
```

```{r}
save(whole, file = "data/GBM_RNA_10_whole_V3.Robj")
```

```{r}
whole_meta <- whole@meta.data
write.table(whole_meta,file = "data/whole_meta_annotation_V2_alt.tsv",sep = "\t",row.names = F,col.names = T,quote = F)
```

# THE ACTUAL PROPORTION PLOT

## load and prepare

```{r}
whole_meta <- read.table(file = paste0(indir,"whole_meta_annotation_V2_alt.tsv"),sep = "\t",header = T)
```

```{r}
table(whole_meta$orig.ident)
table(whole_meta$batch_ID)
table(whole_meta$progress)
```
Before repeating everything, let's clarify some goals and ratioinales.

1) For analysis of non-immune cell compartments, restrict to all tissue samples.
2) grouping of cell types and stratifications:
  i) Comparison of all compartment sizes (still barplots; we can add pie charts if there is a need;) within the sample
  ii) comparison of cell type in compartments (e.g. % myeloid in immune cells)
  iii) comparison of annotation main in compartments (e.g. %DC in immune cells)
  iv) comparison of subpopulation in compartments (e.g. %cDC1 in immune cells)
  v) comparison of annotation main in cell type (e.g. %DC in myeloid); pie chart
  vi) comparison of subpopulation in annotation main (pie chart %cDC1 in DC)
  
In the end, there should be in total four panels, highlighting the compartment composition, the cell type composition, the annotation main composition (with respect to compartment and cell type), and the subpopulation composition (with respect to compartment and annotation main)


```{r}
all_compartment_meta <- whole_meta %>% filter(batch_ID !="batch_CD45")
immune_cell_meta <- whole_meta %>% filter(compartment == "Immune")
```

```{r}
table(all_compartment_meta$orig.ident)
```

```{r}
write.table(all_compartment_meta,file = "data/whole_meta_annotation_V2_alt_all_comp.tsv",sep = "\t",col.names = T,row.names = F,quote = F)
write.table(immune_cell_meta,file = "data/whole_meta_annotation_V2_alt_immune_cells.tsv",sep = "\t",col.names = T,row.names = F,quote = F)
```

## compartment size plots

```{r}
level <- "compartment_overview"
outdir <- paste0("proportion_plots_V3_alt/",level,"/")
if (!dir.exists(outdir)){
  dir.create(outdir)
}
```

### stratify by sample

```{r}
compart_table_batch <- full_join(
  x = all_compartment_meta %>% group_by(compartment,sample.id,batch_ID) %>% summarise(compartment_size = n()),
  y = all_compartment_meta %>% group_by(sample.id,batch_ID) %>% summarise(sample_size = n()),
  by = c("sample.id","batch_ID")) %>%
  mutate(prop_compart_per_sample = compartment_size*100 /sample_size ) 
compart_table_progress <- full_join(
  x = all_compartment_meta %>% group_by(compartment,sample.id,progress) %>% summarise(compartment_size = n()),
  y = all_compartment_meta %>% group_by(sample.id,progress) %>% summarise(sample_size = n()),
  by = c("sample.id","progress")) %>%
  mutate(prop_compart_per_sample = compartment_size*100 /sample_size ) 
```

```{r}
# by sample barplot
g <- ggplot(compart_table_batch) +
  geom_bar(aes(x = sample.id, y = prop_compart_per_sample,fill = compartment),stat = "identity",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()+ylab("% of compartment in sample")+xlab("Sample ID")
g
ggsave(filename = paste0(outdir,"compartment_prop_barplots_by_sample_ann_V2.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(compart_table_progress) +
  geom_bar(aes(x = sample.id, y = prop_compart_per_sample,fill = compartment),stat = "identity",position = "stack") +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG")), scales = "free")+
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()+ylab("% of compartment in sample")+xlab("Sample ID")
g
ggsave(filename = paste0(outdir,"compartment_prop_barplots_by_sample_by_progress_ann_V2.pdf"),plot = g, width = 8,height = 8)
```
### group by progress

```{r}
compart_table <- full_join(
  x = all_compartment_meta %>% group_by(compartment,progress) %>% summarise(compartment_size = n()),
  y = all_compartment_meta %>% group_by(progress) %>% summarise(progress_size = n()),
  by = c("progress")) %>%
  mutate(prop_compart_per_stage = compartment_size*100 /progress_size ) %>%
  mutate(labels = scales::percent(compartment_size /progress_size))
```

```{r}
g <- ggplot(compart_table, aes(x = "", y = prop_compart_per_stage, fill = compartment)) +
  geom_col(color = "black") +
  ggrepel::geom_label_repel(aes(label = labels),
            position = position_stack(vjust = 0.5),
            show.legend = FALSE,max.overlaps = 15) +
  guides(fill = guide_legend(title = "Compartments",ncol = 2)) +
  scale_fill_manual(values = pal) +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG"))) +
  coord_polar(theta = "y") +
  theme_void()
g
ggsave(filename = paste0(outdir,"compartment_prop_piechart_by_progress_ann_V2.pdf"),plot = g, width = 8,height = 8)
```

```{r}
g <- ggplot(compart_table) +
  geom_bar(aes(x = factor(progress,levels = c("No tumor","LGG","HGG")), y = prop_compart_per_stage,fill = compartment),stat = "identity",position = "stack") +
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()+
  xlab("Stage")+
  ylab("% of compartment in samples from the same stage")
g
ggsave(filename = paste0(outdir,"compartment_prop_barplots_by_progress_ann_V2.pdf"),plot = g, width = 8,height = 8)
```

## cell type level plots

```{r}
level <- "cell_type_overview"
outdir <- paste0("proportion_plots_V3_alt/",level,"/")
if (!dir.exists(outdir)){
  dir.create(outdir)
}
```

### stratify by sample

```{r}
CT_table_batch <- full_join(
  x = all_compartment_meta %>% group_by(cell_type_V2,sample.id,batch_ID) %>% summarise(CT_size = n()),
  y = all_compartment_meta %>% group_by(sample.id,batch_ID) %>% summarise(sample_size = n()),
  by = c("sample.id","batch_ID")) %>%
  mutate(prop_CT_per_sample = CT_size*100 /sample_size ) 
CT_table_progress <- full_join(
  x = all_compartment_meta %>% group_by(cell_type_V2,sample.id,progress) %>% summarise(CT_size = n()),
  y = all_compartment_meta %>% group_by(sample.id,progress) %>% summarise(sample_size = n()),
  by = c("sample.id","progress")) %>%
  mutate(prop_CT_per_sample = CT_size*100 /sample_size ) 
```

```{r}
# by sample barplot
g <- ggplot(CT_table_batch) +
  geom_bar(aes(x = sample.id, y = prop_CT_per_sample,fill = cell_type_V2),stat = "identity",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  scale_fill_manual("Cell Type",values = pal)+
  theme_classic()+
  RotatedAxis()+xlab("Sample ID")+ylab("% of cell type in the sample")
g
ggsave(filename = paste0(outdir,"cell_type_prop_barplots_by_sample_ann_V2.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(CT_table_progress) +
  geom_bar(aes(x = sample.id, y = prop_CT_per_sample,fill = cell_type_V2),stat = "identity",position = "stack") +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG")), scales = "free")+
  scale_fill_manual("Cell Type",values = pal)+
  theme_classic()+
  RotatedAxis()+xlab("Sample ID")+ylab("% of cell type in the sample")
g
ggsave(filename = paste0(outdir,"cell_type_prop_barplots_by_sample_by_progress_ann_V2.pdf"),plot = g, width = 8,height = 8)
```

### summary by stage


```{r}
CT_table <- full_join(
  x = all_compartment_meta %>% group_by(cell_type_V2,progress,compartment) %>% summarise(CT_size = n()),
  y = all_compartment_meta %>% group_by(progress,compartment) %>% summarise(progress_size = n()),
  by = c("progress","compartment")) %>%
  mutate(prop_CT_per_stage = CT_size*100 /progress_size ) %>%
  mutate(labels = scales::percent(CT_size /progress_size))
```

```{r}
g <- ggplot(CT_table, aes(x = "", y = prop_CT_per_stage, fill = cell_type_V2)) +
  geom_col(color = "black") +
  ggrepel::geom_label_repel(aes(label = labels),
            position = position_stack(vjust = 0.5),
            show.legend = FALSE,max.overlaps = 15) +
  guides(fill = guide_legend(title = "Cell Types",ncol = 2)) +
  scale_fill_manual(values = pal) +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG"))) +
  coord_polar(theta = "y") +
  theme_void()
g
ggsave(filename = paste0(outdir,"cell_type_prop_piechart_by_progress_ann_V2.pdf"),plot = g, width = 10,height = 10)
```

```{r}
g <- ggplot(CT_table) +
  geom_bar(aes(x = factor(progress,levels = c("No tumor","LGG","HGG")), y = prop_CT_per_stage,fill = cell_type_V2),stat = "identity",position = "stack") +
  scale_fill_manual("Cell Type",values = pal)+
  theme_classic()+
  RotatedAxis()+
  xlab("Stage")+
  ylab("% in cell type in samples from the same stage")+
  facet_wrap(~compartment,scales = "free")
g
ggsave(filename = paste0(outdir,"cell_type_prop_barplots_by_progress_ann_V2.pdf"),plot = g, width = 8,height = 8)
```

```{r}
g <- ggplot(CT_table) +
  geom_bar(aes(x = factor(progress,levels = c("No tumor","LGG","HGG")), y = prop_CT_per_stage,fill = cell_type_V2),stat = "identity",position = "dodge") +
  scale_fill_manual("Cell Type",values = pal)+
  facet_wrap(~compartment+cell_type_V2,scales = "free")+
  theme_classic()+
  RotatedAxis()+
  xlab("Stage")+
  ylab("% in cell type in samples from the same stage")
g
ggsave(filename = paste0(outdir,"cell_type_prop_barplots_by_progress_by_comp_ann_V2.pdf"),plot = g, width = 10,height = 10)
```

```{r}
g <- ggplot(CT_table, aes(x = "", y = prop_CT_per_stage, fill = cell_type_V2)) +
  geom_col(color = "black") +
  ggrepel::geom_label_repel(aes(label = labels),
            position = position_stack(vjust = 0.5),
            show.legend = FALSE,max.overlaps = 15) +
  guides(fill = guide_legend(title = "Cell Types",ncol = 2)) +
  scale_fill_manual(values = pal) +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG"))+compartment) +
  coord_polar(theta = "y") +
  theme_void()
g
ggsave(filename = paste0(outdir,"cell_type_prop_piechart_by_progress_by_comp_ann_V2.pdf"),plot = g, width = 10,height = 10)
```


### cell type composition from all immune cells

```{r}
CT_table_imm <- full_join(
  x = immune_cell_meta %>% group_by(cell_type_V2,progress,compartment) %>% summarise(CT_size = n()),
  y = immune_cell_meta %>% group_by(progress,compartment) %>% summarise(progress_size = n()),
  by = c("progress","compartment")) %>%
  mutate(prop_CT_per_stage = CT_size*100 /progress_size ) %>%
  mutate(labels = scales::percent(CT_size /progress_size))
```


```{r}
g <- ggplot(CT_table_imm) +
  geom_bar(aes(x = factor(progress,levels = c("No tumor","LGG","HGG")), y = prop_CT_per_stage,fill = cell_type_V2),stat = "identity",position = "dodge") +
  scale_fill_manual("Cell Type",values = pal[c(4,5,7)])+
  facet_wrap(~compartment+cell_type_V2,scales = "free")+
  theme_classic()+
  RotatedAxis()+
  xlab("Stage")+
  ylab("% in cell type in samples from the same stage")
g
ggsave(filename = paste0(outdir,"imm_cell_type_prop_barplots_by_progress_by_comp_ann_V2.pdf"),plot = g, width = 8,height = 8)
```

```{r}
g <- ggplot(CT_table_imm, aes(x = "", y = prop_CT_per_stage, fill = cell_type_V2)) +
  geom_col(color = "black") +
  ggrepel::geom_label_repel(aes(label = labels),
            position = position_stack(vjust = 0.5),
            show.legend = FALSE,max.overlaps = 15) +
  guides(fill = guide_legend(title = "Cell Types",ncol = 2)) +
  scale_fill_manual(values = pal[c(4,5,7)]) +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG"))+compartment) +
  coord_polar(theta = "y") +
  theme_void()
g
ggsave(filename = paste0(outdir,"imm_cell_type_prop_piechart_by_progress_by_comp_ann_V2.pdf"),plot = g, width = 10,height = 10)
```

## annotation main plots

```{r}
level <- "annotation_main"
outdir <- paste0("proportion_plots_V3_alt/",level,"/")
if (!dir.exists(outdir)){
  dir.create(outdir)
}
```

### stratify by sample

I'll not be doing this for the subpopulation oh my goodness :))))) It is easy to see sample differences in subpopulation capture.

*EDIT: Okay, I had to do the sample-level stratification because I need to exclude sample-specific populations :)) They may create results that are hard to generalize and interpret for this dataste.*

#### proportion of ann_main in its corresponding compartment for non-immune cells

Now you need to consider splitting by compartment as well.

```{r}
prop_ann_main_comp_batch <- full_join(
  x = all_compartment_meta %>% group_by(compartment,cell_type_V2,sample.id,batch_ID,annotation_main) %>% summarise(ann_size = n()),
  y = all_compartment_meta %>% group_by(sample.id,batch_ID) %>% summarise(sample_size = n()),
  by = c("sample.id","batch_ID")) %>%
  mutate(prop_ann_per_sample = ann_size*100 /sample_size ) %>% filter(compartment != "Immune")

prop_ann_main_comp_progress <- full_join(
  x = all_compartment_meta %>% group_by(compartment,cell_type_V2,sample.id,progress,annotation_main) %>% summarise(ann_size = n()),
  y = all_compartment_meta %>% group_by(sample.id,progress) %>% summarise(sample_size = n()),
  by = c("sample.id","progress")) %>%
  mutate(prop_ann_per_sample = ann_size*100 /sample_size ) %>% filter(compartment != "Immune")

```
```{r}
compartment_list <- unique(prop_ann_main_comp_batch$compartment) 
for (i in compartment_list){
  g <- ggplot(prop_ann_main_comp_batch %>% filter(compartment == i)) +
  geom_bar(aes(x = sample.id, y = prop_ann_per_sample,fill = annotation_main),stat = "identity",position = "dodge") +
  facet_wrap(~batch_ID+annotation_main, scales = "free")+
  scale_fill_manual("Cell Population",values = pal)+
  theme_classic()+
  RotatedAxis()+
  xlab("Sample ID") + ylab("% population in sample")
g
ggsave(filename = paste0(outdir,i,"_ann_main_comp_prop_barplots_by_sample_ann_V2.pdf"),plot = g, width = 12,height = 12)

# by sample barplot
g <- ggplot(prop_ann_main_comp_progress %>% filter(compartment == i)) +
  geom_bar(aes(x = sample.id, y = prop_ann_per_sample,fill = annotation_main),stat = "identity",position = "dodge") +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG"))+annotation_main, scales = "free")+
  scale_fill_manual("Cell Population",values = pal)+
  theme_classic()+
  RotatedAxis()+
  xlab("Sample ID") + ylab("% population in sample")
g
ggsave(filename = paste0(outdir,i,"_ann_main_comp_prop_barplots_by_sample_by_progress_ann_V2.pdf"),plot = g, width = 12,height = 12)
  
}

```

#### proportion of ann_main in its corresponding compartment for immune cells

```{r}
prop_ann_main_comp_batch_imm <- full_join(
  x = immune_cell_meta %>% group_by(compartment,sample.id,batch_ID,annotation_main,cell_type_V2) %>% summarise(ann_size = n()),
  y = immune_cell_meta %>% group_by(sample.id,batch_ID) %>% summarise(sample_size = n()),
  by = c("sample.id","batch_ID")) %>%
  mutate(prop_ann_per_sample = ann_size*100 /sample_size ) 
prop_ann_main_comp_progress_imm <- full_join(
  x = immune_cell_meta %>% group_by(compartment,sample.id,progress,annotation_main,cell_type_V2) %>% summarise(ann_size = n()),
  y = immune_cell_meta %>% group_by(sample.id,progress) %>% summarise(sample_size = n()),
  by = c("sample.id","progress")) %>%
  mutate(prop_ann_per_sample = ann_size*100 /sample_size )
```

```{r}
g <- ggplot(prop_ann_main_comp_batch_imm) +
  geom_bar(aes(x = sample.id, y = prop_ann_per_sample,fill = annotation_main),stat = "identity",position = "dodge") +
  facet_wrap(~batch_ID+annotation_main, scales = "free")+
  scale_fill_manual("Cell Population",values = pal)+
  theme_classic()+
  RotatedAxis()+
  xlab("Sample ID") + ylab("% population in sample")+theme(strip.text = element_text(size=6))
g
ggsave(filename = paste0(outdir,"imm_ann_main_comp_prop_barplots_by_sample_ann_V2.pdf"),plot = g, width = 12,height = 12)

# by sample barplot
g <- ggplot(prop_ann_main_comp_progress_imm) +
  geom_bar(aes(x = sample.id, y = prop_ann_per_sample,fill = annotation_main),stat = "identity",position = "dodge") +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG"))+annotation_main, scales = "free")+
  scale_fill_manual("Cell Population",values = pal)+
  theme_classic()+
  RotatedAxis()+
  xlab("Sample ID") + ylab("% population in sample") +theme(strip.text = element_text(size=6))
g
ggsave(filename = paste0(outdir,"imm_ann_main_comp_prop_barplots_by_sample_by_progress_ann_V2.pdf"),plot = g, width = 12,height = 12)
```
### group by stages with NT tumors

#### proportion of ann_main in its corresponding compartment for non-immune cells

```{r}
ann_main_table <- full_join(
  x = all_compartment_meta %>% group_by(annotation_main,progress,compartment,cell_type_V2) %>% summarise(CT_size = n()),
  y = all_compartment_meta %>% group_by(progress,compartment) %>% summarise(progress_size = n()),
  by = c("progress","compartment")) %>%
  mutate(prop_pop_per_stage = CT_size*100 /progress_size ) %>%
  mutate(labels = scales::percent(CT_size /progress_size)) %>% filter(compartment != "Immune")
```


```{r}

compartment_list <- unique(ann_main_table$compartment) 
for (i in compartment_list){
  
g <- ggplot(ann_main_table %>% filter(compartment == i)) +
  geom_bar(aes(x = factor(progress,levels = c("No tumor","LGG","HGG")), y = prop_pop_per_stage,fill = annotation_main),stat = "identity",position = "dodge") +
  scale_fill_manual("Cell Population",values = pal)+
  facet_wrap(~compartment+annotation_main,scales = "free")+
  theme_classic()+
  RotatedAxis()+
  xlab("Stage")+
  ylab("% in compartent in samples from the same stage")
g
ggsave(filename = paste0(outdir,i,"_cell_pop_prop_barplots_by_progress_by_comp_ann_V2.pdf"),plot = g, width = 10,height = 10)
}



```

#### pie chart of ann main in CT of non-immune cells

```{r}
ann_main_table <- full_join(
  x = all_compartment_meta %>% group_by(annotation_main,progress,compartment,cell_type_V2) %>% summarise(CT_size = n()),
  y = all_compartment_meta %>% group_by(progress,compartment,cell_type_V2) %>% summarise(progress_size = n()),
  by = c("progress","compartment","cell_type_V2")) %>%
  mutate(prop_pop_per_stage = CT_size*100 /progress_size ) %>%
  mutate(labels = scales::percent(CT_size /progress_size)) %>% filter(compartment != "Immune")
```

```{r}
compartment_list <- unique(ann_main_table$compartment) 
for (i in compartment_list){
g <- ggplot(ann_main_table %>% filter(compartment == i) , aes(x = "", y = prop_pop_per_stage, fill = annotation_main)) +
  geom_col(color = "black") +
  ggrepel::geom_label_repel(aes(label = labels),color = "white",
            position = position_stack(vjust = 0.5),
            show.legend = FALSE,max.overlaps = 15) +
  guides(fill = guide_legend(title = "Cell Population",ncol = 2)) +
  scale_fill_manual(values = pal) +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG"))+cell_type_V2) +
  coord_polar(theta = "y") +
  theme_void()
g
ggsave(filename = paste0(outdir,i,"_cell_pop_prop_piechart_by_progress_by_comp_ann_V2.pdf"),plot = g, width = 10,height = 10)
}
```




#### proportion of ann_main in its corresponding compartment for non-immune cells


```{r}
ann_main_table_imm <- full_join(
  x = immune_cell_meta %>% group_by(annotation_main,progress,compartment,cell_type_V2) %>% summarise(CT_size = n()),
  y = immune_cell_meta %>% group_by(progress,compartment) %>% summarise(progress_size = n()),
  by = c("progress","compartment")) %>%
  mutate(prop_pop_per_stage = CT_size*100 /progress_size ) %>%
  mutate(labels = scales::percent(CT_size /progress_size))
```


```{r}
g <- ggplot(ann_main_table_imm) +
  geom_bar(aes(x = factor(progress,levels = c("No tumor","LGG","HGG")), y = prop_pop_per_stage,fill = annotation_main),stat = "identity",position = "dodge") +
  scale_fill_manual("Cell Population",values = pal)+
  facet_wrap(~compartment+annotation_main,scales = "free")+
  theme_classic()+
  RotatedAxis()+
  xlab("Stage")+
  ylab("% in compartment in samples from the same stage")
g
ggsave(filename = paste0(outdir,"imm_cell_pop_prop_barplots_by_progress_by_comp_ann_V2.pdf"),plot = g, width = 10,height = 10)
```

#### pie chart of ann main in CT of immune cells

```{r}
ann_main_table_imm <- full_join(
  x = all_compartment_meta %>% group_by(annotation_main,progress,compartment,cell_type_V2) %>% summarise(CT_size = n()),
  y = all_compartment_meta %>% group_by(progress,compartment,cell_type_V2) %>% summarise(progress_size = n()),
  by = c("progress","compartment","cell_type_V2")) %>%
  mutate(prop_pop_per_stage = CT_size*100 /progress_size ) %>%
  mutate(labels = scales::percent(CT_size /progress_size)) 
```

```{r}
compartment_list <- unique(ann_main_table_imm$compartment) 
for (i in compartment_list){
g <- ggplot(ann_main_table_imm %>% filter(compartment == i) , aes(x = "", y = prop_pop_per_stage, fill = annotation_main)) +
  geom_col(color = "black") +
  ggrepel::geom_label_repel(aes(label = labels),color = "white",
            position = position_stack(vjust = 0.5),
            show.legend = FALSE,max.overlaps = 15) +
  guides(fill = guide_legend(title = "Cell Population",ncol = 2)) +
  scale_fill_manual(values = pal) +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG"))+cell_type_V2) +
  coord_polar(theta = "y") +
  theme_void()
g
ggsave(filename = paste0(outdir,i,"_cell_pop_prop_piechart_by_progress_by_comp_ann_V2.pdf"),plot = g, width = 10,height = 10)
}
```




### group by stages without NT tumors

#### proportion of ann_main in its corresponding compartment for non-immune cells

```{r}
ann_main_table <- full_join(
  x = all_compartment_meta %>% filter(! (progress == "No tumor" & compartment == "Neoplastic" )) %>% group_by(annotation_main,progress,compartment,cell_type_V2) %>% summarise(CT_size = n()),
  y = all_compartment_meta %>% filter(! (progress == "No tumor" & compartment == "Neoplastic" )) %>% group_by(progress,compartment) %>% summarise(progress_size = n()),
  by = c("progress","compartment")) %>%
  mutate(prop_pop_per_stage = CT_size*100 /progress_size ) %>%
  mutate(labels = scales::percent(CT_size /progress_size)) %>% filter(compartment != "Immune")
```


```{r}

compartment_list <- unique(ann_main_table$compartment) 
for (i in compartment_list){
  
g <- ggplot(ann_main_table %>% filter(compartment == i)) +
  geom_bar(aes(x = factor(progress,levels = c("No tumor","LGG","HGG")), y = prop_pop_per_stage,fill = annotation_main),stat = "identity",position = "dodge") +
  scale_fill_manual("Cell Population",values = pal)+
  facet_wrap(~compartment+annotation_main,scales = "free")+
  theme_classic()+
  RotatedAxis()+
  xlab("Stage")+
  ylab("% in compartent in samples from the same stage")
g
ggsave(filename = paste0(outdir,i,"_cell_pop_noNT_prop_barplots_by_progress_by_comp_ann_V2.pdf"),plot = g, width = 10,height = 10)
}



```

#### pie chart of ann main in CT of non-immune cells

```{r}
ann_main_table <- full_join(
  x = all_compartment_meta %>% filter(! (progress == "No tumor" & compartment == "Neoplastic" )) %>% group_by(annotation_main,progress,compartment,cell_type_V2) %>% summarise(CT_size = n()),
  y = all_compartment_meta %>% filter(! (progress == "No tumor" & compartment == "Neoplastic" )) %>% group_by(progress,compartment,cell_type_V2) %>% summarise(progress_size = n()),
  by = c("progress","compartment","cell_type_V2")) %>%
  mutate(prop_pop_per_stage = CT_size*100 /progress_size ) %>%
  mutate(labels = scales::percent(CT_size /progress_size)) %>% filter(compartment != "Immune")
```

```{r}
compartment_list <- unique(ann_main_table$compartment) 
for (i in compartment_list){
g <- ggplot(ann_main_table %>% filter(compartment == i) , aes(x = "", y = prop_pop_per_stage, fill = annotation_main)) +
  geom_col(color = "black") +
  ggrepel::geom_label_repel(aes(label = labels),color = "white",
            position = position_stack(vjust = 0.5),
            show.legend = FALSE,max.overlaps = 15) +
  guides(fill = guide_legend(title = "Cell Population",ncol = 2)) +
  scale_fill_manual(values = pal) +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG"))+cell_type_V2) +
  coord_polar(theta = "y") +
  theme_void()
g
ggsave(filename = paste0(outdir,i,"_cell_pop_noNT_prop_piechart_by_progress_by_comp_ann_V2.pdf"),plot = g, width = 10,height = 10)
}
```




#### proportion of ann_main in its corresponding compartment for non-immune cells


```{r}
ann_main_table_imm <- full_join(
  x = immune_cell_meta %>% group_by(annotation_main,progress,compartment,cell_type_V2) %>% summarise(CT_size = n()),
  y = immune_cell_meta %>% group_by(progress,compartment) %>% summarise(progress_size = n()),
  by = c("progress","compartment")) %>%
  mutate(prop_pop_per_stage = CT_size*100 /progress_size ) %>%
  mutate(labels = scales::percent(CT_size /progress_size))
```


```{r}
g <- ggplot(ann_main_table_imm) +
  geom_bar(aes(x = factor(progress,levels = c("No tumor","LGG","HGG")), y = prop_pop_per_stage,fill = annotation_main),stat = "identity",position = "dodge") +
  scale_fill_manual("Cell Population",values = pal)+
  facet_wrap(~compartment+annotation_main,scales = "free")+
  theme_classic()+
  RotatedAxis()+
  xlab("Stage")+
  ylab("% in compartment in samples from the same stage")
g
ggsave(filename = paste0(outdir,"imm_cell_pop_prop_barplots_by_progress_by_comp_ann_V2.pdf"),plot = g, width = 10,height = 10)
```

#### pie chart of ann main in CT of immune cells

```{r}
ann_main_table_imm <- full_join(
  x = all_compartment_meta %>% group_by(annotation_main,progress,compartment,cell_type_V2) %>% summarise(CT_size = n()),
  y = all_compartment_meta %>% group_by(progress,compartment,cell_type_V2) %>% summarise(progress_size = n()),
  by = c("progress","compartment","cell_type_V2")) %>%
  mutate(prop_pop_per_stage = CT_size*100 /progress_size ) %>%
  mutate(labels = scales::percent(CT_size /progress_size)) 
```

```{r}
compartment_list <- unique(ann_main_table_imm$compartment) 
for (i in compartment_list){
g <- ggplot(ann_main_table_imm %>% filter(compartment == i) , aes(x = "", y = prop_pop_per_stage, fill = annotation_main)) +
  geom_col(color = "black") +
  ggrepel::geom_label_repel(aes(label = labels),color = "white",
            position = position_stack(vjust = 0.5),
            show.legend = FALSE,max.overlaps = 15) +
  guides(fill = guide_legend(title = "Cell Population",ncol = 2)) +
  scale_fill_manual(values = pal) +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG"))+cell_type_V2) +
  coord_polar(theta = "y") +
  theme_void()
g
ggsave(filename = paste0(outdir,i,"_cell_pop_prop_piechart_by_progress_by_comp_ann_V2.pdf"),plot = g, width = 10,height = 10)
}
```


## annotation (subpopulation plots)

```{r}
level <- "annotation_V2"
outdir <- paste0("proportion_plots_V3_alt/",level,"/")
if (!dir.exists(outdir)){
  dir.create(outdir)
}
```

### ann_V2 % comp barplots

#### non-immune cells

```{r}
ann_main_table <- full_join(
  x = all_compartment_meta %>% group_by(annotation_V2,progress,compartment) %>% summarise(CT_size = n()),
  y = all_compartment_meta %>% group_by(progress,compartment) %>% summarise(progress_size = n()),
  by = c("progress","compartment")) %>%
  mutate(prop_pop_per_stage = CT_size*100 /progress_size ) %>%
  mutate(labels = scales::percent(CT_size /progress_size)) %>% filter(compartment != "Immune")
```


```{r}

compartment_list <- unique(ann_main_table$compartment) 
for (i in compartment_list){

g <- ggplot(ann_main_table %>% filter(compartment == i)) +
  geom_bar(aes(x = factor(progress,levels = c("No tumor","LGG","HGG")), y = prop_pop_per_stage,fill = annotation_V2),stat = "identity",position = "dodge") +
  scale_fill_manual("Cell Subpopulation",values = pal)+
  facet_wrap(~compartment+annotation_V2,scales = "free")+
  theme_classic()+
  RotatedAxis()+
  xlab("Stage")+
  ylab("% in compartent in samples from the same stage")+theme(strip.text = element_text(size=6))
g
ggsave(filename = paste0(outdir,i,"_cell_subpop_prop_barplots_by_progress_by_comp_ann_V2.pdf"),plot = g, width = 10,height = 10)
}

```


#### immune cells

```{r}
ann_main_table_imm <- full_join(
  x = immune_cell_meta %>% group_by(annotation_V2,progress,compartment,annotation_main) %>% summarise(CT_size = n()),
  y = immune_cell_meta %>% group_by(progress,compartment) %>% summarise(progress_size = n()),
  by = c("progress","compartment")) %>%
  mutate(prop_pop_per_stage = CT_size*100 /progress_size ) %>%
  mutate(labels = scales::percent(CT_size /progress_size))
```

```{r}
compartment_list <- unique(ann_main_table_imm$compartment) 
for (i in compartment_list){

g <- ggplot(ann_main_table_imm %>% filter(compartment == i)) +
  geom_bar(aes(x = factor(progress,levels = c("No tumor","LGG","HGG")), y = prop_pop_per_stage,fill = annotation_V2),stat = "identity",position = "dodge") +
  scale_fill_manual("Cell Subpopulation",values = pal)+
  facet_wrap(~compartment+annotation_V2,scales = "free")+
  theme_classic()+
  RotatedAxis()+
  xlab("Stage")+
  ylab("% in compartent in samples from the same stage")+theme(strip.text = element_text(size=6))
g
ggsave(filename = paste0(outdir,i,"_cell_subpop_prop_barplots_by_progress_by_comp_ann_V2.pdf"),plot = g, width = 20,height = 15)
}

```

### ann_V2 % ann_main pie charts

#### non-immune

```{r}
ann_main_table <- full_join(
  x = all_compartment_meta %>% group_by(annotation_V2,progress,annotation_main,compartment) %>% summarise(CT_size = n()),
  y = all_compartment_meta %>% group_by(progress,annotation_main) %>% summarise(progress_size = n()),
  by = c("progress","annotation_main")) %>%
  mutate(prop_pop_per_stage = CT_size*100 /progress_size ) %>%
  mutate(labels = scales::percent(CT_size /progress_size)) %>% filter(compartment != "Immune")
```


```{r}

compartment_list <- unique(ann_main_table$compartment) 
for (i in compartment_list){

g <- ggplot(ann_main_table %>% filter(compartment == i) , aes(x = "", y = prop_pop_per_stage, fill = annotation_V2)) +
  geom_col(color = "black") +
  ggrepel::geom_label_repel(aes(label = labels),color = "white",
            position = position_stack(vjust = 0.5),
            show.legend = FALSE,max.overlaps = 15) +
  guides(fill = guide_legend(title = "Cell Subpopulation",ncol = 2)) +
  scale_fill_manual(values = pal) +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG"))+annotation_main) +
  coord_polar(theta = "y") +
  theme_void()
g
ggsave(filename = paste0(outdir,i,"_cell_subpop_prop_barplots_by_progress_by_ann_main_V2.pdf"),plot = g, width = 15,height = 10)
}

```



#### immune cells

```{r}
ann_main_table_imm <- full_join(
  x = immune_cell_meta %>% group_by(annotation_V2,progress,annotation_main,compartment,cell_type_V2) %>% summarise(CT_size = n()),
  y = immune_cell_meta %>% group_by(progress,annotation_main) %>% summarise(progress_size = n()),
  by = c("progress","annotation_main")) %>%
  mutate(prop_pop_per_stage = CT_size*100 /progress_size ) %>%
  mutate(labels = scales::percent(CT_size /progress_size)) 
```


```{r}

CT_list <- unique(ann_main_table_imm$cell_type_V2) 
for (i in CT_list){

g <- ggplot(ann_main_table_imm %>% filter(cell_type_V2 == i) , aes(x = "", y = prop_pop_per_stage, fill = annotation_V2)) +
  geom_col(color = "black") +
  ggrepel::geom_label_repel(aes(label = labels),color = "white",
            position = position_stack(vjust = 0.5),
            show.legend = FALSE,max.overlaps = 15) +
  guides(fill = guide_legend(title = "Cell Subpopulation",ncol = 2)) +
  scale_fill_manual(values = pal) +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG"))+annotation_main) +
  coord_polar(theta = "y") +
  theme_void()
g
ggsave(filename = paste0(outdir,i,"_cell_subpop_prop_barplots_by_progress_by_ann_main_V2.pdf"),plot = g, width = 15,height = 10)
}

```

### sample-wise subpopulation-compartment proportion plots

```{r}
all_compartment_meta <- read.table(file = "data/whole_meta_annotation_V2_alt_all_comp.tsv",sep = "\t",header = T)
immune_cell_meta <- read.table(file = "data/whole_meta_annotation_V2_alt_immune_cells.tsv",sep = "\t",header = T)
```

```{r}
level <- "annotation_V2"
outdir <- paste0("proportion_plots_V3_alt/",level,"/")
if (!dir.exists(outdir)){
  dir.create(outdir)
}
```


#### non-immune cells

```{r}
prop_ann_main_comp_batch <- full_join(
  x = all_compartment_meta %>% group_by(compartment,annotation_V2,sample.id,batch_ID) %>% summarise(ann_size = n()),
  y = all_compartment_meta %>% group_by(sample.id,batch_ID,compartment) %>% summarise(sample_size = n()),
  by = c("sample.id","batch_ID","compartment")) %>%
  mutate(prop_ann_per_sample = ann_size*100 /sample_size ) %>% filter(compartment != "Immune")

prop_ann_main_comp_progress <- full_join(
  x = all_compartment_meta %>% group_by(compartment,annotation_V2,sample.id,progress) %>% summarise(ann_size = n()),
  y = all_compartment_meta %>% group_by(sample.id,progress,compartment) %>% summarise(sample_size = n()),
  by = c("sample.id","progress","compartment")) %>%
  mutate(prop_ann_per_sample = ann_size*100 /sample_size ) %>% filter(compartment != "Immune")
  
```


```{r}
compartment_list <- unique(prop_ann_main_comp_batch$compartment) 
for (i in compartment_list){
  g <- ggplot(prop_ann_main_comp_batch %>% filter(compartment == i)) +
  geom_bar(aes(x = sample.id, y = prop_ann_per_sample,fill = annotation_V2),stat = "identity",position = "dodge") +
  facet_wrap(~batch_ID+annotation_V2, scales = "free")+
  scale_fill_manual("Cell Population",values = pal)+
  theme_classic()+
  RotatedAxis()+
  xlab("Sample ID") + ylab("% population in sample")
g
ggsave(filename = paste0(outdir,i,"_ann_V2_comp_prop_barplots_by_sample_ann_V2.pdf"),plot = g, width = 12,height = 12)

# by sample barplot
g <- ggplot(prop_ann_main_comp_progress %>% filter(compartment == i)) +
  geom_bar(aes(x = sample.id, y = prop_ann_per_sample,fill = annotation_V2),stat = "identity",position = "dodge") +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG"))+annotation_V2, scales = "free")+
  scale_fill_manual("Cell Population",values = pal)+
  theme_classic()+
  RotatedAxis()+
  xlab("Sample ID") + ylab("% population in sample")
g
ggsave(filename = paste0(outdir,i,"_ann_V2_comp_prop_barplots_by_sample_by_progress_ann_V2.pdf"),plot = g, width = 12,height = 12)
  
}


```


### immune cells

```{r}
prop_ann_main_comp_batch_imm <- full_join(
  x = immune_cell_meta %>% group_by(compartment,sample.id,batch_ID,annotation_main,annotation_V2) %>% summarise(ann_size = n()),
  y = immune_cell_meta %>% group_by(sample.id,batch_ID,compartment) %>% summarise(sample_size = n()),
  by = c("sample.id","batch_ID","compartment")) %>%
  mutate(prop_ann_per_sample = ann_size*100 /sample_size ) 
prop_ann_main_comp_progress_imm <- full_join(
  x = immune_cell_meta %>% group_by(compartment,sample.id,progress,annotation_main,annotation_V2) %>% summarise(ann_size = n()),
  y = immune_cell_meta %>% group_by(sample.id,progress,compartment) %>% summarise(sample_size = n()),
  by = c("sample.id","progress","compartment")) %>%
  mutate(prop_ann_per_sample = ann_size*100 /sample_size )
```

```{r}
g <- ggplot(prop_ann_main_comp_batch_imm) +
  geom_bar(aes(x = sample.id, y = prop_ann_per_sample,fill = annotation_main),stat = "identity",position = "dodge") +
  facet_wrap(~batch_ID+annotation_V2, scales = "free")+
  scale_fill_manual("Cell Population",values = pal)+
  theme_classic()+
  RotatedAxis()+
  xlab("Sample ID") + ylab("% population in sample")+theme(strip.text = element_text(size=6))
g
ggsave(filename = paste0(outdir,"imm_ann_V2_comp_prop_barplots_by_sample_ann_V2.pdf"),plot = g, width = 12,height = 12)

# by sample barplot
g <- ggplot(prop_ann_main_comp_progress_imm) +
  geom_bar(aes(x = sample.id, y = prop_ann_per_sample,fill = annotation_main),stat = "identity",position = "dodge") +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG"))+annotation_V2, scales = "free")+
  scale_fill_manual("Cell Population",values = pal)+
  theme_classic()+
  RotatedAxis()+
  xlab("Sample ID") + ylab("% population in sample") +theme(strip.text = element_text(size=6))
g
ggsave(filename = paste0(outdir,"imm_ann_V2_comp_prop_barplots_by_sample_by_progress_ann_V2.pdf"),plot = g, width = 12,height = 12)
```

## annotation (subpopulation plots) with NT tumor removed

```{r}
level <- "annotation_V2"
outdir <- paste0("proportion_plots_V3_alt/",level,"/")
if (!dir.exists(outdir)){
  dir.create(outdir)
}
```

### ann_V2 % comp barplots

#### non-immune cells

```{r}
ann_main_table <- full_join(
  x = all_compartment_meta %>% filter(! (progress == "No tumor" & compartment == "Neoplastic" )) %>% group_by(annotation_V2,progress,compartment) %>% summarise(CT_size = n()),
  y = all_compartment_meta %>% filter(! (progress == "No tumor" & compartment == "Neoplastic" )) %>% group_by(progress,compartment) %>% summarise(progress_size = n()),
  by = c("progress","compartment")) %>%
  mutate(prop_pop_per_stage = CT_size*100 /progress_size ) %>%
  mutate(labels = scales::percent(CT_size /progress_size)) %>% filter(compartment != "Immune")
```


```{r}

compartment_list <- unique(ann_main_table$compartment) 
for (i in compartment_list){

g <- ggplot(ann_main_table %>% filter(compartment == i)) +
  geom_bar(aes(x = factor(progress,levels = c("No tumor","LGG","HGG")), y = prop_pop_per_stage,fill = annotation_V2),stat = "identity",position = "dodge") +
  scale_fill_manual("Cell Subpopulation",values = pal)+
  facet_wrap(~compartment+annotation_V2,scales = "free")+
  theme_classic()+
  RotatedAxis()+
  xlab("Stage")+
  ylab("% in compartent in samples from the same stage")+theme(strip.text = element_text(size=6))
g
ggsave(filename = paste0(outdir,i,"_cell_subpop_noNTt_prop_barplots_by_progress_by_comp_ann_V2.pdf"),plot = g, width = 10,height = 10)
}

```


#### immune cells

```{r}
ann_main_table_imm <- full_join(
  x = immune_cell_meta %>% group_by(annotation_V2,progress,compartment,annotation_main) %>% summarise(CT_size = n()),
  y = immune_cell_meta %>% group_by(progress,compartment) %>% summarise(progress_size = n()),
  by = c("progress","compartment")) %>%
  mutate(prop_pop_per_stage = CT_size*100 /progress_size ) %>%
  mutate(labels = scales::percent(CT_size /progress_size))
```

```{r}
compartment_list <- unique(ann_main_table_imm$compartment) 
for (i in compartment_list){

g <- ggplot(ann_main_table_imm %>% filter(compartment == i)) +
  geom_bar(aes(x = factor(progress,levels = c("No tumor","LGG","HGG")), y = prop_pop_per_stage,fill = annotation_V2),stat = "identity",position = "dodge") +
  scale_fill_manual("Cell Subpopulation",values = pal)+
  facet_wrap(~compartment+annotation_V2,scales = "free")+
  theme_classic()+
  RotatedAxis()+
  xlab("Stage")+
  ylab("% in compartent in samples from the same stage")+theme(strip.text = element_text(size=6))
g
ggsave(filename = paste0(outdir,i,"_cell_subpop_prop_barplots_by_progress_by_comp_ann_V2.pdf"),plot = g, width = 20,height = 15)
}

```

### ann_V2 % ann_main pie charts

#### non-immune

```{r}
ann_main_table <- full_join(
  x = all_compartment_meta %>% filter(! (progress == "No tumor" & compartment == "Neoplastic" )) %>% group_by(annotation_V2,progress,annotation_main,compartment) %>% summarise(CT_size = n()),
  y = all_compartment_meta %>% filter(! (progress == "No tumor" & compartment == "Neoplastic" )) %>% group_by(progress,annotation_main) %>% summarise(progress_size = n()),
  by = c("progress","annotation_main")) %>%
  mutate(prop_pop_per_stage = CT_size*100 /progress_size ) %>%
  mutate(labels = scales::percent(CT_size /progress_size)) %>% filter(compartment != "Immune")
```


```{r}

compartment_list <- unique(ann_main_table$compartment) 
for (i in compartment_list){

g <- ggplot(ann_main_table %>% filter(compartment == i) , aes(x = "", y = prop_pop_per_stage, fill = annotation_V2)) +
  geom_col(color = "black") +
  ggrepel::geom_label_repel(aes(label = labels),color = "white",
            position = position_stack(vjust = 0.5),
            show.legend = FALSE,max.overlaps = 15) +
  guides(fill = guide_legend(title = "Cell Subpopulation",ncol = 2)) +
  scale_fill_manual(values = pal) +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG"))+annotation_main) +
  coord_polar(theta = "y") +
  theme_void()
g
ggsave(filename = paste0(outdir,i,"_cell_subpop_noNTt_prop_barplots_by_progress_by_ann_main_V2.pdf"),plot = g, width = 15,height = 10)
}

```



#### immune cells

```{r}
ann_main_table_imm <- full_join(
  x = immune_cell_meta %>% group_by(annotation_V2,progress,annotation_main,compartment,cell_type_V2) %>% summarise(CT_size = n()),
  y = immune_cell_meta %>% group_by(progress,annotation_main) %>% summarise(progress_size = n()),
  by = c("progress","annotation_main")) %>%
  mutate(prop_pop_per_stage = CT_size*100 /progress_size ) %>%
  mutate(labels = scales::percent(CT_size /progress_size)) 
```


```{r}

CT_list <- unique(ann_main_table_imm$cell_type_V2) 
for (i in CT_list){

g <- ggplot(ann_main_table_imm %>% filter(cell_type_V2 == i) , aes(x = "", y = prop_pop_per_stage, fill = annotation_V2)) +
  geom_col(color = "black") +
  ggrepel::geom_label_repel(aes(label = labels),color = "white",
            position = position_stack(vjust = 0.5),
            show.legend = FALSE,max.overlaps = 15) +
  guides(fill = guide_legend(title = "Cell Subpopulation",ncol = 2)) +
  scale_fill_manual(values = pal) +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG"))+annotation_main) +
  coord_polar(theta = "y") +
  theme_void()
g
ggsave(filename = paste0(outdir,i,"_cell_subpop_prop_barplots_by_progress_by_ann_main_V2.pdf"),plot = g, width = 15,height = 10)
}

```

### sample-wise subpopulation-compartment proportion plots

```{r}
all_compartment_meta <- read.table(file = "data/whole_meta_annotation_V2_alt_all_comp.tsv",sep = "\t",header = T)
immune_cell_meta <- read.table(file = "data/whole_meta_annotation_V2_alt_immune_cells.tsv",sep = "\t",header = T)
```

```{r}
level <- "annotation_V2"
outdir <- paste0("proportion_plots_V3_alt/",level,"/")
if (!dir.exists(outdir)){
  dir.create(outdir)
}
```


#### non-immune cells

```{r}
prop_ann_main_comp_batch <- full_join(
  x = all_compartment_meta %>% filter(! (progress == "No tumor" & compartment == "Neoplastic" )) %>% group_by(compartment,annotation_V2,sample.id,batch_ID) %>% summarise(ann_size = n()),
  y = all_compartment_meta %>% filter(! (progress == "No tumor" & compartment == "Neoplastic" )) %>% group_by(sample.id,batch_ID,compartment) %>% summarise(sample_size = n()),
  by = c("sample.id","batch_ID","compartment")) %>%
  mutate(prop_ann_per_sample = ann_size*100 /sample_size ) %>% filter(compartment != "Immune")

prop_ann_main_comp_progress <- full_join(
  x = all_compartment_meta %>% filter(! (progress == "No tumor" & compartment == "Neoplastic" )) %>% group_by(compartment,annotation_V2,sample.id,progress) %>% summarise(ann_size = n()),
  y = all_compartment_meta %>% group_by(sample.id,progress,compartment) %>% summarise(sample_size = n()),
  by = c("sample.id","progress","compartment")) %>%
  mutate(prop_ann_per_sample = ann_size*100 /sample_size ) %>% filter(compartment != "Immune")
  
```


```{r}
compartment_list <- unique(prop_ann_main_comp_batch$compartment) 
for (i in compartment_list){
  g <- ggplot(prop_ann_main_comp_batch %>% filter(compartment == i)) +
  geom_bar(aes(x = sample.id, y = prop_ann_per_sample,fill = annotation_V2),stat = "identity",position = "dodge") +
  facet_wrap(~batch_ID+annotation_V2, scales = "free")+
  scale_fill_manual("Cell Population",values = pal)+
  theme_classic()+
  RotatedAxis()+
  xlab("Sample ID") + ylab("% population in sample")
g
ggsave(filename = paste0(outdir,i,"_ann_V2_comp_noNTt_prop_barplots_by_sample_ann_V2.pdf"),plot = g, width = 12,height = 12)

# by sample barplot
g <- ggplot(prop_ann_main_comp_progress %>% filter(compartment == i)) +
  geom_bar(aes(x = sample.id, y = prop_ann_per_sample,fill = annotation_V2),stat = "identity",position = "dodge") +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG"))+annotation_V2, scales = "free")+
  scale_fill_manual("Cell Population",values = pal)+
  theme_classic()+
  RotatedAxis()+
  xlab("Sample ID") + ylab("% population in sample")
g
ggsave(filename = paste0(outdir,i,"_ann_V2_comp_noNTt_prop_barplots_by_sample_by_progress_ann_V2.pdf"),plot = g, width = 12,height = 12)
  
}


```


### immune cells

```{r}
prop_ann_main_comp_batch_imm <- full_join(
  x = immune_cell_meta %>% group_by(compartment,sample.id,batch_ID,annotation_main,annotation_V2) %>% summarise(ann_size = n()),
  y = immune_cell_meta %>% group_by(sample.id,batch_ID,compartment) %>% summarise(sample_size = n()),
  by = c("sample.id","batch_ID","compartment")) %>%
  mutate(prop_ann_per_sample = ann_size*100 /sample_size ) 
prop_ann_main_comp_progress_imm <- full_join(
  x = immune_cell_meta %>% group_by(compartment,sample.id,progress,annotation_main,annotation_V2) %>% summarise(ann_size = n()),
  y = immune_cell_meta %>% group_by(sample.id,progress,compartment) %>% summarise(sample_size = n()),
  by = c("sample.id","progress","compartment")) %>%
  mutate(prop_ann_per_sample = ann_size*100 /sample_size )
```

```{r}
g <- ggplot(prop_ann_main_comp_batch_imm) +
  geom_bar(aes(x = sample.id, y = prop_ann_per_sample,fill = annotation_main),stat = "identity",position = "dodge") +
  facet_wrap(~batch_ID+annotation_V2, scales = "free")+
  scale_fill_manual("Cell Population",values = pal)+
  theme_classic()+
  RotatedAxis()+
  xlab("Sample ID") + ylab("% population in sample")+theme(strip.text = element_text(size=6))
g
ggsave(filename = paste0(outdir,"imm_ann_V2_comp_prop_barplots_by_sample_ann_V2.pdf"),plot = g, width = 12,height = 12)

# by sample barplot
g <- ggplot(prop_ann_main_comp_progress_imm) +
  geom_bar(aes(x = sample.id, y = prop_ann_per_sample,fill = annotation_main),stat = "identity",position = "dodge") +
  facet_wrap(~factor(progress,levels = c("No tumor","LGG","HGG"))+annotation_V2, scales = "free")+
  scale_fill_manual("Cell Population",values = pal)+
  theme_classic()+
  RotatedAxis()+
  xlab("Sample ID") + ylab("% population in sample") +theme(strip.text = element_text(size=6))
g
ggsave(filename = paste0(outdir,"imm_ann_V2_comp_prop_barplots_by_sample_by_progress_ann_V2.pdf"),plot = g, width = 12,height = 12)
```



