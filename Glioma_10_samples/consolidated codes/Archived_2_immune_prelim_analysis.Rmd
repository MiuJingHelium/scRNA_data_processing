---
title: "Immune cell preliminary analysis"
output: html_document
date: "2024-03-30"
---
This markdown file contains codes downstream of the the subset creation. V2p# immune cell subsets (microglia, myeloid, lymphoid) were created.

```{r}
library(tidyverse)
library(Seurat)
library(harmony)
```

```{r}
rds_in <- "data/"
rds_out <- "data/"
```

# loading dataset

At one stage, I tried merging smaller immune cell clusters from other subsets back to the immune cell compartment, but later it added complexity to subset creation, In addition, these small clusters are indeed very small. I decided to not worry about them, and proceed with the immune cell cluster I obtained from the whole dataset. The results of the previous attempt were stored in data/imm_V2_orev/

```{r}
#load(paste0(rds_out,"GBM_RNA_10_resident_V1_imm_small.Robj"))
load(paste0(rds_out,"GBM_RNA_10_imm_V1.Robj"))
#load(paste0(rds_out,"GBM_RNA_10_vascular_V2_imm_small.Robj"))
```

```{r}
#Immune_cells <- merge(x = Immune_cells,y = c(imm_small,imm_small_vas))
```

# process

## first iteration
```{r}
Immune_cells <- NormalizeData(Immune_cells,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
Immune_cells <- FindVariableFeatures(object = Immune_cells, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(Immune_cells) <-  VariableFeatures(Immune_cells) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(Immune_cells))]
VariableFeaturePlot(Immune_cells,selection.method = "mean.var.plot")

Immune_cells <- ScaleData(object = Immune_cells, features = VariableFeatures(object = Immune_cells), vars.to.regress = c("nCount_RNA", "percent.mt"))
Immune_cells <- RunPCA(object = Immune_cells,
                features =  VariableFeatures(object = Immune_cells),
                dims = 1:50)
gc()

ElbowPlot(Immune_cells,ndims = 50)
```

```{r}
Immune_cells <- RunHarmony(object = Immune_cells, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
Immune_cells <- RunUMAP(Immune_cells,dims = 1:30,reduction = "harmony")
Immune_cells <- RunTSNE(Immune_cells,dims = 1:30,reduction = "harmony")

Immune_cells <- FindNeighbors(Immune_cells, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  Immune_cells <- FindClusters(object = Immune_cells, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
```

```{r}
Immune_cells <- JoinLayers(Immune_cells)
```

```{r}
table(Immune_cells$annotation_prelim)
```


```{r}
save(Immune_cells,file = paste0(rds_out,"GBM_RNA_10_imm_V2.Robj"))
```

```{r}
DimPlot(Immune_cells,reduction = "tsne",group.by = "orig.ident",shuffle = T)
DimPlot(Immune_cells,reduction = "umap",group.by = "orig.ident",shuffle = T)
DimPlot(Immune_cells,reduction = "umap",group.by = "RNA_snn_res.0.1",label = T)
DimPlot(Immune_cells,reduction = "umap",group.by = "RNA_snn_res.1",label = T)
```

```{r}
Idents(Immune_cells) <- Immune_cells$RNA_snn_res.1
DotPlot(Immune_cells,features = c("Aqp4","Sox9","Sox10","Olig2","Pdgfra","Gad2","Sox2","Nes","Igfbp7","Myct1","Col5a2","Dlc1","Pdgfrb","Vtn","Anpep","Acta2","Mki67","Pecam1","Ptprc"),cluster.idents = T) + RotatedAxis()
DotPlot(Immune_cells,features = c("Mki67","Ptprc","P2ry12","Tmem119","Cd79a","Adgre1","Ly6c2","Ms4a7","Ccr2","Mertk","Cd3e","Cd4","Foxp3","Cd8a","Tyrobp","Ncr1","Klrb1c","S100a9","Ly6g","Cpa3","Flt3","Irf8","Xcr1","Siglech","Sirpa","Cd74","H2-Ab1","Anpep"),cluster.idents = T) + RotatedAxis()
```
```{r}
Idents(Immune_cells) <- Immune_cells$RNA_snn_res.0.1
DotPlot(Immune_cells,features = c("Mki67","Ptprc","P2ry12","Tmem119","Cd3e","Cd79a","Adgre1","Ly6c2","Ms4a7","Ccr2","Mertk","Cd4","Foxp3","Cd8a","Tyrobp","Ncr1","Klrb1c","S100a9","Ly6g","Cpa3","Flt3","Irf8","Xcr1","Siglech","Sirpa","Cd74","H2-Ab1","Anpep"),cluster.idents = T) + RotatedAxis()
```


```{r}
Idents(Immune_cells) <- Immune_cells$RNA_snn_res.0.6
DotPlot(Immune_cells,features = c("Mki67","Ptprc","P2ry12","Tmem119","Cd79a","Adgre1","Ly6c2","Ms4a7","Ccr2","Mertk","Cd3e","Cd4","Foxp3","Cd8a","Tyrobp","Ncr1","Klrb1c","S100a9","Ly6g","Cpa3","Flt3","Irf8","Xcr1","Siglech","Sirpa","Cd74","H2-Ab1","Anpep"),cluster.idents = T) + RotatedAxis()
DimPlot(Immune_cells,reduction = "umap",group.by = "RNA_snn_res.0.6",label = T)
```
```{r}
Immune_cells@meta.data <- Immune_cells@meta.data %>%
  mutate(annotation_V1 = case_match(
    as.character(RNA_snn_res.0.6),
    "0" ~ "microglia_1",
    "1" ~ "microglia_2",
    "2" ~ "microglia_3",
    "3" ~ "microglia_4",
    "4" ~ "microglia_",
    "5" ~ "T_cells",
    "6" ~ "mono_mac_1",
    "7" ~ "mono_mac_2",
    "8" ~ "microglia_5",
    "9" ~ "proliferating",
    "10" ~ "NK_NKT",
    "11" ~ "cDC1",
    "12" ~ "B_cells",
    "13" ~ "mono_mac_3",
    "14" ~ "pDC",
    "15" ~ "cDC2"
  ),
  compartment = rep("immune_cells",nrow(Immune_cells@meta.data)))
```


```{r}
save(Immune_cells,file = paste0(rds_out,"GBM_RNA_10_imm_V2.Robj"))
```


```{r}
Idents(Immune_cells) <- Immune_cells$RNA_snn_res.0.1
DotPlot(Immune_cells,features = c("Mki67","Ptprc","P2ry12","Cd3e","Cd19","Adgre1","Ly6c2","Cd4","Cd8a","Tyrobp","Cd200r3","Flt3","Aqp4","Sox9","Sox10","Olig2","Pdgfra","Gad2","Sox2","Nes","Igfbp7","Pecam1","Myct1","Col5a2","Dlc1","Pdgfrb","Vtn","Anpep","Acta2"),cluster.idents = T) + RotatedAxis()
```
c5 and c7 at resolution = 0.1 or c16-18, c20, and c22 are satellites that show co-expression of immune cell markers and stromal cell markers. I think those are doublets because I don't see why microglia should have signature of vascular and brain-resident cell signatures at such low number. They are also distinct clusters at low resolution.

```{r}
Idents(Immune_cells) <- Immune_cells$RNA_snn_res.1
```

```{r}
Immune_cells <- subset(Immune_cells,idents = c(0:22)[!(c(0:22) %in% c(16:18,20,22))])
```

```{r}
save(Immune_cells,file = paste0(rds_out,"GBM_RNA_10_imm_V2p1.Robj"))
```

## second iteration



```{r}
Immune_cells <- NormalizeData(Immune_cells,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
Immune_cells <- FindVariableFeatures(object = Immune_cells, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(Immune_cells) <-  VariableFeatures(Immune_cells) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(Immune_cells))]
VariableFeaturePlot(Immune_cells,selection.method = "mean.var.plot")

Immune_cells <- ScaleData(object = Immune_cells, features = VariableFeatures(object = Immune_cells), vars.to.regress = c("nCount_RNA", "percent.mt"))
Immune_cells <- RunPCA(object = Immune_cells,
                features =  VariableFeatures(object = Immune_cells),
                dims = 1:50)
gc()

ElbowPlot(Immune_cells,ndims = 50)

```

```{r}
Immune_cells <- RunHarmony(object = Immune_cells, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
Immune_cells <- RunUMAP(Immune_cells,dims = 1:30,reduction = "harmony")
Immune_cells <- RunTSNE(Immune_cells,dims = 1:30,reduction = "harmony")

Immune_cells <- FindNeighbors(Immune_cells, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  Immune_cells <- FindClusters(object = Immune_cells, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
```

```{r}
save(Immune_cells,file = paste0(rds_out,"GBM_RNA_10_imm_V2p1.Robj"))
```

```{r}
DimPlot(Immune_cells,reduction = "tsne",group.by = "orig.ident",shuffle = T)
DimPlot(Immune_cells,reduction = "umap",group.by = "orig.ident",shuffle = T)
DimPlot(Immune_cells,reduction = "umap",group.by = "RNA_snn_res.0.1",label = T)
DimPlot(Immune_cells,reduction = "umap",group.by = "RNA_snn_res.1",label = T)
```
```{r}
DimPlot(Immune_cells,reduction = "umap",group.by = "RNA_snn_res.0.9",label = T)
```


```{r}
Idents(Immune_cells) <- Immune_cells$RNA_snn_res.0.1
DotPlot(Immune_cells,features = c("Mki67","Ptprc","P2ry12","Sall1","Cd3e","Cd19","Adgre1","Ccr2","Mertk","Cd44","Siglec1","Ly6c2","Cd4","Cd8a","Tyrobp","Cd200r3","Flt3","Aqp4","Sox9","Sox10","Olig2","Pdgfra","Gad2","Sox2","Nes","Igfbp7","Pecam1","Myct1","Col5a2","Dlc1","Pdgfrb","Vtn","Anpep","Acta2"),cluster.idents = T) + RotatedAxis()
```

```{r}
Idents(Immune_cells) <- Immune_cells$RNA_snn_res.1
DotPlot(Immune_cells,features = c("Mki67","Ptprc","P2ry12","Sall1","Cd3e","Cd19","Adgre1","Cd44","Siglec1","Ly6c2","Cd4","Cd8a","Tyrobp","Klrb1c","Cd200r3","Flt3","Aqp4","Sox9","Sox10","Olig2","Pdgfra","Gad2","Sox2","Nes","Igfbp7","Pecam1","Myct1","Col5a2","Dlc1","Pdgfrb","Vtn","Anpep"),cluster.idents = T) + RotatedAxis()
```

```{r}
Idents(Immune_cells) <- Immune_cells$RNA_snn_res.1
g <- DotPlot(Immune_cells,features = c("Mki67","Ptprc","P2ry12","Sall1","C1qa","Cx3cr1","Trem2","Adgre1","Cd44","Siglec1","Ccr2","Mertk","Lyz2","Ly6c2","Itgam","Itgax","Cd19","Cd200r3","Flt3","Sirpa","Xcr1","Siglech","Cd3e","Cd4","Cd8a","Tyrobp","Klrb1c","Pecam1","Anpep"),cluster.idents = T) + RotatedAxis()
ggsave(filename = "immune_ann_sorted.pdf",plot = g, height = 7, width = 15)
```



```{r}
FeaturePlot(Immune_cells,features = c("Cd3e"),label = T)
FeaturePlot(Immune_cells,features = c("Cd79a"),label = T)
FeaturePlot(Immune_cells,features = c("Flt3"),label = T)
FeaturePlot(Immune_cells,features = c("P2ry12"),label = T)
FeaturePlot(Immune_cells,features = c("Cd4"),label = T)
FeaturePlot(Immune_cells,features = c("Cd8a"),label = T)
FeaturePlot(Immune_cells,features = c("Cd200r3"),label = T)
FeaturePlot(Immune_cells,features = c("Siglech"),label = T)
FeaturePlot(Immune_cells,features = c("Xcr1"),label = T)
FeaturePlot(Immune_cells,features = c("Sirpa"),label = T)
```

```{r}
FeaturePlot(Immune_cells,features = c("Klrb1c"),label = T)
FeaturePlot(Immune_cells,features = c("Xcl1"),label = T)
FeaturePlot(Immune_cells,features = c("Tyrobp"),label = T)
FeaturePlot(Immune_cells,features = c("Ncr1"),label = T)
```
```{r}
Idents(Immune_cells) <- Immune_cells$RNA_snn_res.1
FeaturePlot(Immune_cells,features = c("Sall1"),label = T)
FeaturePlot(Immune_cells,features = c("Cd44"),label = T)
FeaturePlot(Immune_cells,features = c("Ccr2"),label = T)
FeaturePlot(Immune_cells,features = c("Lyz2"),label = T)
```
```{r}
FeaturePlot(Immune_cells,features = c("nCount_RNA_log10"),label = T,label.size = 1)
FeaturePlot(Immune_cells,features = c("percent.mt"),label = T,label.size = 1)
FeaturePlot(Immune_cells,features = c("nFeature_RNA_log10"),label = T,label.size = 1)
FeaturePlot(Immune_cells,features = c("nCount_RNA"),label = T,label.size = 1)
FeaturePlot(Immune_cells,features = c("nFeature_RNA"),label = T,label.size = 1)
```


Need sub-division for fully annotated version. Create compartment labels for cells of different lineages.
e.g. microglia, myeloids, lymohoids. Currently, the distinction between microglia and macrophages is still a bit ambiguous, so I'll divide by lymphoid and non-lymphoid and then isolate microgalia from non-lymphoid.

```{r}
Immune_cells <- JoinLayers(Immune_cells)
```


```{r}
lymphoid_brain <- subset(Immune_cells,idents = c(6,11,13))
```

```{r}
myeloid_brain <- subset(Immune_cells,idents = c(17,10,15,8,7))
microglia <- subset(Immune_cells,idents = c(5,9,12,4,1,16,3,2,0,14))
```


```{r}
save(lymphoid_brain,file = paste0(rds_out,"GBM_RNA_10_lymphoid_V2p1.Robj"))
save(myeloid_brain,file = paste0(rds_out,"GBM_RNA_10_myeloid_V2p1.Robj"))
save(microglia,file = paste0(rds_out,"GBM_RNA_10_microglia_V2p1.Robj"))
```

# process subsets

## first iteration

### lymphoid

```{r}
lymphoid_brain <- NormalizeData(lymphoid_brain,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
lymphoid_brain <- FindVariableFeatures(object = lymphoid_brain, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(lymphoid_brain) <-  VariableFeatures(lymphoid_brain) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(lymphoid_brain))]
VariableFeaturePlot(lymphoid_brain,selection.method = "mean.var.plot")

lymphoid_brain <- ScaleData(object = lymphoid_brain, features = VariableFeatures(object = lymphoid_brain), vars.to.regress = c("nCount_RNA", "percent.mt"))
lymphoid_brain <- RunPCA(object = lymphoid_brain,
                features =  VariableFeatures(object = lymphoid_brain),
                dims = 1:50)
gc()

ElbowPlot(lymphoid_brain,ndims = 50)
```

```{r}
lymphoid_brain <- RunHarmony(object = lymphoid_brain, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
lymphoid_brain <- RunUMAP(lymphoid_brain,dims = 1:30,reduction = "harmony")
lymphoid_brain <- RunTSNE(lymphoid_brain,dims = 1:30,reduction = "harmony")

lymphoid_brain <- FindNeighbors(lymphoid_brain, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  lymphoid_brain <- FindClusters(object = lymphoid_brain, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
```


```{r}
DimPlot(lymphoid_brain,reduction = "tsne",group.by = "orig.ident",shuffle = T)
DimPlot(lymphoid_brain,reduction = "umap",group.by = "orig.ident",shuffle = T)
DimPlot(lymphoid_brain,reduction = "umap",group.by = "RNA_snn_res.0.1",label = T)
DimPlot(lymphoid_brain,reduction = "umap",group.by = "RNA_snn_res.1",label = T)
```

```{r}
Idents(lymphoid_brain) <- lymphoid_brain$RNA_snn_res.1
DotPlot(lymphoid_brain,features = c("Mki67","Ptprc","P2ry12","Sall1","Hexb","Klf2","C1qa","Cx3cr1","Trem2","Adgre1","Cd44","Siglec1","Ccr2","Mertk","Lyz2","Ly6c2","Itgam","Itgax","Cd19","Cd200r3","Flt3","Sirpa","Xcr1","Siglech","Cd3e","Cd4","Cd8a","Tyrobp","Klrb1c","Pecam1","Anpep"),cluster.idents = T) + RotatedAxis()
```

```{r}
Idents(lymphoid_brain) <- lymphoid_brain$RNA_snn_res.1
g <- DotPlot(lymphoid_brain,features = c("Mki67","Ptprc","P2ry12","Sall1","C1qa","Cx3cr1","Trem2","Adgre1","Cd44","Siglec1","Ccr2","Mertk","Lyz2","Ly6c2","Itgam","Itgax","Cd19","Cd200r3","Flt3","Sirpa","Xcr1","Siglech","Cd3e","Cd4","Cd8a","Tyrobp","Klrb1c","Pecam1","Anpep"),cluster.idents = T) + RotatedAxis()
ggsave(filename = "lymphoid_ann_sorted_R1.pdf",plot = g, height = 7, width = 15)
```

```{r}
save(lymphoid_brain,file = paste0(rds_out,"GBM_RNA_10_lymphoid_V2p1.Robj"))
```

```{r}
lymphoid_brain <- JoinLayers(lymphoid_brain)
```

```{r}
mixture <- subset(lymphoid_brain,idents = c(5,11,14,10,7,4))
```

```{r}
mixture <- NormalizeData(mixture,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
mixture <- FindVariableFeatures(object = mixture, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(mixture) <-  VariableFeatures(mixture) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(mixture))]
VariableFeaturePlot(mixture,selection.method = "mean.var.plot")

mixture <- ScaleData(object = mixture, features = VariableFeatures(object = mixture), vars.to.regress = c("nCount_RNA", "percent.mt"))
mixture <- RunPCA(object = mixture,
                features =  VariableFeatures(object = mixture),
                dims = 1:50)
gc()

ElbowPlot(mixture,ndims = 50)
```

```{r}
mixture <- RunHarmony(object = mixture, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
mixture <- RunUMAP(mixture,dims = 1:40,reduction = "harmony")
mixture <- RunTSNE(mixture,dims = 1:40,reduction = "harmony")

mixture <- FindNeighbors(mixture, dims = 1:40,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  mixture <- FindClusters(object = mixture, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
```

```{r}
DimPlot(mixture,reduction = "tsne",group.by = "orig.ident",shuffle = T)
DimPlot(mixture,reduction = "umap",group.by = "orig.ident",shuffle = T)
DimPlot(mixture,reduction = "umap",group.by = "RNA_snn_res.0.1",label = T)
DimPlot(mixture,reduction = "umap",group.by = "RNA_snn_res.1",label = T)
```
```{r}
Idents(mixture) <- mixture$RNA_snn_res.1
DotPlot(mixture,features = c("Mki67","Ptprc","P2ry12","Sall1","Hexb","Klf2","C1qa","Cx3cr1","Trem2","Adgre1","Cd44","Siglec1","Ccr2","Mertk","Lyz2","Ly6c2","Itgam","Itgax","Cd19","Cd200r3","Flt3","Sirpa","Xcr1","Siglech","Cd3e","Cd4","Cd8a","Tyrobp","Klrb1c","Pecam1","Anpep"),cluster.idents = T) + RotatedAxis()
```

```{r}
lymphoid_brain <- subset(lymphoid_brain,idents = c(0:14)[!(c(0:14) %in% c(11,12))])
```


```{r}
save(lymphoid_brain,file = paste0(rds_out,"GBM_RNA_10_lymphoid_V2p2.Robj"))
```


### myeloid

```{r}
myeloid_brain@assays$RNA@layers$scale.data.1 <- NULL
myeloid_brain@assays$RNA@layers$scale.data.2 <- NULL
myeloid_brain@assays$RNA@layers$scale.data <- NULL
```

```{r}
myeloid_brain@assays$RNA
```

```{r}
head(myeloid_brain@assays$RNA@cells@.Data)
```
```{r}
head(myeloid_brain@assays$RNA@cells@.Data[,c("data", "counts", "scale.data")])
```


```{r}
myeloid_brain@assays$RNA@cells@.Data <- myeloid_brain@assays$RNA@cells@.Data[,c("data", "counts", "scale.data")]
```


```{r}
myeloid_brain <- NormalizeData(myeloid_brain,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
myeloid_brain <- FindVariableFeatures(object = myeloid_brain, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(myeloid_brain) <-  VariableFeatures(myeloid_brain) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(myeloid_brain))]
VariableFeaturePlot(myeloid_brain,selection.method = "mean.var.plot")

myeloid_brain <- ScaleData(object = myeloid_brain, features = VariableFeatures(object = myeloid_brain), vars.to.regress = c("nCount_RNA", "percent.mt"))
myeloid_brain <- RunPCA(object = myeloid_brain,
                features =  VariableFeatures(object = myeloid_brain),
                dims = 1:50)
gc()

ElbowPlot(myeloid_brain,ndims = 50)
```

```{r}
myeloid_brain <- RunHarmony(object = myeloid_brain, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
myeloid_brain <- RunUMAP(myeloid_brain,dims = 1:30,reduction = "harmony")
myeloid_brain <- RunTSNE(myeloid_brain,dims = 1:30,reduction = "harmony")

myeloid_brain <- FindNeighbors(myeloid_brain, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  myeloid_brain <- FindClusters(object = myeloid_brain, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
```

```{r}
DimPlot(myeloid_brain,reduction = "tsne",group.by = "orig.ident",shuffle = T)
DimPlot(myeloid_brain,reduction = "umap",group.by = "orig.ident",shuffle = T)
DimPlot(myeloid_brain,reduction = "umap",group.by = "RNA_snn_res.0.1",label = T)
DimPlot(myeloid_brain,reduction = "umap",group.by = "RNA_snn_res.1",label = T)
```

```{r}
Idents(myeloid_brain) <- myeloid_brain$RNA_snn_res.1
DotPlot(myeloid_brain,features = c("Mki67","Ptprc","P2ry12","Sall1","C1qa","Cx3cr1","Trem2","Adgre1","Cd44","Siglec1","Ccr2","Mertk","Lyz2","Ly6c2","Itgam","Itgax","S100a8","Cd19","Cd200r3","Flt3","Sirpa","Xcr1","Siglech","Cd3e","Cd4","Cd8a","Tyrobp","Klrb1c","Pecam1","Anpep"),cluster.idents = T) + RotatedAxis()
```

```{r}
Idents(myeloid_brain) <- myeloid_brain$RNA_snn_res.1
g <- DotPlot(myeloid_brain,features = c("Mki67","Ptprc","P2ry12","Sall1","C1qa","Cx3cr1","Trem2","Adgre1","Cd44","Siglec1","Ccr2","Mertk","Lyz2","Ly6c2","Itgam","Itgax","S100a8","Cd19","Cd200r3","Flt3","Sirpa","Xcr1","Siglech","Cd3e","Cd4","Cd8a","Tyrobp","Klrb1c","Pecam1","Anpep"),cluster.idents = T) + RotatedAxis()
ggsave(filename = "lymphoid_ann_sorted_R1.pdf",plot = g, height = 7, width = 15)
```

```{r}
myeloid_brain@meta.data[,paste0("SCT_snn_res.",seq(0.1,1.5,0.1))] <- NULL
myeloid_brain@meta.data[,paste0("RNA_snn_res.",seq(1.1,1.5,0.1))] <- NULL
```


```{r}
save(myeloid_brain,file = paste0(rds_out,"GBM_RNA_10_myeloid_V2p1.Robj"))
```


```{r}
load(paste0(rds_out,"GBM_RNA_10_myeloid_V2p1.Robj"))
```

```{r}
myeloid_brain <- JoinLayers(myeloid_brain)
```

```{r}
table(Idents(myeloid_brain))
```

```{r}
table(myeloid_brain$annotation_prelim)
```

```{r}
microglia_small <- subset(myeloid_brain, subset = RNA_snn_res.1 == 8)
```

```{r}
myeloid_brain <- subset(myeloid_brain,idents = c(0:14)[!(c(0:14) %in% c(11))])
```

```{r}
table(microglia_small$RNA_snn_res.1)
```

```{r}
save(myeloid_brain,file = paste0(rds_out,"GBM_RNA_10_myeloid_V2p2.Robj"))
```

```{r}
save(microglia_small,file = paste0(rds_out,"GBM_RNA_10_myeloid_V2p1_microglia.Robj"))
```


### microglia

```{r}
microglia <- NormalizeData(microglia,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
microglia <- FindVariableFeatures(object = microglia, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(microglia) <-  VariableFeatures(microglia) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(microglia))]
VariableFeaturePlot(microglia,selection.method = "mean.var.plot")

microglia <- ScaleData(object = microglia, features = VariableFeatures(object = microglia), vars.to.regress = c("nCount_RNA", "percent.mt"))
microglia <- RunPCA(object = microglia,
                features =  VariableFeatures(object = microglia),
                dims = 1:50)
gc()

ElbowPlot(microglia,ndims = 50)
```

```{r}
microglia <- RunHarmony(object = microglia, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
microglia <- RunUMAP(microglia,dims = 1:30,reduction = "harmony")
microglia <- RunTSNE(microglia,dims = 1:30,reduction = "harmony")

microglia <- FindNeighbors(microglia, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  microglia <- FindClusters(object = microglia, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
```

```{r}
DimPlot(microglia,reduction = "tsne",group.by = "orig.ident",shuffle = T)
DimPlot(microglia,reduction = "umap",group.by = "orig.ident",shuffle = T)
DimPlot(microglia,reduction = "umap",group.by = "RNA_snn_res.0.1",label = T)
DimPlot(microglia,reduction = "umap",group.by = "RNA_snn_res.1",label = T)
```

```{r}
Idents(microglia) <- microglia$RNA_snn_res.1
DotPlot(microglia,features = c("Mki67","Ptprc","P2ry12","Sall1","C1qa","Cx3cr1","Trem2","Adgre1","Cd44","Siglec1","Ccr2","Mertk","Lyz2","Ly6c2","Itgam","Itgax","S100a8","Cd19","Cd200r3","Flt3","Sirpa","Xcr1","Siglech","Cd3e","Cd4","Cd8a","Tyrobp","Klrb1c","Pecam1","Anpep"),cluster.idents = T) + RotatedAxis()
```

```{r}
Idents(microglia) <- microglia$RNA_snn_res.1
g <- DotPlot(microglia,features = c("Mki67","Ptprc","P2ry12","Sall1","C1qa","Cx3cr1","Trem2","Adgre1","Cd44","Siglec1","Ccr2","Mertk","Lyz2","Ly6c2","Itgam","Itgax","S100a8","Cd19","Cd200r3","Flt3","Sirpa","Xcr1","Siglech","Cd3e","Cd4","Cd8a","Tyrobp","Klrb1c","Pecam1","Anpep"),cluster.idents = T) + RotatedAxis()
ggsave(filename = "microglia_ann_sorted_R1.pdf",plot = g, height = 7, width = 15)
```

```{r}
VlnPlot(microglia,features = c("percent.mt","nFeature_RNA_log10"),alpha = 0.2)
VlnPlot(microglia,features = c("percent.mt","nCount_RNA_log10"),alpha = 0.2)
```


```{r}
save(microglia,file = paste0(rds_out,"GBM_RNA_10_microglia_V2p1.Robj"))
```

```{r}
microglia <- subset(microglia,idents = c(0:15)[!(c(0:15) %in% c(12))])
```

```{r}
microglia <- JoinLayers(microglia)
```

```{r}
microglia@assays$RNA@layers$scale.data.1 <- NULL
microglia@assays$RNA@layers$scale.data.2 <- NULL
microglia@assays$RNA@layers$scale.data <- NULL
```

```{r}
microglia_small@assays$RNA@layers$scale.data <- NULL
```


```{r}
save(microglia,file = paste0(rds_out,"GBM_RNA_10_microglia_V2p2.Robj"))
```

## second iteration

### lymphoid

```{r}
lymphoid_brain <- NormalizeData(lymphoid_brain,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
lymphoid_brain <- FindVariableFeatures(object = lymphoid_brain, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(lymphoid_brain) <-  VariableFeatures(lymphoid_brain) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(lymphoid_brain))]
VariableFeaturePlot(lymphoid_brain,selection.method = "mean.var.plot")

lymphoid_brain <- ScaleData(object = lymphoid_brain, features = VariableFeatures(object = lymphoid_brain), vars.to.regress = c("nCount_RNA", "percent.mt"))
lymphoid_brain <- RunPCA(object = lymphoid_brain,
                features =  VariableFeatures(object = lymphoid_brain),
                dims = 1:50)
gc()

ElbowPlot(lymphoid_brain,ndims = 50)
```

```{r}
lymphoid_brain <- RunHarmony(object = lymphoid_brain, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
lymphoid_brain <- RunUMAP(lymphoid_brain,dims = 1:25,reduction = "harmony")
lymphoid_brain <- RunTSNE(lymphoid_brain,dims = 1:25,reduction = "harmony")

lymphoid_brain <- FindNeighbors(lymphoid_brain, dims = 1:25,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  lymphoid_brain <- FindClusters(object = lymphoid_brain, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
```


```{r}
DimPlot(lymphoid_brain,reduction = "tsne",group.by = "orig.ident",shuffle = T)
DimPlot(lymphoid_brain,reduction = "umap",group.by = "orig.ident",shuffle = T)
DimPlot(lymphoid_brain,reduction = "umap",group.by = "RNA_snn_res.0.1",label = T)
DimPlot(lymphoid_brain,reduction = "umap",group.by = "RNA_snn_res.1",label = T)
```

```{r}
Idents(lymphoid_brain) <- lymphoid_brain$RNA_snn_res.1
DotPlot(lymphoid_brain,features = c("Mki67","Ptprc","P2ry12","Gpr34","Sall1","Hexb","Klf2","C1qa","Cx3cr1","Trem2","Adgre1","Cd44","Siglec1","Ccr2","Mertk","Lyz2","Ly6c2","Itgam","Itgax","Cd19","Cd200r3","Flt3","Sirpa","Xcr1","Siglech","Cd3e","Cd4","Cd8a","Tyrobp","Klrb1c","Pecam1","Anpep"),cluster.idents = T) + RotatedAxis()
```

```{r}
Idents(lymphoid_brain) <- lymphoid_brain$RNA_snn_res.1
g <- DotPlot(lymphoid_brain,features = c("Mki67","Ptprc","P2ry12","Gpr34","Sall1","C1qa","Cx3cr1","Trem2","Adgre1","Cd44","Siglec1","Ccr2","Mertk","Lyz2","Ly6c2","Itgam","Itgax","Cd19","Cd200r3","Flt3","Sirpa","Xcr1","Siglech","Cd3e","Cd4","Cd8a","Tyrobp","Klrb1c","Pecam1","Anpep"),cluster.idents = T) + RotatedAxis()
ggsave(filename = "lymphoid_ann_sorted_R2.pdf",plot = g, height = 7, width = 15)
```

```{r}
lymphoid_brain <- JoinLayers(lymphoid_brain)
```

```{r}
save(lymphoid_brain,file = paste0(rds_out,"GBM_RNA_10_lymphoid_V2p2.Robj"))
```

```{r}
lymphoid_brain <- subset(lymphoid_brain,idents = c(0:13)[!(c(0:13) %in% c(11))])
```

```{r}
lymphoid_brain <- NormalizeData(lymphoid_brain,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
lymphoid_brain <- FindVariableFeatures(object = lymphoid_brain, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(lymphoid_brain) <-  VariableFeatures(lymphoid_brain) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(lymphoid_brain))]
VariableFeaturePlot(lymphoid_brain,selection.method = "mean.var.plot")

lymphoid_brain <- ScaleData(object = lymphoid_brain, features = VariableFeatures(object = lymphoid_brain), vars.to.regress = c("nCount_RNA", "percent.mt"))
lymphoid_brain <- RunPCA(object = lymphoid_brain,
                features =  VariableFeatures(object = lymphoid_brain),
                dims = 1:50)
gc()

ElbowPlot(lymphoid_brain,ndims = 50)
```

```{r}
lymphoid_brain <- RunHarmony(object = lymphoid_brain, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
lymphoid_brain <- RunUMAP(lymphoid_brain,dims = 1:20,reduction = "harmony")
lymphoid_brain <- RunTSNE(lymphoid_brain,dims = 1:20,reduction = "harmony")

lymphoid_brain <- FindNeighbors(lymphoid_brain, dims = 1:20,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  lymphoid_brain <- FindClusters(object = lymphoid_brain, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
```


```{r}
DimPlot(lymphoid_brain,reduction = "tsne",group.by = "orig.ident",shuffle = T)
DimPlot(lymphoid_brain,reduction = "umap",group.by = "orig.ident",shuffle = T)
DimPlot(lymphoid_brain,reduction = "umap",group.by = "RNA_snn_res.0.1",label = T)
DimPlot(lymphoid_brain,reduction = "umap",group.by = "RNA_snn_res.1",label = T)
```

```{r}
Idents(lymphoid_brain) <- lymphoid_brain$RNA_snn_res.1
DotPlot(lymphoid_brain,features = c("Mki67","Ptprc","P2ry12","Gpr34","Sall1","Hexb","Klf2","C1qa","Cx3cr1","Trem2","Adgre1","Cd44","Siglec1","Ccr2","Mertk","Lyz2","Ly6c2","Itgam","Itgax","Cd19","Cd200r3","Flt3","Sirpa","Xcr1","Siglech","Cd3e","Cd4","Cd8a","Tyrobp","Klrb1c","Pecam1","Anpep"),cluster.idents = T) + RotatedAxis()
```

```{r}
Idents(lymphoid_brain) <- lymphoid_brain$RNA_snn_res.1
DotPlot(lymphoid_brain,features = c("Mki67","P2ry12","Gpr34","Sall1","Hexb","Klf2","C1qa","Cx3cr1","Trem2","Adgre1","Ccr2","Mertk","Lyz2","Ly6c2","Itgam","Itgax","Cd19","Sirpa","Siglech","Cd3e","Cd4","Foxp3","Cd8a","Gzma","Gzmb","Pdcd1","Prf1","Tyrobp","Klrb1c"),cluster.idents = T) + RotatedAxis()
```

```{r}
lymphoid_brain@meta.data[,paste0("SCT_snn_res.",seq(0.1,1.5,0.1))] <- NULL
lymphoid_brain@meta.data[,paste0("RNA_snn_res.",seq(1,1.5,0.1))] <- NULL
```

```{r}
lymphoid_brain <- subset(lymphoid_brain,idents = c(0:12)[!(c(0:12) %in% c(9))])
```

```{r}
lymphoid_brain <- JoinLayers(lymphoid_brain)
```

```{r}
lymphoid_brain <- NormalizeData(lymphoid_brain,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
lymphoid_brain <- FindVariableFeatures(object = lymphoid_brain, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(lymphoid_brain) <-  VariableFeatures(lymphoid_brain) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(lymphoid_brain))]
VariableFeaturePlot(lymphoid_brain,selection.method = "mean.var.plot")

lymphoid_brain <- ScaleData(object = lymphoid_brain, features = VariableFeatures(object = lymphoid_brain), vars.to.regress = c("nCount_RNA", "percent.mt"))
lymphoid_brain <- RunPCA(object = lymphoid_brain,
                features =  VariableFeatures(object = lymphoid_brain),
                dims = 1:50)
gc()

ElbowPlot(lymphoid_brain,ndims = 50)
```

```{r}
lymphoid_brain <- RunHarmony(object = lymphoid_brain, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
lymphoid_brain <- RunUMAP(lymphoid_brain,dims = 1:20,reduction = "harmony")
lymphoid_brain <- RunTSNE(lymphoid_brain,dims = 1:20,reduction = "harmony")

lymphoid_brain <- FindNeighbors(lymphoid_brain, dims = 1:20,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  lymphoid_brain <- FindClusters(object = lymphoid_brain, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
```


```{r}
DimPlot(lymphoid_brain,reduction = "tsne",group.by = "orig.ident",shuffle = T)
DimPlot(lymphoid_brain,reduction = "umap",group.by = "orig.ident",shuffle = T)
DimPlot(lymphoid_brain,reduction = "umap",group.by = "RNA_snn_res.0.1",label = T)
DimPlot(lymphoid_brain,reduction = "umap",group.by = "RNA_snn_res.1",label = T)
```
```{r}
Idents(lymphoid_brain) <- lymphoid_brain$RNA_snn_res.1
DotPlot(lymphoid_brain,features = c("Mki67","Ptprc","P2ry12","Gpr34","Sall1","Hexb","Klf2","C1qa","Cx3cr1","Trem2","Adgre1","Cd44","Siglec1","Ccr2","Mertk","Lyz2","Ly6c2","Itgam","Itgax","Cd19","Cd200r3","Flt3","Sirpa","Xcr1","Siglech","Cd3e","Cd4","Cd8a","Tyrobp","Klrb1c","Pecam1","Anpep"),cluster.idents = T) + RotatedAxis()
```

```{r}
Idents(lymphoid_brain) <- lymphoid_brain$RNA_snn_res.1
DotPlot(lymphoid_brain,features = c("Mki67","P2ry12","Gpr34","Sall1","Hexb","Klf2","C1qa","Cx3cr1","Trem2","Adgre1","Ccr2","Mertk","Lyz2","Ly6c2","Itgam","Itgax","Cd19","Sirpa","Siglech","Cd3e","Cd4","Foxp3","Cd8a","Gzma","Gzmb","Ifitm1","Ifit2","Il2ra","Pdcd1","Prf1","Tyrobp","Klrb1c"),cluster.idents = T) + RotatedAxis()
```

```{r}
lymphoid_brain@meta.data <- lymphoid_brain@meta.data %>%
  mutate(annotation_V1 =
           case_match(
             as.character(RNA_snn_res.1),
             "0" ~ "CD4T_1",
             "1" ~ "CD8T_1",
             "2" ~ "NK_NKT",
             "3" ~ "T_unclear",
             "4" ~ "Adgre1+Cd3e+_1",
             "5" ~ "B_1",
             "6" ~ "Adgre1+Cd3e+_2",
             "7" ~ "CD8T_2",
             "8" ~ "CD4T_2",
             "9" ~ "B_2",
             "10" ~ "proliferating"
           ),
         compartment = rep("immune_cells",nrow(lymphoid_brain@meta.data)))
```

```{r}
table(lymphoid_brain$compartment)
table(lymphoid_brain$annotation_prelim)
table(lymphoid_brain$annotation_V1)
```

```{r}
save(lymphoid_brain,file = paste0(rds_out,"GBM_RNA_10_lymphoid_V2p2.Robj"))
```



### myeloid

```{r}
myeloid_brain@assays$RNA@layers$scale.data <- NULL
```


```{r}
myeloid_brain <- JoinLayers(myeloid_brain)
```


```{r}
myeloid_brain <- NormalizeData(myeloid_brain,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
myeloid_brain <- FindVariableFeatures(object = myeloid_brain, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(myeloid_brain) <-  VariableFeatures(myeloid_brain) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(myeloid_brain))]
VariableFeaturePlot(myeloid_brain,selection.method = "mean.var.plot")

myeloid_brain <- ScaleData(object = myeloid_brain, features = VariableFeatures(object = myeloid_brain), vars.to.regress = c("nCount_RNA", "percent.mt"))
myeloid_brain <- RunPCA(object = myeloid_brain,
                features =  VariableFeatures(object = myeloid_brain),
                dims = 1:50)
gc()

ElbowPlot(myeloid_brain,ndims = 50)
```

```{r}
myeloid_brain <- RunHarmony(object = myeloid_brain, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
myeloid_brain <- RunUMAP(myeloid_brain,dims = 1:30,reduction = "harmony")
myeloid_brain <- RunTSNE(myeloid_brain,dims = 1:30,reduction = "harmony")

myeloid_brain <- FindNeighbors(myeloid_brain, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  myeloid_brain <- FindClusters(object = myeloid_brain, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
```

```{r}
DimPlot(myeloid_brain,reduction = "tsne",group.by = "orig.ident",shuffle = T)
DimPlot(myeloid_brain,reduction = "umap",group.by = "orig.ident",shuffle = T)
DimPlot(myeloid_brain,reduction = "umap",group.by = "RNA_snn_res.0.1",label = T)
DimPlot(myeloid_brain,reduction = "umap",group.by = "RNA_snn_res.1",label = T)
```

```{r}
Idents(myeloid_brain) <- myeloid_brain$RNA_snn_res.1
DotPlot(myeloid_brain,features = c("Mki67","Ptprc","P2ry12","Sall1","C1qa","Cx3cr1","Trem2","Adgre1","Cd44","Siglec1","Ccr2","Mertk","Lyz2","Ly6c2","Itgam","Itgax","S100a9","Cd19","Cd200r3","Flt3","Sirpa","Xcr1","Siglech","Cd3e","Cd4","Cd8a","Tyrobp","Klrb1c","Pecam1","Anpep"),cluster.idents = T) + RotatedAxis()
```

```{r}
Idents(myeloid_brain) <- myeloid_brain$RNA_snn_res.1
DotPlot(myeloid_brain,features = c("Mki67","Ptprc","P2ry12","Sall1","C1qa","Cx3cr1","Trem2","Adgre1","Cd44","Siglec1","Ccr2","Mertk","Lyz2","Ly6c2","Itgam","Itgax","Flt3","Sirpa","Xcr1","Siglech","Cd3e","Cd4","Cd8a","Tyrobp","Anpep"),cluster.idents = T) + RotatedAxis()
```

```{r}
Idents(myeloid_brain) <- myeloid_brain$RNA_snn_res.0.6
DotPlot(myeloid_brain,features = c("Ptprc","Sall1","C1qa","Trem2","Rsad2","Mrc1","Cx3cr1","Adgre1","Cd44","Siglec1","Ccr2","Mertk","Lyz2","Ly6c2","Itgam","Itgax","Flt3","Sirpa","Xcr1","Siglech","Cd3e","Cd4","Anpep","Camp"),cluster.idents = T) + RotatedAxis()
DimPlot(myeloid_brain,reduction = "umap",group.by = "RNA_snn_res.0.6",label = T)
```

```{r}
myeloid_brain@meta.data <- myeloid_brain@meta.data %>%
  mutate(annotation_V1 =
           case_match(
             as.character(RNA_snn_res.0.6),
             "0" ~ "mono_mac_1",
             "1" ~ "mono_mac_2",
             "2" ~ "mono_mac_3",
             "3" ~ "mono_mac_4",
             "4" ~ "cDC2",
             "5" ~ "mono_mac_5",
             "6" ~ "pDC",
             "7" ~ "cDC1",
             "8" ~ "microglia-like",
             "9" ~ "mono_mac_6",
             "10" ~ "mono_mac_7"
           ),
         compartment = rep("immune_cells",nrow(myeloid_brain@meta.data)))
```


```{r}
save(myeloid_brain,file = paste0(rds_out,"GBM_RNA_10_myeloid_V2p2.Robj"))
```



### microglia

```{r}
microglia@assays$RNA
head(microglia@assays$RNA@cells@.Data)
```


```{r}
microglia <- NormalizeData(microglia,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
microglia <- FindVariableFeatures(object = microglia, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(microglia) <-  VariableFeatures(microglia) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(microglia))]
VariableFeaturePlot(microglia,selection.method = "mean.var.plot")

microglia <- ScaleData(object = microglia, features = VariableFeatures(object = microglia), vars.to.regress = c("nCount_RNA", "percent.mt"))
microglia <- RunPCA(object = microglia,
                features =  VariableFeatures(object = microglia),
                dims = 1:50)
gc()

ElbowPlot(microglia,ndims = 50)
```

```{r}
microglia <- RunHarmony(object = microglia, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
microglia <- RunUMAP(microglia,dims = 1:30,reduction = "harmony")
microglia <- RunTSNE(microglia,dims = 1:30,reduction = "harmony")

microglia <- FindNeighbors(microglia, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  microglia <- FindClusters(object = microglia, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
```

```{r}
DimPlot(microglia,reduction = "tsne",group.by = "orig.ident",shuffle = T)
DimPlot(microglia,reduction = "umap",group.by = "orig.ident",shuffle = T)
DimPlot(microglia,reduction = "umap",group.by = "RNA_snn_res.0.1",label = T)
DimPlot(microglia,reduction = "umap",group.by = "RNA_snn_res.1",label = T)
```

```{r}
Idents(microglia) <- microglia$RNA_snn_res.1
DotPlot(microglia,features = c("Mki67","Ptprc","P2ry12","Sall1","C1qa","Cx3cr1","Trem2","Adgre1","Cd44","Siglec1","Ccr2","Mertk","Lyz2","Ly6c2","Itgam","Itgax","S100a8","Cd19","Cd200r3","Flt3","Sirpa","Xcr1","Siglech","Cd3e","Cd4","Cd8a","Tyrobp","Klrb1c","Pecam1","Anpep"),cluster.idents = T) + RotatedAxis()
```



```{r}
Idents(microglia) <- microglia$RNA_snn_res.0.1
DotPlot(microglia,features = c("Mki67","Ptprc","P2ry12","Sall1","Hexb","Klf2","C1qa","Ccl3","Ccl4","Cx3cr1","Trem2","Adgre1","Cd44","Siglec1","Ccr2","Mertk","Lyz2","Ly6c2","Itgam","Itgax","Sirpa"),cluster.idents = T) + RotatedAxis()
DimPlot(microglia,reduction = "umap",group.by = "RNA_snn_res.0.1",label = T)
```

```{r}
microglia <- JoinLayers(microglia)
```

```{r}
microglia@meta.data[,paste0("SCT_snn_res.",seq(0.1,1.5,0.1))] <- NULL
microglia@meta.data[,paste0("RNA_snn_res.",seq(1,1.5,0.1))] <- NULL
```


```{r}
save(microglia,file = paste0(rds_out,"GBM_RNA_10_microglia_V2p2.Robj"))
```






