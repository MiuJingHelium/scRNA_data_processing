---
title: "merge back whole dataset"
output: html_document
date: "2024-04-04"
---

This is an earlier version of whole dataset re-generation using entirely V2 subsets. Changes were made to the immune cell subset because of mislabeling of myeloid and lymphoid cells. The problem is that some myeloid will get mistaken as lymphoid if immune cell subsets were created from preliminary annotation and directly divided into microglia, myeloid, and lymphoid.

```{r}
library(tidyverse)
library(Seurat)
library(harmony)
```

```{r}
rds_in <- "data/"
rds_out <- "data/"
```

```{r}
load(paste0(rds_in,"GBM_RNA_10_glioma_V2.Robj"))
load(paste0(rds_in,"GBM_RNA_10_imm_V2.Robj"))
load(paste0(rds_in,"GBM_RNA_10_stromal_V2.Robj"))
```

```{r}
stromal <- JoinLayers(stromal)
```

```{r}
whole <- merge(x = Glioma, y = c(Immune_cells,stromal))
```

```{r}
whole <- NormalizeData(whole,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
whole <- FindVariableFeatures(object = whole, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(whole) <-  VariableFeatures(whole) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(whole))]
VariableFeaturePlot(whole,selection.method = "mean.var.plot")

whole <- ScaleData(object = whole, features = VariableFeatures(object = whole), vars.to.regress = c("nCount_RNA", "percent.mt"))
whole <- RunPCA(object = whole,
                features =  VariableFeatures(object = whole),
                dims = 1:50)
gc()

ElbowPlot(whole,ndims = 50)
```


```{r}
whole <- RunHarmony(object = whole, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
whole <- RunUMAP(whole,dims = 1:40,reduction = "harmony")
whole <- RunTSNE(whole,dims = 1:40,reduction = "harmony")

whole <- FindNeighbors(whole, dims = 1:40,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  whole <- FindClusters(object = whole, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
whole <- JoinLayers(whole)
```

```{r}
save(whole,file = paste0(rds_out,"GBM_RNA_10_whole_V2.Robj"))
```

```{r}
DimPlot(whole,reduction = "tsne",group.by = "orig.ident",shuffle = T)
DimPlot(whole,reduction = "umap",group.by = "orig.ident",shuffle = T)
DimPlot(whole,reduction = "umap",group.by = "RNA_snn_res.0.1",label = T,split.by = "progress")
DimPlot(whole,reduction = "umap",group.by = "RNA_snn_res.1",label = T,split.by = "progress")
DimPlot(whole,reduction = "umap",group.by = "annotation_V1",shuffle = T)
DimPlot(whole,reduction = "umap",group.by = "compartment",shuffle = T)
```
```{r}
DimPlot(whole,reduction = "tsne",group.by = "compartment",shuffle = T)
DimPlot(whole,reduction = "umap",group.by = "compartment",shuffle = T,split.by = "progress")
DimPlot(whole,reduction = "tsne",group.by = "compartment",shuffle = T,split.by = "progress")
```

