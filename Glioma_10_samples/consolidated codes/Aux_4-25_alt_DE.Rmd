---
title: "alternative DE analysis for result reproduction"
output: html_document
date: "2024-08-06"
---


```{r}
# For DE
library(tidyverse)
library(Seurat)
library(harmony)
library(MAST)
```

```{r}
library(RColorBrewer)
library(ggrepel)
pal <- c(brewer.pal(n = 12,name = "Set3"),brewer.pal(n = 12,name = "Paired"),brewer.pal(n = 8,name = "Accent"))
pal[2] <- "darkred"
pal[9] <- "grey25"
pal[23] <- "turquoise4"
pal[19] <- colors()[60]
pal[13] <- "darkblue"
pal[28] <- colors()[16]
pal[31] <- colors()[54] 
pal <- c(pal,colors()[c(85,84,83,89,45,31,41,42,26,29,10,139,107,108,120,109,119,121,143)])
```

```{r}
outdir <- "alt_DE_analysis_V3/"
if(!dir.exists(outdir)) dir.create(outdir)
```


# use wilcox instead

```{r}
load("data/GBM_RNA_10_myeloid_V3p2_alt.Robj")
load("data/GBM_RNA_10_lymphoid_V3p1_alt.Robj")
```


## Myeloid:

```{r}
de_clusters <- function(current_cluster) {
  groups <- gsub(" ","_",paste0(conditions,"_",current_cluster))
  both_markers <- FindMarkers(myeloid, ident.1=groups[1], ident.2=groups[2], test.use="wilcox", min.pct=0.00, logfc.threshold = 0) # change name of object 
  marker_genes <- row.names(both_markers)
  mutate(both_markers, gene = marker_genes, cluster = current_cluster)
}
```


```{r}
table(myeloid$annotation_V2)
table(myeloid$annotation_main)
```

### NT and LGG

MHC2_low_BAM, MHC2_high_BAM , Neutrophil,Slamf9_macrophage,cDC2, Classical_monocytes, Non-classical_monocytes

```{r}
myeloid$group <- gsub(" ","_",paste0(myeloid$progress,"_",myeloid$annotation_V2))
conditions <- unique(myeloid$progress)[order(unique(myeloid$progress))][2:3]
clusters <- c("MHC2_low_BAM", "MHC2_high_BAM" , "Neutrophil","Slamf9_macrophage","cDC2", "Classical_monocytes", "Non-classical_monocytes")
plts <- list()
padj_thres = 10e-2
log2FC_thres = 1
Idents(myeloid) <- myeloid$group
```

```{r}
table(myeloid$group)
```

```{r}
for (i in clusters) {
  output_file <- paste0(outdir,paste0("Myeloid_",conditions[1],'_vs_',conditions[2],'_', i, '.tsv'))
  output_file_flt <- paste0(outdir,paste0("Myeloid_",conditions[1],'_vs_',conditions[2],'_', i, '_filtered.tsv'))
  de_results_tbl <- lapply(i, de_clusters) 
  de_results_tbl <- de_results_tbl %>% bind_rows() %>%
			arrange(desc(abs(avg_log2FC))) %>%
			mutate(threshold = case_when(
			(p_val_adj < padj_thres) & (abs(avg_log2FC) > log2FC_thres) ~ "Pass",
			.default = "Fail"
			))
  write.table(de_results_tbl, output_file,sep="\t",row.names=T)
  
  de_results_tbl <- de_results_tbl %>% 
			filter(p_val_adj < padj_thres) %>%
			filter(abs(avg_log2FC) > log2FC_thres)
			
  write.table(de_results_tbl, output_file_flt,sep="\t",row.names=T)
}

```

### HGG and LGG

MHC2_low_BAM, MHC2_high_BAM , Neutrophil,Slamf9_macrophage,cDC2, Classical_monocytes, cDC1, pDC, Complement_GBP_BAM, intM,migDC

```{r}
myeloid$group <- gsub(" ","_",paste0(myeloid$progress,"_",myeloid$annotation_V2))
conditions <- unique(myeloid$progress)[order(unique(myeloid$progress))][1:2]
clusters <- c("MHC2_low_BAM", "MHC2_high_BAM" , "Neutrophil","Slamf9_macrophage","cDC2", "Classical_monocytes", "cDC1", "pDC", "Complement_GBP_BAM", "intM","migDC")
plts <- list()
padj_thres = 10e-2
log2FC_thres = 1
Idents(myeloid) <- myeloid$group
```


```{r}
table(myeloid$group)
```

```{r}
for (i in clusters) {
  output_file <- paste0(outdir,paste0("Myeloid_",conditions[1],'_vs_',conditions[2],'_', i, '.tsv'))
  output_file_flt <- paste0(outdir,paste0("Myeloid_",conditions[1],'_vs_',conditions[2],'_', i, '_filtered.tsv'))
  de_results_tbl <- lapply(i, de_clusters) 
  de_results_tbl <- de_results_tbl %>% bind_rows() %>%
			arrange(desc(abs(avg_log2FC))) %>%
			mutate(threshold = case_when(
			(p_val_adj < padj_thres) & (abs(avg_log2FC) > log2FC_thres) ~ "Pass",
			.default = "Fail"
			))
  write.table(de_results_tbl, output_file,sep="\t",row.names=T)
  
  de_results_tbl <- de_results_tbl %>% 
			filter(p_val_adj < padj_thres) %>%
			filter(abs(avg_log2FC) > log2FC_thres)
			
  write.table(de_results_tbl, output_file_flt,sep="\t",row.names=T)
}

```


## lymphoid

```{r}
de_clusters <- function(current_cluster) {
  groups <- gsub(" ","_",paste0(conditions,"_",current_cluster))
  both_markers <- FindMarkers(lymphoid, ident.1=groups[1], ident.2=groups[2], test.use="wilcox", min.pct=0.00, logfc.threshold = 0) # change name of object 
  marker_genes <- row.names(both_markers)
  mutate(both_markers, gene = marker_genes, cluster = current_cluster)
}
```

```{r}
table(lymphoid$annotation_V2)
```


LGG and HGG: 0_activated_CD8, 1_activated_CD4, Memory_B_1, Memory_B_2, Memory_B_3, NKT, NK, Naive_T_cells
LGG and NT: Pdcd1_Cd44_high_activated_T, gdT_cells, NKT, NK, Naive_T_cells

### NT and LGG

```{r}
lymphoid$group <- gsub(" ","_",paste0(lymphoid$progress,"_",lymphoid$annotation_V2))
conditions <- unique(lymphoid$progress)[order(unique(lymphoid$progress))][2:3]
clusters <- c("Pdcd1_Cd44_high_activated_T", "gdT_cells")
plts <- list()
padj_thres = 10e-2
log2FC_thres = 1
Idents(lymphoid) <- lymphoid$group
```

```{r}
table(lymphoid$group)
```

```{r}
for (i in clusters) {
  output_file <- paste0(outdir,paste0("Lymphoid_",conditions[1],'_vs_',conditions[2],'_', i, '.tsv'))
  output_file_flt <- paste0(outdir,paste0("Lymphoid_",conditions[1],'_vs_',conditions[2],'_', i, '_filtered.tsv'))
  de_results_tbl <- lapply(i, de_clusters) 
  de_results_tbl <- de_results_tbl %>% bind_rows() %>%
			arrange(desc(abs(avg_log2FC))) %>%
			mutate(threshold = case_when(
			(p_val_adj < padj_thres) & (abs(avg_log2FC) > log2FC_thres) ~ "Pass",
			.default = "Fail"
			))
  write.table(de_results_tbl, output_file,sep="\t",row.names=T)
  
  de_results_tbl <- de_results_tbl %>% 
			filter(p_val_adj < padj_thres) %>%
			filter(abs(avg_log2FC) > log2FC_thres)
			
  write.table(de_results_tbl, output_file_flt,sep="\t",row.names=T)
}

```

### HGG and LGG

```{r}
lymphoid$group <- gsub(" ","_",paste0(lymphoid$progress,"_",lymphoid$annotation_V2))
conditions <- unique(lymphoid$progress)[order(unique(lymphoid$progress))][1:2]
clusters <- c("0_activated_CD8", "1_activated_CD4", "Memory_B_1", "Memory_B_2", "Memory_B_3", "NKT", "NK", "Naive_T_cells")
plts <- list()
padj_thres = 10e-2
log2FC_thres = 1
Idents(lymphoid) <- lymphoid$group
```


```{r}
table(lymphoid$group)
```

```{r}
for (i in clusters) {
  output_file <- paste0(outdir,paste0("Lymphoid_",conditions[1],'_vs_',conditions[2],'_', i, '.tsv'))
  output_file_flt <- paste0(outdir,paste0("Lymphoid_",conditions[1],'_vs_',conditions[2],'_', i, '_filtered.tsv'))
  de_results_tbl <- lapply(i, de_clusters) 
  de_results_tbl <- de_results_tbl %>% bind_rows() %>%
			arrange(desc(abs(avg_log2FC))) %>%
			mutate(threshold = case_when(
			(p_val_adj < padj_thres) & (abs(avg_log2FC) > log2FC_thres) ~ "Pass",
			.default = "Fail"
			))
  write.table(de_results_tbl, output_file,sep="\t",row.names=T)
  
  de_results_tbl <- de_results_tbl %>% 
			filter(p_val_adj < padj_thres) %>%
			filter(abs(avg_log2FC) > log2FC_thres)
			
  write.table(de_results_tbl, output_file_flt,sep="\t",row.names=T)
}

```

## Volcano Plot

### myeloid

#### NT and LGG

```{r}
clusters <- c("MHC2_low_BAM", "MHC2_high_BAM" , "Neutrophil","Slamf9_macrophage","cDC2", "Classical_monocytes", "Non-classical_monocytes")
conditions <- unique(myeloid$progress)[order(unique(myeloid$progress))][2:3]
glist <- lapply(clusters,function(x){
  de_table <- read.table(paste0(outdir,"alt_DE_analysis_V3","Myeloid_",conditions[1],'_vs_',conditions[2],'_', x, '.tsv'))
  ggplot(de_table,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("LGG v.s. NT: ", x)
})


g <- gridExtra::grid.arrange(grobs = glist, ncol = 3)
ggsave("Wilcox_DE_myeloid_NT_LGG_combined.pdf",plot = g, width = 15, height = 18)
```

#### LGG and HGG

```{r}
clusters <- c("MHC2_low_BAM", "MHC2_high_BAM" , "Neutrophil","Slamf9_macrophage","cDC2", "Classical_monocytes", "cDC1", "pDC", "Complement_GBP_BAM", "intM","migDC")
conditions <- unique(myeloid$progress)[order(unique(myeloid$progress))][1:2]

glist <- lapply(clusters,function(x){
  de_table <- read.table(paste0(outdir,"alt_DE_analysis_V3","Myeloid_",conditions[1],'_vs_',conditions[2],'_', x, '.tsv'))
  ggplot(de_table,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("HGG v.s. LGG: ", x)
})

g <- gridExtra::grid.arrange(grobs = glist, ncol = 3)
ggsave("Wilcox_DE_myeloid_HGG_LGG_combined.pdf",plot = g, width = 15, height = 18)
```

### lymphoid

#### NT and LGG

```{r}
clusters <- c("Pdcd1_Cd44_high_activated_T", "gdT_cells","NK","NKT")
conditions <- unique(lymphoid$progress)[order(unique(lymphoid$progress))][2:3]

glist <- lapply(clusters,function(x){
  de_table <- read.table(paste0(outdir,"alt_DE_analysis_V3","Lymphoid_",conditions[1],'_vs_',conditions[2],'_', x, '.tsv'))
  ggplot(de_table,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("HGG v.s. LGG: ", x)
})

g <- gridExtra::grid.arrange(grobs = glist, ncol = 2)
ggsave("Wilcox_DE_lymphoid_NT_LGG_combined.pdf",plot = g, width = 9, height = 9)
```

#### LGG and HGG

```{r}
clusters <- c("0_activated_CD8", "1_activated_CD4", "Memory_B_1", "Memory_B_2", "Memory_B_3", "NKT", "NK", "Naive_T_cells")
conditions <- unique(lymphoid$progress)[order(unique(lymphoid$progress))][1:2]

glist <- lapply(clusters,function(x){
  de_table <- read.table(paste0(outdir,"alt_DE_analysis_V3","Lymphoid_",conditions[1],'_vs_',conditions[2],'_', x, '.tsv'))
  ggplot(de_table,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("HGG v.s. LGG: ", x)
})

g <- gridExtra::grid.arrange(grobs = glist, ncol = 3)
ggsave("Wilcox_DE_lymphoid_HGG_LGG_combined.pdf",plot = g, width = 15, height = 18)

```

# DE over annotation_main using wilcox:


## Myeloid:

```{r}
de_clusters <- function(current_cluster) {
  groups <- gsub(" ","_",paste0(conditions,"_",current_cluster))
  both_markers <- FindMarkers(myeloid, ident.1=groups[1], ident.2=groups[2], test.use="wilcox", min.pct=0.00, logfc.threshold = 0) # change name of object 
  marker_genes <- row.names(both_markers)
  mutate(both_markers, gene = marker_genes, cluster = current_cluster)
}
```


```{r}
table(myeloid$annotation_V2)
table(myeloid$annotation_main)
```

### NT and LGG

MHC2_low_BAM, MHC2_high_BAM , Neutrophil,Slamf9_macrophage,cDC2, Classical_monocytes, Non-classical_monocytes

```{r}
myeloid$group <- gsub(" ","_",paste0(myeloid$progress,"_",myeloid$annotation_main))
conditions <- unique(myeloid$progress)[order(unique(myeloid$progress))][2:3]
clusters <- unique(myeloid$annotation_main)[!(unique(myeloid$annotation_main) %in% c("Mast cells","MoMac"))]
plts <- list()
padj_thres = 10e-2
log2FC_thres = 1
Idents(myeloid) <- myeloid$group
```

```{r}
table(myeloid$group)
```

```{r}
for (i in clusters) {
  output_file <- paste0(outdir,paste0("Myeloid_",conditions[1],'_vs_',conditions[2],'_', i, '.tsv'))
  output_file_flt <- paste0(outdir,paste0("Myeloid_",conditions[1],'_vs_',conditions[2],'_', i, '_filtered.tsv'))
  de_results_tbl <- lapply(i, de_clusters) 
  de_results_tbl <- de_results_tbl %>% bind_rows() %>%
			arrange(desc(abs(avg_log2FC))) %>%
			mutate(threshold = case_when(
			(p_val_adj < padj_thres) & (abs(avg_log2FC) > log2FC_thres) ~ "Pass",
			.default = "Fail"
			))
  write.table(de_results_tbl, output_file,sep="\t",row.names=T)
  
  de_results_tbl <- de_results_tbl %>% 
			filter(p_val_adj < padj_thres) %>%
			filter(abs(avg_log2FC) > log2FC_thres)
			
  write.table(de_results_tbl, output_file_flt,sep="\t",row.names=T)
}

```


```{r}
clusters <- unique(myeloid$annotation_main)[!(unique(myeloid$annotation_main) %in% c("Mast cells","MoMac"))]
conditions <- unique(myeloid$progress)[order(unique(myeloid$progress))][2:3]
glist <- lapply(clusters,function(x){
  de_table <- read.table(paste0(outdir,"Myeloid_",conditions[1],'_vs_',conditions[2],'_', x, '.tsv'))
  ggplot(de_table,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("LGG v.s. NT: ", x)
})


g <- gridExtra::grid.arrange(grobs = glist, ncol = 3)
ggsave("Wilcox_DE_myeloid_main_NT_LGG_combined.pdf",plot = g, width = 15, height = 18)
```


### HGG and LGG

MHC2_low_BAM, MHC2_high_BAM , Neutrophil,Slamf9_macrophage,cDC2, Classical_monocytes, cDC1, pDC, Complement_GBP_BAM, intM,migDC

```{r}
myeloid$group <- gsub(" ","_",paste0(myeloid$progress,"_",myeloid$annotation_main))
conditions <- unique(myeloid$progress)[order(unique(myeloid$progress))][1:2]
clusters <- unique(myeloid$annotation_main)[unique(myeloid$annotation_main) != "Mast cells"]
plts <- list()
padj_thres = 10e-2
log2FC_thres = 1
Idents(myeloid) <- myeloid$group
```


```{r}
table(myeloid$group)
```

```{r}
for (i in clusters) {
  output_file <- paste0(outdir,paste0("Myeloid_",conditions[1],'_vs_',conditions[2],'_', i, '.tsv'))
  output_file_flt <- paste0(outdir,paste0("Myeloid_",conditions[1],'_vs_',conditions[2],'_', i, '_filtered.tsv'))
  de_results_tbl <- lapply(i, de_clusters) 
  de_results_tbl <- de_results_tbl %>% bind_rows() %>%
			arrange(desc(abs(avg_log2FC))) %>%
			mutate(threshold = case_when(
			(p_val_adj < padj_thres) & (abs(avg_log2FC) > log2FC_thres) ~ "Pass",
			.default = "Fail"
			))
  write.table(de_results_tbl, output_file,sep="\t",row.names=T)
  
  de_results_tbl <- de_results_tbl %>% 
			filter(p_val_adj < padj_thres) %>%
			filter(abs(avg_log2FC) > log2FC_thres)
			
  write.table(de_results_tbl, output_file_flt,sep="\t",row.names=T)
}

```

```{r}
clusters <- unique(myeloid$annotation_main)[!(unique(myeloid$annotation_main) %in% c("Mast cells"))]
conditions <- unique(myeloid$progress)[order(unique(myeloid$progress))][1:2]
glist <- lapply(clusters,function(x){
  de_table <- read.table(paste0(outdir,"Myeloid_",conditions[1],'_vs_',conditions[2],'_', x, '.tsv'))
  ggplot(de_table,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("HGG v.s. LGG: ", x)
})


g <- gridExtra::grid.arrange(grobs = glist, ncol = 3)
ggsave("Wilcox_DE_myeloid_main_HGG_LGG_combined.pdf",plot = g, width = 15, height = 18)
```


## lymphoid

```{r}
de_clusters <- function(current_cluster) {
  groups <- gsub(" ","_",paste0(conditions,"_",current_cluster))
  both_markers <- FindMarkers(lymphoid, ident.1=groups[1], ident.2=groups[2], test.use="wilcox", min.pct=0.00, logfc.threshold = 0) # change name of object 
  marker_genes <- row.names(both_markers)
  mutate(both_markers, gene = marker_genes, cluster = current_cluster)
}
```

```{r}
table(lymphoid$annotation_main)
```


### NT and LGG

```{r}
lymphoid$group <- gsub(" ","_",paste0(lymphoid$progress,"_",lymphoid$annotation_main))
conditions <- unique(lymphoid$progress)[order(unique(lymphoid$progress))][2:3]
clusters <- c("B_cells")
plts <- list()
padj_thres = 10e-2
log2FC_thres = 1
Idents(lymphoid) <- lymphoid$group
```

```{r}
table(lymphoid$group)
```

```{r}
for (i in clusters) {
  output_file <- paste0(outdir,paste0("Lymphoid_",conditions[1],'_vs_',conditions[2],'_', i, '.tsv'))
  output_file_flt <- paste0(outdir,paste0("Lymphoid_",conditions[1],'_vs_',conditions[2],'_', i, '_filtered.tsv'))
  de_results_tbl <- lapply(i, de_clusters) 
  de_results_tbl <- de_results_tbl %>% bind_rows() %>%
			arrange(desc(abs(avg_log2FC))) %>%
			mutate(threshold = case_when(
			(p_val_adj < padj_thres) & (abs(avg_log2FC) > log2FC_thres) ~ "Pass",
			.default = "Fail"
			))
  write.table(de_results_tbl, output_file,sep="\t",row.names=T)
  
  de_results_tbl <- de_results_tbl %>% 
			filter(p_val_adj < padj_thres) %>%
			filter(abs(avg_log2FC) > log2FC_thres)
			
  write.table(de_results_tbl, output_file_flt,sep="\t",row.names=T)
}

```

```{r}
clusters <- c("B_cells")
conditions <- unique(lymphoid$progress)[order(unique(lymphoid$progress))][2:3]

glist <- lapply(clusters,function(x){
  de_table <- read.table(paste0(outdir,"Lymphoid_",conditions[1],'_vs_',conditions[2],'_', x, '.tsv'))
  ggplot(de_table,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("LGG v.s. NT: ", x)
})

g <- gridExtra::grid.arrange(grobs = glist, ncol = 2)
ggsave("Wilcox_DE_lymphoid_main_NT_LGG_combined.pdf",plot = g, width = 5, height = 5)
```

### HGG and LGG

```{r}
lymphoid$group <- gsub(" ","_",paste0(lymphoid$progress,"_",lymphoid$annotation_main))
conditions <- unique(lymphoid$progress)[order(unique(lymphoid$progress))][1:2]
clusters <- unique(lymphoid$annotation_main)[unique(lymphoid$annotation_main) != c("noise","gdT_cells")]
plts <- list()
padj_thres = 10e-2
log2FC_thres = 1
Idents(lymphoid) <- lymphoid$group
```


```{r}
table(lymphoid$group)
```

```{r}
for (i in clusters) {
  output_file <- paste0(outdir,paste0("Lymphoid_",conditions[1],'_vs_',conditions[2],'_', i, '.tsv'))
  output_file_flt <- paste0(outdir,paste0("Lymphoid_",conditions[1],'_vs_',conditions[2],'_', i, '_filtered.tsv'))
  de_results_tbl <- lapply(i, de_clusters) 
  de_results_tbl <- de_results_tbl %>% bind_rows() %>%
			arrange(desc(abs(avg_log2FC))) %>%
			mutate(threshold = case_when(
			(p_val_adj < padj_thres) & (abs(avg_log2FC) > log2FC_thres) ~ "Pass",
			.default = "Fail"
			))
  write.table(de_results_tbl, output_file,sep="\t",row.names=T)
  
  de_results_tbl <- de_results_tbl %>% 
			filter(p_val_adj < padj_thres) %>%
			filter(abs(avg_log2FC) > log2FC_thres)
			
  write.table(de_results_tbl, output_file_flt,sep="\t",row.names=T)
}

```

```{r}
clusters <- unique(lymphoid$annotation_main)[unique(lymphoid$annotation_main) != c("noise","gdT_cells")]
conditions <- unique(lymphoid$progress)[order(unique(lymphoid$progress))][1:2]

glist <- lapply(clusters,function(x){
  de_table <- read.table(paste0(outdir,"Lymphoid_",conditions[1],'_vs_',conditions[2],'_', x, '.tsv'))
  ggplot(de_table,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("HGG v.s. LGG: ", x)
})

g <- gridExtra::grid.arrange(grobs = glist, ncol = 3)
ggsave("Wilcox_DE_lymphoid_main_HGG_LGG_combined.pdf",plot = g, width = 9, height = 9)
```



# Try pseudobulk

```{r}

```

