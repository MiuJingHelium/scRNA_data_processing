---
title: "4-40_functional analysis"
output: html_document
date: "2024-07-24"
---

```{r}
library(Seurat)
library(tidyverse)
# install enhanced volcano plot ; or you can also do ggplot
# install clusterProfiler
library(clusterProfiler)
library(AnnotationHub) # for id conversion

# for fgsea
library(msigdbr)
library(fgsea)
library(org.Mm.eg.db)
library(Seurat) # youb know why
library(tidyverse) # base package for data organization and plotting
library(RColorBrewer) # for making palettes
library(gridExtra) # for arranging multiple plots
library(data.table) # well...
library(dslice) # for loading gmt files
```

# GSEA analysis

## preparation

```{r}
table(msigdbr(species = "mouse", category = "C4")$gs_subcat)
```

```{r}
C4_3CA <- load_gmt(file = paste0("functional_analysis/",list.files("functional_analysis/",pattern = "^c4")))
fgsea_sets_3CA <- C4_3CA$gene_symbol
names(fgsea_sets_3CA) <- C4_3CA$set_name
```


```{r prepare gene sets}
H_df<- msigdbr(species = "Mus musculus", category = "H")
Imm_df <- msigdbr(species = "Mus musculus", category = "C7",subcategory = "IMMUNESIGDB")
Celltype_df <- msigdbr(species = "Mus musculus", category = "C8")
C2_KEGG <- msigdbr(species = "Mus musculus", category = "C2",subcategory = "CP:KEGG")
C2_React <- msigdbr(species = "Mus musculus", category = "C2",subcategory = "CP:REACTOME")
CP_df <- msigdbr(species = "Mus musculus", category = "C2",subcategory = "CP")
GO_BP_df <- msigdbr(species = "Mus musculus", category = "C5",subcategory = "GO:BP")
GO_CC_df <- msigdbr(species = "Mus musculus", category = "C5",subcategory = "GO:CC")
GO_MF_df <- msigdbr(species = "Mus musculus", category = "C5",subcategory = "GO:MF")

fgsea_sets_Hallmark <- H_df %>% split(x = .$gene_symbol, f = .$gs_name)
fgsea_sets_Imm <- Imm_df %>% split(x = .$gene_symbol, f = .$gs_name)
fgsea_sets_KEGG <- C2_KEGG %>% split(x = .$gene_symbol, f = .$gs_name)
fgsea_sets_REACT <- C2_React %>% split(x = .$gene_symbol, f = .$gs_name)
fgsea_sets_Celltype <- Celltype_df %>% split(x = .$gene_symbol, f = .$gs_name)
fgsea_sets_CP <- CP_df %>% split(x = .$gene_symbol, f = .$gs_name)
fgsea_sets_GOBP <- GO_BP_df %>% split(x = .$gene_symbol, f = .$gs_name)
fgsea_sets_GOCC <- GO_CC_df %>% split(x = .$gene_symbol, f = .$gs_name)
fgsea_sets_GOMF <- GO_MF_df %>% split(x = .$gene_symbol, f = .$gs_name)
```


```{r additional gene sets}
onco <- msigdbr(species = "Mus musculus", category = "C6")
fgsea_sets_Onco <- onco %>% split(x = .$gene_symbol, f = .$gs_name)
```

```{r}
fgsea_res <- function(cell_type_vector, DE_genes, choose_n = 100, choose_tops = F,gene_set = fgsea_sets_Hallmark,mode = "combined",outdir){
  if(!dir.exists(outdir)) {dir.create(outdir)}
  fgsea_res <- list()
  #DE_selected <- DE_genes %>% group_by(cluster) %>% filter(p_val_adj < 0.05 & abs(avg_log2FC) > 1 & pct.1 > 0.1) %>% mutate(metric = sign(avg_log2FC)*(-log10(p_val_adj))) %>% filter(!is.infinite(metric))
  DE_selected <- DE_genes %>% mutate(metric = sign(avg_log2FC)*(-log10(p_val_adj))) %>% filter(!is.infinite(metric))
  if (mode == "simple"){
    DE_selected <- DE_genes %>% mutate(metric = avg_log2FC) %>% filter(!is.infinite(metric))
  }
  for (i in cell_type_vector) {
    DE <- DE_selected[DE_selected$cluster == i,] %>% arrange(desc(metric)) %>% dplyr::select(gene,metric)
    if (choose_tops){
      DE_top <- DE %>% group_by(cluster) %>% slice_max(order_by = metric, n = choose_n)
      DE_tail <- DE %>% group_by(cluster) %>% slice_min(order_by = metric, n = choose_n)
      DE <- rbind(DE_top,DE_tail)
    }
    DE <- DE %>% arrange(desc(metric)) %>% dplyr::select(gene,metric)
    rankings <- DE$metric
    names(rankings) <- DE$gene
    #print(rankings)
    plot(rankings)
    title(main = i)
    fgseaRes <- fgsea(gene_set, stats = rankings,nPermSimple = 10000)
    fgseaResTidy <- fgseaRes %>%
      as_tibble() %>% filter(padj < 0.05 ) %>%
      arrange(desc(NES))
  fgsea_res[[i]] <- fgseaResTidy
  fwrite(fgseaResTidy, file=paste0(outdir,i,"_fgsea.tsv"), sep="\t", sep2=c("", " ", ""))
  } # need to add name of gene sets to the file name
   return(fgsea_res)
}
```

```{r}
# define path to DE tables
# define path to output files
resdir <- "functional_analysis_V3_alt/"
if (!dir.exists(resdir)) dir.create(resdir)
```

## glioma cells
```{r}
celltype_dir <- "glioma/"
outdir <- paste0(resdir,celltype_dir)
if (!dir.exists(outdir)) dir.create(outdir)
```


```{r load DE genes}
glioma_markers <- read.table(file = paste0("DE_analysis_post_meeting2","/glioma_ann_V1.tsv"),header = T,sep = "\t")
```

 
### Hallmarks

```{r run fgsea over gene sets}
glioma_fgsea_hallmark <- fgsea_res(as.character(unique(glioma_markers$cluster)),glioma_markers,gene_set = fgsea_sets_Hallmark,mode = "simple",outdir = paste0(outdir,"Hallmark/"))
```

```{r consolidate fgsea results}
Hallmark_vector <- names(fgsea_sets_Hallmark)
celltype_vector <- as.character(unique(glioma_markers$cluster))
table_res_glioma <- data.frame(pathway = Hallmark_vector)
for (i in celltype_vector){
  table_tmp <- glioma_fgsea_hallmark[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% Hallmark_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_glioma <- full_join(table_res_glioma,table_celltype,by = "pathway")
}

table_res_glioma[is.na(table_res_glioma)] = 0
table_res_glioma <- table_res_glioma[apply(table_res_glioma[,2:(length(unique(glioma_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_glioma,file = paste0(outdir,"Hallmark/","fgsea_glioma_Hallmark_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### KEGG

```{r run fgsea over gene sets}
glioma_fgsea_KEGG <- fgsea_res(as.character(unique(glioma_markers$cluster)),glioma_markers,gene_set = fgsea_sets_KEGG,mode = "simple",outdir = paste0(outdir,"KEGG/"))
```

```{r consolidate fgsea results}
KEGG_vector <- names(fgsea_sets_KEGG)
celltype_vector <- as.character(unique(glioma_markers$cluster))
table_res_glioma <- data.frame(pathway = KEGG_vector)
for (i in celltype_vector){
  table_tmp <- glioma_fgsea_KEGG[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% KEGG_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_glioma <- full_join(table_res_glioma,table_celltype,by = "pathway")
}

table_res_glioma[is.na(table_res_glioma)] = 0
table_res_glioma <- table_res_glioma[apply(table_res_glioma[,2:(length(unique(glioma_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_glioma,file = paste0(outdir,"KEGG/","fgsea_glioma_KEGG_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### REACTOME

```{r run fgsea over gene sets}
glioma_fgsea_REACT <- fgsea_res(as.character(unique(glioma_markers$cluster)),glioma_markers,gene_set = fgsea_sets_REACT,mode = "simple",outdir = paste0(outdir,"Reactome/"))
```

```{r consolidate fgsea results}
REACT_vector <- names(fgsea_sets_REACT)
celltype_vector <- as.character(unique(glioma_markers$cluster))
table_res_glioma <- data.frame(pathway = REACT_vector)
for (i in celltype_vector){
  table_tmp <- glioma_fgsea_REACT[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% REACT_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_glioma <- full_join(table_res_glioma,table_celltype,by = "pathway")
}

table_res_glioma[is.na(table_res_glioma)] = 0
table_res_glioma <- table_res_glioma[apply(table_res_glioma[,2:(length(unique(glioma_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_glioma,file = paste0(outdir,"Reactome/","fgsea_glioma_REACT_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### 3CA

```{r}
glioma_fgsea_3CA <- fgsea_res(as.character(unique(glioma_markers$cluster)),glioma_markers,gene_set = fgsea_sets_3CA,mode = "simple",outdir = paste0(outdir,"C4_3CA/"))

C4_3CA_vector <- names(fgsea_sets_3CA)
celltype_vector <- as.character(unique(glioma_markers$cluster))
table_res_glioma <- data.frame(pathway = C4_3CA_vector)
for (i in celltype_vector){
  table_tmp <- glioma_fgsea_3CA[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% C4_3CA_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_glioma <- full_join(table_res_glioma,table_celltype,by = "pathway")
}

table_res_glioma[is.na(table_res_glioma)] = 0
table_res_glioma <- table_res_glioma[apply(table_res_glioma[,2:(length(unique(glioma_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_glioma,file = paste0(outdir,"C4_3CA/","fgsea_glioma_C4-3CA_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### Oncogenic

```{r}
glioma_fgsea_Onco <- fgsea_res(as.character(unique(glioma_markers$cluster)),glioma_markers,gene_set = fgsea_sets_Onco,mode = "simple",outdir = paste0(outdir,"Oncogenic/"))

Onco_vector <- names(fgsea_sets_Onco)
celltype_vector <- as.character(unique(glioma_markers$cluster))
table_res_glioma <- data.frame(pathway = Onco_vector)
for (i in celltype_vector){
  table_tmp <- glioma_fgsea_Onco[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% Onco_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_glioma <- full_join(table_res_glioma,table_celltype,by = "pathway")
}

table_res_glioma[is.na(table_res_glioma)] = 0
table_res_glioma <- table_res_glioma[apply(table_res_glioma[,2:(length(unique(glioma_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_glioma,file = paste0(outdir,"Oncogenic/","fgsea_glioma_Onco_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### cell type

```{r}
glioma_fgsea_Celltype <- fgsea_res(as.character(unique(glioma_markers$cluster)),glioma_markers,gene_set = fgsea_sets_Celltype,mode = "simple",outdir = paste0(outdir,"Celltype/"))

CellType_vector <- names(fgsea_sets_Celltype)
celltype_vector <- as.character(unique(glioma_markers$cluster))
table_res_glioma <- data.frame(pathway = CellType_vector)
for (i in celltype_vector){
  table_tmp <- glioma_fgsea_Celltype[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% CellType_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_glioma <- full_join(table_res_glioma,table_celltype,by = "pathway")
}

table_res_glioma[is.na(table_res_glioma)] = 0
table_res_glioma <- table_res_glioma[apply(table_res_glioma[,2:(length(unique(glioma_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_glioma,file = paste0(outdir,"Celltype/","fgsea_glioma_celltype_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

## microglia

```{r}

celltype_dir <- "microglia/"
outdir <- paste0(resdir,celltype_dir)
if (!dir.exists(outdir)) dir.create(outdir)
```

```{r load DE genes}
microglia_markers <- read.table(file = "DE_analysis_post_meeting2/microglia_ann_V2.tsv",header = T,sep = "\t")
```

### Hallmarks

```{r}
microglia_fgsea_hallmark <- fgsea_res(as.character(unique(microglia_markers$cluster)),microglia_markers,gene_set = fgsea_sets_Hallmark,mode = "simple",outdir = paste0(outdir,"Hallmark/"))

Hallmark_vector <- names(fgsea_sets_Hallmark)
celltype_vector <- as.character(unique(microglia_markers$cluster))
table_res_microglia <- data.frame(pathway = Hallmark_vector)
for (i in celltype_vector){
  table_tmp <- microglia_fgsea_hallmark[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% Hallmark_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_microglia <- full_join(table_res_microglia,table_celltype,by = "pathway")
}

table_res_microglia[is.na(table_res_microglia)] = 0
table_res_microglia <- table_res_microglia[apply(table_res_microglia[,2:(length(unique(microglia_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_microglia,file = paste0(outdir,"Hallmark/","fgsea_microglia_Hallmark_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### KEGG 

```{r}
microglia_fgsea_KEGG <- fgsea_res(as.character(unique(microglia_markers$cluster)),microglia_markers,gene_set = fgsea_sets_KEGG,mode = "simple",outdir = paste0(outdir,"KEGG/"))

KEGG_vector <- names(fgsea_sets_KEGG)
celltype_vector <- as.character(unique(microglia_markers$cluster))
table_res_microglia <- data.frame(pathway = KEGG_vector)
for (i in celltype_vector){
  table_tmp <- microglia_fgsea_KEGG[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% KEGG_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_microglia <- full_join(table_res_microglia,table_celltype,by = "pathway")
}

table_res_microglia[is.na(table_res_microglia)] = 0
table_res_microglia <- table_res_microglia[apply(table_res_microglia[,2:(length(unique(microglia_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_microglia,file = paste0(outdir,"KEGG/","fgsea_microglia_KEGG_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### REACT

```{r}
microglia_fgsea_REACT <- fgsea_res(as.character(unique(microglia_markers$cluster)),microglia_markers,gene_set = fgsea_sets_REACT,mode = "simple",outdir = paste0(outdir,"Reactome/"))

REACT_vector <- names(fgsea_sets_REACT)
celltype_vector <- as.character(unique(microglia_markers$cluster))
table_res_microglia <- data.frame(pathway = REACT_vector)
for (i in celltype_vector){
  table_tmp <- microglia_fgsea_REACT[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% REACT_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_microglia <- full_join(table_res_microglia,table_celltype,by = "pathway")
}

table_res_microglia[is.na(table_res_microglia)] = 0
table_res_microglia <- table_res_microglia[apply(table_res_microglia[,2:(length(unique(microglia_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_microglia,file = paste0(outdir,"Reactome/","fgsea_microglia_Reactome_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```


### celltype

```{r}
microglia_fgsea_celltype <- fgsea_res(as.character(unique(microglia_markers$cluster)),microglia_markers,gene_set = fgsea_sets_Celltype,mode = "simple",outdir = paste0(outdir,"Celltype/"))

CellType_vector <- names(fgsea_sets_Celltype)
celltype_vector <- as.character(unique(microglia_markers$cluster))
table_res_microglia <- data.frame(pathway = CellType_vector)
for (i in celltype_vector){
  table_tmp <- microglia_fgsea_celltype[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% CellType_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_microglia <- full_join(table_res_microglia,table_celltype,by = "pathway")
}

table_res_microglia[is.na(table_res_microglia)] = 0
table_res_microglia <- table_res_microglia[apply(table_res_microglia[,2:(length(unique(microglia_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_microglia,file = paste0(outdir,"Celltype/","fgsea_microglia_Celltype_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### immunogenic

```{r}
microglia_fgsea_imm <- fgsea_res(as.character(unique(microglia_markers$cluster)),microglia_markers,gene_set = fgsea_sets_Imm,mode = "simple",outdir = paste0(outdir,"Immunogenic/"))

imm_vector <- names(fgsea_sets_Imm)
celltype_vector <- as.character(unique(microglia_markers$cluster))
table_res_microglia <- data.frame(pathway = imm_vector)
for (i in celltype_vector){
  table_tmp <- microglia_fgsea_imm[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% imm_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_microglia <- full_join(table_res_microglia,table_celltype,by = "pathway")
}

table_res_microglia[is.na(table_res_microglia)] = 0
table_res_microglia <- table_res_microglia[apply(table_res_microglia[,2:(length(unique(microglia_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_microglia,file = paste0(outdir,"Immunogenic/","fgsea_microglia_Immunogenic_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

## Mo-Mph

```{r}

celltype_dir <- "Mo-Mac/"
outdir <- paste0(resdir,celltype_dir)
dir.create(outdir)
```


```{r load DE genes}
myeloid_markers <- read.table(file = "DE_analysis_post_meeting2/Mo_Mph_ann_V2.tsv",header = T,sep = "\t")
```

### Hallmarks

```{r}
myeloid_fgsea_hallmark <- fgsea_res(as.character(unique(myeloid_markers$cluster)),myeloid_markers,gene_set = fgsea_sets_Hallmark,mode = "simple",outdir = paste0(outdir,"Hallmark/"))

Hallmark_vector <- names(fgsea_sets_Hallmark)
celltype_vector <- as.character(unique(myeloid_markers$cluster))
table_res_myeloid <- data.frame(pathway = Hallmark_vector)
for (i in celltype_vector){
  table_tmp <- myeloid_fgsea_hallmark[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% Hallmark_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_myeloid <- full_join(table_res_myeloid,table_celltype,by = "pathway")
}

table_res_myeloid[is.na(table_res_myeloid)] = 0
table_res_myeloid <- table_res_myeloid[apply(table_res_myeloid[,2:(length(unique(myeloid_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_myeloid,file = paste0(outdir,"Hallmark/","fgsea_myeloid_Hallmark_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### KEGG 

```{r}
myeloid_fgsea_KEGG <- fgsea_res(as.character(unique(myeloid_markers$cluster)),myeloid_markers,gene_set = fgsea_sets_KEGG,mode = "simple",outdir = paste0(outdir,"KEGG/"))

KEGG_vector <- names(fgsea_sets_KEGG)
celltype_vector <- as.character(unique(myeloid_markers$cluster))
table_res_myeloid <- data.frame(pathway = KEGG_vector)
for (i in celltype_vector){
  table_tmp <- myeloid_fgsea_KEGG[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% KEGG_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_myeloid <- full_join(table_res_myeloid,table_celltype,by = "pathway")
}

table_res_myeloid[is.na(table_res_myeloid)] = 0
table_res_myeloid <- table_res_myeloid[apply(table_res_myeloid[,2:(length(unique(myeloid_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_myeloid,file = paste0(outdir,"KEGG/","fgsea_myeloid_KEGG_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### REACT

```{r}
myeloid_fgsea_REACT <- fgsea_res(as.character(unique(myeloid_markers$cluster)),myeloid_markers,gene_set = fgsea_sets_REACT,mode = "simple",outdir = paste0(outdir,"Reactome/"))

REACT_vector <- names(fgsea_sets_REACT)
celltype_vector <- as.character(unique(myeloid_markers$cluster))
table_res_myeloid <- data.frame(pathway = REACT_vector)
for (i in celltype_vector){
  table_tmp <- myeloid_fgsea_REACT[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% REACT_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_myeloid <- full_join(table_res_myeloid,table_celltype,by = "pathway")
}

table_res_myeloid[is.na(table_res_myeloid)] = 0
table_res_myeloid <- table_res_myeloid[apply(table_res_myeloid[,2:(length(unique(myeloid_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_myeloid,file = paste0(outdir,"Reactome/","fgsea_myeloid_Reactome_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```


### celltype

```{r}
myeloid_fgsea_celltype <- fgsea_res(as.character(unique(myeloid_markers$cluster)),myeloid_markers,gene_set = fgsea_sets_Celltype,mode = "simple",outdir = paste0(outdir,"Celltype/"))

CellType_vector <- names(fgsea_sets_Celltype)
celltype_vector <- as.character(unique(myeloid_markers$cluster))
table_res_myeloid <- data.frame(pathway = CellType_vector)
for (i in celltype_vector){
  table_tmp <- myeloid_fgsea_celltype[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% CellType_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_myeloid <- full_join(table_res_myeloid,table_celltype,by = "pathway")
}

table_res_myeloid[is.na(table_res_myeloid)] = 0
table_res_myeloid <- table_res_myeloid[apply(table_res_myeloid[,2:(length(unique(myeloid_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_myeloid,file = paste0(outdir,"Celltype/","fgsea_myeloid_Celltype_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### immunogenic

```{r}
myeloid_fgsea_imm <- fgsea_res(as.character(unique(myeloid_markers$cluster)),myeloid_markers,gene_set = fgsea_sets_Imm,mode = "simple",outdir = paste0(outdir,"Immunogenic/"))

imm_vector <- names(fgsea_sets_Imm)
celltype_vector <- as.character(unique(myeloid_markers$cluster))
table_res_myeloid <- data.frame(pathway = imm_vector)
for (i in celltype_vector){
  table_tmp <- myeloid_fgsea_imm[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% imm_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_myeloid <- full_join(table_res_myeloid,table_celltype,by = "pathway")
}

table_res_myeloid[is.na(table_res_myeloid)] = 0
table_res_myeloid <- table_res_myeloid[apply(table_res_myeloid[,2:(length(unique(myeloid_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_myeloid,file = paste0(outdir,"Immunogenic/","fgsea_myeloid_Immunogenic_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

## lymphoid: B cells

```{r}

celltype_dir <- "B_cells/"
outdir <- paste0(resdir,celltype_dir)
dir.create(outdir)
```


```{r load DE genes}
lymphoid_markers <- read.table(file = "DE_analysis_post_meeting2/B_cells_ann_V2.tsv",header = T,sep = "\t")
```

### Hallmarks

```{r}
lymphoid_fgsea_hallmark <- fgsea_res(as.character(unique(lymphoid_markers$cluster)),lymphoid_markers,gene_set = fgsea_sets_Hallmark,mode = "simple",outdir = paste0(outdir,"Hallmark/"))

Hallmark_vector <- names(fgsea_sets_Hallmark)
celltype_vector <- as.character(unique(lymphoid_markers$cluster))
table_res_lymphoid <- data.frame(pathway = Hallmark_vector)
for (i in celltype_vector){
  table_tmp <- lymphoid_fgsea_hallmark[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% Hallmark_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_lymphoid <- full_join(table_res_lymphoid,table_celltype,by = "pathway")
}

table_res_lymphoid[is.na(table_res_lymphoid)] = 0
table_res_lymphoid <- table_res_lymphoid[apply(table_res_lymphoid[,2:(length(unique(lymphoid_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_lymphoid,file = paste0(outdir,"Hallmark/","fgsea_lymphoid_Hallmark_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### KEGG 

```{r}
lymphoid_fgsea_KEGG <- fgsea_res(as.character(unique(lymphoid_markers$cluster)),lymphoid_markers,gene_set = fgsea_sets_KEGG,mode = "simple",outdir = paste0(outdir,"KEGG/"))

KEGG_vector <- names(fgsea_sets_KEGG)
celltype_vector <- as.character(unique(lymphoid_markers$cluster))
table_res_lymphoid <- data.frame(pathway = KEGG_vector)
for (i in celltype_vector){
  table_tmp <- lymphoid_fgsea_KEGG[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% KEGG_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_lymphoid <- full_join(table_res_lymphoid,table_celltype,by = "pathway")
}

table_res_lymphoid[is.na(table_res_lymphoid)] = 0
table_res_lymphoid <- table_res_lymphoid[apply(table_res_lymphoid[,2:(length(unique(lymphoid_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_lymphoid,file = paste0(outdir,"KEGG/","fgsea_lymphoid_KEGG_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### REACT

```{r}
lymphoid_fgsea_REACT <- fgsea_res(as.character(unique(lymphoid_markers$cluster)),lymphoid_markers,gene_set = fgsea_sets_REACT,mode = "simple",outdir = paste0(outdir,"Reactome/"))

REACT_vector <- names(fgsea_sets_REACT)
celltype_vector <- as.character(unique(lymphoid_markers$cluster))
table_res_lymphoid <- data.frame(pathway = REACT_vector)
for (i in celltype_vector){
  table_tmp <- lymphoid_fgsea_REACT[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% REACT_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_lymphoid <- full_join(table_res_lymphoid,table_celltype,by = "pathway")
}

table_res_lymphoid[is.na(table_res_lymphoid)] = 0
table_res_lymphoid <- table_res_lymphoid[apply(table_res_lymphoid[,2:(length(unique(lymphoid_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_lymphoid,file = paste0(outdir,"Reactome/","fgsea_lymphoid_Reactome_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### celltype

```{r}
lymphoid_fgsea_celltype <- fgsea_res(as.character(unique(lymphoid_markers$cluster)),lymphoid_markers,gene_set = fgsea_sets_Celltype,mode = "simple",outdir = paste0(outdir,"Celltype/"))

CellType_vector <- names(fgsea_sets_Celltype)
celltype_vector <- as.character(unique(lymphoid_markers$cluster))
table_res_lymphoid <- data.frame(pathway = CellType_vector)
for (i in celltype_vector){
  table_tmp <- lymphoid_fgsea_celltype[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% CellType_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_lymphoid <- full_join(table_res_lymphoid,table_celltype,by = "pathway")
}

table_res_lymphoid[is.na(table_res_lymphoid)] = 0
table_res_lymphoid <- table_res_lymphoid[apply(table_res_lymphoid[,2:(length(unique(lymphoid_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_lymphoid,file = paste0(outdir,"Celltype/","fgsea_lymphoid_Celltype_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### immunogenic

```{r}
lymphoid_fgsea_imm <- fgsea_res(as.character(unique(lymphoid_markers$cluster)),lymphoid_markers,gene_set = fgsea_sets_Imm,mode = "simple",outdir = paste0(outdir,"Immunogenic/"))

imm_vector <- names(fgsea_sets_Imm)
celltype_vector <- as.character(unique(lymphoid_markers$cluster))
table_res_lymphoid <- data.frame(pathway = imm_vector)
for (i in celltype_vector){
  table_tmp <- lymphoid_fgsea_imm[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% imm_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_lymphoid <- full_join(table_res_lymphoid,table_celltype,by = "pathway")
}

table_res_lymphoid[is.na(table_res_lymphoid)] = 0
table_res_lymphoid <- table_res_lymphoid[apply(table_res_lymphoid[,2:(length(unique(lymphoid_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_lymphoid,file = paste0(outdir,"Immunogenic/","fgsea_lymphoid_Immunogenic_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```


## lymphoid: T cells

```{r}

celltype_dir <- "T_cells/"
outdir <- paste0(resdir,celltype_dir)
dir.create(outdir)
```


```{r load DE genes}
lymphoid_markers <- read.table(file = "DE_analysis_post_meeting2/T_cells_ann_V2.tsv",header = T,sep = "\t")
```

### Hallmarks

```{r}
lymphoid_fgsea_hallmark <- fgsea_res(as.character(unique(lymphoid_markers$cluster)),lymphoid_markers,gene_set = fgsea_sets_Hallmark,mode = "simple",outdir = paste0(outdir,"Hallmark/"))

Hallmark_vector <- names(fgsea_sets_Hallmark)
celltype_vector <- as.character(unique(lymphoid_markers$cluster))
table_res_lymphoid <- data.frame(pathway = Hallmark_vector)
for (i in celltype_vector){
  table_tmp <- lymphoid_fgsea_hallmark[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% Hallmark_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_lymphoid <- full_join(table_res_lymphoid,table_celltype,by = "pathway")
}

table_res_lymphoid[is.na(table_res_lymphoid)] = 0
table_res_lymphoid <- table_res_lymphoid[apply(table_res_lymphoid[,2:(length(unique(lymphoid_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_lymphoid,file = paste0(outdir,"Hallmark/","fgsea_lymphoid_Hallmark_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### KEGG 

```{r}
lymphoid_fgsea_KEGG <- fgsea_res(as.character(unique(lymphoid_markers$cluster)),lymphoid_markers,gene_set = fgsea_sets_KEGG,mode = "simple",outdir = paste0(outdir,"KEGG/"))

KEGG_vector <- names(fgsea_sets_KEGG)
celltype_vector <- as.character(unique(lymphoid_markers$cluster))
table_res_lymphoid <- data.frame(pathway = KEGG_vector)
for (i in celltype_vector){
  table_tmp <- lymphoid_fgsea_KEGG[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% KEGG_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_lymphoid <- full_join(table_res_lymphoid,table_celltype,by = "pathway")
}

table_res_lymphoid[is.na(table_res_lymphoid)] = 0
table_res_lymphoid <- table_res_lymphoid[apply(table_res_lymphoid[,2:(length(unique(lymphoid_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_lymphoid,file = paste0(outdir,"KEGG/","fgsea_lymphoid_KEGG_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### REACT

```{r}
lymphoid_fgsea_REACT <- fgsea_res(as.character(unique(lymphoid_markers$cluster)),lymphoid_markers,gene_set = fgsea_sets_REACT,mode = "simple",outdir = paste0(outdir,"Reactome/"))

REACT_vector <- names(fgsea_sets_REACT)
celltype_vector <- as.character(unique(lymphoid_markers$cluster))
table_res_lymphoid <- data.frame(pathway = REACT_vector)
for (i in celltype_vector){
  table_tmp <- lymphoid_fgsea_REACT[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% REACT_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_lymphoid <- full_join(table_res_lymphoid,table_celltype,by = "pathway")
}

table_res_lymphoid[is.na(table_res_lymphoid)] = 0
table_res_lymphoid <- table_res_lymphoid[apply(table_res_lymphoid[,2:(length(unique(lymphoid_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_lymphoid,file = paste0(outdir,"Reactome/","fgsea_lymphoid_Reactome_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### celltype

```{r}
lymphoid_fgsea_celltype <- fgsea_res(as.character(unique(lymphoid_markers$cluster)),lymphoid_markers,gene_set = fgsea_sets_Celltype,mode = "simple",outdir = paste0(outdir,"Celltype/"))

CellType_vector <- names(fgsea_sets_Celltype)
celltype_vector <- as.character(unique(lymphoid_markers$cluster))
table_res_lymphoid <- data.frame(pathway = CellType_vector)
for (i in celltype_vector){
  table_tmp <- lymphoid_fgsea_celltype[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% CellType_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_lymphoid <- full_join(table_res_lymphoid,table_celltype,by = "pathway")
}

table_res_lymphoid[is.na(table_res_lymphoid)] = 0
table_res_lymphoid <- table_res_lymphoid[apply(table_res_lymphoid[,2:(length(unique(lymphoid_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_lymphoid,file = paste0(outdir,"Celltype/","fgsea_lymphoid_Celltype_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### immunogenic

```{r}
lymphoid_fgsea_imm <- fgsea_res(as.character(unique(lymphoid_markers$cluster)),lymphoid_markers,gene_set = fgsea_sets_Imm,mode = "simple",outdir = paste0(outdir,"Immunogenic/"))

imm_vector <- names(fgsea_sets_Imm)
celltype_vector <- as.character(unique(lymphoid_markers$cluster))
table_res_lymphoid <- data.frame(pathway = imm_vector)
for (i in celltype_vector){
  table_tmp <- lymphoid_fgsea_imm[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% imm_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_lymphoid <- full_join(table_res_lymphoid,table_celltype,by = "pathway")
}

table_res_lymphoid[is.na(table_res_lymphoid)] = 0
table_res_lymphoid <- table_res_lymphoid[apply(table_res_lymphoid[,2:(length(unique(lymphoid_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_lymphoid,file = paste0(outdir,"Immunogenic/","fgsea_lymphoid_Immunogenic_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```



## neuronal/resident: OLG

```{r}

celltype_dir <- "OLG/"
outdir <- paste0(resdir,celltype_dir)
dir.create(outdir)
```


```{r load DE genes}
neuronal_markers <- read.table(file = "DE_analysis_post_meeting2/OLG_ann_V2.tsv",header = T,sep = "\t")
```

### Hallmarks

```{r}
neuronal_fgsea_hallmark <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Hallmark,mode = "simple",outdir = paste0(outdir,"Hallmark/"))

Hallmark_vector <- names(fgsea_sets_Hallmark)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = Hallmark_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_hallmark[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% Hallmark_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Hallmark/","fgsea_OLG_Hallmark_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### KEGG 

```{r}
neuronal_fgsea_KEGG <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_KEGG,mode = "simple",outdir = paste0(outdir,"KEGG/"))

KEGG_vector <- names(fgsea_sets_KEGG)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = KEGG_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_KEGG[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% KEGG_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"KEGG/","fgsea_OLG_KEGG_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### REACT

```{r}
neuronal_fgsea_REACT <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_REACT,mode = "simple",outdir = paste0(outdir,"Reactome/"))

REACT_vector <- names(fgsea_sets_REACT)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = REACT_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_REACT[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% REACT_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Reactome/","fgsea_OLG_Reactome_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### celltype

```{r}
neuronal_fgsea_celltype <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Celltype,mode = "simple",outdir = paste0(outdir,"Celltype/"))

CellType_vector <- names(fgsea_sets_Celltype)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = CellType_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_celltype[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% CellType_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Celltype/","fgsea_OLG_Celltype_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### immunogenic

```{r}
neuronal_fgsea_imm <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Imm,mode = "simple",outdir = paste0(outdir,"Immunogenic/"))

imm_vector <- names(fgsea_sets_Imm)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = imm_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_imm[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% imm_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Immunogenic/","fgsea_OLG_Immunogenic_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```



## neuronal/resident: AST

```{r}

celltype_dir <- "AST/"
outdir <- paste0(resdir,celltype_dir)
dir.create(outdir)
```


```{r load DE genes}
neuronal_markers <- read.table(file = "DE_analysis_post_meeting2/AST_ann_V2.tsv",header = T,sep = "\t")
```

### Hallmarks

```{r}
neuronal_fgsea_hallmark <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Hallmark,mode = "simple",outdir = paste0(outdir,"Hallmark/"))

Hallmark_vector <- names(fgsea_sets_Hallmark)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = Hallmark_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_hallmark[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% Hallmark_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Hallmark/","fgsea_AST_Hallmark_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### KEGG 

```{r}
neuronal_fgsea_KEGG <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_KEGG,mode = "simple",outdir = paste0(outdir,"KEGG/"))

KEGG_vector <- names(fgsea_sets_KEGG)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = KEGG_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_KEGG[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% KEGG_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"KEGG/","fgsea_AST_KEGG_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### REACT

```{r}
neuronal_fgsea_REACT <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_REACT,mode = "simple",outdir = paste0(outdir,"Reactome/"))

REACT_vector <- names(fgsea_sets_REACT)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = REACT_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_REACT[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% REACT_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Reactome/","fgsea_AST_Reactome_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### celltype

```{r}
neuronal_fgsea_celltype <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Celltype,mode = "simple",outdir = paste0(outdir,"Celltype/"))

CellType_vector <- names(fgsea_sets_Celltype)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = CellType_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_celltype[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% CellType_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Celltype/","fgsea_AST_Celltype_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### immunogenic

```{r}
neuronal_fgsea_imm <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Imm,mode = "simple",outdir = paste0(outdir,"Immunogenic/"))

imm_vector <- names(fgsea_sets_Imm)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = imm_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_imm[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% imm_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Immunogenic/","fgsea_AST_Immunogenic_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```






## neuronal/resident: EPD

```{r}

celltype_dir <- "EPD/"
outdir <- paste0(resdir,celltype_dir)
dir.create(outdir)
```


```{r load DE genes}
neuronal_markers <- read.table(file = "DE_analysis_post_meeting2/EPD_ann_V2.tsv",header = T,sep = "\t")
```

### Hallmarks

```{r}
neuronal_fgsea_hallmark <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Hallmark,mode = "simple",outdir = paste0(outdir,"Hallmark/"))

Hallmark_vector <- names(fgsea_sets_Hallmark)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = Hallmark_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_hallmark[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% Hallmark_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Hallmark/","fgsea_EPD_Hallmark_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### KEGG 

```{r}
neuronal_fgsea_KEGG <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_KEGG,mode = "simple",outdir = paste0(outdir,"KEGG/"))

KEGG_vector <- names(fgsea_sets_KEGG)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = KEGG_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_KEGG[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% KEGG_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"KEGG/","fgsea_EPD_KEGG_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### REACT

```{r}
neuronal_fgsea_REACT <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_REACT,mode = "simple",outdir = paste0(outdir,"Reactome/"))

REACT_vector <- names(fgsea_sets_REACT)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = REACT_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_REACT[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% REACT_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Reactome/","fgsea_EPD_Reactome_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### celltype (no need to run)

```{r}
neuronal_fgsea_celltype <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Celltype,mode = "simple",outdir = paste0(outdir,"Celltype/"))

CellType_vector <- names(fgsea_sets_Celltype)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = CellType_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_celltype[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% CellType_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Celltype/","fgsea_EPD_Celltype_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### immunogenic

```{r}
neuronal_fgsea_imm <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Imm,mode = "simple",outdir = paste0(outdir,"Immunogenic/"))

imm_vector <- names(fgsea_sets_Imm)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = imm_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_imm[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% imm_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Immunogenic/","fgsea_EPD_Immunogenic_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```







## neuronal/resident: Prog

```{r}

celltype_dir <- "Prog/"
outdir <- paste0(resdir,celltype_dir)
dir.create(outdir)
```


```{r load DE genes}
neuronal_markers <- read.table(file = "DE_analysis_post_meeting2/Prog_ann_V2.tsv",header = T,sep = "\t")
```

### Hallmarks

```{r}
neuronal_fgsea_hallmark <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Hallmark,mode = "simple",outdir = paste0(outdir,"Hallmark/"))

Hallmark_vector <- names(fgsea_sets_Hallmark)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = Hallmark_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_hallmark[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% Hallmark_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Hallmark/","fgsea_Prog_Hallmark_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### KEGG 

```{r}
neuronal_fgsea_KEGG <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_KEGG,mode = "simple",outdir = paste0(outdir,"KEGG/"))

KEGG_vector <- names(fgsea_sets_KEGG)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = KEGG_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_KEGG[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% KEGG_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"KEGG/","fgsea_Prog_KEGG_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### REACT

```{r}
neuronal_fgsea_REACT <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_REACT,mode = "simple",outdir = paste0(outdir,"Reactome/"))

REACT_vector <- names(fgsea_sets_REACT)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = REACT_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_REACT[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% REACT_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Reactome/","fgsea_Prog_Reactome_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### celltype (no need to run)

```{r}
neuronal_fgsea_celltype <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Celltype,mode = "simple",outdir = paste0(outdir,"Celltype/"))

CellType_vector <- names(fgsea_sets_Celltype)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = CellType_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_celltype[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% CellType_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Celltype/","fgsea_Prog_Celltype_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### immunogenic

```{r}
neuronal_fgsea_imm <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Imm,mode = "simple",outdir = paste0(outdir,"Immunogenic/"))

imm_vector <- names(fgsea_sets_Imm)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = imm_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_imm[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% imm_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Immunogenic/","fgsea_Prog_Immunogenic_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```








## neuronal/resident: Neu

```{r}

celltype_dir <- "Neu/"
outdir <- paste0(resdir,celltype_dir)
dir.create(outdir)
```


```{r load DE genes}
neuronal_markers <- read.table(file = "DE_analysis_post_meeting2/Neu_ann_V2.tsv",header = T,sep = "\t")
```

### Hallmarks

```{r}
neuronal_fgsea_hallmark <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Hallmark,mode = "simple",outdir = paste0(outdir,"Hallmark/"))

Hallmark_vector <- names(fgsea_sets_Hallmark)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = Hallmark_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_hallmark[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% Hallmark_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Hallmark/","fgsea_Neu_Hallmark_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### KEGG 

```{r}
neuronal_fgsea_KEGG <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_KEGG,mode = "simple",outdir = paste0(outdir,"KEGG/"))

KEGG_vector <- names(fgsea_sets_KEGG)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = KEGG_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_KEGG[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% KEGG_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"KEGG/","fgsea_Neu_KEGG_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### REACT

```{r}
neuronal_fgsea_REACT <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_REACT,mode = "simple",outdir = paste0(outdir,"Reactome/"))

REACT_vector <- names(fgsea_sets_REACT)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = REACT_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_REACT[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% REACT_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Reactome/","fgsea_Neu_Reactome_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### celltype (no need to run)

```{r}
neuronal_fgsea_celltype <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Celltype,mode = "simple",outdir = paste0(outdir,"Celltype/"))

CellType_vector <- names(fgsea_sets_Celltype)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = CellType_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_celltype[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% CellType_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Celltype/","fgsea_Neu_Celltype_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### immunogenic

```{r}
neuronal_fgsea_imm <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Imm,mode = "simple",outdir = paste0(outdir,"Immunogenic/"))

imm_vector <- names(fgsea_sets_Imm)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = imm_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_imm[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% imm_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Immunogenic/","fgsea_Neu_Immunogenic_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```









## stromal/vascular: EC

```{r}

celltype_dir <- "EC/"
outdir <- paste0(resdir,celltype_dir)
dir.create(outdir)
```


```{r load DE genes}
neuronal_markers <- read.table(file = "DE_analysis_post_meeting2/EC_ann_V2.tsv",header = T,sep = "\t")
```

### Hallmarks

```{r}
neuronal_fgsea_hallmark <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Hallmark,mode = "simple",outdir = paste0(outdir,"Hallmark/"))

Hallmark_vector <- names(fgsea_sets_Hallmark)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = Hallmark_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_hallmark[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% Hallmark_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Hallmark/","fgsea_EC_Hallmark_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### KEGG 

```{r}
neuronal_fgsea_KEGG <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_KEGG,mode = "simple",outdir = paste0(outdir,"KEGG/"))

KEGG_vector <- names(fgsea_sets_KEGG)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = KEGG_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_KEGG[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% KEGG_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"KEGG/","fgsea_EC_KEGG_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### REACT

```{r}
neuronal_fgsea_REACT <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_REACT,mode = "simple",outdir = paste0(outdir,"Reactome/"))

REACT_vector <- names(fgsea_sets_REACT)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = REACT_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_REACT[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% REACT_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Reactome/","fgsea_EC_Reactome_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### celltype (no need to run)

```{r}
neuronal_fgsea_celltype <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Celltype,mode = "simple",outdir = paste0(outdir,"Celltype/"))

CellType_vector <- names(fgsea_sets_Celltype)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = CellType_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_celltype[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% CellType_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Celltype/","fgsea_EC_Celltype_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### immunogenic

```{r}
neuronal_fgsea_imm <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Imm,mode = "simple",outdir = paste0(outdir,"Immunogenic/"))

imm_vector <- names(fgsea_sets_Imm)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = imm_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_imm[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% imm_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Immunogenic/","fgsea_EC_Immunogenic_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```









## stromal/vascular: Fib

```{r}

celltype_dir <- "Fib/"
outdir <- paste0(resdir,celltype_dir)
dir.create(outdir)
```


```{r load DE genes}
neuronal_markers <- read.table(file = "DE_analysis_post_meeting2/Fib_ann_V2.tsv",header = T,sep = "\t")
```

### Hallmarks

```{r}
neuronal_fgsea_hallmark <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Hallmark,mode = "simple",outdir = paste0(outdir,"Hallmark/"))

Hallmark_vector <- names(fgsea_sets_Hallmark)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = Hallmark_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_hallmark[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% Hallmark_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Hallmark/","fgsea_Fib_Hallmark_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### KEGG 

```{r}
neuronal_fgsea_KEGG <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_KEGG,mode = "simple",outdir = paste0(outdir,"KEGG/"))

KEGG_vector <- names(fgsea_sets_KEGG)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = KEGG_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_KEGG[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% KEGG_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"KEGG/","fgsea_Fib_KEGG_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### REACT

```{r}
neuronal_fgsea_REACT <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_REACT,mode = "simple",outdir = paste0(outdir,"Reactome/"))

REACT_vector <- names(fgsea_sets_REACT)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = REACT_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_REACT[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% REACT_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Reactome/","fgsea_Fib_Reactome_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### celltype (no need to run)

```{r}
neuronal_fgsea_celltype <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Celltype,mode = "simple",outdir = paste0(outdir,"Celltype/"))

CellType_vector <- names(fgsea_sets_Celltype)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = CellType_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_celltype[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% CellType_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Celltype/","fgsea_Fib_Celltype_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### immunogenic

```{r}
neuronal_fgsea_imm <- fgsea_res(as.character(unique(neuronal_markers$cluster)),neuronal_markers,gene_set = fgsea_sets_Imm,mode = "simple",outdir = paste0(outdir,"Immunogenic/"))

imm_vector <- names(fgsea_sets_Imm)
celltype_vector <- as.character(unique(neuronal_markers$cluster))
table_res_neuronal <- data.frame(pathway = imm_vector)
for (i in celltype_vector){
  table_tmp <- neuronal_fgsea_imm[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% imm_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_neuronal <- full_join(table_res_neuronal,table_celltype,by = "pathway")
}

table_res_neuronal[is.na(table_res_neuronal)] = 0
table_res_neuronal <- table_res_neuronal[apply(table_res_neuronal[,2:(length(unique(neuronal_markers$cluster))+1)],1,var) != 0,]

write.table(table_res_neuronal,file = paste0(outdir,"Immunogenic/","fgsea_Fib_Immunogenic_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```


# cross condition DE analysis for commonly existing clusters: volvano plot

## Tumors

### Tumor 4

```{r}
NT_LGG <- read.table(file = "DE_analysis_post_meeting2/Glioma_LGG_vs_No tumor_tumor_4.tsv",header = T,sep = "\t")
```

```{r}
g <- ggplot(NT_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("LGG_vs_NT_tumor_4_volcano.pdf",plot = g, width = 10, height = 10)
```

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Glioma_HGG_vs_LGG_tumor_4.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_tumor_4_volcano.pdf",plot = g, width = 10, height = 10)
```
### tumor 1

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Glioma_HGG_vs_LGG_tumor_1.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_tumor_1_volcano.pdf",plot = g, width = 10, height = 10)
```

### tumor 11

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Glioma_HGG_vs_LGG_tumor_11.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_tumor_11_volcano.pdf",plot = g, width = 10, height = 10)
```

### tumor 2

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Glioma_HGG_vs_LGG_tumor_2.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_tumor_2_volcano.pdf",plot = g, width = 10, height = 10)
```

### tumor 5

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Glioma_HGG_vs_LGG_tumor_5.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_tumor_5_volcano.pdf",plot = g, width = 10, height = 10)
```
### tumor 6

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Glioma_HGG_vs_LGG_tumor_6.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_tumor_6_volcano.pdf",plot = g, width = 10, height = 10)
```

### tumor 7

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Glioma_HGG_vs_LGG_tumor_7.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_tumor_7_volcano.pdf",plot = g, width = 10, height = 10)
```
### tumor 8

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Glioma_HGG_vs_LGG_tumor_8.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_tumor_8_volcano.pdf",plot = g, width = 10, height = 10)
```

### tumor 9

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Glioma_HGG_vs_LGG_tumor_9.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_tumor_9_volcano.pdf",plot = g, width = 10, height = 10)
```

## microglia

### HET unknown MG

```{r}
NT_LGG <- read.table(file = "DE_analysis_post_meeting2/MG_LGG_vs_No tumor_HET_unknown_MG.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("LGG_vs_NT_HET_unknown_MG_volcano.pdf",plot = g, width = 10, height = 10)
```

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/MG_HGG_vs_LGG_HET_unknown_MG.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_HET_unknown_MG_volcano.pdf",plot = g, width = 10, height = 10)
```
### NT-HIGH_Trem2_Ccr6_high_MG

```{r}
NT_LGG <- read.table(file = "DE_analysis_post_meeting2/MG_LGG_vs_No tumor_NT-HIGH_Trem2_Ccr6_high_MG.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("LGG_vs_NT_NT-HIGH_Trem2_Ccr6_high_MG_volcano.pdf",plot = g, width = 10, height = 10)
```

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/MG_HGG_vs_LGG_NT-HIGH_Trem2_Ccr6_high_MG.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_NT-HIGH_Trem2_Ccr6_high_MG_volcano.pdf",plot = g, width = 10, height = 10)
```


### NT-HIGH_Fosb_Dusp1_high_MG

```{r}
NT_LGG <- read.table(file = "DE_analysis_post_meeting2/MG_LGG_vs_No tumor_NT-HIGH_Fosb_Dusp1_high_MG.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("LGG_vs_NT_NT-HIGH_Fosb_Dusp1_high_MG_volcano.pdf",plot = g, width = 10, height = 10)
```

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/MG_HGG_vs_LGG_NT-HIGH_Fosb_Dusp1_high_MG.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_NT-HIGH_Fosb_Dusp1_high_MG_volcano.pdf",plot = g, width = 10, height = 10)
```

### HGG-HIGH_Chst2_high_MG

```{r}
NT_LGG <- read.table(file = "DE_analysis_post_meeting2/MG_LGG_vs_No tumor_HGG-HIGH_Chst2_high_MG.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("LGG_vs_NT_HGG-HIGH_Chst2_high_MG_volcano.pdf",plot = g, width = 10, height = 10)
```

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/MG_HGG_vs_LGG_HGG-HIGH_Chst2_high_MG.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_HGG-HIGH_Chst2_high_MG_volcano.pdf",plot = g, width = 10, height = 10)
```

### LGG-HIGH_Ifn-responsive_MG

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/MG_HGG_vs_LGG_LGG-HIGH_Ifn-responsive_MG.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_LGG-HIGH_Ifn-responsive_MG_volcano.pdf",plot = g, width = 10, height = 10)
```

### LGG-HIGH_Il7r_Hspa1a_high_MG

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/MG_HGG_vs_LGG_LGG-HIGH_Ifn-responsive_MG.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_LGG-HIGH_Ifn-responsive_MG_volcano.pdf",plot = g, width = 10, height = 10)
```

### LGG-HIGH_Nr4a1_Fos_high_MG

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/MG_HGG_vs_LGG_LGG-HIGH_Nr4a1_Fos_high_MG.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_LGG-HIGH_Nr4a1_Fos_high_MG_volcano.pdf",plot = g, width = 10, height = 10)
```
## lymphoid

### Pdcd1_Cd44_high_activated_T

```{r}
NT_LGG <- read.table(file = "DE_analysis_post_meeting2/Lymphoid_LGG_vs_No tumor_Pdcd1_Cd44_high_activated_T.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("LGG_vs_NT_Pdcd1_Cd44_high_activated_T_volcano.pdf",plot = g, width = 10, height = 10)
```

### NKT

```{r}
NT_LGG <- read.table(file = "DE_analysis_post_meeting2/Lymphoid_LGG_vs_No tumor_NKT.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("LGG_vs_NT_NKT_volcano.pdf",plot = g, width = 10, height = 10)
```


### NK

```{r}
NT_LGG <- read.table(file = "DE_analysis_post_meeting2/Lymphoid_LGG_vs_No tumor_NK.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("LGG_vs_NT_NK_volcano.pdf",plot = g, width = 10, height = 10)
```


### 0_activated_CD8

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Lymphoid_HGG_vs_LGG_0_activated_CD8.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_0_activated_CD8_volcano.pdf",plot = g, width = 10, height = 10)
```

### 1_activated_CD4
```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Lymphoid_HGG_vs_LGG_1_activated_CD4.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_1_activated_CD4_volcano.pdf",plot = g, width = 10, height = 10)
```

### Naive_T_cells

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Lymphoid_HGG_vs_LGG_Naive_T_cells.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_Naive_T_cells_volcano.pdf",plot = g, width = 10, height = 10)
```

## myeloid (excluding small populations)

### MHC2_low_BAM

```{r}
NT_LGG <- read.table(file = "DE_analysis_post_meeting2/Myeloid_LGG_vs_No tumor_MHC2_low_BAM.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("LGG_vs_NT_MHC2_low_BAM_volcano.pdf",plot = g, width = 10, height = 10)
```

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Myeloid_HGG_vs_LGG_MHC2_low_BAM.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_MHC2_low_BAM_volcano.pdf",plot = g, width = 10, height = 10)
```


### MHC2_high_BAM

```{r}
NT_LGG <- read.table(file = "DE_analysis_post_meeting2/Myeloid_LGG_vs_No tumor_MHC2_high_BAM.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("LGG_vs_NT_MHC2_high_BAM_volcano.pdf",plot = g, width = 10, height = 10)
```

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Myeloid_HGG_vs_LGG_MHC2_high_BAM.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_MHC2_high_BAM_volcano.pdf",plot = g, width = 10, height = 10)
```


### Slamf9_macrophage

```{r}
NT_LGG <- read.table(file = "DE_analysis_post_meeting2/Myeloid_LGG_vs_No tumor_Slamf9_macrophage.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("LGG_vs_NT_Slamf9_macrophage_volcano.pdf",plot = g, width = 10, height = 10)
```

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Myeloid_HGG_vs_LGG_Slamf9_macrophage.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_Slamf9_macrophage_volcano.pdf",plot = g, width = 10, height = 10)
```


### cDC2

```{r}
NT_LGG <- read.table(file = "DE_analysis_post_meeting2/Myeloid_LGG_vs_No tumor_cDC2.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("LGG_vs_NT_cDC2_volcano.pdf",plot = g, width = 10, height = 10)
```

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Myeloid_HGG_vs_LGG_cDC2.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_cDC2_volcano.pdf",plot = g, width = 10, height = 10)
```

### cDC1

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Myeloid_HGG_vs_LGG_cDC1.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_cDC1_volcano.pdf",plot = g, width = 10, height = 10)
```


### Complement_GBP_BAM

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Myeloid_HGG_vs_LGG_Complement_GBP_BAM.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_Complement_GBP_BAM_volcano.pdf",plot = g, width = 10, height = 10)
```

### intM 


```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Myeloid_HGG_vs_LGG_intM.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_intM_volcano.pdf",plot = g, width = 10, height = 10)
```


### migDC

```{r}
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Myeloid_HGG_vs_LGG_migDC.tsv",header = T,sep = "\t")

g <- ggplot(HGG_LGG,aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()
g
ggsave("HGG_vs_LGG_migDC_volcano.pdf",plot = g, width = 10, height = 10)
```


# GO analysis

## Tumors

### Tumor 4

```{r}
NT_LGG <- read.table(file = "DE_analysis_post_meeting2/Glioma_LGG_vs_No tumor_tumor_4.tsv",header = T,sep = "\t")
HGG_LGG <- read.table(file = "DE_analysis_post_meeting2/Glioma_HGG_vs_LGG_tumor_4.tsv",header = T,sep = "\t")
```

#### NT and LGG

```{r}
# gene.df <- bitr(NT_LGG$gene, fromType = "SYMBOL",
#         toType = c("ENSEMBL", "ENTREZID"),
#         OrgDb = org.Mm.eg.db)
# 
# ego <- enrichGO(gene          = gene.df$ENTREZID,
#                 universe      = gene.df$ENTREZID,
#                 OrgDb         = org.Mm.eg.db,
#                 ont           = "CC",
#                 pAdjustMethod = "BH",
#                 pvalueCutoff  = 0.01,
#                 qvalueCutoff  = 0.05)
# 
# head(ego@result)
```
Without the conversion is more straightforward:

```{r}
ego <- enrichGO(gene         = NT_LGG$gene[(NT_LGG$avg_log2FC > 1) & (NT_LGG$p_val_adj < 0.05)],
                OrgDb         = org.Mm.eg.db,
                keyType       = 'SYMBOL',
                ont           = "CC",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05)
head((ego@result))
```

```{r}
g <- dotplot(ego, showCategory=30)+theme(axis.text.y = element_text(size = 8))
g
ggsave("enrichGO_CC_tumor4_LGG_vs_NT_up.pdf",plot = g,height = 10,width = 10)
```

```{r}
ego <- enrichGO(gene         = NT_LGG$gene[(NT_LGG$avg_log2FC > 1) & (NT_LGG$p_val_adj < 0.05)],
                OrgDb         = org.Mm.eg.db,
                keyType       = 'SYMBOL',
                ont           = "MF",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05)
head((ego@result))
```

```{r}
g <- dotplot(ego, showCategory=30)+theme(axis.text.y = element_text(size = 8))
g
ggsave("enrichGO_MF_tumor4_LGG_vs_NT_up.pdf",plot = g,height = 10,width = 10)
```

```{r}
ego <- enrichGO(gene         = NT_LGG$gene[(NT_LGG$avg_log2FC > 1) & (NT_LGG$p_val_adj < 0.05)],
                OrgDb         = org.Mm.eg.db,
                keyType       = 'SYMBOL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05)
head((ego@result))
```

```{r}
g <- dotplot(ego, showCategory=30)+theme(axis.text.y = element_text(size = 8))
g
ggsave("enrichGO_BP_tumor4_LGG_vs_NT_up.pdf",plot = g,height = 10,width = 10)
```



```{r}
ego <- enrichGO(gene         = NT_LGG$gene[(NT_LGG$avg_log2FC < -1) & (NT_LGG$p_val_adj < 0.05)],
                OrgDb         = org.Mm.eg.db,
                keyType       = 'SYMBOL',
                ont           = "CC",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05)
head((ego@result))
```

```{r}
g <- dotplot(ego, showCategory=30)+theme(axis.text.y = element_text(size = 8))

ggsave("enrichGO_CC_tumor4_LGG_vs_NT_down.pdf",plot = g,height = 10,width = 10)
```

```{r}
ego <- enrichGO(gene         = NT_LGG$gene[(NT_LGG$avg_log2FC < -1) & (NT_LGG$p_val_adj < 0.05)],
                OrgDb         = org.Mm.eg.db,
                keyType       = 'SYMBOL',
                ont           = "MF",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05)
head((ego@result))
```

```{r}
g <- dotplot(ego, showCategory=30)+theme(axis.text.y = element_text(size = 8))
ggsave("enrichGO_MF_tumor4_LGG_vs_NT_down.pdf",plot = g,height = 10,width = 10)
```

```{r}
ego <- enrichGO(gene         = NT_LGG$gene[(NT_LGG$avg_log2FC < - 1) & (NT_LGG$p_val_adj < 0.05)],
                OrgDb         = org.Mm.eg.db,
                keyType       = 'SYMBOL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05)
head((ego@result))
```

```{r}
g <- dotplot(ego, showCategory=30)+theme(axis.text.y = element_text(size = 8))
g
ggsave("enrichGO_BP_tumor4_LGG_vs_NT_up.pdf",plot = g,height = 10,width = 10)
```


#### HGG and LGG: up

```{r}
ego <- enrichGO(gene         = HGG_LGG$gene[(HGG_LGG$avg_log2FC > 1) & (HGG_LGG$p_val_adj < 0.05)],
                OrgDb         = org.Mm.eg.db,
                keyType       = 'SYMBOL',
                ont           = "CC",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05)
head((ego@result))
```

```{r}
g <- dotplot(ego, showCategory=30)+theme(axis.text.y = element_text(size = 8))
g
ggsave("enrichGO_CC_tumor4_HGG_vs_LGG_up.pdf",plot = g,height = 10,width = 10)
```

```{r}
ego <- enrichGO(gene         = HGG_LGG$gene[(HGG_LGG$avg_log2FC > 1) & (HGG_LGG$p_val_adj < 0.05)],
                OrgDb         = org.Mm.eg.db,
                keyType       = 'SYMBOL',
                ont           = "MF",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05)
head((ego@result))
```

```{r}
g <- dotplot(ego, showCategory=30)+theme(axis.text.y = element_text(size = 8))
g
ggsave("enrichGO_MF_tumor4_HGG_vs_LGG_up.pdf",plot = g,height = 10,width = 10)
```

```{r}
ego <- enrichGO(gene         = HGG_LGG$gene[(HGG_LGG$avg_log2FC > 1) & (HGG_LGG$p_val_adj < 0.05)],
                OrgDb         = org.Mm.eg.db,
                keyType       = 'SYMBOL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05)
head((ego@result))
```

```{r}
g <- dotplot(ego, showCategory=30)+theme(axis.text.y = element_text(size = 8))
g
ggsave("enrichGO_BP_tumor4_HGG_vs_LGG_up.pdf",plot = g,height = 10,width = 10)
```




#### HGG and LGG:down

```{r}
ego <- enrichGO(gene         = HGG_LGG$gene[(HGG_LGG$avg_log2FC < - 1) & (HGG_LGG$p_val_adj < 0.05)],
                OrgDb         = org.Mm.eg.db,
                keyType       = 'SYMBOL',
                ont           = "CC",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05)
head((ego@result))
```

```{r}
g <- dotplot(ego, showCategory=30)+theme(axis.text.y = element_text(size = 8))
g
ggsave("enrichGO_CC_tumor4_HGG_vs_LGG_down.pdf",plot = g,height = 10,width = 10)
```

```{r}
ego <- enrichGO(gene         = HGG_LGG$gene[(HGG_LGG$avg_log2FC < - 1) & (HGG_LGG$p_val_adj < 0.05)],
                OrgDb         = org.Mm.eg.db,
                keyType       = 'SYMBOL',
                ont           = "MF",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05)
head((ego@result))
```

```{r}
g <- dotplot(ego, showCategory=30)+theme(axis.text.y = element_text(size = 8))
g
ggsave("enrichGO_MF_tumor4_HGG_vs_LGG_down.pdf",plot = g,height = 10,width = 10)
```

```{r}
ego <- enrichGO(gene         = HGG_LGG$gene[(HGG_LGG$avg_log2FC < - 1) & (HGG_LGG$p_val_adj < 0.05)],
                OrgDb         = org.Mm.eg.db,
                keyType       = 'SYMBOL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05)
head((ego@result))
```

```{r}
g <- dotplot(ego, showCategory=30)+theme(axis.text.y = element_text(size = 8))
g
ggsave("enrichGO_BP_tumor4_HGG_vs_LGG_down.pdf",plot = g,height = 10,width = 10)
```



## microglia


## macrophage (consolidatiob)


```{r}
NT_LGG <- read.table(file = "alt_DE_analysis_V3/Myeloid_LGG_vs_No tumor_Macrophages.tsv",header = T,sep = "\t")
HGG_LGG <- read.table(file = "alt_DE_analysis_V3/Myeloid_HGG_vs_LGG_Macrophages.tsv",header = T,sep = "\t")
```

### LGG and NT: up in LGG and 

#### down in LGG (up in NT)

```{r}
ego <- enrichGO(gene         = NT_LGG$gene[(NT_LGG$avg_log2FC < - 1) & (NT_LGG$p_val_adj < 0.05)],
                OrgDb         = org.Mm.eg.db,
                keyType       = 'SYMBOL',
                ont           = "MF",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05)
head((ego@result))

MF <- ego@result

ego <- enrichGO(gene         = NT_LGG$gene[(NT_LGG$avg_log2FC < - 1) & (NT_LGG$p_val_adj < 0.05)],
                OrgDb         = org.Mm.eg.db,
                keyType       = 'SYMBOL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05)
head((ego@result))

BP <- ego@result
```

```{r}
NT_GO <- rbind(MF,BP)
```

```{r}
NT_GO_plot <- NT_GO %>% slice_max(order_by = GeneRatio,n = 20) %>% mutate(
  GeneRatio_numeric = as.numeric(case_match(
    GeneRatio,
    "3/34" ~ as.character(3/34),
    "4/34" ~ as.character(4/34),
    "6/34" ~ as.character(6/34)
  )),
  condition = "NT"
)
```


```{r}
g <- ggplot(NT_GO_plot)+
  geom_point(aes(x = GeneRatio,y = reorder(Description, GeneRatio_numeric ),size = p.adjust,color = GeneRatio_numeric))+ylab("GO Terms")
ggsave("Macrophage_NT_GO_top20_plot.pdf",plot = g, width = 10,height = 7)
```



```{r}
ego <- enrichGO(gene         = NT_LGG$gene[(NT_LGG$avg_log2FC >1) & (NT_LGG$p_val_adj < 0.05)],
                OrgDb         = org.Mm.eg.db,
                keyType       = 'SYMBOL',
                ont           = "MF",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05)
head((ego@result))

MF <- ego@result

ego <- enrichGO(gene         = NT_LGG$gene[(NT_LGG$avg_log2FC > 1) & (NT_LGG$p_val_adj < 0.05)],
                OrgDb         = org.Mm.eg.db,
                keyType       = 'SYMBOL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05)
head((ego@result))

BP <- ego@result
```


```{r}
LGG_GO <- rbind(MF,BP)
```

```{r}
unique(LGG_GO$Count)[order(unique(LGG_GO$Count))]

LGG_GO %>% slice_max(order_by = Count,n = 20)
```


```{r}
LGG_GO_plot <- LGG_GO %>% slice_max(order_by = Count,n = 20) %>% mutate(
  GeneRatio_numeric = as.numeric(case_match(
    GeneRatio,
    "30/105" ~ as.character(30/105),
    "29/105" ~ as.character(29/105),
    "28/105" ~ as.character(28/105),
    "27/105" ~ as.character(27/105),
    "26/105" ~ as.character(26/105),
    "25/105" ~ as.character(25/105),
    "24/105" ~ as.character(24/105),
    "23/105" ~ as.character(23/105),
    "21/105" ~ as.character(21/105)
  )),
  condition = "LGG"
)
```

```{r}
g <- ggplot(LGG_GO_plot)+
  geom_point(aes(x = GeneRatio,y = reorder(Description, GeneRatio_numeric ),size = p.adjust,color = GeneRatio_numeric))+theme(axis.text.x = element_text(angle = 90))+ylab("GO Terms")
ggsave("Macrophage_LGG_GO_top20_plot.pdf",plot = g, width = 12,height = 7)
```

### HGG and LGG: up in HGG

```{r}
ego <- enrichGO(gene         = HGG_LGG$gene[(HGG_LGG$avg_log2FC >1) & (HGG_LGG$p_val_adj < 0.05)],
                OrgDb         = org.Mm.eg.db,
                keyType       = 'SYMBOL',
                ont           = "MF",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05)
head((ego@result))

MF <- ego@result

ego <- enrichGO(gene         = HGG_LGG$gene[(HGG_LGG$avg_log2FC > 1) & (HGG_LGG$p_val_adj < 0.05)],
                OrgDb         = org.Mm.eg.db,
                keyType       = 'SYMBOL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05)
head((ego@result))

BP <- ego@result
HGG_GO <- rbind(MF,BP)
```

```{r}
unique(HGG_GO$Count)[order(unique(HGG_GO$Count))]

HGG_GO %>% slice_max(order_by = Count,n = 20)
```

```{r}
HGG_GO_plot <- HGG_GO %>% slice_max(order_by = Count,n = 20) %>% mutate(
  GeneRatio_numeric = as.numeric(case_match(
    GeneRatio,
    "16/111" ~ as.character(16/111),
    "15/111" ~ as.character(15/111),
    "14/111" ~ as.character(14/111),
    "13/111" ~ as.character(13/111),
    "11/106" ~ as.character(11/106),
    "11/111" ~ as.character(11/111),
    "10/106" ~ as.character(10/106),
    "10/111" ~ as.character(10/111)
  )),
  condition = "HGG"
)
```

```{r}
g <- ggplot(HGG_GO_plot)+
  geom_point(aes(x = GeneRatio,y = reorder(Description, GeneRatio_numeric ),size = p.adjust,color = GeneRatio_numeric))+theme(axis.text.x = element_text(angle = 90))+ylab("GO Terms")
ggsave("Macrophage_HGG_GO_top20_plot.pdf",plot = g, width = 12,height = 7)
```

# Volcano plot of tumor-associated population (DE genes in comparison to other clusters)

## Mo-mac

```{r}
myeloid_DE <- read.table(paste0("DE_analysis_post_meeting2/","Mo_MPh_ann_V2.tsv"),sep = "\t",header = T)
```

```{r}
table(myeloid_DE$cluster)
```
```{r}
padj_thres = 10e-2
log2FC_thres = 1
myeloid_DE <- myeloid_DE %>% mutate(threshold = case_when(
  (p_val_adj < padj_thres) & (abs(avg_log2FC) > log2FC_thres) ~ "Pass",
			.default = "Fail" 
))
```

### GAM

```{r}
g <- ggplot(myeloid_DE %>% filter(cluster == "GAM"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","GAM")
g
ggsave("GAM_subpop_DE.pdf",plot = g, width = 8, height = 8)
```

### intM

```{r}
g <- ggplot(myeloid_DE %>% filter(cluster == "intM"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","intM")
g
ggsave("intM_subpop_DE.pdf",plot = g, width = 8, height = 8)
```


### Slamf9 Mac

```{r}
g <- ggplot(myeloid_DE %>% filter(cluster == "Slamf9_macrophage"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","Slamf9_macrophage")
g
ggsave("Slamf9_macrophage_subpop_DE.pdf",plot = g, width = 8, height = 8)
```

### Complement_GBP_BAM

```{r}
g <- ggplot(myeloid_DE %>% filter(cluster == "Complement_GBP_BAM"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","Complement_GBP_BAM")
g
ggsave("Complement_GBP_BAM_subpop_DE.pdf",plot = g, width = 8, height = 8)
```

## B_cells

```{r}
B_DE <- read.table(paste0("DE_analysis_post_meeting2/","B_cells_ann_V2.tsv"),sep = "\t",header = T)
padj_thres = 10e-2
log2FC_thres = 1
B_DE <- B_DE %>% mutate(threshold = case_when(
  (p_val_adj < padj_thres) & (abs(avg_log2FC) > log2FC_thres) ~ "Pass",
			.default = "Fail" 
))
```

```{r}
table(B_DE$cluster)
```


```{r}
g <- ggplot(B_DE %>% filter(cluster == "Memory_B_2"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","Memory_B_2")
g
ggsave("B_2_subpop_DE.pdf",plot = g, width = 8, height = 8)
```


## T_cells

```{r}
T_DE <- read.table(paste0("DE_analysis_post_meeting2/","T_cells_ann_V2.tsv"),sep = "\t",header = T)
padj_thres = 10e-2
log2FC_thres = 1
T_DE <- T_DE %>% mutate(threshold = case_when(
  (p_val_adj < padj_thres) & (abs(avg_log2FC) > log2FC_thres) ~ "Pass",
			.default = "Fail" 
))
```

```{r}
table(T_DE$cluster)
```


### Pdcd1_Cd44 T

```{r}
g <- ggplot(T_DE %>% filter(cluster == "Pdcd1_Cd44_high_activated_T"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","Pdcd1_Cd44_high_activated_T")
g
ggsave("Pdcd1_Cd44_high_activated_T_subpop_DE.pdf",plot = g, width = 8, height = 8)
```
### activated CD8 T

```{r}
g <- ggplot(T_DE %>% filter(cluster == "0_activated_CD8"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","0_activated_CD8")
g
ggsave("activated_CD8_subpop_DE.pdf",plot = g, width = 8, height = 8)
```

### activated CD4 T cell

```{r}
g <- ggplot(T_DE %>% filter(cluster == "1_activated_CD4"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","1_activated_CD4")
g
ggsave("activated_CD4_subpop_DE.pdf",plot = g, width = 8, height = 8)
```
### Ifn-responsive_T_cells

```{r}
g <- ggplot(T_DE %>% filter(cluster == "Ifn-responsive_T_cells"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","Ifn-responsive_T_cells")
g
ggsave("Ifn-responsive_T_cells_subpop_DE.pdf",plot = g, width = 8, height = 8)
```

## microglia

```{r}
microglia_DE <- read.table(paste0("DE_analysis_post_meeting2/","microglia_ann_V2.tsv"),sep = "\t",header = T)
padj_thres = 10e-2
log2FC_thres = 1
microglia_DE <- microglia_DE %>% mutate(threshold = case_when(
  (p_val_adj < padj_thres) & (abs(avg_log2FC) > log2FC_thres) ~ "Pass",
			.default = "Fail" 
))
```

```{r}
table(microglia_DE$cluster)
```
### HET_unknown_MG

```{r}
g <- ggplot(microglia_DE %>% filter(cluster == "HET_unknown_MG"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","HET_unknown_MG")
g
ggsave("HET_unknown_MG_subpop_DE.pdf",plot = g, width = 8, height = 8)
```

### HGG-HIGH_Chst2_high_MG

```{r}
g <- ggplot(microglia_DE %>% filter(cluster == "HGG-HIGH_Chst2_high_MG"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","HGG-HIGH_Chst2_high_MG")
g
ggsave("HGG-HIGH_Chst2_high_MG_subpop_DE.pdf",plot = g, width = 8, height = 8)
```


### HGG-HIGH_PAM

```{r}
g <- ggplot(microglia_DE %>% filter(cluster == "HGG-HIGH_PAM"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","HGG-HIGH_PAM")
g
ggsave("HGG-HIGH_PAM_subpop_DE.pdf",plot = g, width = 8, height = 8)
```

### NT-HIGH_BAM-like_Sparc+

```{r}
g <- ggplot(microglia_DE %>% filter(cluster == "NT-HIGH_BAM-like_Sparc+"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","NT-HIGH_BAM-like_Sparc+")
g
ggsave("NT-HIGH_BAM-like_Sparc+_subpop_DE.pdf",plot = g, width = 8, height = 8)
```

### LGG-HIGH_Ifn-responsive_MG

```{r}
g <- ggplot(microglia_DE %>% filter(cluster == "LGG-HIGH_Ifn-responsive_MG"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","LGG-HIGH_Ifn-responsive_MG")
g
ggsave("LGG-HIGH_Ifn-responsive_MG_subpop_DE.pdf",plot = g, width = 8, height = 8)
```


### LGG-HIGH_Il7r_Hspa1a_high_MG

```{r}
g <- ggplot(microglia_DE %>% filter(cluster == "LGG-HIGH_Il7r_Hspa1a_high_MG"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","LGG-HIGH_Il7r_Hspa1a_high_MG")
g
ggsave("LGG-HIGH_Il7r_Hspa1a_high_MG_subpop_DE.pdf",plot = g, width = 8, height = 8)
```


### LGG-HIGH_Nr4a1_Fos_high_MG

```{r}
g <- ggplot(microglia_DE %>% filter(cluster == "LGG-HIGH_Nr4a1_Fos_high_MG"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","LGG-HIGH_Nr4a1_Fos_high_MG")
g
ggsave("LGG-HIGH_Nr4a1_Fos_high_MG_subpop_DE.pdf",plot = g, width = 8, height = 8)
```


### NT-HIGH_Fosb_Dusp1_high_MG

```{r}
g <- ggplot(microglia_DE %>% filter(cluster == "NT-HIGH_Fosb_Dusp1_high_MG"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","NT-HIGH_Fosb_Dusp1_high_MG")
g
ggsave("NT-HIGH_Fosb_Dusp1_high_MG_subpop_DE.pdf",plot = g, width = 8, height = 8)
```


### NT-HIGH_Trem2_Ccr6_high_MG

```{r}
g <- ggplot(microglia_DE %>% filter(cluster == "NT-HIGH_Trem2_Ccr6_high_MG"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","NT-HIGH_Trem2_Ccr6_high_MG")
g
ggsave("NT-HIGH_Trem2_Ccr6_high_MG_subpop_DE.pdf",plot = g, width = 8, height = 8)
```


## tumor

```{r}
glioma_DE <- read.table(paste0("DE_analysis_post_meeting2/","glioma_ann_V1.tsv"),sep = "\t",header = T)
padj_thres = 10e-2
log2FC_thres = 1
glioma_DE <- glioma_DE %>% mutate(threshold = case_when(
  (p_val_adj < padj_thres) & (abs(avg_log2FC) > log2FC_thres) ~ "Pass",
			.default = "Fail" 
))
```

```{r}
table(glioma_DE$cluster)
```

### tumor3

```{r}
g <- ggplot(glioma_DE %>% filter(cluster == "tumor_3"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","tumor_3")
g
ggsave("tumor_3_subpop_DE.pdf",plot = g, width = 8, height = 8)
```
### tumor 4

```{r}
g <- ggplot(glioma_DE %>% filter(cluster == "tumor_4"),aes(x=avg_log2FC, y = -log10(p_val_adj), label = gene))+
  geom_point(aes(color = threshold))+
  geom_vline(xintercept = c(1,-1),color = "red2")+geom_hline(yintercept = 1.3, color = "red2")+ ggrepel::geom_label_repel(aes(label=ifelse((p_val_adj < 0.05) & (abs(avg_log2FC) > 1),as.character(gene),'')),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  size = 2,
                  segment.color = 'grey50',
                  max.overlaps = 30) +
  theme_classic()+
    ggtitle("","tumor_4")
g
ggsave("tumor_4_subpop_DE.pdf",plot = g, width = 8, height = 8)
```

# cross-condition DE and GSEA for large populations (FindAllMarkers over annotation_main and progress label)

## Macrophage

```{r}
load("data/GBM_RNA_10_myeloid_V3p2_alt.Robj")
```

```{r}
table(myeloid$annotation_main)
```


```{r}
macrophage <- subset(myeloid,subset = annotation_main == "Macrophages")
```

```{r}
macrophage$group <- gsub(" ","_",paste0(macrophage$progress,"_",macrophage$annotation_main))
Idents(macrophage) <- macrophage$group
```

```{r}
table(macrophage$group)
```

```{r}
MPh_DE <- FindAllMarkers(macrophage,test.use =  "MAST")
write.table(MPh_DE,file = paste0("DE_analysis_post_meeting2/","MPh_cross_cond_DE.tsv"),sep = "\t",col.names = T,row.names = F,quote = F)
```

```{r}
celltype_dir <- "MPh_cross_cond/"
outdir <- paste0(resdir,celltype_dir)
if (!dir.exists(outdir)) dir.create(outdir)
```


```{r load DE genes}
MPh_DE <- read.table(file = paste0("DE_analysis_post_meeting2","/MPh_cross_cond_DE.tsv"),header = T,sep = "\t")
```


### Hallmarks

```{r}
microglia_fgsea_hallmark <- fgsea_res(as.character(unique(MPh_DE$cluster)),MPh_DE,gene_set = fgsea_sets_Hallmark,mode = "simple",outdir = paste0(outdir,"Hallmark/"))

Hallmark_vector <- names(fgsea_sets_Hallmark)
celltype_vector <- as.character(unique(MPh_DE$cluster))
table_res_microglia <- data.frame(pathway = Hallmark_vector)
for (i in celltype_vector){
  table_tmp <- microglia_fgsea_hallmark[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% Hallmark_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_microglia <- full_join(table_res_microglia,table_celltype,by = "pathway")
}

table_res_microglia[is.na(table_res_microglia)] = 0
table_res_microglia <- table_res_microglia[apply(table_res_microglia[,2:(length(unique(MPh_DE$cluster))+1)],1,var) != 0,]

write.table(table_res_microglia,file = paste0(outdir,"Hallmark/","fgsea_MPh_CC_Hallmark_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### KEGG 

```{r}
microglia_fgsea_KEGG <- fgsea_res(as.character(unique(MPh_DE$cluster)),MPh_DE,gene_set = fgsea_sets_KEGG,mode = "simple",outdir = paste0(outdir,"KEGG/"))

KEGG_vector <- names(fgsea_sets_KEGG)
celltype_vector <- as.character(unique(MPh_DE$cluster))
table_res_microglia <- data.frame(pathway = KEGG_vector)
for (i in celltype_vector){
  table_tmp <- microglia_fgsea_KEGG[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% KEGG_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_microglia <- full_join(table_res_microglia,table_celltype,by = "pathway")
}

table_res_microglia[is.na(table_res_microglia)] = 0
table_res_microglia <- table_res_microglia[apply(table_res_microglia[,2:(length(unique(MPh_DE$cluster))+1)],1,var) != 0,]

write.table(table_res_microglia,file = paste0(outdir,"KEGG/","fgsea_MPh_CC_KEGG_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```

### REACT

```{r}
microglia_fgsea_REACT <- fgsea_res(as.character(unique(MPh_DE$cluster)),MPh_DE,gene_set = fgsea_sets_REACT,mode = "simple",outdir = paste0(outdir,"Reactome/"))

REACT_vector <- names(fgsea_sets_REACT)
celltype_vector <- as.character(unique(MPh_DE$cluster))
table_res_microglia <- data.frame(pathway = REACT_vector)
for (i in celltype_vector){
  table_tmp <- microglia_fgsea_REACT[[i]]
  table_celltype <- table_tmp[table_tmp$pathway %in% REACT_vector,c("pathway","NES")]
  colnames(table_celltype) <- c("pathway",i)
  table_res_microglia <- full_join(table_res_microglia,table_celltype,by = "pathway")
}

table_res_microglia[is.na(table_res_microglia)] = 0
table_res_microglia <- table_res_microglia[apply(table_res_microglia[,2:(length(unique(MPh_DE$cluster))+1)],1,var) != 0,]

write.table(table_res_microglia,file = paste0(outdir,"Reactome/","fgsea_MPh_CC_Reactome_consolidated_filtered.tsv") ,sep = "\t",row.names = F,quote = F)
```




# supplementary: gene exp sanity check

Hbb and Hba are very common among the downregulated genes for disease progression comparisons.

```{r}
load("data/GBM_RNA_10_whole_V3.Robj")
```

```{r}
VariableFeatures(whole)[grep("^Hbb|^Hba",VariableFeatures(whole))]
```

```{r}
VlnPlot(whole,features = c("Hbb-bs"),group.by = "compartment",split.by = "progress",alpha = 0.1)
VlnPlot(whole,features = c("Hbb-bs"),group.by = "cell_type_V2",split.by = "progress",alpha = 0.1)
VlnPlot(whole,features = c("Hbb-bs"),group.by = "annotation_main",split.by = "progress",alpha = 0.1)
```

```{r}
VlnPlot(whole,features = c("Hba-a1"),group.by = "compartment",split.by = "progress",alpha = 0.1)
VlnPlot(whole,features = c("Hba-a1"),group.by = "cell_type_V2",split.by = "progress",alpha = 0.1)
VlnPlot(whole,features = c("Hba-a1"),group.by = "annotation_main",split.by = "progress",alpha = 0.1)
```

```{r}
VlnPlot(whole,features = c("Hbb-bs"),group.by = "compartment",split.by = "batch_ID",alpha = 0.1)
VlnPlot(whole,features = c("Hbb-bs"),group.by = "cell_type_V2",split.by = "batch_ID",alpha = 0.1)
VlnPlot(whole,features = c("Hbb-bs"),group.by = "annotation_main",split.by = "batch_ID",alpha = 0.1)
```

```{r}
VlnPlot(whole,features = c("Hba-a1"),group.by = "compartment",split.by = "batch_ID",alpha = 0.1)
VlnPlot(whole,features = c("Hba-a1"),group.by = "cell_type_V2",split.by = "batch_ID",alpha = 0.1)
VlnPlot(whole,features = c("Hba-a1"),group.by = "annotation_main",split.by = "batch_ID",alpha = 0.1)
```

```{r}
VlnPlot(whole,features = c("Hbb-bs"),group.by = "batch_ID",split.by = "progress",alpha = 0.1)
VlnPlot(whole,features = c("Hbb-bs"),group.by = "sample.id",split.by = "progress",alpha = 0.1)
```
```{r}
VlnPlot(whole,features = c("Hbb-bs"),group.by = "sample.id",split.by = "compartment",alpha = 0.1)
VlnPlot(whole,features = c("Hbb-bs"),group.by = "cell_type_V2",split.by = "sample.id",alpha = 0.1)
```
```{r}
DimPlot(whole, group.by = "compartment")
FeaturePlot(whole, features = "Hbb-bs")
```
# troubleshoot fgsea

## check intM gene exp

```{r}
genes_to_inspect <- c("Timp1", "Olr1", "Ffar2", "Ccl17", "Ccl24", "Slc7a2", "Rasgrp1", "Mefv", "Met", "Ptgir", "Adora2b", "Sell", "Kcna3", "Hbegf", "Gpr132", "Cxcl10", "Mmp14", "Cd40", "Il1b", "Itga5", "Cdkn1a", "Plaur", "Ptger2", "Hif1a", "Nampt", "Osm", "Slc7a1", "Serpine1", "Irf7", "Pde4b", "Ccl5", "Ahr", "Csf1", "Cd69", "Pvr", "Axl", "Nfkb1", "Slc4a4", "Ripk2", "Csf3r", "Icam1", "Il7r", "Cxcl9")
```

```{r}
intM_markers <- read.table("DE_analysis_post_meeting2/Mo_Mph_ann_V2.tsv",sep = "\t",header = T) %>% filter(cluster =="intM")
```

```{r}
inspect <- intM_markers %>% filter(gene %in% genes_to_inspect)
```

```{r}
ggplot(inspect)+
  geom_histogram(aes(x = pct.1),bins = 50)
ggplot(inspect)+
  geom_histogram(aes(x = pct.2),bins = 50)
```

