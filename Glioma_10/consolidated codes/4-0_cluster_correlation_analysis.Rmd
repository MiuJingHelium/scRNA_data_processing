---
title: "4-0_cluster_correlation_analysis"
output: html_document
date: "2024-06-18"
---

```{r}
library(tidyverse)
library(Seurat)
library(igraph)

```


```{r}
library(corrplot)
library(RColorBrewer)
```

```{r}
pal <- c(brewer.pal(n = 12,name = "Set3"),brewer.pal(n = 12,name = "Paired"),brewer.pal(n = 8,name = "Accent"))
pal[2] <- "darkred"
pal[9] <- "grey25"
pal[23] <- "turquoise4"
pal[19] <- colors()[60]
pal[13] <- "darkblue"
pal[28] <- colors()[16]
pal[31] <- colors()[54] 
pal <- c(pal,colors()[c(85,84,83,89,45,31,41,42,26,29,10,139,107,108,120,109,119,121,143)])

```



```{r}
whole_meta <- read.table(file = paste0("data/","whole_meta_annotation_V2_alt.tsv"),sep = "\t",header = T)
```

Note "updated version" is after second attempt.

# create full proportion table (matrix)

Test 1 : using raw proportion of clusters (abundant cell type will definitely be dominant)

```{r}
prop_table_full <- full_join(
  x = whole_meta %>% group_by(sample.id,progress) %>% summarise(sample_size = n()),
  y = whole_meta %>% group_by(sample.id,progress,annotation_V1,compartment) %>% summarise(population_size = n()),
  by = c("sample.id","progress")) %>%
  mutate(population_prop = population_size /sample_size ) 
  #whole_meta %>% group_by() %>% summarise(pop_size = n()) %>% 

```

```{r}
prop_table_full %>% ungroup() %>% dplyr::select(sample.id,annotation_V1,population_prop)
```


```{r}
prop_table_cast <- prop_table_full %>% ungroup() %>% dplyr::select(sample.id,annotation_V1,population_prop) %>% spread(key = annotation_V1, value = population_prop)
```

```{r}
prop_table_cast[is.na(prop_table_cast)] <- 0
```

normalize prop_table

```{r}
prop_mat <- scale(prop_table_cast[,2:76]) # Try full scaling
  

```


```{r}
corr_mat <- cor(prop_mat,method = "spearman")
```

## visualize

```{r}
g <- {corrplot.mixed(corr_mat,
 upper = "square",
 lower = "number",
 addgrid.col = "black",
 tl.col = "black");
  recordPlot()
}
#ggsave(filename = "V2_test_cluster_correlation_plot.pdf",plot = replayPlot(g), width = 20,height = 20)
```

```{r}
pdf("V2_test_cluster_correlation_plot_Spearman_scaled.pdf",width = 20,height = 20)
corrplot(corr_mat,
         type = "full",
         tl.cex = 1,
         tl.col = "black",
         order = "hclust",
         addrect = 6,
         col =  rev(COL2('RdBu', 25))
         )
dev.off()

```

```{r}
corr_mat_kendall <- cor(prop_mat,method = "kendall")
pdf("V2_test_cluster_correlation_plot_kendall.pdf",width = 20,height = 20)
corrplot(corr_mat,
         type = "full",
         tl.cex = 1,
         tl.col = "black",
         order = "hclust",
         addrect = 6,
         col =  rev(COL2('RdBu', 25))
         )
dev.off()
```

## test isolating specific compartments

```{r}
tumor_imm <- prop_table_full %>% filter(compartment == "neoplastic" | compartment == "immune_cells") %>% ungroup() %>% dplyr::select(sample.id,annotation_V1,population_prop) %>% spread(key = annotation_V1, value = population_prop)
```


```{r}
tumor_imm[is.na(tumor_imm)] <- 0
```

median-normalize prop_table

```{r}
prop_mat_TI <- scale(tumor_imm[,2:54])
  

```

```{r}
pdf("V2_test_cluster_correlation_plot_tumor_immune_Spearman_scaled.pdf",width = 20,height = 20)
corrplot(cor(prop_mat_TI,method = "spearman"),
         type = "full",
         tl.cex = 1,
         tl.col = "black",
         order = "hclust",
         addrect = 3,
         col =  rev(COL2('RdBu', 20))
         )
dev.off()

```

# Try again with compartment proportion instead of raw

```{r}
prop_table_full <- full_join(
  x = whole_meta %>% group_by(sample.id,progress,compartment) %>% summarise(sample_compartment_size = n()),
  y = whole_meta %>% group_by(sample.id,progress,annotation_V1,compartment) %>% summarise(population_size = n()),
  by = c("sample.id","progress","compartment")) %>%
  mutate(population_prop = population_size /sample_compartment_size ) 
  #whole_meta %>% group_by() %>% summarise(pop_size = n()) %>% 
```


```{r}
prop_table_cast <- prop_table_full %>% ungroup() %>% dplyr::select(sample.id,progress,annotation_V1,population_prop) %>% spread(key = annotation_V1, value = population_prop)
```

```{r}
prop_table_cast[is.na(prop_table_cast)] <- 0
```


```{r}
prop_mat <- scale(prop_table_cast[,3:77]) # Try full scaling
```

```{r}
corr_mat <- cor(prop_mat,method = "spearman")
```


```{r}
pdf("V2_test_cluster_compartment_correlation_plot_Spearman_scaled.pdf",width = 20,height = 20)
corrplot(corr_mat,
         type = "full",
         tl.cex = 1,
         tl.col = "black",
         order = "hclust",
         addrect = 6,
         col =  rev(COL2('RdBu', 25))
         )
dev.off()

```

```{r}
prop_mat <- apply(prop_table_cast[,3:77],2,scale) # Try full scaling
```

```{r}
corr_mat <- cor(prop_mat,method = "spearman")
```


```{r}
pdf("V2_test_cluster_compartment_correlation_plot_Spearman.pdf",width = 20,height = 20)
corrplot(corr_mat,
         type = "full",
         tl.cex = 1,
         tl.col = "black",
         order = "hclust",
         addrect = 6,
         col =  rev(COL2('RdBu', 25))
         )
dev.off()

```

## check immune cells

```{r}
tumor_imm <- prop_table_full %>% filter(compartment == "neoplastic" | compartment == "immune_cells") %>% ungroup() %>% dplyr::select(sample.id,annotation_V1,population_prop) %>% spread(key = annotation_V1, value = population_prop)
```


```{r}
tumor_imm[is.na(tumor_imm)] <- 0
```

median-normalize prop_table

```{r}
prop_mat_TI <- apply(tumor_imm[,2:54],2,scale)
  

```

```{r}
pdf("V2_test_cluster_compartment_correlation_plot_tumor_immune_Spearman.pdf",width = 20,height = 20)
corrplot(cor(prop_mat_TI,method = "spearman"),
         type = "full",
         tl.cex = 1,
         tl.col = "black",
         order = "hclust",
         addrect = 3,
         col =  rev(COL2('RdBu', 20))
         )
dev.off()

```




# check sample covariation

```{r}
prop_table <- prop_table_cast
prop_table[,3:77] <- apply(prop_table[,3:77],2,scale)
  
```


```{r}
sample_corr <- cor(t(as.matrix(prop_table[,3:77])))
```

```{r}
rownames(sample_corr) <- prop_table$sample.id
colnames(sample_corr) <- prop_table$sample.id
```

```{r}
corrplot(sample_corr,
         type = "full",
         tl.cex = 1,
         tl.col = "black",
         order = "hclust",
         addrect = 3,
         col =  rev(COL2('RdBu', 25))
         )
```

# Updated version

Note: I'll need to modify the proporition a bit such that immune cell proportion considers all immune cell included samples but non-immune compartments are calculated by all-tissue samples only. 

Consider the sampling issue of restricting the sample space, we need to clarify the following premise:
1) Proportions can be calculated based on two types of levels: i) the sample level and ii) some subpopulation level
2) the type of sample included will affect the proportion of compartments. Thus, proportions calculated by dividing the sample size is sensitive to the type of cells included.
3) However, the proportion of subpopulations are usually calculated by dividing the compartment/population size, so these proportions are not affected by the types of cells included in the sample.

Based on these three premises, we can conclude that we only need the all-tissue samples for the compartment size proportions and the non-immune subpopulation sizes. For the immune cell subpopulations, we need only the immune cells from all samples.

The correlation analysis is interested in subpopulation proportions, so I'll load the whole metadata and perform the calculations separately for different compartments.

```{r}
table(whole_meta$compartment)
table(whole_meta$batch_ID)
```

```{r}
immune_meta <- whole_meta %>% filter(compartment=="Immune")
tumor_meta <- whole_meta %>% filter((batch_ID != "batch_CD45" )& (compartment=="Neoplastic"))
NG_meta <- whole_meta %>% filter((batch_ID != "batch_CD45" )& (compartment=="Neuronal-Glial"))
VS_meta <- whole_meta %>% filter((batch_ID != "batch_CD45" )& (compartment=="Vascular-Stromal"))
```

Then I'll calculate the proportion with respect to different levels for each compartment separately and then merge them into one table for correlation analysis. I have decided to skip some of the levels because they are not so interesting for correlation analysis, which has more emphasis on the relationship of subpopulations. In summary, I'll only calculate the in compartment proportion of annotation_main and annotation_V2. 


## annotation_main

```{r message=FALSE}
immune_prop <- full_join( x = immune_meta %>% group_by(orig.ident,progress,annotation_main,compartment) %>% summarise(population_size = n()),
                      y = immune_meta %>%  group_by(orig.ident,progress,compartment) %>% summarise(compartment_size = n()),
                       by = c("progress","compartment","orig.ident")) %>%
                        mutate(proportion = 100*population_size/compartment_size)

tumor_prop <- full_join( x = tumor_meta %>% group_by(orig.ident,progress,annotation_main,compartment) %>% summarise(population_size = n()),
                      y = tumor_meta %>%  group_by(orig.ident,progress,compartment) %>% summarise(compartment_size = n()),
                       by = c("progress","compartment","orig.ident")) %>%
                        mutate(proportion = 100*population_size/compartment_size) 
tumor_prop$proportion[tumor_prop$progress == "No tumor"] = 0
NG_prop <- full_join( x = NG_meta %>% group_by(orig.ident,progress,annotation_main,compartment) %>% summarise(population_size = n()),
                      y = NG_meta %>%  group_by(orig.ident,progress,compartment) %>% summarise(compartment_size = n()),
                       by = c("progress","compartment","orig.ident")) %>%
                        mutate(proportion = 100*population_size/compartment_size)

VS_prop <- full_join( x = VS_meta %>% group_by(orig.ident,progress,annotation_main,compartment) %>% summarise(population_size = n()),
                      y = VS_meta %>%  group_by(orig.ident,progress,compartment) %>% summarise(compartment_size = n()),
                       by = c("progress","compartment","orig.ident")) %>%
                        mutate(proportion = 100*population_size/compartment_size)
prop_table <- rbind(immune_prop,tumor_prop, NG_prop, VS_prop)
```



```{r}
prop_table_cast <- prop_table %>% ungroup() %>% dplyr::select(orig.ident,progress,annotation_main,proportion) %>% spread(key = annotation_main, value = proportion)
```

```{r}
# prop_table_cast[is.na(prop_table_cast)] <- 0
```


```{r}
prop_mat <- scale(prop_table_cast[,3:ncol(prop_table_cast)]) # Try full scaling
```

```{r}
corr_mat <- cor(prop_mat,method = "spearman",use ="complete.obs")
```


```{r}
pdf("V3_test_cluster_compartment_correlation_plot_Spearman_scaled.pdf",width = 20,height = 20)
corrplot(corr_mat,
         type = "full",
         tl.cex = 1,
         tl.col = "black",
         order = "hclust",
         addrect = 6,
         col =  rev(COL2('RdBu', 25))
         )
dev.off()

```

```{r}
prop_mat <- apply(prop_table_cast[,3:ncol(prop_table_cast)],2,scale) # Try scale only the columns
```

```{r}
corr_mat <- cor(prop_mat,method = "spearman",use ="complete.obs")

```


```{r}
pdf("V3_test_cluster_compartment_correlation_plot_Spearman_col_scaled.pdf",width = 20,height = 20)
corrplot(corr_mat,
         type = "full",
         tl.cex = 1,
         tl.col = "black",
         order = "hclust",
         addrect = 6,
         col =  rev(COL2('RdBu', 25))
         )
dev.off()

```


### Try visualize by network


```{r}
corr_mat <- cor(prop_table_cast[,3:ncol(prop_table_cast)],method = "spearman",use ="complete.obs")
```

```{r}
network <- graph_from_adjacency_matrix( corr_mat, weighted=T, mode="undirected", diag=F)
```

```{r}
coul <- brewer.pal(nlevels(as.factor(whole_meta$compartment)), "Set2")
my_color <- coul[as.numeric(as.factor(whole_meta$compartment))]

# plot
par(bg="grey13", mar=c(0,0,0,0))
set.seed(4)
plot(network, 
    vertex.size=12,
    vertex.color=my_color, 
    vertex.label.cex=0.7,
    vertex.label.color="white",
    vertex.frame.color="transparent"
    )

# title and legend
legend(x=-0.2, y=-0.12, 
       legend=paste( levels(as.factor(whole_meta$compartment)), sep=""), 
       col = coul , 
       bty = "n", pch=20 , pt.cex = 2, cex = 1,
       text.col="white" , horiz = F)
```


## annotation of subpopulation

```{r}
immune_prop <- full_join( x = immune_meta %>% group_by(orig.ident,progress,annotation_V2,compartment) %>% summarise(population_size = n()),
                      y = immune_meta %>%  group_by(orig.ident,progress,compartment) %>% summarise(compartment_size = n()),
                       by = c("progress","compartment","orig.ident")) %>%
                        mutate(proportion = 100*population_size/compartment_size)

tumor_prop <- full_join( x = tumor_meta %>% group_by(orig.ident,progress,annotation_V2,compartment) %>% summarise(population_size = n()),
                      y = tumor_meta %>%  group_by(orig.ident,progress,compartment) %>% summarise(compartment_size = n()),
                       by = c("progress","compartment","orig.ident")) %>%
                        mutate(proportion = 100*population_size/compartment_size)

NG_prop <- full_join( x = NG_meta %>% group_by(orig.ident,progress,annotation_V2,compartment) %>% summarise(population_size = n()),
                      y = NG_meta %>%  group_by(orig.ident,progress,compartment) %>% summarise(compartment_size = n()),
                       by = c("progress","compartment","orig.ident")) %>%
                        mutate(proportion = 100*population_size/compartment_size)

VS_prop <- full_join( x = VS_meta %>% group_by(orig.ident,progress,annotation_V2,compartment) %>% summarise(population_size = n()),
                      y = VS_meta %>%  group_by(orig.ident,progress,compartment) %>% summarise(compartment_size = n()),
                       by = c("progress","compartment","orig.ident")) %>%
                        mutate(proportion = 100*population_size/compartment_size)
prop_table <- rbind(immune_prop,tumor_prop, NG_prop, VS_prop)
```


```{r}
prop_table_cast <- prop_table %>% ungroup() %>% dplyr::select(orig.ident,progress,annotation_V2,proportion) %>% spread(key = annotation_V2, value = proportion)
```

```{r}
prop_table_cast[is.na(prop_table_cast)] <- 0
```


```{r}
prop_mat <- scale(prop_table_cast[,3:ncol(prop_table_cast)]) # Try full scaling
```

```{r}
corr_mat <- cor(prop_mat,method = "spearman")
```


```{r}
pdf("V3_test_subpop_compartment_correlation_plot_Spearman_full_scaled.pdf",width = 20,height = 20)
corrplot(corr_mat,
         type = "full",
         tl.cex = 1,
         tl.col = "black",
         order = "hclust",
         addrect = 6,
         col =  rev(COL2('RdBu', 25))
         )
dev.off()

```

```{r}
prop_mat <- apply(prop_table_cast[,3:ncol(prop_table_cast)],2,scale) # Try scale only the columns
```

```{r}
corr_mat <- cor(prop_mat,method = "spearman")
```


```{r}
pdf("V3_test_subpop_compartment_correlation_plot_Spearman_column_scaled.pdf",width = 20,height = 20)
corrplot(corr_mat,
         type = "full",
         tl.cex = 1,
         tl.col = "black",
         order = "hclust",
         addrect = 6,
         col =  rev(COL2('RdBu', 25))
         )
dev.off()

```

### Try throwing away the NA values instead of replacing by 0



```{r}
prop_table_cast <- prop_table %>% ungroup() %>% dplyr::select(orig.ident,progress,annotation_V2,proportion) %>% spread(key = annotation_V2, value = proportion)
```

```{r}
prop_mat <- scale(prop_table_cast[,3:ncol(prop_table_cast)]) # Try full scaling
```

```{r}
corr_mat <- cor(prop_mat,method = "spearman",use ="pairwise.complete.obs") 
corr_mat[is.na(corr_mat)] <- 0
```


```{r}
# no complete element pairs
pdf("V3_test_subpop_compartment_correlation_plot_Spearman_full_scaled_NA_dropped.pdf",width = 20,height = 20)
corrplot(corr_mat,
         type = "full",
         tl.cex = 1,
         tl.col = "black",
         order = "hclust",
         addrect = 6,
         col =  rev(COL2('RdBu', 25))
         )
dev.off()

```

```{r}
prop_mat <- apply(prop_table_cast[,3:ncol(prop_table_cast)],2,scale) # Try scale only the columns
```

```{r}
corr_mat <- cor(prop_mat,method = "spearman",use ="pairwise.complete.obs") 
corr_mat[is.na(corr_mat)] <- 0

```


```{r}
# no complete element pairs
pdf("V3_test_subpop_compartment_correlation_plot_Spearman_scaled_NA_dropped.pdf",width = 20,height = 20)
corrplot(corr_mat,
         type = "full",
         tl.cex = 1,
         tl.col = "black",
         order = "hclust",
         addrect = 6,
         col =  rev(COL2('RdBu', 25))
         )
dev.off()

```

#### visiualize by network

```{r}
# Remove astrocyte_5 and Astrocyte_7
prop_table_cast <- prop_table_cast %>% dplyr :: select(-c("HGG-HIGH_Astrocyte_5","HGG-HIGH_Astrocyte_7"))
prop_mat <- apply(prop_table_cast[,3:ncol(prop_table_cast)],2,scale) # Try scale only the columns
```

```{r}
corr_mat <- cor(prop_mat,method = "spearman",use ="pairwise.complete.obs") 
corr_mat[is.na(corr_mat)] <- 0

```

```{r}
mat <- corr_mat
mat[mat <0.9] <- 0
```

```{r}
meta <- prop_table %>% group_by(annotation_V2,compartment) %>% summarise()
rownames(meta) <- meta$annotation_V2
```


```{r}
network <- graph_from_adjacency_matrix( mat, weighted=T, mode="undirected", diag=F)
```

```{r}
coul <- brewer.pal(nlevels(as.factor(meta$compartment)), "Set2")
my_color <- coul[as.numeric(as.factor(meta$compartment))]

# plot
par(bg="grey13", mar=c(0,0,0,0))
set.seed(4)
plot(network, 
    vertex.size=12,
    vertex.color=my_color, 
    vertex.label.cex=0.7,
    vertex.label.color="white",
    vertex.frame.color="transparent"
    )

# title and legend
legend(x=-0.2, y=-0.12, 
       legend=paste( levels(as.factor(whole_meta$compartment)), sep=""), 
       col = coul , 
       bty = "n", pch=20 , pt.cex = 2, cex = 1,
       text.col="white" , horiz = F)
```

```{r}
pdf("Network_correlation_plot_0.9_ann_V2.pdf",width = 12,height = 10)
par(bg="grey13", mar=c(0,0,0,0))
set.seed(4)
plot(network, 
    vertex.size=12,
    vertex.color=my_color, 
    vertex.label.cex=0.5,
    vertex.label.color="white",
    vertex.frame.color="transparent"
    )

# title and legend
legend("topleft", 
       legend=paste( levels(as.factor(whole_meta$compartment)), sep=""), 
       col = coul , 
       bty = "n", pch=20 , pt.cex = 2, cex = 1,
       text.col="white" , horiz = F)
dev.off()
```

#### check correlation scatter plot

```{r}
colnames(prop_table_cast)
```


```{r}
ggplot(data = prop_table_cast)+
  geom_point(aes(x = `0_activated_CD8`, y = `1_activated_CD4`, color = progress))

ggplot(data = prop_table_cast)+
  geom_point(aes(x = `Memory_B_2`, y = `HGG_HIGH_Tumor3`, color = progress))
```

```{r}
ggplot(data = prop_table_cast)+
  geom_point(aes(x = `Memory_B_2`, y = `Fibroblast_1`, color = progress))
```


### check immune tumor

```{r}
immune_prop <- full_join( x = immune_meta %>% group_by(orig.ident,progress,annotation_V2,compartment) %>% summarise(population_size = n()),
                      y = immune_meta %>%  group_by(orig.ident,progress,compartment) %>% summarise(compartment_size = n()),
                       by = c("progress","compartment","orig.ident")) %>%
                        mutate(proportion = 100*population_size/compartment_size)

tumor_prop <- full_join( x = tumor_meta %>% group_by(orig.ident,progress,annotation_V2,compartment) %>% summarise(population_size = n()),
                      y = tumor_meta %>%  group_by(orig.ident,progress,compartment) %>% summarise(compartment_size = n()),
                       by = c("progress","compartment","orig.ident")) %>%
                        mutate(proportion = 100*population_size/compartment_size)

prop_table <- rbind(immune_prop,tumor_prop)
```

```{r}
prop_table_cast <- prop_table %>% ungroup() %>% dplyr::select(orig.ident,progress,annotation_V2,proportion) %>% spread(key = annotation_V2, value = proportion)
```

```{r}
prop_mat <- scale(prop_table_cast[,3:ncol(prop_table_cast)]) # Try full scaling
```

```{r}
corr_mat <- cor(prop_mat,method = "spearman",use ="pairwise.complete.obs") 
corr_mat[is.na(corr_mat)] <- 0
```


```{r}
# no complete element pairs
pdf("V3_tumot_imm_correlation_plot_Spearman_full_scaled_NA_dropped.pdf",width = 20,height = 20)
corrplot(corr_mat,
         type = "full",
         tl.cex = 1,
         tl.col = "black",
         order = "hclust",
         addrect = 6,
         col =  rev(COL2('RdBu', 25))
         )
dev.off()

```

```{r}
prop_mat <- apply(prop_table_cast[,3:ncol(prop_table_cast)],2,scale) # Try scale only the columns
```

```{r}
# no complete element pairs

corr_mat <- cor(prop_mat,method = "spearman",use ="pairwise.complete.obs")
corr_mat[is.na(corr_mat)] <- 0
```


```{r}
# no complete element pairs
pdf("V3_tumot_imm_correlation_plot_Spearman_col_scaled_NA_dropped.pdf",width = 20,height = 20)
corrplot(corr_mat,
         type = "full",
         tl.cex = 1,
         tl.col = "black",
         order = "hclust",
         addrect = 6,
         col =  rev(COL2('RdBu', 25))
         )
dev.off()

```

#### network

```{r}
prop_mat <- apply(prop_table_cast[,3:ncol(prop_table_cast)],2,scale) # Try scale only the columns
```

```{r}
corr_mat <- cor(prop_mat,method = "spearman",use ="pairwise.complete.obs") 
corr_mat[is.na(corr_mat)] <- 0

```

```{r}
mat <- corr_mat
mat[mat <0.6] <- 0
```

```{r}
meta <- whole_meta %>% filter(compartment == "Immune" | compartment == "Neoplastic") %>% group_by(annotation_V2,annotation_main) %>% summarise()
rownames(meta) <- meta$annotation_V2
```



```{r}
coul <- pal[1:nlevels(as.factor(meta$annotation_main))]
my_color <- coul[as.numeric(as.factor(meta$annotation_main))]

network <- graph_from_adjacency_matrix(mat, weighted=T, mode="undirected", diag=F)
V(network)$color <- my_color
```

```{r}

# plot
par(bg="grey10", mar=c(0,0,0,0))
set.seed(4)
plot(network, 
    vertex.size=12,
    vertex.label.cex=0.7,
    vertex.label.color="white",
    vertex.frame.color="transparent"
    )

# title and legend
legend("topleft", 
        legend=levels(as.factor(meta$annotation_main)), 
        col = coul , 
        bty = "n", pch=20 , pt.cex = 2, cex = 1,
        text.col="white" , horiz = F)
```

```{r}
pdf("Network_immune-tumor_correlation_plot_0.6_ann_V2.pdf",width = 12,height = 10)

par(bg="grey10", mar=c(0,0,0,0))
set.seed(4)
plot(network, 
    vertex.size=12,
    vertex.color=my_color,
    vertex.label.cex=0.7,
    vertex.label.color="white",
    vertex.frame.color="transparent"
    )

# title and legend
legend("topleft", 
        legend=levels(as.factor(meta$annotation_main)), 
        col = coul , 
        bty = "n", pch=20 , pt.cex = 2, cex = 1,
        text.col="white" , horiz = F)

dev.off()
```

# iGraph

```{r}
immune_prop <- full_join( x = immune_meta %>% group_by(orig.ident,progress,annotation_V2,compartment) %>% summarise(population_size = n()),
                      y = immune_meta %>%  group_by(orig.ident,progress,compartment) %>% summarise(compartment_size = n()),
                       by = c("progress","compartment","orig.ident")) %>%
                        mutate(proportion = 100*population_size/compartment_size)

tumor_prop <- full_join( x = tumor_meta %>% group_by(orig.ident,progress,annotation_V2,compartment) %>% summarise(population_size = n()),
                      y = tumor_meta %>%  group_by(orig.ident,progress,compartment) %>% summarise(compartment_size = n()),
                       by = c("progress","compartment","orig.ident")) %>%
                        mutate(proportion = 100*population_size/compartment_size)
tumor_prop$proportion[tumor_prop$progress == "No tumor"] = 0
prop_table <- rbind(immune_prop,tumor_prop)
```

```{r}
prop_table_cast <- prop_table %>% ungroup() %>% dplyr::select(orig.ident,progress,annotation_V2,proportion) %>% spread(key = annotation_V2, value = proportion)
```

```{r}
prop_mat <- apply(prop_table_cast[,3:ncol(prop_table_cast)],2,scale) # Try scale only the columns
```


```{r}
corr_mat <- cor(prop_mat,method = "spearman",use ="pairwise.complete.obs") 
corr_mat[is.na(corr_mat)] <- 0

```

```{r}
mat <- corr_mat
mat[mat < 0] <- 0
```


```{r}
meta <- whole_meta %>% filter(compartment == "Immune" | compartment == "Neoplastic") %>% group_by(annotation_V2,annotation_main) %>% summarise() 
rownames(meta) <- meta$annotation_V2
meta <- meta[order(meta$annotation_V2),]
```




```{r}
coul <- pal[1:nlevels(as.factor(meta$annotation_main))] # prepare 19 colors
names(coul) <- levels(as.factor(meta$annotation_main))
my_color <- coul[meta$annotation_main] # map colors to ann_V2 based on V2-main relation
# names(my_color) <- meta$annotation_main[order(meta$annotation_main)]
network <- graph_from_adjacency_matrix(mat, weighted=T, mode="undirected", diag=F)
V(network)$color <- my_color
```




```{r}
degree(network)
```


```{r}

# plot
par(bg="grey10", mar=c(0,0,0,0))
set.seed(4)
plot(network, 
    vertex.size=12,
    vertex.color = my_color,
    vertex.label.cex=0.7,
    vertex.label.color="white",
    vertex.frame.color="transparent"
    )

# title and legend
legend("topleft", 
        legend=levels(as.factor(meta$annotation_main)), 
        col = coul , 
        bty = "n", pch=20 , pt.cex = 2, cex = 1,
        text.col="white" , horiz = F)
```

```{r}
pdf("Network_immune-tumor_correlation_plot_pos_ann_V2.pdf",width = 14,height = 14)

par(bg="grey10", mar=c(0,0,0,0))
set.seed(4)
plot(network, 
    vertex.size=12,
    vertex.color=my_color,
    vertex.label.cex=0.7,
    vertex.label.color="white",
    vertex.frame.color="transparent"
    )

# title and legend
legend("topleft", 
        legend=levels(as.factor(meta$annotation_main)), 
        col = coul , 
        bty = "n", pch=20 , pt.cex = 2, cex = 1,
        text.col="white" , horiz = F)

dev.off()
```

```{r}
mat <- corr_mat
mat[mat > 0] <- 0
mat = -(mat)

meta <- whole_meta %>% filter(compartment == "Immune" | compartment == "Neoplastic") %>% group_by(annotation_V2,annotation_main) %>% summarise() 
rownames(meta) <- meta$annotation_V2
meta <- meta[order(meta$annotation_V2),]

coul <- pal[1:nlevels(as.factor(meta$annotation_main))] # prepare 19 colors
names(coul) <- levels(as.factor(meta$annotation_main))
my_color <- coul[meta$annotation_main] # map colors to ann_V2 based on V2-main relation
# names(my_color) <- meta$annotation_main[order(meta$annotation_main)]
network <- graph_from_adjacency_matrix(mat, weighted=T, mode="undirected", diag=F)
V(network)$color <- my_color

degree(network)
```

```{r}

# plot
par(bg="grey10", mar=c(0,0,0,0))
set.seed(4)
plot(network, 
    vertex.size=12,
    vertex.color = my_color,
    vertex.label.cex=0.7,
    vertex.label.color="white",
    vertex.frame.color="transparent"
    )

# title and legend
legend("topleft", 
        legend=levels(as.factor(meta$annotation_main)), 
        col = coul , 
        bty = "n", pch=20 , pt.cex = 2, cex = 1,
        text.col="white" , horiz = F)
```

```{r}
pdf("Network_immune-tumor_correlation_plot_neg_ann_V2.pdf",width = 14,height = 14)

par(bg="grey10", mar=c(0,0,0,0))
set.seed(4)
plot(network, 
    vertex.size=12,
    vertex.color=my_color,
    vertex.label.cex=0.7,
    vertex.label.color="white",
    vertex.frame.color="transparent"
    )

# title and legend
legend("topleft", 
        legend=levels(as.factor(meta$annotation_main)), 
        col = coul , 
        bty = "n", pch=20 , pt.cex = 2, cex = 1,
        text.col="white" , horiz = F)

dev.off()
```


## Try additional filtering

```{r}
mat <- corr_mat
mat[mat > -0.5 ] <- 0
mat = -(mat)

meta <- whole_meta %>% filter(compartment == "Immune" | compartment == "Neoplastic") %>% group_by(annotation_V2,annotation_main) %>% summarise() 
rownames(meta) <- meta$annotation_V2
meta <- meta[order(meta$annotation_V2),]

coul <- pal[1:nlevels(as.factor(meta$annotation_main))] # prepare 19 colors
names(coul) <- levels(as.factor(meta$annotation_main))
my_color <- coul[meta$annotation_main] # map colors to ann_V2 based on V2-main relation
# names(my_color) <- meta$annotation_main[order(meta$annotation_main)]
network <- graph_from_adjacency_matrix(mat, weighted=T, mode="undirected", diag=F)
V(network)$color <- my_color

degree(network)
```

```{r}
pdf("Network_immune-tumor_correlation_plot_neg_0.5_ann_V2.pdf",width = 14,height = 14)

par(bg="grey10", mar=c(0,0,0,0))
set.seed(4)
plot(network, 
    vertex.size=12,
    vertex.color=my_color,
    vertex.label.cex=0.7,
    vertex.label.color="white",
    vertex.frame.color="transparent"
    )

# title and legend
legend("topleft", 
        legend=levels(as.factor(meta$annotation_main)), 
        col = coul , 
        bty = "n", pch=20 , pt.cex = 2, cex = 1,
        text.col="white" , horiz = F)

dev.off()
```
