---
title: "finalize annotation"
output: html_document
date: "2024-04-19"
---

Although this markdown file contains "finalization" in it, it is mainly used for performing sanity check of the annotation and additional analysis.

```{r}
library(tidyverse)
library(Seurat)
library(harmony)
```

Originally this Rmd was dedicated to performing annotation; to aid annotation, the gene cycle score assignment was later added.

```{r}
indir <- "data/"
outdir <- "data/"
```

# Glioma

```{r}
load(paste0(indir,"GBM_RNA_10_glioma_V2.Robj"))
```

```{r}
table(Glioma$annotation_V1)
```

```{r}
DimPlot(Glioma,group.by = "annotation_V1")
```

```{r}
colnames(Glioma@meta.data)
table(Glioma$compartment)
table(Glioma$annotation_V1)
```

```{r}
Glioma$annotation_main <- Glioma$compartment
```



```{r}
Glioma$cell_type <- Glioma$compartment
```



```{r}
save(Glioma,file = paste0(indir,"GBM_RNA_10_glioma_V2.Robj"))
```


## version 3 processing

remove  tumor_7 for version 3

```{r}
Glioma <- subset(Glioma, subset = annotation_V1 != "tumor_7")
```

```{r}
DimPlot(Glioma,group.by = "annotation_V1")
```
```{r}
Glioma <- FindVariableFeatures(object = Glioma, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
#VariableFeatures(Glioma) <-  VariableFeatures(Glioma) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(Glioma))]
VariableFeaturePlot(Glioma,selection.method = "mean.var.plot")

Glioma <- ScaleData(object = Glioma, features = VariableFeatures(object = Glioma), vars.to.regress = c("nCount_RNA", "percent.mt"))
Glioma <- RunPCA(object = Glioma,
                features =  VariableFeatures(object = Glioma),
                dims = 1:50)
gc()

ElbowPlot(Glioma,ndims = 50)
```


```{r}
Glioma <- RunHarmony(object = Glioma, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
Glioma <- RunUMAP(Glioma,dims = 1:30,reduction = "harmony")
Glioma <- RunTSNE(Glioma,dims = 1:30,reduction = "harmony")

Glioma <- FindNeighbors(Glioma, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  Glioma <- FindClusters(object = Glioma, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
Glioma <- JoinLayers(Glioma)
```

```{r}
DimPlot(Glioma,group.by = "annotation_V1")
```

```{r}
colnames(Glioma@meta.data)
table(Glioma$annotation_V1)
table(Glioma$compartment)
```

```{r}
Glioma$cell_type <- Glioma$compartment
```


```{r}
save(Glioma, file = paste0(indir,"GBM_RNA_10_glioma_V3.Robj"))
```

### add cell cyle score to V3 and perform trajectory analysis

```{r}
load(paste0(indir,"GBM_RNA_10_glioma_V3.Robj"))
```

```{r}
s.genes <- cc.genes$s.genes
g2m.genes <- cc.genes$g2m.genes
```

```{r}
mouse_human_genes <- read.csv("http://www.informatics.jax.org/downloads/reports/HOM_MouseHumanSequence.rpt",sep="\t")

# separate human and mouse 
mouse <- split.data.frame(mouse_human_genes,mouse_human_genes$Common.Organism.Name)[[2]]
human <- split.data.frame(mouse_human_genes,mouse_human_genes$Common.Organism.Name)[[1]]

# remove some columns
mouse <- mouse[,c(1,4)]
human <- human[,c(1,4)]

# merge the 2 dataset  (note that the human list is longer than the mouse one)
mh_data <- merge.data.frame(mouse,human,by = "DB.Class.Key",all.y = TRUE) 
```

```{r}
s.genes <- mh_data[mh_data$Symbol.y %in% s.genes,"Symbol.x"]
g2m.genes <- mh_data[mh_data$Symbol.y %in% g2m.genes,"Symbol.x"]
```

```{r}
Glioma <- CellCycleScoring(Glioma, s.features = s.genes, g2m.features = g2m.genes, set.ident = F)
```

```{r}
DimPlot(Glioma,group.by = "Phase",reduction = "pca")
```


```{r}
DimPlot(Glioma,group.by = "Phase",reduction = "umap")
```

```{r}
library(monocle3)
library(SeuratWrappers)
cds <- as.cell_data_set(Glioma)
cds <- cluster_cells(cds, resolution=1e-3)
```

```{r}
plot_cells(cds, color_cells_by = "cluster", show_trajectory_graph = FALSE)
plot_cells(cds, color_cells_by = "partition", show_trajectory_graph = FALSE)
```
```{r}
cds <- learn_graph(cds, use_partition = T, verbose = FALSE)

plot_cells(cds,
           color_cells_by = "cluster",
           label_groups_by_cluster=T,
           label_leaves=FALSE,
           label_branch_points=FALSE)
```

```{r}
cds <- order_cells(cds, root_cells = colnames(cds[,clusters(cds) == 4]))
plot_cells(cds,
           color_cells_by = "pseudotime",
           group_cells_by = "cluster",
           label_cell_groups = FALSE,
           label_groups_by_cluster=FALSE,
           label_leaves=F,
           label_branch_points=F,
           label_roots = T,
           trajectory_graph_color = "white")+theme_dark()
```

```{r}
Glioma <- AddMetaData(Glioma,metadata = cds@principal_graph_aux@listData$UMAP$pseudotime,col.name = "monocle3_trajectory")
```


```{r}
DimPlot(Glioma,reduction = "umap",group.by = "annotation_V1")
```

```{r}
save(Glioma, file = paste0(indir,"GBM_RNA_10_glioma_V3.Robj"))
```

### check Glioma DE profiles

Reload V2 Glioma object needed; 

```{r}
markers <- read.table(file = "functional_analysis/glioma_res01_DE.tsv",header = T,sep = "\t")
```


```{r}
ggplot(markers, aes(x = cluster, y = avg_log2FC)) +
  geom_point(aes(colour = cut(p_val_adj, c(0, 0.01,1))),
             size = 1)+
  scale_color_manual(name = "p_val_adj",
                    values = c("(0,0.01]" = "red",
                                  "(0.01, 1]" = "black"),
                     labels = c("<= 0.01", "> 0.01"))+
  theme_classic()
ggplot(markers, aes(x = cluster, y = avg_log2FC * -log10(p_val_adj))) +
  geom_point(aes(colour = cut(p_val_adj, c(0, 0.01,1))),
             size = 1)+
  scale_color_manual(name = "p_val_adj",
                    values = c("(0,0.01]" = "red",
                                  "(0.01, 1]" = "black"),
                     labels = c("<= 0.01", "> 0.01"))+
  theme_classic()
```

```{r}
# use V2 glioma
n_cells <- Glioma@meta.data %>% group_by(annotation_V1) %>% summarise(n=n())
n_DE <- markers %>% group_by(cluster) %>% filter(p_val_adj <= 0.01) %>% summarise(n_DE = n())
n_DE_cells <- cbind(n_cells,n_DE)
n_DE_cells <- n_DE_cells[,c("annotation_V1","n","n_DE")]
```


```{r}
ggplot(n_DE_cells,aes(x = annotation_V1, y = n_DE/n))+
  geom_bar(stat = "identity")
```


# non-neoplastic non-immune cells

## neutronal/residents

```{r}
load(paste0(indir,"GBM_RNA_10_resident_V2p2.Robj"))
```

```{r}
table(resident$annotation_V1)
```


```{r}
DimPlot(resident,group.by = "annotation_V1")
```

```{r}
g <- DotPlot(resident,group.by = "annotation_V1",features = unique(c("Aqp4","Aldh1l1","Aldoc","Fezf2", "Rorb", "Dbx2","Lhx2","Sox9","Sox10","Olig1","Olig2","Mag","Pdgfra","Pdgfrb","Gad1","Gad2","Bcl11b","Ppp1r1b","Otx2","Slc17a7","Slc32a1","Ndnf","Pvalb","Nfib","Sox2","Nes","Foxp2","Cspg4","Igfbp7","Pecam1","Myct1","Col1a1","Col5a2","Dlc1","Pdgfrb","Vtn","Anpep","Acta2","Mki67","Top2a","C1qa","P2ry12","Sall1","Ptprc"))) + RotatedAxis()
ggsave(filename = "neuronal_annotation_V2_markers.pdf",plot = g, width = 12,height = 6)
```

Remove the two progenitor-like clusters for V3?

```{r}
FeaturePlot(resident, features = c("Olig1"))
```

```{r}
colnames(resident@meta.data)
table(resident$annotation_V1)
table(resident$compartment)
```

```{r}
resident@meta.data <- resident@meta.data %>%
  mutate(compartment = case_match(
    compartment,
    "Neuronal" ~ "neuronal"
  ),
   annotation_V1 = case_match(
   annotation_V1,
   "Neutron_1" ~ "Neuron_1",
   "Neutron_2" ~ "Neuron_2",
   .default = annotation_V1
  ),
    cell_type = case_match(
    annotation_V1,
    "Astrocyte_1" ~ "astrocyte",
    "Astrocyte_2" ~ "astrocyte",
    "Astrocyte_3" ~ "astrocyte",
    "Astrocyte_4" ~ "astrocyte",
    "Neuron_3" ~ "neuron",
    "Neuron_2" ~ "neuron",
    "Neuron_1" ~ "neuron",
    "Oligodendrocyte_1" ~ "oligodendrocyte",
    "Oligodendrocyte_2" ~ "oligodendrocyte",
    "OPC" ~ "progenitor",
    "Progenitor-like_1" ~ "progenitor-like",
    "Progenitor-like_2" ~ "progenitor-like"
  ))
```

```{r}
table(resident$cell_type)
```

```{r}
resident$annotation_main <- resident$cell_type
```


```{r}
save(resident,file = paste0(indir,"GBM_RNA_10_resident_V2p2.Robj"))
```

### cell cycle and trajectory

```{r}
resident <- CellCycleScoring(resident, s.features = s.genes, g2m.features = g2m.genes, set.ident = F)
```

```{r}
DimPlot(resident,group.by = "Phase",reduction = "pca")
DimPlot(resident,group.by = "Phase",reduction = "umap")
```


```{r}
cds <- as.cell_data_set(resident)
cds <- cluster_cells(cds, resolution=1e-3)
plot_cells(cds, color_cells_by = "cluster", show_trajectory_graph = FALSE)
plot_cells(cds, color_cells_by = "partition", show_trajectory_graph = FALSE)
cds <- learn_graph(cds, use_partition = T, verbose = FALSE)

plot_cells(cds,
           color_cells_by = "cluster",
           label_groups_by_cluster=T,
           label_leaves=FALSE,
           label_branch_points=FALSE)
cds <- order_cells(cds, root_cells = colnames(cds[,clusters(cds) == 4]))
plot_cells(cds,
           color_cells_by = "pseudotime",
           group_cells_by = "cluster",
           label_cell_groups = FALSE,
           label_groups_by_cluster=FALSE,
           label_leaves=F,
           label_branch_points=F,
           label_roots = T,
           trajectory_graph_color = "white")+theme_dark()


```


```{r}
resident <- AddMetaData(resident,metadata = cds@principal_graph_aux@listData$UMAP$pseudotime,col.name = "monocle3_trajectory")
```


```{r}
save(resident,file = paste0(indir,"GBM_RNA_10_resident_V2p2.Robj"))
```

### check DE profiles

```{r}
markers <- read.table(file = "functional_analysis/resident_res01_DE.tsv",header = T,sep = "\t")
```


```{r}
ggplot(markers, aes(x = cluster, y = avg_log2FC)) +
  geom_point(aes(colour = cut(p_val_adj, c(0, 0.01,1))),
             size = 1)+
  scale_color_manual(name = "p_val_adj",
                    values = c("(0,0.01]" = "red",
                                  "(0.01, 1]" = "black"),
                     labels = c("<= 0.01", "> 0.01"))+
  theme_classic()+
  RotatedAxis()
ggplot(markers, aes(x = cluster, y = avg_log2FC * -log10(p_val_adj))) +
  geom_point(aes(colour = cut(p_val_adj, c(0, 0.01,1))),
             size = 1)+
  scale_color_manual(name = "p_val_adj",
                    values = c("(0,0.01]" = "red",
                                  "(0.01, 1]" = "black"),
                     labels = c("<= 0.01", "> 0.01"))+
  theme_classic()+
  RotatedAxis()
```

```{r}
# use V2 resident
n_cells <- resident@meta.data %>% group_by(annotation_V1) %>% summarise(n=n())
n_DE <- markers %>% group_by(cluster) %>% filter(p_val_adj <= 0.01) %>% summarise(n_DE = n())
n_DE_cells <- cbind(n_cells,n_DE)
n_DE_cells <- n_DE_cells[,c("annotation_V1","n","n_DE")]
```


```{r}
ggplot(n_DE_cells,aes(x = annotation_V1, y = n_DE/n))+
  geom_bar(stat = "identity")+RotatedAxis()
```



## stromal

```{r}
load(paste0(indir,"GBM_RNA_10_vascular_V2p1.Robj"))
```

```{r}
table(vascular$annotation_V1)
```


```{r}
DimPlot(vascular,group.by = "annotation_V1")
DimPlot(vascular,group.by = "annotation_V1",split.by = "progress")
```
```{r}
g <- DotPlot(vascular,group.by = "annotation_V1",features = unique(c("Aqp4","Aldh1l1","Aldoc","Fezf2", "Rorb", "Dbx2","Lhx2","Sox9","Sox10","Olig1","Olig2","Mag","Pdgfra","Pdgfrb","Gad1","Gad2","Bcl11b","Ppp1r1b","Otx2","Slc17a7","Slc32a1","Ndnf","Pvalb","Nfib","Sox2","Nes","Foxp2","Cspg4","Igfbp7","Pecam1","Myct1","Col1a1","Col5a2","Dlc1","Pdgfrb","Vtn","Anpep","Acta2","Mki67","Top2a","C1qa","P2ry12","Sall1","Ptprc"))) + RotatedAxis()
ggsave(filename = "stromal_annotation_V2_markers.pdf",plot = g, width = 12,height = 6)
```

```{r}
 DotPlot(vascular,group.by = "annotation_V1",features = unique(c("Pdgfra","Pdgfrb","Ndnf","Nfib","Nes","Foxp2","Cspg4","Igfbp7","Cdh5","Pecam1","Myct1","Fn1","Fap","Col1a1","Col5a2","Igfbp2","Dlc1","Pdgfrb","Vtn","Anpep","Acta2","Fbln1"))) + RotatedAxis()
```

```{r}
colnames(vascular@meta.data)
table(vascular$compartment)
table(vascular$annotation_V1)
```



```{r}
vascular@meta.data <- vascular@meta.data %>%
  mutate(cell_type = case_match(
    annotation_V1,
    "Endothelial_1" ~ "endothelial",
    "Endothelial_2" ~ "endothelial",
    "Endothelial_3" ~ "endothelial",
    "Perivascular_1" ~ "perivascular",
    "Perivascular_2" ~ "perivascular"
  ))
```

```{r}
vascular$compartment <- rep("stromal",nrow(vascular@meta.data))
vascular$annotation_main <- vascular$cell_type
```

```{r}
table(vascular$annotation_main)
table(vascular$compartment)
```


```{r}
save(vascular, file = paste0(indir,"GBM_RNA_10_vascular_V2p1.Robj"))
```


### check DE profiles

```{r}
markers <- read.table(file = "functional_analysis/vascular_res01_DE.tsv",header = T,sep = "\t")
```


```{r}
ggplot(markers, aes(x = cluster, y = avg_log2FC)) +
  geom_point(aes(colour = cut(p_val_adj, c(0, 0.01,1))),
             size = 1) +
  scale_color_manual(name = "p_val_adj",
                    values = c("(0,0.01]" = "red",
                                  "(0.01, 1]" = "black"),
                     labels = c("<= 0.01", "> 0.01"))+
  theme_classic()+
  RotatedAxis()
ggplot(markers, aes(x = cluster, y = avg_log2FC * -log10(p_val_adj))) +
  geom_point(aes(colour = cut(p_val_adj, c(0, 0.01,1))),
             size = 1)+
  scale_color_manual(name = "p_val_adj",
                    values = c("(0,0.01]" = "red",
                                  "(0.01, 1]" = "black"),
                     labels = c("<= 0.01", "> 0.01"))+
  theme_classic()+
  RotatedAxis()
```

```{r}
# use V2 resident
n_cells <- vascular@meta.data %>% group_by(annotation_V1) %>% summarise(n=n())
n_DE <- markers %>% group_by(cluster) %>% filter(p_val_adj <= 0.01) %>% summarise(n_DE = n())
n_DE_cells <- cbind(n_cells,n_DE)
n_DE_cells <- n_DE_cells[,c("annotation_V1","n","n_DE")]
```


```{r}
ggplot(n_DE_cells,aes(x = annotation_V1, y = n_DE/n))+
  geom_bar(stat = "identity")+RotatedAxis()
```


# Immune cells

## microglia

```{r}
#load(paste0(indir,"GBM_RNA_10_imm_V2_microglia.Robj"))
load(paste0(indir,"GBM_RNA_10_microglia_V3.Robj"))
```

```{r}
DimPlot(microglia,group.by = "annotation_V1")
DimPlot(microglia,group.by = "annotation_V1",split.by = "progress")
```

```{r}
FeaturePlot(microglia,features = "Ms4a7")
```


### cell cycle and trajectory

```{r}
microglia <- CellCycleScoring(microglia, s.features = s.genes, g2m.features = g2m.genes, set.ident = F)
```

```{r}
DimPlot(microglia,group.by = "Phase",reduction = "pca")
DimPlot(microglia,group.by = "Phase",reduction = "umap")
```

```{r}
cds <- as.cell_data_set(microglia)
cds <- cluster_cells(cds, resolution=1e-3)
plot_cells(cds, color_cells_by = "cluster", show_trajectory_graph = FALSE)
plot_cells(cds, color_cells_by = "partition", show_trajectory_graph = FALSE)
cds <- learn_graph(cds, use_partition = T, verbose = FALSE)

plot_cells(cds,
           color_cells_by = "cluster",
           label_groups_by_cluster=T,
           label_leaves=FALSE,
           label_branch_points=FALSE)
cds <- order_cells(cds, root_cells = colnames(cds[,clusters(cds) == 4]))
plot_cells(cds,
           color_cells_by = "pseudotime",
           group_cells_by = "cluster",
           label_cell_groups = FALSE,
           label_groups_by_cluster=FALSE,
           label_leaves=F,
           label_branch_points=F,
           label_roots = T,
           trajectory_graph_color = "white")+theme_dark()


```
```{r}
saveRDS(cds, file='data/microglia_monocle3.rds')
```


```{r}
microglia <- AddMetaData(microglia,metadata = cds@principal_graph_aux@listData$UMAP$pseudotime,col.name = "monocle3_trajectory")
```


```{r}
save(microglia,file = paste0(indir,"GBM_RNA_10_microglia_V3.Robj"))
```





### check DE profiles

```{r}
markers <- read.table(file = "functional_analysis/microglia_V3_res06_DE.tsv",header = T,sep = "\t")
```


```{r}
ggplot(markers, aes(x = cluster, y = avg_log2FC)) +
  geom_point(aes(colour = cut(p_val_adj, c(0, 0.01,1))),
             size = 1) +
  scale_color_manual(name = "p_val_adj",
                    values = c("(0,0.01]" = "red",
                                  "(0.01, 1]" = "black"),
                     labels = c("<= 0.01", "> 0.01"))+
  theme_classic()+
  RotatedAxis()
ggplot(markers, aes(x = cluster, y = avg_log2FC * -log10(p_val_adj))) +
  geom_point(aes(colour = cut(p_val_adj, c(0, 0.01,1))),
             size = 1)+
  scale_color_manual(name = "p_val_adj",
                    values = c("(0,0.01]" = "red",
                                  "(0.01, 1]" = "black"),
                     labels = c("<= 0.01", "> 0.01"))+
  theme_classic()+
  RotatedAxis()
```
```{r}
microglia$annotation_V1 <- microglia$annotation_V2
microglia$annotation_V2 <- NULL
```


```{r}
# use V2 resident
n_cells <- microglia@meta.data %>% group_by(annotation_V1) %>% summarise(n=n())
n_DE <- markers %>% group_by(cluster) %>% filter(p_val_adj <= 0.01) %>% summarise(n_DE = n())
n_DE_cells <- cbind(n_cells,n_DE)
n_DE_cells <- n_DE_cells[,c("annotation_V1","n","n_DE")]
```

```{r}
table(microglia$annotation_V1)
```

```{r}
ggplot(n_DE_cells,aes(x = annotation_V1, y = n_DE/n))+
  geom_bar(stat = "identity")+RotatedAxis()
```

```{r}
table(microglia$cell_lineage)
```


```{r}
colnames(microglia@meta.data)
microglia@meta.data <- microglia@meta.data %>%
  mutate(cell_type = case_match(
    cell_lineage,
    "microglial" ~ "microglia"
  ))
microglia$cell_lineage <- NULL
table(microglia$cell_type)
```
```{r}
colnames(microglia@meta.data)
```


```{r}
microglia@meta.data[,paste0(c("SCT_snn_res."),seq(0.1,1.5,0.1))] <- NULL
microglia@meta.data[,paste0(c("RNA_snn_res."),seq(1.1,1.5,0.1))] <- NULL
colnames(microglia@meta.data) 
```

```{r}
save(microglia,file = paste0(indir,"GBM_RNA_10_imm_V2_microglia.Robj"))
```


## myeloids

```{r}
load(paste0(indir,"GBM_RNA_10_myeloid_V3p1.Robj"))
```

```{r}
myeloid$annotation_V1 <- myeloid$annotation_V2
myeloid$annotation_V2 <- NULL
```

```{r}
DimPlot(myeloid,group.by = "annotation_V1")
DimPlot(myeloid,group.by = "annotation_V1",split.by = "progress")
```

```{r}
FeaturePlot(myeloid,features = "Ms4a7")
FeaturePlot(myeloid,features = "Tgfbi")
FeaturePlot(myeloid,features = "Cd163")
FeaturePlot(myeloid,features = "Mrc1")
FeaturePlot(myeloid,features = "P2rx7")
FeaturePlot(myeloid,features = "Cd44")
FeaturePlot(myeloid,features = "Ccr2")
```


```{r}
DotPlot(myeloid,group.by = "annotation_V1",features = c("Cd3e","Cd4","Cd8a","Ly6g","Itgax","Itgam","Xcr1","Sirpa","Batf3","Zbtb46","Siglech","Adgre1","Ccr2","Mertk","Mrc1","Cx3cr1")) + RotatedAxis()
```


### check DE profiles

```{r}
markers <- read.table(file = "functional_analysis/myeloid_V3_res03_DE.tsv",header = T,sep = "\t")
```


```{r}
ggplot(markers, aes(x = cluster, y = avg_log2FC)) +
  geom_point(aes(colour = cut(p_val_adj, c(0, 0.01,1))),
             size = 1) +
  scale_color_manual(name = "p_val_adj",
                    values = c("(0,0.01]" = "red",
                                  "(0.01, 1]" = "black"),
                     labels = c("<= 0.01", "> 0.01"))+
  theme_classic()+
  RotatedAxis()
ggplot(markers, aes(x = cluster, y = avg_log2FC * -log10(p_val_adj))) +
  geom_point(aes(colour = cut(p_val_adj, c(0, 0.01,1))),
             size = 1)+
  scale_color_manual(name = "p_val_adj",
                    values = c("(0,0.01]" = "red",
                                  "(0.01, 1]" = "black"),
                     labels = c("<= 0.01", "> 0.01"))+
  theme_classic()+
  RotatedAxis()
```


```{r}
# use V2 resident
n_cells <- myeloid@meta.data %>% group_by(annotation_V1) %>% summarise(n=n())
n_DE <- markers %>% group_by(cluster) %>% filter(p_val_adj <= 0.01) %>% summarise(n_DE = n())
n_DE_cells <- cbind(n_cells,n_DE)
n_DE_cells <- n_DE_cells[,c("annotation_V1","n","n_DE")]
```

```{r}
table(myeloid$annotation_V1)
```

```{r}
ggplot(n_DE_cells,aes(x = annotation_V1, y = n_DE/n))+
  geom_bar(stat = "identity")+RotatedAxis()
```



```{r}
save(myeloid,file = paste0(indir,"GBM_RNA_10_imm_V2_myeloid.Robj"))
```


## lymphoids

```{r}
# load(paste0(indir,"GBM_RNA_10_imm_V2_lymphoid_V2p1.Robj"))
load(paste0(indir,"GBM_RNA_10_lymphoid_V3p1.Robj"))
```


```{r}
lymphoid$annotation_V1 <- lymphoid$annotation_V2
lymphoid$annotation_V2 <- NULL
```

```{r}
FeaturePlot(lymphoid,features = "Siglech")
FeaturePlot(lymphoid,features = "Cd3e")
FeaturePlot(lymphoid,features = "Cd4")
FeaturePlot(lymphoid,features = "Itgax")
FeaturePlot(lymphoid,features = "Itgam")
FeaturePlot(lymphoid,features = "H2-Ab1")
FeaturePlot(lymphoid,features = "Cd79a")
```



```{r}
DimPlot(lymphoid,group.by = "annotation_V1")
DimPlot(lymphoid,group.by = "annotation_V1",split.by = "progress")
```


```{r}
save(lymphoid,file = paste0(indir,"GBM_RNA_10_imm_V2_lymphoid_V2p1.Robj"))
```

### check DE profiles


```{r}
markers <- read.table(file = "functional_analysis/lymphoid_V3_rescombined_DE.tsv",header = T,sep = "\t")
```


```{r}
ggplot(markers, aes(x = cluster, y = avg_log2FC)) +
  geom_point(aes(colour = cut(p_val_adj, c(0, 0.01,1))),
             size = 1) +
  scale_color_manual(name = "p_val_adj",
                    values = c("(0,0.01]" = "red",
                                  "(0.01, 1]" = "black"),
                     labels = c("<= 0.01", "> 0.01"))+
  theme_classic()+
  RotatedAxis()
ggplot(markers, aes(x = cluster, y = avg_log2FC * -log10(p_val_adj))) +
  geom_point(aes(colour = cut(p_val_adj, c(0, 0.01,1))),
             size = 1)+
  scale_color_manual(name = "p_val_adj",
                    values = c("(0,0.01]" = "red",
                                  "(0.01, 1]" = "black"),
                     labels = c("<= 0.01", "> 0.01"))+
  theme_classic()+
  RotatedAxis()
```


```{r}
# use V2 resident
n_cells <- lymphoid@meta.data %>% group_by(annotation_V1) %>% summarise(n=n())
n_DE <- markers %>% group_by(cluster) %>% filter(p_val_adj <= 0.01) %>% summarise(n_DE = n())
n_DE_cells <- cbind(n_cells,n_DE)
n_DE_cells <- n_DE_cells[,c("annotation_V1","n","n_DE")]
```

```{r}
table(lymphoid$annotation_V1)
```

```{r}
ggplot(n_DE_cells,aes(x = annotation_V1, y = n_DE/n))+
  geom_bar(stat = "identity")+RotatedAxis()
```

# calculate proportions: metadata export prep
versions: Glioma V2, immune cells V3, resident and vascular V2

To avoid confusion, data are loaded again in this section

```{r}
load(paste0(indir,"GBM_RNA_10_glioma_V2.Robj"))
load(paste0(indir,"GBM_RNA_10_vascular_V2p1.Robj"))
load(paste0(indir,"GBM_RNA_10_resident_V2p2.Robj"))
load(paste0(indir,"GBM_RNA_10_lymphoid_V3p1.Robj"))
load(paste0(indir,"GBM_RNA_10_myeloid_V3p2.Robj"))
load(paste0(indir,"GBM_RNA_10_microglia_V3.Robj"))
```

```{r}
nrow(myeloid@meta.data)
```

```{r}
myeloid$compartment <- rep("immune_cells",nrow(myeloid@meta.data))
```

```{r}
save(myeloid,file = paste0(indir,"GBM_RNA_10_myeloid_V3p2.Robj"))
```

```{r}
table(Glioma$compartment)
table(microglia$compartment)
table(lymphoid$compartment)
table(myeloid$compartment)
table(resident$compartment)
table(vascular$compartment)
```

```{r}
whole_meta <- rbind(Glioma@meta.data,microglia@meta.data,lymphoid@meta.data,myeloid@meta.data,resident@meta.data,vascular@meta.data)
```

```{r}
whole_meta <- whole_meta %>% 
  mutate(batch = case_match(
    sample.id,
    "S0087" ~ "CD45_only",
    "S0088" ~ "CD45_only",
    "S0096" ~ "CD45_only",
    "S0130" ~ "All_Percoll",
    "S0129" ~ "All_Percoll",
    "S0108" ~ "All_Papain",
    "S0162" ~ "All_Dissociation",
    "S0163" ~ "All_Dissociation",
    "S0164" ~ "All_Dissociation",
    "S0165" ~ "All_Dissociation"
  ))
```

```{r}
table(whole_meta$batch)
```


## batch

```{r}
whole_meta %>% group_by(annotation_V1,compartment, batch) %>% summarise(cluster_size = n()) 
```
```{r}
whole_meta %>% group_by(compartment,batch) %>% summarise(compartment_size = n()) 
```

```{r}
table(whole_meta$batch)
```

```{r}
whole_meta <- whole_meta %>% 
  mutate(batch_ID = case_match(
    batch,
    "All_Dissociation" ~ "batch_all_dissociation",
    "All_Papain" ~ "batch_all_digestion",
    "All_Percoll" ~ "batch_all_digestion",
    "CD45_only" ~ "batch_CD45"
  ))
```



```{r}
write.table(whole_meta,file = "data/whole_meta_annotation_V1.tsv",sep = "\t",col.names = T,row.names = F,quote = F)
```

