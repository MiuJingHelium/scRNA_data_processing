---
title: 'V1 whole dataset: subset creation'
output: html_document
date: "2024-05-24"
---

This markdown contains the codes subsequent to preliminary processing of the 10 sample dataset. In the previous markdown/script, SCT-based (sctransform) and RNA-based (log-normalization) RDS were generated. In this markdown, the goal is to preliminary annotate clusters and create subsets for further cleaning and annotation.

## Initialize

```{r}
library(Seurat)
library(tidyverse)
library(harmony)
```

```{r}
indir <- "./data/"
outdir <- "./output/"
```

```{r}
load("data/GBM_RNA_10.Robj")
```

## generate preliminary annotation

### create featureplot for major cell type markers

Note that some clusters near 1 and 2 are possibly not glioma clusters but cell types of similar lineage.

```{r}
DimPlot(whole, label = T,group.by = "RNA_snn_res.0.1")+ guides(color = guide_legend(override.aes = list(size=4), ncol=2) )
```

```{r}
Idents(whole) <- whole$RNA_snn_res.0.1
```

```{r}
DimPlot(whole,split.by = "progress",label = T)
```

```{r}
whole$RNA_snn_res.0.1 <- as.numeric(whole$RNA_snn_res.0.1)
Idents(whole) <- whole$RNA_snn_res.0.1
Glioma <- subset(whole,idents = c(1,2,15,17))
Immune_cells <- subset(whole,idents = c(0,3,4,7,6,10,16,29))
stromal <- subset(whole, idents = (0:31)[!((0:31) %in% c(1,2,15,17,0,3,4,7,6,10,16,29))])
```

```{r}
whole@meta.data <- whole@meta.data %>% 
  mutate(RNA_snn_res.0.1 = as.character(RNA_snn_res.0.1)) %>%
  mutate(annotation_prelim = case_match(
    RNA_snn_res.0.1,
    "0" ~ "0:microglia",
    "1" ~ "1:glioma-like",
    "2" ~ "2:glioma-like",
    "3" ~ "3:microglia",
    "4" ~ "4:microglia",
    "5" ~ "5:Olig",
    "6" ~ "6:lymphoid and B cells",
    "7" ~ "7:microglia",
    "8" ~ "8:EC",
    "9" ~ "9:astrocytes",
    "10" ~ "10:BAM",
    "11" ~ "11:ciliated cell",
    "12" ~ "12:Dcx+ proneural",
    "13" ~ "13:astrocytes",
    "14" ~ "14:Pdgfra- olig-like",
    "15" ~ "15:Mki67+ glioma-like",
    "16" ~ "16:myeloids",
    "17" ~ "17:Mki67+ glioma-like",
    "18" ~ "18:astrocytes",
    "19" ~ "19:EC",
    "20" ~ "20:EC",
    "21" ~ "21:EC",
    "22" ~ "22:EC",
    "23" ~ "23:Tmem119+ Unknown",
    "24" ~ "24:neural",
    "25" ~ "25:proliferative neural",
    "26" ~ "26:astrocytes",
    "27" ~ "27:EC",
    "28" ~ "28:Unknown Olig-like",
    "29" ~ "29:small Ptprc+",
    "30" ~ "30:Unknown",
    "31" ~ "31:Ptprc+ glioma-like/doublet-like"
    
  ) )
```

```{r}
save(whole, file = "data/GBM_RNA_10.Robj")
```


```{r}
outdir <- "output/"
cluster_prop_comp <- whole@meta.data %>% group_by(progress,annotation_prelim) %>%
  summarise(n = n()) %>% mutate(proportion = 100*n/sum(n))
p1 <- ggplot(cluster_prop_comp,aes(x = progress, y = proportion,fill = progress))+
  geom_bar(stat = "identity", position = 'dodge')+
  facet_wrap(~annotation_prelim,scales = "free")+guides(fill=guide_legend(title="Condition"))+ ylab("Percentage of all cells")+
  theme(
  plot.title = element_blank(),
  axis.title.x = element_blank())+RotatedAxis()
ggsave(filename = paste0(outdir,"Proportion_barplots_major_whole.pdf"), plot = p1, units = "cm",height = 60,width = 40)
p1 <- DimPlot(whole, split.by = "progress",group.by = "annotation_prelim")+guides(color = guide_legend(override.aes = list(size=4), ncol=2) )
ggsave(filename = paste0(outdir,"Progression_dimplot_major_whole.pdf"), plot = p1, units = "cm",height = 15,width = 40)
```



```{r}
save(Glioma, file = "data/GBM_RNA_10_glioma_V1.Robj")
save(Immune_cells, file = "data/GBM_RNA_10_imm_V1.Robj")
save(stromal, file = "data/GBM_RNA_10_stromal_V1.Robj")
```

## processing glioma

```{r}
Glioma <- FindVariableFeatures(object = Glioma, selection.method = 'mean.var.plot', mean.cutoff = c(0.0125, 5), dispersion.cutoff = c(0.5, Inf))
VariableFeatures(Glioma) <-  VariableFeatures(Glioma) [!grepl("^Tra|^Trb|^Igh|^Igk|Mamu-A", VariableFeatures(Glioma))]
VariableFeaturePlot(Glioma)
Glioma <- ScaleData(object = Glioma, features = VariableFeatures(object = Glioma), vars.to.regress = c("nCount_RNA", "percent.mt"))
Glioma <- RunPCA(object = Glioma,
                features =  VariableFeatures(object = Glioma),
                dims = 1:50)
gc()
ElbowPlot(Glioma,ndims = 50)
```

```{r}
Glioma <- RunHarmony(object = Glioma, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
Glioma <- RunUMAP(Glioma,dims = 1:30,reduction = "harmony")
Glioma <- RunTSNE(Glioma,dims = 1:30,reduction = "harmony")

Glioma <- FindNeighbors(Glioma, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  Glioma <- FindClusters(object = Glioma, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
```

```{r}
DimPlot(Glioma,group.by = "RNA_snn_res.0.1",label = T)
DimPlot(Glioma,group.by = "progress",shuffle = T,label = T)

FeaturePlot(Glioma,reduction = "umap",features = "Egfr",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) # classical GMB
FeaturePlot(Glioma,reduction = "umap",features = "Olig1",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
FeaturePlot(Glioma,reduction = "umap",features = "Olig2",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
FeaturePlot(Glioma,reduction = "umap",features = "Sox2",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
FeaturePlot(Glioma,reduction = "umap",features = "S100b",label = T)+scale_colour_gradientn(colors = c("grey", "red", "purple")) #
```

```{r}
save(Glioma, file = "data/GBM_RNA_10_glioma_V1.Robj")
```

```{r}
DotPlot(Glioma,features = c("Olig2","Sox2","S100b","Mki67","P2ry12","Tyrobp","Ly6c2","Cd79a","Ptprc","Lyz2","Cd3e","Aqp4","Pecam1","Igfbp5","Igfbp7","Plp1"),group.by = "RNA_snn_res.0.1")+RotatedAxis()
```
```{r}
whole@meta.data %>% group_by(progress) %>% 
  summarise(n = n())
```


```{r}
cluster_prop_comp <- Glioma@meta.data %>% group_by(progress,RNA_snn_res.0.1) %>% 
  summarise(n = n()) %>% 
  mutate(
         n_by_progress = case_match(progress,
                "HGG" ~ 20948,
                "LGG" ~ 24298,
                "No tumor" ~ 11857
  )) %>% mutate(proportion = 100*n/n_by_progress)
```


```{r}

ggplot(cluster_prop_comp,aes(x = progress, y = proportion,fill = progress))+
  geom_bar(stat = "identity", position = 'dodge')+
  facet_wrap(~RNA_snn_res.0.1,scales = "free")+guides(fill=guide_legend(title="Condition"))+ ylab("Percentage of all cells from the same condition")+
  theme(
  plot.title = element_blank(),
  axis.title.x = element_blank())+RotatedAxis()
```

remove doublet-like clusters

```{r}
Idents(Glioma) <- Glioma$RNA_snn_res.0.1
Glioma <- subset(Glioma,idents = c(0:4,6))
```

```{r}
Glioma <- FindVariableFeatures(object = Glioma, selection.method = 'mean.var.plot', mean.cutoff = c(0.0125, 5), dispersion.cutoff = c(0.5, Inf))
VariableFeatures(Glioma) <-  VariableFeatures(Glioma) [!grepl("^Tra|^Trb|^Igh|^Igk|Mamu-A", VariableFeatures(Glioma))]
VariableFeaturePlot(Glioma)
Glioma <- ScaleData(object = Glioma, features = VariableFeatures(object = Glioma), vars.to.regress = c("nCount_RNA", "percent.mt"))
Glioma <- RunPCA(object = Glioma,
                features =  VariableFeatures(object = Glioma),
                dims = 1:50)
gc()
ElbowPlot(Glioma,ndims = 50)
Glioma <- RunHarmony(object = Glioma, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
Glioma <- RunUMAP(Glioma,dims = 1:30,reduction = "harmony")
Glioma <- RunTSNE(Glioma,dims = 1:30,reduction = "harmony")

Glioma <- FindNeighbors(Glioma, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  Glioma <- FindClusters(object = Glioma, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
```


```{r}
DimPlot(Glioma,group.by = "RNA_snn_res.0.1",label = T)
DimPlot(Glioma,group.by = "progress",shuffle = T,label = T)
DotPlot(Glioma,features = c("Olig2","Sox2","S100b","Mki67","P2ry12","Tyrobp","Ly6c2","Cd79a","Ptprc","Lyz2","Cd3e","Aqp4","Pecam1","Igfbp5","Igfbp7","Plp1"),group.by = "RNA_snn_res.0.1")+RotatedAxis()
```



```{r}
Glioma <- JoinLayers(Glioma)
save(Glioma, file = "data/GBM_RNA_10_glioma_V1.Robj")
```



## processing immune cells

```{r}
Immune_cells <- FindVariableFeatures(object = Immune_cells, selection.method = 'mean.var.plot', mean.cutoff = c(0.0125, 5), dispersion.cutoff = c(0.5, Inf))
VariableFeatures(Immune_cells) <-  VariableFeatures(Immune_cells) [!grepl("^Tra|^Trb|^Igh|^Igk|Mamu-A", VariableFeatures(Immune_cells))]
VariableFeaturePlot(Immune_cells)
Immune_cells <- ScaleData(object = Immune_cells, features = VariableFeatures(object = Immune_cells), vars.to.regress = c("nCount_RNA", "percent.mt"))
Immune_cells <- RunPCA(object = Immune_cells,
                features =  VariableFeatures(object = Immune_cells),
                dims = 1:50)
gc()
ElbowPlot(Immune_cells,ndims = 50)
```

```{r}
Immune_cells <- RunHarmony(object = Immune_cells, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
Immune_cells <- RunUMAP(Immune_cells,dims = 1:30,reduction = "harmony")
Immune_cells <- RunTSNE(Immune_cells,dims = 1:30,reduction = "harmony")

Immune_cells <- FindNeighbors(Immune_cells, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  Immune_cells <- FindClusters(object = Immune_cells, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
```


```{r}
DimPlot(Immune_cells,group.by = "RNA_snn_res.0.1",label = T)
DimPlot(Immune_cells,group.by = "progress",shuffle = T,label = T)
DotPlot(Immune_cells,features = c("Olig2","Sox2","S100b","Mki67","Ptprc","P2ry12","Tyrobp","Ly6c2","Cd79a","Cd19","Mpo","Itgam","Cd200r3","Cd4","Cd8a","Cd3e","Lyz2","Adgre1","Aqp4","Pecam1","Igfbp5","Igfbp7","Plp1"),group.by = "RNA_snn_res.0.1")+RotatedAxis()
```

```{r}
cluster_prop_comp <- Immune_cells@meta.data %>% group_by(progress,RNA_snn_res.0.1) %>% 
  summarise(n = n()) %>% 
  mutate(
         n_by_progress = case_match(progress,
                "HGG" ~ 20948,
                "LGG" ~ 24298,
                "No tumor" ~ 11857
  )) %>% mutate(proportion = 100*n/n_by_progress)
ggplot(cluster_prop_comp,aes(x = progress, y = proportion,fill = progress))+
  geom_bar(stat = "identity", position = 'dodge')+
  facet_wrap(~RNA_snn_res.0.1,scales = "free")+guides(fill=guide_legend(title="Condition"))+ ylab("Percentage of all cells from the same condition")+
  theme(
  plot.title = element_blank(),
  axis.title.x = element_blank())+RotatedAxis()
```

Remove doublet-like clusters

```{r}
Idents(Immune_cells) <- Immune_cells$RNA_snn_res.0.1
Immune_cells <- subset(Immune_cells,idents = c(0:5,7))
```

```{r}
DimPlot(Immune_cells,group.by = "RNA_snn_res.0.1",label = T)
```


```{r}
Immune_cells <- FindVariableFeatures(object = Immune_cells, selection.method = 'mean.var.plot', mean.cutoff = c(0.0125, 5), dispersion.cutoff = c(0.5, Inf))
VariableFeatures(Immune_cells) <-  VariableFeatures(Immune_cells) [!grepl("^Tra|^Trb|^Igh|^Igk|Mamu-A", VariableFeatures(Immune_cells))]
VariableFeaturePlot(Immune_cells)
Immune_cells <- ScaleData(object = Immune_cells, features = VariableFeatures(object = Immune_cells), vars.to.regress = c("nCount_RNA", "percent.mt"))
Immune_cells <- RunPCA(object = Immune_cells,
                features =  VariableFeatures(object = Immune_cells),
                dims = 1:50)
gc()
ElbowPlot(Immune_cells,ndims = 50)
Immune_cells <- RunHarmony(object = Immune_cells, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
Immune_cells <- RunUMAP(Immune_cells,dims = 1:30,reduction = "harmony")
Immune_cells <- RunTSNE(Immune_cells,dims = 1:30,reduction = "harmony")

Immune_cells <- FindNeighbors(Immune_cells, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  Immune_cells <- FindClusters(object = Immune_cells, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
```


```{r}
DimPlot(Immune_cells,group.by = "RNA_snn_res.0.1",label = T)
DimPlot(Immune_cells,label = T)
DimPlot(Immune_cells,group.by = "progress",shuffle = T,label = T)
DotPlot(Immune_cells,features = c("Olig2","Sox2","S100b","Mki67","Ptprc","P2ry12","Tyrobp","Ly6c2","Cd79a","Cd19","Mpo","Itgam","Cd200r3","Cd4","Cd8a","Cd3e","Lyz2","Adgre1","Aqp4","Pecam1","Igfbp5","Igfbp7","Plp1"),group.by = "RNA_snn_res.0.1")+RotatedAxis()
DotPlot(Immune_cells,features = c("Olig2","Sox2","S100b","Mki67","Ptprc","P2ry12","Tyrobp","Ly6c2","Cd79a","Cd19","Mpo","Itgam","Cd200r3","Cd4","Cd8a","Cd3e","Lyz2","Adgre1","Aqp4","Pecam1","Igfbp5","Igfbp7","Plp1"))+RotatedAxis()
```

```{r}
VlnPlot(Immune_cells,features = c("percent.mt"),alpha = 0.2)
VlnPlot(Immune_cells,features = c("nCount_RNA"),alpha = 0.2)
VlnPlot(Immune_cells,features = c("nFeature_RNA"),alpha = 0.2)
VlnPlot(Immune_cells,features = c("nCount_RNA_log10"),alpha = 0.2)
VlnPlot(Immune_cells,features = c("nFeature_RNA_log10"),alpha = 0.2)
```


```{r}
Immune_cells <- JoinLayers(Immune_cells)
save(Immune_cells, file = "data/GBM_RNA_10_imm_V1.Robj")
```



### processing stromal cells


```{r}
stromal <- FindVariableFeatures(object = stromal, selection.method = 'mean.var.plot', mean.cutoff = c(0.0125, 5), dispersion.cutoff = c(0.5, Inf))
VariableFeatures(stromal) <-  VariableFeatures(stromal) [!grepl("^Tra|^Trb|^Igh|^Igk|Mamu-A", VariableFeatures(stromal))]
VariableFeaturePlot(stromal)
stromal <- ScaleData(object = stromal, features = VariableFeatures(object = stromal), vars.to.regress = c("nCount_RNA", "percent.mt"))
stromal <- RunPCA(object = stromal,
                features =  VariableFeatures(object = stromal),
                dims = 1:50)
gc()
ElbowPlot(stromal,ndims = 50)
```

```{r}
stromal <- RunHarmony(object = stromal, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
stromal <- RunUMAP(stromal,dims = 1:30,reduction = "harmony")
stromal <- RunTSNE(stromal,dims = 1:30,reduction = "harmony")

stromal <- FindNeighbors(stromal, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  stromal <- FindClusters(object = stromal, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
```

```{r}
DimPlot(stromal,group.by = "RNA_snn_res.0.1",label = T)
DimPlot(stromal,group.by = "progress",shuffle = T,label = T)
DotPlot(stromal,features = c("Olig2","Sox2","S100b","Mki67","Ptprc","P2ry12","Tyrobp","Ly6c2","Cd79a","Cd19","Mpo","Itgam","Cd200r3","Cd4","Cd8a","Cd3e","Lyz2","Adgre1","Aqp4","Pecam1","Myct1","Egfr","Mog","Igfbp5","Igfbp7","Plp1"),group.by = "RNA_snn_res.0.1")+RotatedAxis()
```

```{r}
cluster_prop_comp <- stromal@meta.data %>% group_by(progress,RNA_snn_res.0.1) %>% 
  summarise(n = n()) %>% 
  mutate(
         n_by_progress = case_match(progress,
                "HGG" ~ 20948,
                "LGG" ~ 24298,
                "No tumor" ~ 11857
  )) %>% mutate(proportion = 100*n/n_by_progress)
ggplot(cluster_prop_comp,aes(x = progress, y = proportion,fill = progress))+
  geom_bar(stat = "identity", position = 'dodge')+
  facet_wrap(~RNA_snn_res.0.1,scales = "free")+guides(fill=guide_legend(title="Condition"))+ ylab("Percentage of all cells from the same condition")+
  theme(
  plot.title = element_blank(),
  axis.title.x = element_blank())+RotatedAxis()
```

```{r}
Idents(stromal) <- stromal$RNA_snn_res.0.1
VlnPlot(stromal,features = c("percent.mt"),alpha = 0.2)
VlnPlot(stromal,features = c("nCount_RNA"),alpha = 0.2)
VlnPlot(stromal,features = c("nFeature_RNA"),alpha = 0.2)
VlnPlot(stromal,features = c("nCount_RNA_log10"),alpha = 0.2)
VlnPlot(stromal,features = c("nFeature_RNA_log10"),alpha = 0.2)
```

```{r}
stromal <- JoinLayers(stromal)
save(stromal, file = "data/GBM_RNA_10_stromal_V1.Robj")
```

Stromal cluster cleaning require additional marker checking. At this point I was unsure of markers for stromal cells and brain resident cells. Clusters that are obviously doublets can be removed at this point.

```{r}
Idents(stromal) <- stromal$RNA_snn_res.0.1
stromal <- subset(stromal,idents = c(0:5,7))
```

```{r}
stromal <- FindVariableFeatures(object = stromal, selection.method = 'mean.var.plot', mean.cutoff = c(0.0125, 5), dispersion.cutoff = c(0.5, Inf))
VariableFeatures(stromal) <-  VariableFeatures(stromal) [!grepl("^Tra|^Trb|^Igh|^Igk|Mamu-A", VariableFeatures(stromal))]
VariableFeaturePlot(stromal)
stromal <- ScaleData(object = stromal, features = VariableFeatures(object = stromal), vars.to.regress = c("nCount_RNA", "percent.mt"))
stromal <- RunPCA(object = stromal,
                features =  VariableFeatures(object = stromal),
                dims = 1:50)
gc()
ElbowPlot(stromal,ndims = 50)
stromal <- RunHarmony(object = stromal, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
stromal <- RunUMAP(stromal,dims = 1:30,reduction = "harmony")
stromal <- RunTSNE(stromal,dims = 1:30,reduction = "harmony")

stromal <- FindNeighbors(stromal, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  stromal <- FindClusters(object = stromal, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
```



