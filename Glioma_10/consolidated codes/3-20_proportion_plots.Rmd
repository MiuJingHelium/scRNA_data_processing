---
title: "cell type proportion plots"
output: html_document
date: "2024-04-28"
---

```{r}
library(tidyverse)
library(Seurat)
library(harmony)
```

```{r}
indir <- "data/"
outdir <- "proportion_plots/"
if (!dir.exists(outdir)){
  dir.create(outdir)
}
```

```{r}
whole_meta <- read.table(file = paste0(indir,"whole_meta_annotation_V1.tsv"),sep = "\t",header = T)
```

# prepare functions for plotting (to be implemented)

# Overview of compartments

## proportion of samples in each sample

```{r}
compart_table_batch <- full_join(
  x = whole_meta %>% group_by(compartment,sample.id,batch) %>% summarise(compartment_size = n()),
  y = whole_meta %>% group_by(sample.id,batch) %>% summarise(sample_size = n()),
  by = c("sample.id","batch")) %>%
  mutate(prop_compart_per_sample = compartment_size*100 /sample_size ) 
compart_table_progress <- full_join(
  x = whole_meta %>% group_by(compartment,sample.id,progress) %>% summarise(compartment_size = n()),
  y = whole_meta %>% group_by(sample.id,progress) %>% summarise(sample_size = n()),
  by = c("sample.id","progress")) %>%
  mutate(prop_compart_per_sample = compartment_size*100 /sample_size ) 
```

```{r for batch_ID version}
compart_table <- full_join(
  x = whole_meta %>% group_by(compartment,sample.id,progress,batch_ID) %>% summarise(compartment_size = n()),
  y = whole_meta %>% group_by(sample.id,progress,batch_ID) %>% summarise(sample_size = n()),
  by = c("sample.id","progress","batch_ID")) %>%
  mutate(prop_compart_per_sample = compartment_size*100 /sample_size ) %>% 
  group_by(batch_ID,compartment) %>% mutate(compart_size_batch = sum(compartment_size),
                             sample_size_batch = sum(sample_size)) %>% 
  ungroup() %>%
  group_by(progress,compartment) %>% mutate(compart_size_progress = sum(compartment_size),
                                sample_size_progress = sum(sample_size)) %>% 
  ungroup() %>%
  mutate(prop_compart_per_batch = compart_size_batch*100/sample_size_batch,
         prop_compart_per_progress = compart_size_progress*100/sample_size_progress)
```


Version note: adding annotation_V1 will add more table points; the table needs to be collapsed before actual plotting.



```{r}
compartment <- "compartment_overview"
outdir <- paste0("proportion_plots/",compartment,"/")
if (!dir.create(outdir)){
  dir.create(outdir)
}
```


### boxplots

```{r}
g <- ggplot(compart_table_progress)+
  geom_boxplot(aes(x = compartment, y = prop_compart_per_sample,fill = progress)) +
  geom_jitter(aes(x = compartment, y = prop_compart_per_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"compartment_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
g <- ggplot(compart_table_batch)+
  geom_boxplot(aes(x = compartment, y = prop_compart_per_sample,fill = batch)) +
  geom_jitter(aes(x = compartment, y = prop_compart_per_sample,shape = batch), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"compartment_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 10,height = 10)
```


```{r}
g <- ggplot(compart_table)+
  geom_boxplot(aes(x = compartment, y = prop_compart_per_sample,fill = batch_ID)) +
  geom_jitter(aes(x = compartment, y = prop_compart_per_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"compartment_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)
```


### barplots (of average)

```{r}
# by sample barplot
g <- ggplot(compart_table) +
  geom_bar(aes(x = sample.id, y = prop_compart_per_sample,fill = compartment),stat = "summary",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  RotatedAxis()
ggsave(filename = paste0(outdir,"compartment_prop_barplots_by_sample_ann_V1.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(compart_table) +
  geom_bar(aes(x = sample.id, y = prop_compart_per_sample,fill = compartment),stat = "summary",position = "stack") +
  facet_wrap(~progress, scales = "free")+
  RotatedAxis()
ggsave(filename = paste0(outdir,"compartment_prop_barplots_by_sample_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```



```{r}
batch_comp_table <- full_join(
  x = whole_meta %>% group_by(compartment,batch) %>% summarise(compartment_size = n()),
  y = whole_meta %>% group_by(batch) %>% summarise(batch_size = n()),
  by = c("batch")) %>%
  mutate(prop_compart_per_batch = compartment_size*100 /batch_size)
```


```{r}
g <- ggplot(batch_comp_table) +
  geom_bar(aes(x = batch, y = prop_compart_per_batch,fill = compartment),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"compartment_prop_barplots_by_batch_ann_V1.pdf"),plot = g, width = 8,height = 8)
```



```{r}
progress_comp_table <- full_join(
  x = whole_meta %>% group_by(compartment,progress) %>% summarise(compartment_size = n()),
  y = whole_meta %>% group_by(progress) %>% summarise(progress_size = n()),
  by = c("progress")) %>%
  mutate(prop_compart_per_progress = compartment_size*100 /progress_size)
```



```{r}
g <- ggplot(progress_comp_table) +
  geom_bar(aes(x = progress, y = prop_compart_per_progress,fill = compartment),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"compartment_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


```{r}
batch_ID_comp_table <- full_join(
  x = whole_meta %>% group_by(compartment,batch_ID) %>% summarise(compartment_size = n()),
  y = whole_meta %>% group_by(batch_ID) %>% summarise(batch_ID_size = n()),
  by = c("batch_ID")) %>%
  mutate(prop_compart_per_batch_ID = compartment_size*100 /batch_ID_size)
```


```{r}
g <- ggplot(batch_ID_comp_table) +
  geom_bar(aes(x = batch_ID, y = prop_compart_per_batch_ID,fill = compartment),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"compartment_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


# create cluster proportion tables 

Note type immune cell types have too many clusters so analysis will be performed at subcompartment level.

```{r}
# single sample prop with progress and batch stratifiable labels
cluster_sample_prop_table <- full_join(
                                  x = whole_meta %>% 
                                    group_by(annotation_V1,sample.id,compartment,progress,batch) %>%
                                    summarise(cluster_size = n()),
                                  y = whole_meta %>% 
                                    group_by(sample.id,progress,batch) %>% 
                                    summarise(sample_size = n()),
                                  by = c("sample.id","progress","batch")) %>%
                          mutate(prop_cluster_in_sample = cluster_size*100 /sample_size )
# single sample prop with progress and batch stratifiable labels
cluster_sample_compart_prop_table <- full_join(
                                  x = whole_meta %>% 
                                    group_by(annotation_V1,compartment,sample.id,progress,batch) %>%
                                    summarise(cluster_size = n()),
                                  y = whole_meta %>% 
                                    group_by(compartment,sample.id,progress,batch) %>% 
                                    summarise(sample_compartment_size = n()),
                                  by = c("compartment","sample.id","progress","batch")) %>%
                          mutate(prop_cluster_in_compartment_per_sample = cluster_size*100 /sample_compartment_size )
  
# overall in batch clust/comp
cluster_compartment_prop_by_batch <- full_join(
                                  x = whole_meta %>% 
                                    group_by(annotation_V1,compartment,batch) %>%
                                    summarise(cluster_size = n()),
                                  y = whole_meta %>% 
                                    group_by(compartment,batch) %>% 
                                    summarise(batch_compartment_size = n()),
                                  by = c("compartment","batch")) %>%
                          mutate(prop_cluster_in_compartment_per_batch = cluster_size*100 /batch_compartment_size )

# overall in batch: clust/batch
cluster_batch_prop <- full_join(
                                  x = whole_meta %>% 
                                    group_by(annotation_V1,compartment,batch) %>%
                                    summarise(cluster_size = n()),
                                  y = whole_meta %>% 
                                    group_by(batch) %>% 
                                    summarise(batch_size = n()),
                                  by = c("batch")) %>%
                          mutate(prop_cluster_in_batch = cluster_size*100 /batch_size )

# overall in progress clust/comp
cluster_compartment_prop_by_progress <- full_join(
                                  x = whole_meta %>% 
                                    group_by(annotation_V1,compartment,progress) %>%
                                    summarise(cluster_size = n()),
                                  y = whole_meta %>% 
                                    group_by(compartment,progress) %>% 
                                    summarise(progress_compartment_size = n()),
                                  by = c("progress","compartment")) %>%
                          mutate(prop_cluster_in_compartment_per_progress = cluster_size*100 /progress_compartment_size )

# overall in progress: clust/progress
cluster_progress_prop <- full_join(
                                  x = whole_meta %>% 
                                    group_by(annotation_V1,compartment,progress) %>%
                                    summarise(cluster_size = n()),
                                  y = whole_meta %>% 
                                    group_by(progress) %>% 
                                    summarise(progress_size = n()),
                                  by = c("progress")) %>%
                          mutate(prop_cluster_in_progress = cluster_size*100 /progress_size )

```


```{r batch ID version}
cluster_sample_prop_table_batch_ID <- full_join(
                                  x = whole_meta %>% 
                                    group_by(annotation_V1,sample.id,compartment,progress,batch_ID) %>%
                                    summarise(cluster_size = n()),
                                  y = whole_meta %>% 
                                    group_by(sample.id,progress,batch_ID) %>% 
                                    summarise(sample_size = n()),
                                  by = c("sample.id","progress","batch_ID")) %>%
                          mutate(prop_cluster_in_sample = cluster_size*100 /sample_size )
# single sample prop with progress and batch stratifiable labels
cluster_sample_compart_prop_table_batch_ID <- full_join(
                                  x = whole_meta %>% 
                                    group_by(annotation_V1,compartment,sample.id,progress,batch_ID) %>%
                                    summarise(cluster_size = n()),
                                  y = whole_meta %>% 
                                    group_by(compartment,sample.id,progress,batch_ID) %>% 
                                    summarise(sample_compartment_size = n()),
                                  by = c("compartment","sample.id","progress","batch_ID")) %>%
                          mutate(prop_cluster_in_compartment_per_sample = cluster_size*100 /sample_compartment_size )
  
# overall in batch clust/comp
cluster_compartment_prop_by_batch_ID <- full_join(
                                  x = whole_meta %>% 
                                    group_by(annotation_V1,compartment,batch_ID) %>%
                                    summarise(cluster_size = n()),
                                  y = whole_meta %>% 
                                    group_by(compartment,batch_ID) %>% 
                                    summarise(batch_compartment_size = n()),
                                  by = c("compartment","batch_ID")) %>%
                          mutate(prop_cluster_in_compartment_per_batch = cluster_size*100 /batch_compartment_size )

# overall in batch: clust/batch
cluster_batch_prop_batch_ID <- full_join(
                                  x = whole_meta %>% 
                                    group_by(annotation_V1,compartment,batch_ID) %>%
                                    summarise(cluster_size = n()),
                                  y = whole_meta %>% 
                                    group_by(batch_ID) %>% 
                                    summarise(batch_size = n()),
                                  by = c("batch_ID")) %>%
                          mutate(prop_cluster_in_batch = cluster_size*100 /batch_size )
```

## Glioma 

```{r}
compartment <- "neoplastic"
outdir <- paste0("proportion_plots/",compartment,"/")
if (!dir.create(outdir)){
  dir.create(outdir)
}
```


### box plots

#### clust_size / sample_size

```{r}
g <- ggplot(cluster_sample_prop_table %>% filter(compartment == "neoplastic"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_sample,fill = progress)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_cluster_sample_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
g <- ggplot(cluster_sample_prop_table %>% filter(compartment == "neoplastic"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_sample,fill = batch)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_sample,shape = batch), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_cluster_sample_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

#### clust_size / compartment_size

```{r}
g <- ggplot(cluster_sample_compart_prop_table %>% filter(compartment == "neoplastic"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,fill = progress)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_cluster_compartment_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
g <- ggplot(cluster_sample_compart_prop_table %>% filter(compartment == "neoplastic"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,fill = batch)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,shape = batch), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_cluster_compartment_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 10,height = 10)
```


### bar plots

#### clust_size / batch_size

```{r}
g <- ggplot(cluster_batch_prop %>% filter(compartment == "neoplastic")) +
  geom_bar(aes(x = batch, y = prop_cluster_in_batch,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_batch_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

#### cluster / batch_comp_size

```{r}
g <- ggplot(cluster_compartment_prop_by_batch %>% filter(compartment == "neoplastic")) +
  geom_bar(aes(x = batch, y = prop_cluster_in_compartment_per_batch,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_comp_prop_barplots_by_batch_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

#### clust_size / progress_size

```{r}
g <- ggplot(cluster_progress_prop %>% filter(compartment == "neoplastic")) +
  geom_bar(aes(x = progress, y = prop_cluster_in_progress,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_progress_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

#### cluster / progress_comp_size

```{r}
g <- ggplot(cluster_compartment_prop_by_progress %>% filter(compartment == "neoplastic")) +
  geom_bar(aes(x = progress, y = prop_cluster_in_compartment_per_progress,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_comp_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

### batch_ID version

```{r}
g <- ggplot(cluster_sample_prop_table_batch_ID %>% filter(compartment == "neoplastic"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_cluster_sample_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)
```


```{r}
# by sample barplot
g <- ggplot(cluster_sample_prop_table_batch_ID %>% filter(compartment == "neoplastic")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_cluster_sample_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(cluster_sample_prop_table_batch_ID %>% filter(compartment == "neoplastic")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~progress, scales = "free")+
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_cluster_sample_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


```{r}
g <- ggplot(cluster_sample_compart_prop_table_batch_ID %>% filter(compartment == "neoplastic"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_cluster_compartment_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
# by sample barplot
g <- ggplot(cluster_sample_compart_prop_table_batch_ID %>% filter(compartment == "neoplastic")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_compartment_per_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_cluster_compartment_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(cluster_sample_compart_prop_table_batch_ID %>% filter(compartment == "neoplastic")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_compartment_per_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~progress, scales = "free")+
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_cluster_compartment_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

```{r}
g <- ggplot(cluster_batch_prop_batch_ID %>% filter(compartment == "neoplastic")) +
  geom_bar(aes(x = batch_ID, y = prop_cluster_in_batch,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_batch_ID_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

```{r}
g <- ggplot(cluster_compartment_prop_by_batch_ID %>% filter(compartment == "neoplastic")) +
  geom_bar(aes(x = batch_ID, y = prop_cluster_in_compartment_per_batch,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_comp_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)
```




## Neuronal

```{r}
compartment <- "neuronal"
outdir <- paste0("proportion_plots/",compartment,"/")
if (!dir.create(outdir)){
  dir.create(outdir)
}
```


### box plots

#### clust_size / sample_size

```{r}
g <- ggplot(cluster_sample_prop_table %>% filter(compartment == "neuronal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_sample,fill = progress)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_cluster_sample_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
g <- ggplot(cluster_sample_prop_table %>% filter(compartment == "neuronal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_sample,fill = batch)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_sample,shape = batch), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_cluster_sample_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

#### clust_size / compartment_size

```{r}
g <- ggplot(cluster_sample_compart_prop_table %>% filter(compartment == "neuronal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,fill = progress)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_cluster_compartment_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
g <- ggplot(cluster_sample_compart_prop_table %>% filter(compartment == "neuronal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,fill = batch)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,shape = batch), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_cluster_compartment_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 10,height = 10)
```


### bar plots

#### clust_size / batch_size

```{r}
g <- ggplot(cluster_batch_prop %>% filter(compartment == "neuronal")) +
  geom_bar(aes(x = batch, y = prop_cluster_in_batch,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_batch_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

#### cluster / batch_comp_size

```{r}
g <- ggplot(cluster_compartment_prop_by_batch %>% filter(compartment == "neuronal")) +
  geom_bar(aes(x = batch, y = prop_cluster_in_compartment_per_batch,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_comp_prop_barplots_by_batch_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


#### clust_size / progress_size

```{r}
g <- ggplot(cluster_progress_prop %>% filter(compartment == "neuronal")) +
  geom_bar(aes(x = progress, y = prop_cluster_in_progress,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_progress_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

#### cluster / progress_comp_size

```{r}
g <- ggplot(cluster_compartment_prop_by_progress %>% filter(compartment == "neuronal")) +
  geom_bar(aes(x = progress, y = prop_cluster_in_compartment_per_progress,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_comp_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

### batch_ID version

```{r}
g <- ggplot(cluster_sample_prop_table_batch_ID %>% filter(compartment == "neuronal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_cluster_sample_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
# by sample barplot
g <- ggplot(cluster_sample_prop_table_batch_ID %>% filter(compartment == "neuronal")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_cluster_sample_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(cluster_sample_prop_table_batch_ID %>% filter(compartment == "neuronal")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~progress, scales = "free")+
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_cluster_sample_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```



```{r}
g <- ggplot(cluster_sample_compart_prop_table_batch_ID %>% filter(compartment == "neuronal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_cluster_compartment_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
# by sample barplot
g <- ggplot(cluster_sample_compart_prop_table_batch_ID %>% filter(compartment == "neuronal")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_compartment_per_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_cluster_compartment_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(cluster_sample_compart_prop_table_batch_ID %>% filter(compartment == "neuronal")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_compartment_per_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~progress, scales = "free")+
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_cluster_compartment_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

```{r}
g <- ggplot(cluster_batch_prop_batch_ID %>% filter(compartment == "neuronal")) +
  geom_bar(aes(x = batch_ID, y = prop_cluster_in_batch,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_batch_ID_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

```{r}
g <- ggplot(cluster_compartment_prop_by_batch_ID %>% filter(compartment == "neuronal")) +
  geom_bar(aes(x = batch_ID, y = prop_cluster_in_compartment_per_batch,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_comp_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)
```




## stromal

### box plots

#### clust_size / sample_size

```{r}
compartment <- "stromal"
outdir <- paste0("proportion_plots/",compartment,"/")
if (!dir.create(outdir)){
  dir.create(outdir)
}
```


```{r}
g <- ggplot(cluster_sample_prop_table %>% filter(compartment == "stromal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_sample,fill = progress)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_cluster_sample_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
g <- ggplot(cluster_sample_prop_table %>% filter(compartment == "stromal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_sample,fill = batch)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_sample,shape = batch), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_cluster_sample_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

#### clust_size / compartment_size

```{r}
g <- ggplot(cluster_sample_compart_prop_table %>% filter(compartment == "stromal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,fill = progress)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_cluster_compartment_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
g <- ggplot(cluster_sample_compart_prop_table %>% filter(compartment == "stromal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,fill = batch)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,shape = batch), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_cluster_compartment_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 10,height = 10)
```


### bar plots

#### clust_size / batch_size

```{r}
g <- ggplot(cluster_batch_prop %>% filter(compartment == "stromal")) +
  geom_bar(aes(x = batch, y = prop_cluster_in_batch,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_batch_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

#### cluster / batch_comp_size

```{r}
g <- ggplot(cluster_compartment_prop_by_batch %>% filter(compartment == "stromal")) +
  geom_bar(aes(x = batch, y = prop_cluster_in_compartment_per_batch,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_comp_prop_barplots_by_batch_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


#### clust_size / progress_size

```{r}
g <- ggplot(cluster_progress_prop %>% filter(compartment == "stromal")) +
  geom_bar(aes(x = progress, y = prop_cluster_in_progress,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_progress_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

#### cluster / progress_comp_size

```{r}
g <- ggplot(cluster_compartment_prop_by_progress %>% filter(compartment == "stromal")) +
  geom_bar(aes(x = progress, y = prop_cluster_in_compartment_per_progress,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_comp_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

### batch_ID version

```{r}
g <- ggplot(cluster_sample_prop_table_batch_ID %>% filter(compartment == "stromal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_cluster_sample_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
# by sample barplot
g <- ggplot(cluster_sample_prop_table_batch_ID %>% filter(compartment == "stromal")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_cluster_sample_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(cluster_sample_prop_table_batch_ID %>% filter(compartment == "stromal")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~progress, scales = "free")+
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_cluster_sample_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


```{r}
g <- ggplot(cluster_sample_compart_prop_table_batch_ID %>% filter(compartment == "stromal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_cluster_compartment_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
# by sample barplot
g <- ggplot(cluster_sample_compart_prop_table_batch_ID %>% filter(compartment == "stromal")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_compartment_per_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_cluster_compartment_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(cluster_sample_compart_prop_table_batch_ID %>% filter(compartment == "stromal")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_compartment_per_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~progress, scales = "free")+
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_cluster_compartment_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

```{r}
g <- ggplot(cluster_batch_prop_batch_ID %>% filter(compartment == "stromal")) +
  geom_bar(aes(x = batch_ID, y = prop_cluster_in_batch,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromall_batch_ID_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

```{r}
g <- ggplot(cluster_compartment_prop_by_batch_ID %>% filter(compartment == "stromal")) +
  geom_bar(aes(x = batch_ID, y = prop_cluster_in_compartment_per_batch,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_comp_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)
```



## Immune cells


```{r}
Immune_meta <- whole_meta %>% filter(compartment == "immune_cells")
```

```{r}
compartment <- "immune_cells"
outdir <- paste0("proportion_plots/",compartment,"/")
if (!dir.create(outdir)){
  dir.create(outdir)
}
```


### sum by sample; box plots

```{r}
# proportion of main celltypes in the immune cell compartment; sum by sample
annMain_compart_prop <- full_join(
                                  x = Immune_meta %>% 
                                    group_by(annotation_main,sample.id,compartment,progress,batch) %>%
                                    summarise(annMain_size = n()),
                                  y = Immune_meta %>% 
                                    group_by(compartment,sample.id,progress,batch) %>% 
                                    summarise(sample_compartment_size = n()),
                                  by = c("compartment","sample.id","progress","batch")) %>%
                          mutate(prop_annMain_in_compartment_by_sample = annMain_size*100 /sample_compartment_size )


# proportion of subcompartment in the immune cell compartment; sum by sample
subcomp_compart_prop <- full_join(
                                  x = Immune_meta %>% 
                                    group_by(cell_type,sample.id,compartment,progress,batch) %>%
                                    summarise(celltype_size = n()),
                                  y = Immune_meta %>% 
                                    group_by(compartment,sample.id,progress,batch) %>% 
                                    summarise(sample_compartment_size = n()),
                                  by = c("compartment","sample.id","progress","batch")) %>%
                          mutate(prop_celltype_in_compartment_by_sample = celltype_size*100 /sample_compartment_size )

# proportion of clusters in subcompartment of immune cells; sum by sample

clust_subcomp_prop <- full_join(
                                  x = Immune_meta %>% 
                                    group_by(annotation_V1,sample.id,cell_type,progress,batch) %>%
                                    summarise(clust_size = n()),
                                  y = Immune_meta %>% 
                                    group_by(cell_type,sample.id,progress,batch) %>% 
                                    summarise(sample_celltype_size = n()),
                                  by = c("cell_type","sample.id","progress","batch")) %>%
                          mutate(prop_clust_in_celltype_by_sample = clust_size*100 /sample_celltype_size )

```

```{r batch_ID version}
# proportion of main celltypes in the immune cell compartment; sum by sample
annMain_compart_prop_batch_ID <- full_join(
                                  x = Immune_meta %>% 
                                    group_by(annotation_main,sample.id,compartment,progress,batch_ID) %>%
                                    summarise(annMain_size = n()),
                                  y = Immune_meta %>% 
                                    group_by(compartment,sample.id,progress,batch_ID) %>% 
                                    summarise(sample_compartment_size = n()),
                                  by = c("compartment","sample.id","progress","batch_ID")) %>%
                          mutate(prop_annMain_in_compartment_by_sample = annMain_size*100 /sample_compartment_size )


# proportion of subcompartment in the immune cell compartment; sum by sample
subcomp_compart_prop_batch_ID <- full_join(
                                  x = Immune_meta %>% 
                                    group_by(cell_type,sample.id,compartment,progress,batch_ID) %>%
                                    summarise(celltype_size = n()),
                                  y = Immune_meta %>% 
                                    group_by(compartment,sample.id,progress,batch_ID) %>% 
                                    summarise(sample_compartment_size = n()),
                                  by = c("compartment","sample.id","progress","batch_ID")) %>%
                          mutate(prop_celltype_in_compartment_by_sample = celltype_size*100 /sample_compartment_size )

# proportion of clusters in subcompartment of immune cells; sum by sample

clust_subcomp_prop_batch_ID <- full_join(
                                  x = Immune_meta %>% 
                                    group_by(annotation_V1,sample.id,cell_type,progress,batch_ID) %>%
                                    summarise(clust_size = n()),
                                  y = Immune_meta %>% 
                                    group_by(cell_type,sample.id,progress,batch_ID) %>% 
                                    summarise(sample_celltype_size = n()),
                                  by = c("cell_type","sample.id","progress","batch_ID")) %>%
                          mutate(prop_clust_in_celltype_by_sample = clust_size*100 /sample_celltype_size )

```



#### proportion of main celltypes in the immune cell compartment; sum by sample

```{r}
g <- ggplot(annMain_compart_prop)+
  geom_boxplot(aes(x = annotation_main, y = prop_annMain_in_compartment_by_sample,fill = progress)) +
  geom_jitter(aes(x = annotation_main, y = prop_annMain_in_compartment_by_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_main_compartment_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)

g <- ggplot(annMain_compart_prop)+
  geom_boxplot(aes(x = annotation_main, y = prop_annMain_in_compartment_by_sample,fill = batch)) +
  geom_jitter(aes(x = annotation_main, y = prop_annMain_in_compartment_by_sample,shape = batch), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_main_compartment_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 10,height = 10)
```


#### proportion of subcompartment in the immune cell compartment; sum by sample

```{r}
g <- ggplot(subcomp_compart_prop)+
  geom_boxplot(aes(x = cell_type, y = prop_celltype_in_compartment_by_sample,fill = progress)) +
  geom_jitter(aes(x = cell_type, y = prop_celltype_in_compartment_by_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_celltype_compartment_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)

g <- ggplot(subcomp_compart_prop)+
  geom_boxplot(aes(x = cell_type, y = prop_celltype_in_compartment_by_sample,fill = batch)) +
  geom_jitter(aes(x = cell_type, y = prop_celltype_in_compartment_by_sample,shape = batch), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_celltype_compartment_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 10,height = 10)
```


#### proportion of clusters in subcompartment of immune cells; sum by sample

```{r}
g <- ggplot(clust_subcomp_prop)+
  geom_boxplot(aes(x = annotation_V1, y = prop_clust_in_celltype_by_sample,fill = progress)) +
  geom_jitter(aes(x = annotation_V1, y = prop_clust_in_celltype_by_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()+
  facet_wrap(~cell_type,scales = "free")
ggsave(filename = paste0(outdir,"immune_cells_clust_celltype_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)

g <- ggplot(clust_subcomp_prop)+
  geom_boxplot(aes(x = annotation_V1, y = prop_clust_in_celltype_by_sample,fill = batch)) +
  geom_jitter(aes(x = annotation_V1, y = prop_clust_in_celltype_by_sample,shape = batch), size=0.4, alpha=0.9) +
  RotatedAxis()+
  facet_wrap(~cell_type,scales = "free")
ggsave(filename = paste0(outdir,"immune_cells_clust_celltype_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 10,height = 10)
```


```{r}

g <- ggplot(annMain_compart_prop_batch_ID)+
  geom_boxplot(aes(x = annotation_main, y = prop_annMain_in_compartment_by_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_main, y = prop_annMain_in_compartment_by_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_main_compartment_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)

g <- ggplot(subcomp_compart_prop_batch_ID)+
  geom_boxplot(aes(x = cell_type, y = prop_celltype_in_compartment_by_sample,fill = batch_ID)) +
  geom_jitter(aes(x = cell_type, y = prop_celltype_in_compartment_by_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_celltype_compartment_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)

g <- ggplot(clust_subcomp_prop_batch_ID)+
  geom_boxplot(aes(x = annotation_V1, y = prop_clust_in_celltype_by_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_clust_in_celltype_by_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()+
  facet_wrap(~cell_type,scales = "free")
ggsave(filename = paste0(outdir,"immune_cells_clust_celltype_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
# ann_main
g <- ggplot(annMain_compart_prop_batch_ID) +
  geom_bar(aes(x = sample.id, y = prop_annMain_in_compartment_by_sample,fill = annotation_main),stat = "summary",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_main_compartment_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(annMain_compart_prop_batch_ID) +
  geom_bar(aes(x = sample.id, y = prop_annMain_in_compartment_by_sample,fill = annotation_main),stat = "summary",position = "stack") +
  facet_wrap(~progress, scales = "free")+
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_main_compartment_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```





```{r}

# cell_type
g <- ggplot(subcomp_compart_prop_batch_ID) +
  geom_bar(aes(x = sample.id, y = prop_celltype_in_compartment_by_sample,fill = cell_type),stat = "summary",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_celltype_compartment_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(subcomp_compart_prop_batch_ID) +
  geom_bar(aes(x = sample.id, y = prop_celltype_in_compartment_by_sample,fill = cell_type),stat = "summary",position = "stack") +
  facet_wrap(~progress, scales = "free")+
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_celltype_compartment_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


```{r }
subcomps <- unique(Immune_meta$cell_type)
glist <- lapply(subcomps,function(x){
  ggplot(clust_subcomp_prop %>% filter(cell_type == x))+
    geom_bar(aes(x = progress, y = prop_clust_in_celltype,fill = annotation_V1),stat = "summary",position = "stack")+
    RotatedAxis()
})
g <- gridExtra::grid.arrange(grobs = glist, ncol = 2)
ggsave(filename = paste0(outdir,"immune_cells_progress_cluster_celltype_prop_barplots_ann_V1.pdf"),plot = g, width = 12,height = 12)
```

```{r need gridExtra for the annotation plots}

# ann_V1
subcomps <- unique(Immune_meta$cell_type)
glist <- lapply(subcomps,function(x){
  ggplot(clust_subcomp_prop_batch_ID %>% filter(cell_type == x)) +
  geom_bar(aes(x = sample.id, y = prop_clust_in_celltype_by_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_grid(cell_type~batch_ID, scales = "free")+
  RotatedAxis()
})
g <- gridExtra::grid.arrange(grobs = glist, ncol = 2)
ggsave(filename = paste0(outdir,"immune_cells_celltype_compartment_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 12,height = 12)

subcomps <- unique(Immune_meta$cell_type)
glist <- lapply(subcomps,function(x){
  ggplot(clust_subcomp_prop_batch_ID %>% filter(cell_type == x)) +
  geom_bar(aes(x = sample.id, y = prop_clust_in_celltype_by_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_grid(cell_type~progress, scales = "free")+
  RotatedAxis()
})
g <- gridExtra::grid.arrange(grobs = glist, ncol = 2)
ggsave(filename = paste0(outdir,"immune_cells_celltype_compartment_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 12,height = 12)

```




### sum by progress; bar plots

```{r}
# proportion of main celltypes in the immune cell compartment; sum by sample
annMain_compart_prop <- full_join(
                                  x = Immune_meta %>% 
                                    group_by(annotation_main, compartment,progress) %>%
                                    summarise(annMain_size = n()),
                                  y = Immune_meta %>% 
                                    group_by(compartment,progress) %>% 
                                    summarise(compartment_size = n()),
                                  by = c("compartment","progress")) %>%
                          mutate(prop_annMain_in_compartment = annMain_size*100 /compartment_size )


# proportion of subcompartment in the immune cell compartment; sum by sample
subcomp_compart_prop <- full_join(
                                  x = Immune_meta %>% 
                                    group_by(cell_type,compartment,progress) %>%
                                    summarise(celltype_size = n()),
                                  y = Immune_meta %>% 
                                    group_by(compartment,progress) %>% 
                                    summarise(compartment_size = n()),
                                  by = c("compartment","progress")) %>%
                          mutate(prop_celltype_in_compartment = celltype_size*100 /compartment_size )

# proportion of clusters in subcompartment of immune cells; sum by sample

clust_subcomp_prop <- full_join(
                                  x = Immune_meta %>% 
                                    group_by(annotation_V1,cell_type,progress) %>%
                                    summarise(clust_size = n()),
                                  y = Immune_meta %>% 
                                    group_by(cell_type,progress) %>% 
                                    summarise(celltype_size = n()),
                                  by = c("cell_type","progress")) %>%
                          mutate(prop_clust_in_celltype = clust_size*100 /celltype_size )

```



#### proportion of main celltypes in the immune cell compartment;

```{r}
g <- ggplot(annMain_compart_prop) +
  geom_bar(aes(x = progress, y = prop_annMain_in_compartment,fill = annotation_main),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_progress_main_comp_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


#### proportion of subcompartment in the immune cell compartment; 

```{r}
g <- ggplot(subcomp_compart_prop) +
  geom_bar(aes(x = progress, y = prop_celltype_in_compartment,fill = cell_type),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_progress_celltype_comp_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


#### proportion of clusters in subcompartment of immune cells; 

```{r}
subcomps <- unique(Immune_meta$cell_type)
glist <- lapply(subcomps,function(x){
  ggplot(clust_subcomp_prop %>% filter(cell_type == x))+
    geom_bar(aes(x = progress, y = prop_clust_in_celltype,fill = annotation_V1),stat = "summary",position = "stack")+
    RotatedAxis()
})
g <- gridExtra::grid.arrange(grobs = glist, ncol = 2)
ggsave(filename = paste0(outdir,"immune_cells_progress_cluster_celltype_prop_barplots_ann_V1.pdf"),plot = g, width = 12,height = 12)
```



### sum by batch; bar plots


```{r}
# proportion of main celltypes in the immune cell compartment; sum by sample
annMain_compart_prop <- full_join(
                                  x = Immune_meta %>% 
                                    group_by(annotation_main, compartment,batch) %>%
                                    summarise(annMain_size = n()),
                                  y = Immune_meta %>% 
                                    group_by(compartment,batch) %>% 
                                    summarise(compartment_size = n()),
                                  by = c("compartment","batch")) %>%
                          mutate(prop_annMain_in_compartment = annMain_size*100 /compartment_size )


# proportion of subcompartment in the immune cell compartment; sum by sample
subcomp_compart_prop <- full_join(
                                  x = Immune_meta %>% 
                                    group_by(cell_type,compartment,batch) %>%
                                    summarise(celltype_size = n()),
                                  y = Immune_meta %>% 
                                    group_by(compartment,batch) %>% 
                                    summarise(compartment_size = n()),
                                  by = c("compartment","batch")) %>%
                          mutate(prop_celltype_in_compartment = celltype_size*100 /compartment_size )

# proportion of clusters in subcompartment of immune cells; sum by sample

clust_subcomp_prop <- full_join(
                                  x = Immune_meta %>% 
                                    group_by(annotation_V1,cell_type,batch) %>%
                                    summarise(clust_size = n()),
                                  y = Immune_meta %>% 
                                    group_by(cell_type,batch) %>% 
                                    summarise(celltype_size = n()),
                                  by = c("cell_type","batch")) %>%
                          mutate(prop_clust_in_celltype = clust_size*100 /celltype_size )

```

#### proportion of main celltypes in the immune cell compartment;

```{r}
g <- ggplot(annMain_compart_prop) +
  geom_bar(aes(x = batch, y = prop_annMain_in_compartment,fill = annotation_main),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_batch_main_comp_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


#### proportion of subcompartment in the immune cell compartment; 

```{r}
g <- ggplot(subcomp_compart_prop) +
  geom_bar(aes(x = batch, y = prop_celltype_in_compartment,fill = cell_type),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_batch_celltype_comp_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


#### proportion of clusters in subcompartment of immune cells; 

```{r}
subcomps <- unique(Immune_meta$cell_type)
glist <- lapply(subcomps,function(x){
  ggplot(clust_subcomp_prop %>% filter(cell_type == x))+
    geom_bar(aes(x = batch, y = prop_clust_in_celltype,fill = annotation_V1),stat = "summary",position = "stack")+
    RotatedAxis()
})
g <- gridExtra::grid.arrange(grobs = glist, ncol = 2)
ggsave(filename = paste0(outdir,"immune_cells_batch_cluster_celltype_prop_barplots_ann_V1.pdf"),plot = g, width = 12,height = 12)
```


### sum by batch_ID; bar plots


```{r}
# proportion of main celltypes in the immune cell compartment; sum by sample
annMain_compart_prop <- full_join(
                                  x = Immune_meta %>% 
                                    group_by(annotation_main, compartment,batch_ID) %>%
                                    summarise(annMain_size = n()),
                                  y = Immune_meta %>% 
                                    group_by(compartment,batch_ID) %>% 
                                    summarise(compartment_size = n()),
                                  by = c("compartment","batch_ID")) %>%
                          mutate(prop_annMain_in_compartment = annMain_size*100 /compartment_size )


# proportion of subcompartment in the immune cell compartment; sum by sample
subcomp_compart_prop <- full_join(
                                  x = Immune_meta %>% 
                                    group_by(cell_type,compartment,batch_ID) %>%
                                    summarise(celltype_size = n()),
                                  y = Immune_meta %>% 
                                    group_by(compartment,batch_ID) %>% 
                                    summarise(compartment_size = n()),
                                  by = c("compartment","batch_ID")) %>%
                          mutate(prop_celltype_in_compartment = celltype_size*100 /compartment_size )

# proportion of clusters in subcompartment of immune cells; sum by sample

clust_subcomp_prop <- full_join(
                                  x = Immune_meta %>% 
                                    group_by(annotation_V1,cell_type,batch_ID) %>%
                                    summarise(clust_size = n()),
                                  y = Immune_meta %>% 
                                    group_by(cell_type,batch_ID) %>% 
                                    summarise(celltype_size = n()),
                                  by = c("cell_type","batch_ID")) %>%
                          mutate(prop_clust_in_celltype = clust_size*100 /celltype_size )

```

#### proportion of main celltypes in the immune cell compartment;

```{r}
g <- ggplot(annMain_compart_prop) +
  geom_bar(aes(x = batch_ID, y = prop_annMain_in_compartment,fill = annotation_main),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_batch_ID_main_comp_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


#### proportion of subcompartment in the immune cell compartment; 

```{r}
g <- ggplot(subcomp_compart_prop) +
  geom_bar(aes(x = batch_ID, y = prop_celltype_in_compartment,fill = cell_type),stat = "summary",position = "stack") +
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_batch_ID_celltype_comp_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


#### proportion of clusters in subcompartment of immune cells; 

```{r}
subcomps <- unique(Immune_meta$cell_type)
glist <- lapply(subcomps,function(x){
  ggplot(clust_subcomp_prop %>% filter(cell_type == x))+
    geom_bar(aes(x = batch_ID, y = prop_clust_in_celltype,fill = annotation_V1),stat = "summary",position = "stack")+
    RotatedAxis()
})
g <- gridExtra::grid.arrange(grobs = glist, ncol = 2)
ggsave(filename = paste0(outdir,"immune_cells_batch_ID_cluster_celltype_prop_barplots_ann_V1.pdf"),plot = g, width = 12,height = 12)
```








