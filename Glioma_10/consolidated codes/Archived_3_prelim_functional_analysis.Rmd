---
title: "Preliminary functional analysis"
output: html_document
date: "2024-04-10"
---

```{r}
library(tidyverse)
library(Seurat)
library(harmony)
library(MAST)
```

```{r}
indir <- "data/"
outdir <- "functional_analysis/"
dir.create(outdir)
```

# neoplastic

```{r}
load(paste0(indir,"GBM_RNA_10_glioma_V2.Robj"))
```

```{r}
colnames(Glioma@meta.data)
```
```{r}
table(Glioma$annotation_V1)
```

```{r}
table(Glioma$RNA_snn_res.0.1)
```

```{r}
Idents(Glioma) <- "annotation_V1"
glioma_DE <- FindAllMarkers(Glioma,test.use = "MAST")
```

```{r}
DimPlot(Glioma,group.by = "annotation_V1")
```
```{r}
VariableFeatures(Glioma)[51:80]
```

```{r}
FeaturePlot(Glioma,features = "Hbb-bs")
FeaturePlot(Glioma,features = "Mki67")
FeaturePlot(Glioma,features = "Top2a")
FeaturePlot(Glioma,features = "Mbp")
FeaturePlot(Glioma,features = "Ptprc")
FeaturePlot(Glioma,features = "Ttr")
FeaturePlot(Glioma,features = "Mbp")
FeaturePlot(Glioma,features = "Vim")
FeaturePlot(Glioma,features = "Pdgfra")
FeaturePlot(Glioma,features = "Olig2")
```

```{r}
write.table(glioma_DE,file = paste0(outdir,"glioma_res01_DE.tsv"),sep = "\t",col.names = T,row.names = F,quote = F)
```


# immune cells

```{r}
load(paste0(indir,"GBM_RNA_10_imm_V2.Robj"))
```

## divide by lineage at low resolution

```{r}
colnames(Immune_cells@meta.data)
```
```{r}
table(Immune_cells$annotation_V1)
```
```{r}
DimPlot(Immune_cells,group.by = "annotation_V1")
```


```{r}
Immune_cells@meta.data <- Immune_cells@meta.data %>% 
  mutate(annotation_V1 = case_match(
    annotation_V1,
    "microglia_5" ~ "microglia_6",
    "microglia_" ~ "microglia_5",
    .default = annotation_V1
  ))
table(Immune_cells$annotation_V1)

```
```{r}
DimPlot(Immune_cells,group.by = "annotation_V1",label = T)
DimPlot(Immune_cells,group.by = "RNA_snn_res.0.1",label = T)
DimPlot(Immune_cells,group.by = "RNA_snn_res.1",label = T)
```
```{r}
FeaturePlot(Immune_cells,features = "Cd3e")
FeaturePlot(Immune_cells,features = "Cd79a")
FeaturePlot(Immune_cells,features = "Adgre1")
FeaturePlot(Immune_cells,features = "P2ry12")
```


```{r}
Immune_cells@meta.data <- Immune_cells@meta.data %>% 
  mutate(cell_lineage = case_match(
    as.character(RNA_snn_res.0.1),
    "0" ~ "microglial",
    "1" ~ "myeloid",
    "2" ~ "microglial",
    "3" ~ "lymphoid",
    "4" ~ "proliferating",
    "5" ~ "lymphoid",
    "6" ~ "myeloid"
  )) # was not stored
```


```{r}
microglia <- subset(Immune_cells,subset = cell_lineage == "microglial")
proliferating <- subset(Immune_cells,subset= cell_lineage == "proliferating")
myeloid <- subset(Immune_cells,subset = cell_lineage == "myeloid")
lymphoid <- subset(Immune_cells,subset = cell_lineage == "lymphoid")
```


## alternative subsetting

```{r}
colnames(Immune_cells@meta.data)
```
```{r}
table(Immune_cells$compartment)
```

```{r}
Immune_cells@meta.data <- Immune_cells@meta.data %>% 
  mutate(cell_type = case_match(
    as.character(RNA_snn_res.0.1),
    "0" ~ "microglial",
    "1" ~ "myeloid",
    "2" ~ "microglial",
    "3" ~ "lymphoid",
    "4" ~ "proliferating",
    "5" ~ "lymphoid",
    "6" ~ "myeloid"
  ))
```

```{r}
Immune_cells@meta.data[,paste0(c("SCT_snn_res."),seq(0.1,1.5,0.1))] <- NULL
Immune_cells@meta.data[,paste0(c("RNA_snn_res."),seq(1.1,1.5,0.1))] <- NULL
colnames(Immune_cells@meta.data) 
```


```{r}
save(Immune_cells,file = paste0(indir,"GBM_RNA_10_imm_V2.Robj"))
```

```{r}
non_microglia <- subset(Immune_cells,subset = cell_type != "microglial")
```

### process non-microglia

```{r}
colnames(non_microglia@meta.data)
non_microglia@meta.data[,paste0(c("SCT_snn_res."),seq(0.1,1.5,0.1))] <- NULL
non_microglia@meta.data[,paste0(c("RNA_snn_res."),seq(1.1,1.5,0.1))] <- NULL
colnames(non_microglia@meta.data) 
```


```{r}
non_microglia <- NormalizeData(non_microglia,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
non_microglia <- FindVariableFeatures(object = non_microglia, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(non_microglia) <-  VariableFeatures(non_microglia) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(non_microglia))]
VariableFeaturePlot(non_microglia,selection.method = "mean.var.plot")

non_microglia <- ScaleData(object = non_microglia, features = VariableFeatures(object = non_microglia), vars.to.regress = c("nCount_RNA", "percent.mt"))
non_microglia <- RunPCA(object = non_microglia,
                features =  VariableFeatures(object = non_microglia),
                dims = 1:50)
gc()

ElbowPlot(non_microglia,ndims = 50)
non_microglia <- RunHarmony(object = non_microglia, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
non_microglia <- RunUMAP(non_microglia,dims = 1:30,reduction = "harmony")
non_microglia <- RunTSNE(non_microglia,dims = 1:30,reduction = "harmony")

non_microglia <- FindNeighbors(non_microglia, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  non_microglia <- FindClusters(object = non_microglia, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
non_microglia <- JoinLayers(non_microglia)
```


```{r}
DimPlot(non_microglia,group.by = "RNA_snn_res.0.5",label = T)
DimPlot(non_microglia,group.by = "RNA_snn_res.0.1",label = T)
DimPlot(non_microglia,group.by = "RNA_snn_res.1")
DimPlot(non_microglia,group.by = "cell_type")
DimPlot(non_microglia,group.by = "orig.ident")
```

```{r}
FeaturePlot(non_microglia,features = "Cd3e")
FeaturePlot(non_microglia,features = "Cd4")
FeaturePlot(non_microglia,features = "Cd8a")
FeaturePlot(non_microglia,features = "Cd79a")
FeaturePlot(non_microglia,features = "Adgre1")
FeaturePlot(non_microglia,features = "P2ry12")
FeaturePlot(non_microglia,features = "Xcr1")
FeaturePlot(non_microglia,features = "Siglech")
FeaturePlot(non_microglia,features = "Sirpa")
FeaturePlot(non_microglia,features = "Ncr1")
FeaturePlot(non_microglia,features = "Mki67")
FeaturePlot(non_microglia,features = "Top2a")
FeaturePlot(non_microglia,features = "Hexb")
```
```{r}
VariableFeatures(non_microglia)[1:40]
```

```{r}
Idents(non_microglia) <- "RNA_snn_res.0.5"
FeaturePlot(non_microglia,features = "Hbb-bs",label = T)
FeaturePlot(non_microglia,features = "S100a8",label = T)
FeaturePlot(non_microglia,features = "Camp",label = T)
FeaturePlot(non_microglia,features = "Gzma",label = T)
FeaturePlot(non_microglia,features = "Ttr",label = T)
FeaturePlot(non_microglia,features = "Ngp",label = T)
FeaturePlot(non_microglia,features = "Ppbp",label = T)
FeaturePlot(non_microglia,features = "Pf4",label = T)
FeaturePlot(non_microglia,features = "Sall1",label = T)
FeaturePlot(non_microglia,features = "Hexb",label = T)
FeaturePlot(non_microglia,features = "Ms4a7",label = T)
```



```{r}
DotPlot(non_microglia,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.1",cluster.idents = T)+RotatedAxis()
DotPlot(non_microglia,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.0.1",cluster.idents = T)+RotatedAxis()
```
```{r}
g <- DotPlot(non_microglia,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Prf1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Cx3cr1","Arg1","Cd163","Tgfbi","Siglech","Sirpa","Batf3","Zbtb46","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Trem2","Mki67"),group.by = "RNA_snn_res.1",cluster.idents = T)+RotatedAxis()
ggsave(filename = "non-microglia_marker_dotplot.pdf",plot = g,width = 9,height = 6)
```

### isolate microglia using res = 0.4

```{r}
Idents(non_microglia) <- "RNA_snn_res.0.5"
microglia_small <- subset(non_microglia,idents = c(0:17)[c(0:17) %in% c(4,5)])
non_microglia <- subset(non_microglia,idents = c(0:17)[!c(0:17) %in% c(4,5)])
```


### merge and process microglia


```{r}
microglia <- merge(microglia,microglia_small)
```

```{r}
microglia <- NormalizeData(microglia,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
microglia <- FindVariableFeatures(object = microglia, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))

VariableFeaturePlot(microglia,selection.method = "mean.var.plot")

microglia <- ScaleData(object = microglia, features = VariableFeatures(object = microglia), vars.to.regress = c("nCount_RNA", "percent.mt"))
microglia <- RunPCA(object = microglia,
                features =  VariableFeatures(object = microglia),
                dims = 1:30)
gc()

ElbowPlot(microglia,ndims = 30)
```

```{r}
microglia <- RunHarmony(object = microglia, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
microglia <- RunUMAP(microglia,dims = 1:20,reduction = "harmony")
microglia <- RunTSNE(microglia,dims = 1:20,reduction = "harmony")

microglia <- FindNeighbors(microglia, dims = 1:20,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  microglia <- FindClusters(object = microglia, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
microglia <- JoinLayers(microglia)
```

```{r}
colnames(microglia@meta.data)
```
```{r}
DimPlot(microglia,group.by = "annotation_V1")
DimPlot(microglia,group.by = "RNA_snn_res.0.5",label = T)
```
```{r}
DimPlot(microglia,group.by = "RNA_snn_res.0.6",label = T)
DimPlot(microglia,group.by = "orig.ident")
DimPlot(microglia,group.by = "progress")
DimPlot(microglia,group.by = "RNA_snn_res.0.6",split.by = "progress")
```

```{r}
FeaturePlot(microglia,features = "Mki67")
FeaturePlot(microglia,features = "Ms4a7")
FeaturePlot(microglia,features = "Hexb")
FeaturePlot(microglia,features = "Sall1")
FeaturePlot(microglia,features = "Cd19")
FeaturePlot(microglia,features = "Lyz2")
FeaturePlot(microglia,features = "P2ry12")
FeaturePlot(microglia,features = "Cd79a")
FeaturePlot(microglia,features = "Cd3e")
FeaturePlot(microglia,features = "Cd4")
FeaturePlot(microglia,features = "Cd8a")
```

```{r}
save(microglia,file = (paste0(indir,"GBM_RNA_10_microglia_V3.Robj")))
```

```{r}
microglia@meta.data <- microglia@meta.data %>%
  mutate(annotation_V1 = case_match(
    as.character(RNA_snn_res.0.6),
    "0" ~ "microglia_1",
    "1" ~ "microglia_2",
    "2" ~ "microglia_3",
    "3" ~ "microglia_4",
    "4" ~ "microglia_5",
    "5" ~ "microglia_6",
    "6" ~ "microglia_7",
    "7" ~ "proliferating microglia",
    "8" ~ "microglia_8",
    "9" ~ "microglia_9",
    "10" ~ "microglia_10"
  ),
  cell_type = case_match(
    annotation_V1,
    "proliferating microglia" ~ "proliferating",
    .default = "microglia"
  ),
  annotation_main = case_match(
    cell_type,
    "proliferating microglia" ~ "microglia",
    .default = "microglia"))
```

```{r}
table(microglia$cell_type)
table(microglia$annotation_V1)
table(microglia$compartment)
```

```{r}
save(microglia,file = (paste0(indir,"GBM_RNA_10_microglia_V3.Robj")))
```

#### DE for microglia

```{r}
Idents(microglia) <- "annotation_V1"
microglia_DE <- FindAllMarkers(microglia,test.use = "MAST")
write.table(microglia_DE,file = paste0(outdir,"microglia_V3_res06_DE.tsv"),sep = "\t",col.names = T,row.names = F,quote = F)
```





### continue with new non-microglia

```{r}
non_microglia <- NormalizeData(non_microglia,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
non_microglia <- FindVariableFeatures(object = non_microglia, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(non_microglia) <-  VariableFeatures(non_microglia) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(non_microglia))]
VariableFeaturePlot(non_microglia,selection.method = "mean.var.plot")

non_microglia <- ScaleData(object = non_microglia, features = VariableFeatures(object = non_microglia), vars.to.regress = c("nCount_RNA", "percent.mt"))
non_microglia <- RunPCA(object = non_microglia,
                features =  VariableFeatures(object = non_microglia),
                dims = 1:50)
gc()

ElbowPlot(non_microglia,ndims = 50)
non_microglia <- RunHarmony(object = non_microglia, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
non_microglia <- RunUMAP(non_microglia,dims = 1:30,reduction = "harmony")
non_microglia <- RunTSNE(non_microglia,dims = 1:30,reduction = "harmony")

non_microglia <- FindNeighbors(non_microglia, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  non_microglia <- FindClusters(object = non_microglia, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
non_microglia <- JoinLayers(non_microglia)
```
```{r}
DimPlot(non_microglia,group.by = "RNA_snn_res.0.5",label = T)
DimPlot(non_microglia,group.by = "RNA_snn_res.0.1",label = T)
DimPlot(non_microglia,group.by = "RNA_snn_res.1",label = T)
DimPlot(non_microglia,group.by = "cell_type")
DimPlot(non_microglia,group.by = "orig.ident")
```

```{r}
DotPlot(non_microglia,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.1",cluster.idents = T)+RotatedAxis()
DotPlot(non_microglia,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.0.1",cluster.idents = T)+RotatedAxis()
```
```{r}
FeaturePlot(non_microglia,features = "Cd3e")
FeaturePlot(non_microglia,features = "Cd4")
FeaturePlot(non_microglia,features = "Cd8a")
FeaturePlot(non_microglia,features = "Cd79a")
FeaturePlot(non_microglia,features = "Adgre1",order = T)
FeaturePlot(non_microglia,features = "P2ry12")
FeaturePlot(non_microglia,features = "Xcr1")
FeaturePlot(non_microglia,features = "Siglech")
FeaturePlot(non_microglia,features = "Sirpa",order = T)
FeaturePlot(non_microglia,features = "Ncr1")
FeaturePlot(non_microglia,features = "Mki67")
FeaturePlot(non_microglia,features = "Top2a")
FeaturePlot(non_microglia,features = "Hexb")
FeaturePlot(non_microglia,features = "Cd19")
FeaturePlot(non_microglia,features = "Batf3")
```
```{r}
FeaturePlot(non_microglia,features = "Zbtb46")
FeaturePlot(non_microglia,features = "Irf8")
FeaturePlot(non_microglia,features = "Irf4")
FeaturePlot(non_microglia,features = "Klf4")
FeaturePlot(non_microglia,features = "Id2")
FeaturePlot(non_microglia,features = "Cd200r3",order = T)
```


```{r}
FeaturePlot(non_microglia,features = "Hbb-bs",label = T)
FeaturePlot(non_microglia,features = "S100a8",label = T)
FeaturePlot(non_microglia,features = "Camp",label = T)
FeaturePlot(non_microglia,features = "Gzma",label = T)
FeaturePlot(non_microglia,features = "Ttr",label = T)
FeaturePlot(non_microglia,features = "Ngp",label = T)
FeaturePlot(non_microglia,features = "Ppbp",label = T)
FeaturePlot(non_microglia,features = "Pf4",label = T)
FeaturePlot(non_microglia,features = "Sall1",label = T)
FeaturePlot(non_microglia,features = "Hexb",label = T)
FeaturePlot(non_microglia,features = "Ms4a7",label = T)
```



```{r}
Idents(non_microglia) <- non_microglia$RNA_snn_res.0.1
```

```{r}
myeloid <- subset(non_microglia,idents = c(1,2,5,6,7,8,9,10))
lymphoid <- subset(non_microglia,idents = c(0,3,4))
```

```{r}
save(myeloid,file = paste0(indir,"GBM_RNA_10_myeloid_V3.Robj"))
save(lymphoid,file = paste0(indir,"GBM_RNA_10_lymphoid_V3.Robj"))
```

### process myeloid

```{r}
myeloid <- NormalizeData(myeloid,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
myeloid <- FindVariableFeatures(object = myeloid, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))

VariableFeaturePlot(myeloid,selection.method = "mean.var.plot")

myeloid <- ScaleData(object = myeloid, features = VariableFeatures(object = myeloid), vars.to.regress = c("nCount_RNA", "percent.mt"))
myeloid <- RunPCA(object = myeloid,
                features =  VariableFeatures(object = myeloid),
                dims = 1:40)
gc()

ElbowPlot(myeloid,ndims = 40)
```

```{r}
myeloid <- RunHarmony(object = myeloid, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
myeloid <- RunUMAP(myeloid,dims = 1:30,reduction = "harmony")
myeloid <- RunTSNE(myeloid,dims = 1:30,reduction = "harmony")

myeloid <- FindNeighbors(myeloid, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  myeloid <- FindClusters(object = myeloid, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
myeloid <- JoinLayers(myeloid)
```

```{r}
save(myeloid,file = paste0(indir,"GBM_RNA_10_myeloid_V3.Robj"))
```

```{r}
DotPlot(myeloid,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.1",cluster.idents = T)+RotatedAxis()
DotPlot(myeloid,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.0.1",cluster.idents = T)+RotatedAxis()
```

```{r}
DimPlot(myeloid,group.by = "RNA_snn_res.0.1",label = T)
DimPlot(myeloid,group.by = "RNA_snn_res.1",label = T)
```
```{r}
Idents(myeloid) <- myeloid$RNA_snn_res.1
myeloid <- subset(myeloid,idents = c(0:12,15))
```

#### second round

```{r}
myeloid <- NormalizeData(myeloid,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
myeloid <- FindVariableFeatures(object = myeloid, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))

VariableFeaturePlot(myeloid,selection.method = "mean.var.plot")

myeloid <- ScaleData(object = myeloid, features = VariableFeatures(object = myeloid), vars.to.regress = c("nCount_RNA", "percent.mt"))
myeloid <- RunPCA(object = myeloid,
                features =  VariableFeatures(object = myeloid),
                dims = 1:40)
gc()

ElbowPlot(myeloid,ndims = 40)
```

```{r}
myeloid <- RunHarmony(object = myeloid, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
myeloid <- RunUMAP(myeloid,dims = 1:20,reduction = "harmony")
myeloid <- RunTSNE(myeloid,dims = 1:20,reduction = "harmony")

myeloid <- FindNeighbors(myeloid, dims = 1:20,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  myeloid <- FindClusters(object = myeloid, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
myeloid <- JoinLayers(myeloid)
```


```{r}
DimPlot(myeloid,group.by = "RNA_snn_res.0.1",label = T)
DimPlot(myeloid,group.by = "RNA_snn_res.1",label = T)
DotPlot(myeloid,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.0.1",cluster.idents = T)+RotatedAxis()
DotPlot(myeloid,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.1",cluster.idents = T)+RotatedAxis()
```
```{r}
Idents(myeloid) <- myeloid$RNA_snn_res.1
myeloid <- subset(myeloid,idents = c(0:12,14))
```


#### round 3

```{r}
myeloid <- FindVariableFeatures(object = myeloid, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))

VariableFeaturePlot(myeloid,selection.method = "mean.var.plot")

myeloid <- ScaleData(object = myeloid, features = VariableFeatures(object = myeloid), vars.to.regress = c("nCount_RNA", "percent.mt"))
myeloid <- RunPCA(object = myeloid,
                features =  VariableFeatures(object = myeloid),
                dims = 1:40)
gc()

ElbowPlot(myeloid,ndims = 40)
myeloid <- RunHarmony(object = myeloid, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
myeloid <- RunUMAP(myeloid,dims = 1:20,reduction = "harmony")
myeloid <- RunTSNE(myeloid,dims = 1:20,reduction = "harmony")

myeloid <- FindNeighbors(myeloid, dims = 1:20,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  myeloid <- FindClusters(object = myeloid, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
myeloid <- JoinLayers(myeloid)
```
```{r}
DimPlot(myeloid,group.by = "RNA_snn_res.0.1",label = T)
DimPlot(myeloid,group.by = "RNA_snn_res.1",label = T)
DotPlot(myeloid,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.0.1",cluster.idents = T)+RotatedAxis()
DotPlot(myeloid,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.1",cluster.idents = T)+RotatedAxis()
```
```{r}
DimPlot(myeloid,group.by = "RNA_snn_res.0.3",label = T)
DotPlot(myeloid,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.0.3",cluster.idents = T)+RotatedAxis()
```


```{r}
myeloid@meta.data <- myeloid@meta.data %>% 
  mutate(annotation_main = case_match(
    as.character(RNA_snn_res.0.3),
    "0" ~ "mono-mac",
    "1" ~ "mono-mac",
    "2" ~ "mono-mac",
    "3" ~ "mono-mac",
    "4" ~ "mono-mac",
    "5" ~ "DC",
    "6" ~ "DC",
    "7" ~ "DC",
    "8" ~ "mono-mac",
    "9" ~ "mast cells"
  ),
  annotation_V1 = case_match(
    as.character(RNA_snn_res.0.3),
    "0" ~ "mono-mac_1",
    "1" ~ "mono-mac_2",
    "2" ~ "mono-mac_3",
    "3" ~ "mono-mac_4",
    "4" ~ "mono-mac_5",
    "5" ~ "cDC1",
    "6" ~ "DC-like_2",
    "7" ~ "pDC",
    "8" ~ "mono-mac_6",
    "9" ~ "mast cells"
    ),
  cell_type = case_match(
    as.character(RNA_snn_res.0.2),
    "1"  ~ "myeloid",
    .default = "myeloid"
  ))
```


```{r}
save(myeloid,file = paste0(indir,"GBM_RNA_10_myeloid_V3p1.Robj"))
```

#### myeloid DE

```{r}
Idents(myeloid) <- "annotation_V1"
myeloid_DE <- FindAllMarkers(myeloid,test.use = "MAST")
write.table(myeloid_DE,file = paste0(outdir,"myeloid_V3_res03_DE.tsv"),sep = "\t",col.names = T,row.names = F,quote = F)
```


### process lymphoid

```{r}
lymphoid <- NormalizeData(lymphoid,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
lymphoid <- FindVariableFeatures(object = lymphoid, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))

VariableFeaturePlot(lymphoid,selection.method = "mean.var.plot")

lymphoid <- ScaleData(object = lymphoid, features = VariableFeatures(object = lymphoid), vars.to.regress = c("nCount_RNA", "percent.mt"))
lymphoid <- RunPCA(object = lymphoid,
                features =  VariableFeatures(object = lymphoid),
                dims = 1:40)
gc()

ElbowPlot(lymphoid,ndims = 40)
```


```{r}
lymphoid <- RunHarmony(object = lymphoid, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
lymphoid <- RunUMAP(lymphoid,dims = 1:20,reduction = "harmony")
lymphoid <- RunTSNE(lymphoid,dims = 1:20,reduction = "harmony")

lymphoid <- FindNeighbors(lymphoid, dims = 1:20,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  lymphoid <- FindClusters(object = lymphoid, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
lymphoid <- JoinLayers(lymphoid)
```

```{r}
save(lymphoid,file = paste0(indir,"GBM_RNA_10_lymphoid_V3.Robj"))
```

```{r}
DimPlot(lymphoid,group.by = "RNA_snn_res.0.1",label = T)
DimPlot(lymphoid,group.by = "RNA_snn_res.1",label = T)
DotPlot(lymphoid,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.0.1",cluster.idents = T)+RotatedAxis()
DotPlot(lymphoid,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.1",cluster.idents = T)+RotatedAxis()
```
```{r}
FeaturePlot(lymphoid,features = "Ncr1")
FeaturePlot(lymphoid,features = "Cd3e")
FeaturePlot(lymphoid,features = "Ncr1")
FeaturePlot(lymphoid,features = "Itgax")
FeaturePlot(lymphoid,features = "Itgam")
FeaturePlot(lymphoid,features = "Adgre1")
FeaturePlot(lymphoid,features = "Cd4")
FeaturePlot(lymphoid,features = "Cd8a")
FeaturePlot(lymphoid,features = "Ncr1")
FeaturePlot(lymphoid,features = "Cd19")
FeaturePlot(lymphoid,features = "Cd79a")
FeaturePlot(lymphoid,features = "Igkc")
```

```{r}
save(lymphoid,file = paste0(indir,"GBM_RNA_10_lymphoid_V3.Robj"))
```

#### further division

```{r}
Idents(lymphoid) <- lymphoid$RNA_snn_res.0.1
lymphoid_subset_1 <- subset(lymphoid,idents = c(2,3))
lymphoid_subset_2 <- subset(lymphoid,idents = c(0,1,4,5,6))
```

```{r}
lymphoid_subset_1 <- NormalizeData(lymphoid_subset_1,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
lymphoid_subset_1 <- FindVariableFeatures(object = lymphoid_subset_1, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))

VariableFeaturePlot(lymphoid_subset_1,selection.method = "mean.var.plot")

lymphoid_subset_1 <- ScaleData(object = lymphoid_subset_1, features = VariableFeatures(object = lymphoid_subset_1), vars.to.regress = c("nCount_RNA", "percent.mt"))
lymphoid_subset_1 <- RunPCA(object = lymphoid_subset_1,
                features =  VariableFeatures(object = lymphoid_subset_1),
                dims = 1:40)
gc()

ElbowPlot(lymphoid_subset_1,ndims = 40)
lymphoid_subset_1 <- RunHarmony(object = lymphoid_subset_1, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
lymphoid_subset_1 <- RunUMAP(lymphoid_subset_1,dims = 1:20,reduction = "harmony")
lymphoid_subset_1 <- RunTSNE(lymphoid_subset_1,dims = 1:20,reduction = "harmony")

lymphoid_subset_1 <- FindNeighbors(lymphoid_subset_1, dims = 1:20,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  lymphoid_subset_1 <- FindClusters(object = lymphoid_subset_1, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
lymphoid_subset_1 <- JoinLayers(lymphoid_subset_1)
```

```{r}
DimPlot(lymphoid_subset_1)
```

```{r}
DimPlot(lymphoid_subset_1,group.by = "RNA_snn_res.0.1",label = T)
DimPlot(lymphoid_subset_1,group.by = "RNA_snn_res.1",label = T)
DotPlot(lymphoid_subset_1,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.0.1",cluster.idents = T)+RotatedAxis()
DotPlot(lymphoid_subset_1,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.1",cluster.idents = T)+RotatedAxis()
```

```{r}
Idents(lymphoid_subset_1) <- lymphoid_subset_1$RNA_snn_res.1
B_cells <- subset(lymphoid_subset_1,idents = c(1,4,3,5))
```

```{r}
B_cells <- NormalizeData(B_cells,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
B_cells <- FindVariableFeatures(object = B_cells, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(B_cells) <-  VariableFeatures(B_cells) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(B_cells))]
VariableFeaturePlot(B_cells,selection.method = "mean.var.plot")

B_cells <- ScaleData(object = B_cells, features = VariableFeatures(object = B_cells), vars.to.regress = c("nCount_RNA", "percent.mt"))
B_cells <- RunPCA(object = B_cells,
                features =  VariableFeatures(object = B_cells),
                dims = 1:40)
gc()

ElbowPlot(B_cells,ndims = 40)
B_cells <- RunHarmony(object = B_cells, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
B_cells <- RunUMAP(B_cells,dims = 1:20,reduction = "harmony")
B_cells <- RunTSNE(B_cells,dims = 1:20,reduction = "harmony")

B_cells <- FindNeighbors(B_cells, dims = 1:20,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  B_cells <- FindClusters(object = B_cells, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
B_cells <- JoinLayers(B_cells)
```

```{r}
DimPlot(B_cells,group.by = "RNA_snn_res.0.2",label = T)
DimPlot(B_cells,group.by = "RNA_snn_res.0.5",label = T)
DotPlot(B_cells,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.0.2",cluster.idents = T)+RotatedAxis()
DotPlot(B_cells,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.0.5",cluster.idents = T)+RotatedAxis()
```
```{r}
DimPlot(B_cells,group.by = "RNA_snn_res.0.1",label = T)
FeaturePlot(B_cells,features = "Cd79a")
FeaturePlot(B_cells,features = "Igkc")
FeaturePlot(B_cells,features = "Cd74")
FeaturePlot(B_cells,features = "Apoe")
```
```{r}
VariableFeatures(B_cells)[1:50]
```
```{r}
B_cells@meta.data <- B_cells@meta.data %>%
  mutate(annotation_V1 = case_match(
    as.character(RNA_snn_res.0.1),
    "0" ~ "B_cells_1",
    "1" ~ "B_cells_2"
  ),
  cell_type = case_match(
    cell_type,
    "myeloid" ~ "lymphoid",
    .default = "lymphoid"
  ),
  annotation_main = case_match(
    annotation_V1,
    "B_cells_1" ~ "B_cells",
    .default = "B_cells"
  ))
```

```{r}
table(B_cells$cell_type)
table(B_cells$annotation_main)
```


```{r}
lymphoid_subset_2 <- NormalizeData(lymphoid_subset_2,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
lymphoid_subset_2 <- FindVariableFeatures(object = lymphoid_subset_2, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))

VariableFeaturePlot(lymphoid_subset_2,selection.method = "mean.var.plot")

lymphoid_subset_2 <- ScaleData(object = lymphoid_subset_2, features = VariableFeatures(object = lymphoid_subset_2), vars.to.regress = c("nCount_RNA", "percent.mt"))
lymphoid_subset_2 <- RunPCA(object = lymphoid_subset_2,
                features =  VariableFeatures(object = lymphoid_subset_2),
                dims = 1:40)
gc()

ElbowPlot(lymphoid_subset_2,ndims = 40)
lymphoid_subset_2 <- RunHarmony(object = lymphoid_subset_2, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
lymphoid_subset_2 <- RunUMAP(lymphoid_subset_2,dims = 1:20,reduction = "harmony")
lymphoid_subset_2 <- RunTSNE(lymphoid_subset_2,dims = 1:20,reduction = "harmony")

lymphoid_subset_2 <- FindNeighbors(lymphoid_subset_2, dims = 1:20,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  lymphoid_subset_2 <- FindClusters(object = lymphoid_subset_2, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
lymphoid_subset_2 <- JoinLayers(lymphoid_subset_2)
```

```{r}
DimPlot(lymphoid_subset_2,group.by = "RNA_snn_res.0.1",label = T)
DimPlot(lymphoid_subset_2,group.by = "RNA_snn_res.1",label = T)
DotPlot(lymphoid_subset_2,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.0.1",cluster.idents = T)+RotatedAxis()
DotPlot(lymphoid_subset_2,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.1",cluster.idents = T)+RotatedAxis()
```
```{r}
Idents(lymphoid_subset_2) <- lymphoid_subset_2$RNA_snn_res.1
lymphoid_subset_2 <- subset(lymphoid_subset_2,idents = c(0:6,8:12))
```

```{r}
lymphoid_subset_2 <- NormalizeData(lymphoid_subset_2,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
lymphoid_subset_2 <- FindVariableFeatures(object = lymphoid_subset_2, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))

VariableFeaturePlot(lymphoid_subset_2,selection.method = "mean.var.plot")

lymphoid_subset_2 <- ScaleData(object = lymphoid_subset_2, features = VariableFeatures(object = lymphoid_subset_2), vars.to.regress = c("nCount_RNA", "percent.mt"))
lymphoid_subset_2 <- RunPCA(object = lymphoid_subset_2,
                features =  VariableFeatures(object = lymphoid_subset_2),
                dims = 1:40)
gc()

ElbowPlot(lymphoid_subset_2,ndims = 40)
lymphoid_subset_2 <- RunHarmony(object = lymphoid_subset_2, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
lymphoid_subset_2 <- RunUMAP(lymphoid_subset_2,dims = 1:20,reduction = "harmony")
lymphoid_subset_2 <- RunTSNE(lymphoid_subset_2,dims = 1:20,reduction = "harmony")

lymphoid_subset_2 <- FindNeighbors(lymphoid_subset_2, dims = 1:20,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  lymphoid_subset_2 <- FindClusters(object = lymphoid_subset_2, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
lymphoid_subset_2 <- JoinLayers(lymphoid_subset_2)
```

```{r}
DimPlot(lymphoid_subset_2,group.by = "RNA_snn_res.0.1",label = T)
DimPlot(lymphoid_subset_2,group.by = "RNA_snn_res.1",label = T)
DotPlot(lymphoid_subset_2,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.0.1",cluster.idents = T)+RotatedAxis()
DotPlot(lymphoid_subset_2,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.1",cluster.idents = T)+RotatedAxis()
```
```{r}
Idents(lymphoid_subset_2) <- lymphoid_subset_2$RNA_snn_res.1
lymphoid_subset_2 <- subset(lymphoid_subset_2,idents = c(0:7,9:13))
```

```{r}
lymphoid_subset_2 <- NormalizeData(lymphoid_subset_2,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
lymphoid_subset_2 <- FindVariableFeatures(object = lymphoid_subset_2, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))

VariableFeaturePlot(lymphoid_subset_2,selection.method = "mean.var.plot")

lymphoid_subset_2 <- ScaleData(object = lymphoid_subset_2, features = VariableFeatures(object = lymphoid_subset_2), vars.to.regress = c("nCount_RNA", "percent.mt"))
lymphoid_subset_2 <- RunPCA(object = lymphoid_subset_2,
                features =  VariableFeatures(object = lymphoid_subset_2),
                dims = 1:40)
gc()

ElbowPlot(lymphoid_subset_2,ndims = 40)
lymphoid_subset_2 <- RunHarmony(object = lymphoid_subset_2, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
lymphoid_subset_2 <- RunUMAP(lymphoid_subset_2,dims = 1:20,reduction = "harmony")
lymphoid_subset_2 <- RunTSNE(lymphoid_subset_2,dims = 1:20,reduction = "harmony")

lymphoid_subset_2 <- FindNeighbors(lymphoid_subset_2, dims = 1:20,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  lymphoid_subset_2 <- FindClusters(object = lymphoid_subset_2, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
lymphoid_subset_2 <- JoinLayers(lymphoid_subset_2)
```
```{r}
DimPlot(lymphoid_subset_2,group.by = "RNA_snn_res.0.1",label = T)
DimPlot(lymphoid_subset_2,group.by = "RNA_snn_res.1",label = T)
DotPlot(lymphoid_subset_2,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.0.1",cluster.idents = T)+RotatedAxis()
DotPlot(lymphoid_subset_2,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.1",cluster.idents = T)+RotatedAxis()
```
#### divide into NK/NKT and T

```{r}
Idents(lymphoid_subset_2) <- lymphoid_subset_2$RNA_snn_res.0.1
NK_NKT <- subset(lymphoid_subset_2,idents = 1)
T_cells <- subset(lymphoid_subset_2,idents = c(0,2:6))
```

```{r}
NK_NKT <- NormalizeData(NK_NKT,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
NK_NKT <- FindVariableFeatures(object = NK_NKT, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(NK_NKT) <-  VariableFeatures(NK_NKT) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(NK_NKT))]
VariableFeaturePlot(NK_NKT,selection.method = "mean.var.plot")

NK_NKT <- ScaleData(object = NK_NKT, features = VariableFeatures(object = NK_NKT), vars.to.regress = c("nCount_RNA", "percent.mt"))
NK_NKT <- RunPCA(object = NK_NKT,
                features =  VariableFeatures(object = NK_NKT),
                dims = 1:40)
gc()

ElbowPlot(NK_NKT,ndims = 40)
NK_NKT <- RunHarmony(object = NK_NKT, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
NK_NKT <- RunUMAP(NK_NKT,dims = 1:20,reduction = "harmony")
NK_NKT <- RunTSNE(NK_NKT,dims = 1:20,reduction = "harmony")

NK_NKT <- FindNeighbors(NK_NKT, dims = 1:20,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  NK_NKT <- FindClusters(object = NK_NKT, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
NK_NKT <- JoinLayers(NK_NKT)
```

```{r}
DimPlot(NK_NKT,group.by = "RNA_snn_res.1",label = T)
DimPlot(NK_NKT,group.by = "RNA_snn_res.0.3",label = T)
DotPlot(NK_NKT,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.1",cluster.idents = T)+RotatedAxis()
DotPlot(NK_NKT,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.0.3",cluster.idents = T)+RotatedAxis()
```

```{r}
colnames(NK_NKT@meta.data)
```
```{r}
table(NK_NKT$cell_type)
```

```{r}
NK_NKT@meta.data <- NK_NKT@meta.data %>% 
  mutate(annotation_main = case_match(
    as.character(RNA_snn_res.1),
    "0" ~ "NK",
    "3" ~ "NK",
    "1" ~ "NKT",
    "2" ~ "NKT"
  ),
  annotation_V1 = case_match(
    as.character(RNA_snn_res.1),
    "0" ~ "NK",
    "3" ~ "NK",
    "1" ~ "NKT",
    "2" ~ "NKT"))
```

```{r}
T_cells <- NormalizeData(T_cells,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
T_cells <- FindVariableFeatures(object = T_cells, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(T_cells) <-  VariableFeatures(T_cells) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(T_cells))]
VariableFeaturePlot(T_cells,selection.method = "mean.var.plot")

T_cells <- ScaleData(object = T_cells, features = VariableFeatures(object = T_cells), vars.to.regress = c("nCount_RNA", "percent.mt"))
T_cells <- RunPCA(object = T_cells,
                features =  VariableFeatures(object = T_cells),
                dims = 1:40)
gc()

ElbowPlot(T_cells,ndims = 40)
T_cells <- RunHarmony(object = T_cells, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
T_cells <- RunUMAP(T_cells,dims = 1:20,reduction = "harmony")
T_cells <- RunTSNE(T_cells,dims = 1:20,reduction = "harmony")

T_cells <- FindNeighbors(T_cells, dims = 1:20,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  T_cells <- FindClusters(object = T_cells, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
T_cells <- JoinLayers(T_cells)
```

```{r}
DimPlot(T_cells,group.by = "RNA_snn_res.1",label = T)
DimPlot(T_cells,group.by = "RNA_snn_res.0.2",label = T)
DotPlot(T_cells,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.1",cluster.idents = T)+RotatedAxis()
DotPlot(T_cells,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.0.2",cluster.idents = T)+RotatedAxis()
```

```{r}
T_cells@meta.data <- T_cells@meta.data %>% 
  mutate(annotation_main = case_match(
    as.character(RNA_snn_res.0.2),
    "5" ~ "unknown",
    .default = "T cells"
  ),
  annotation_V1 = case_match(
    as.character(RNA_snn_res.0.2),
    "0" ~ "CD8_1",
    "1" ~ "CD4_1",
    "2" ~ "proliferating T cells",
    "3" ~ "CD8_2",
    "4" ~ "DN-like",
    "5" ~ "unknown",
    "6" ~ "CD4_2"
    ),
  cell_type = case_match(
    as.character(RNA_snn_res.0.2),
    "2"  ~ "proliferating",
    .default = "lymphoid"
  ))
```

```{r}
table(T_cells$annotation_main)
table(T_cells$annotation_V1)
table(T_cells$cell_type)
```
### merge lymphoid

```{r}
lymphoid <- merge(x = T_cells,y = c(NK_NKT,B_cells))
```

```{r}
lymphoid <- NormalizeData(lymphoid,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
lymphoid <- FindVariableFeatures(object = lymphoid, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(lymphoid) <-  VariableFeatures(lymphoid) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(lymphoid))]
VariableFeaturePlot(lymphoid,selection.method = "mean.var.plot")

lymphoid <- ScaleData(object = lymphoid, features = VariableFeatures(object = lymphoid), vars.to.regress = c("nCount_RNA", "percent.mt"))
lymphoid <- RunPCA(object = lymphoid,
                features =  VariableFeatures(object = lymphoid),
                dims = 1:40)
gc()

ElbowPlot(lymphoid,ndims = 40)
```


```{r}
lymphoid <- RunHarmony(object = lymphoid, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
lymphoid <- RunUMAP(lymphoid,dims = 1:25,reduction = "harmony")
lymphoid <- RunTSNE(lymphoid,dims = 1:25,reduction = "harmony")

lymphoid <- FindNeighbors(lymphoid, dims = 1:25,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  lymphoid <- FindClusters(object = lymphoid, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
lymphoid <- JoinLayers(lymphoid)
```

```{r}
DimPlot(lymphoid,group.by = "annotation_main")
DimPlot(lymphoid,group.by = "annotation_V1")
```


```{r}
save(lymphoid,file = paste0(indir,"GBM_RNA_10_lymphoid_V3p1.Robj"))
```

#### lymphoid DE

```{r}
Idents(lymphoid) <- "annotation_V1"
lymphoid_DE <- FindAllMarkers(lymphoid,test.use = "MAST")
write.table(lymphoid_DE,file = paste0(outdir,"lymphoid_V3_rescombined_DE.tsv"),sep = "\t",col.names = T,row.names = F,quote = F)
```


## process using four-subsets

### process proliferating

```{r}
proliferating <- NormalizeData(proliferating,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
proliferating <- FindVariableFeatures(object = proliferating, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(proliferating) <-  VariableFeatures(proliferating) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(proliferating))]
VariableFeaturePlot(proliferating,selection.method = "mean.var.plot")

proliferating <- ScaleData(object = proliferating, features = VariableFeatures(object = proliferating), vars.to.regress = c("nCount_RNA", "percent.mt"))
proliferating <- RunPCA(object = proliferating,
                features =  VariableFeatures(object = proliferating),
                dims = 1:30)
gc()

ElbowPlot(proliferating,ndims = 30)
proliferating <- RunHarmony(object = proliferating, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
proliferating <- RunUMAP(proliferating,dims = 1:10,reduction = "harmony")
proliferating <- RunTSNE(proliferating,dims = 1:10,reduction = "harmony")

proliferating <- FindNeighbors(proliferating, dims = 1:10,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  proliferating <- FindClusters(object = proliferating, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
proliferating <- JoinLayers(proliferating)
```
```{r}
DimPlot(proliferating,group.by = "RNA_snn_res.0.5")
FeaturePlot(proliferating,features = "Cd3e")
FeaturePlot(proliferating,features = "Cd79a")
FeaturePlot(proliferating,features = "Adgre1")
FeaturePlot(proliferating,features = "P2ry12")
FeaturePlot(proliferating,features = "Xcr1")
FeaturePlot(proliferating,features = "Siglech")
FeaturePlot(proliferating,features = "Sirpa")
FeaturePlot(proliferating,features = "Ncr1")
```

```{r}
table(proliferating$annotation_V1)
```

```{r}
proliferating$annotation_V2 <- proliferating$annotation_V1
```


```{r}
save(proliferating,file = (paste0(indir,"GBM_RNA_10_imm_V2_proliferating.Robj")))
```

### microglia

```{r}
microglia <- NormalizeData(microglia,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
microglia <- FindVariableFeatures(object = microglia, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))

VariableFeaturePlot(microglia,selection.method = "mean.var.plot")

microglia <- ScaleData(object = microglia, features = VariableFeatures(object = microglia), vars.to.regress = c("nCount_RNA", "percent.mt"))
microglia <- RunPCA(object = microglia,
                features =  VariableFeatures(object = microglia),
                dims = 1:30)
gc()

ElbowPlot(microglia,ndims = 30)
```


```{r}
microglia <- RunHarmony(object = microglia, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
microglia <- RunUMAP(microglia,dims = 1:20,reduction = "harmony")
microglia <- RunTSNE(microglia,dims = 1:20,reduction = "harmony")

microglia <- FindNeighbors(microglia, dims = 1:20,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  microglia <- FindClusters(object = microglia, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
microglia <- JoinLayers(microglia)
```

```{r}
DimPlot(microglia,group.by = "RNA_snn_res.0.5",split.by = "progress")
```

```{r}
microglia@meta.data <- microglia@meta.data %>%
  mutate(annotation_V2 = case_match(
    as.character(RNA_snn_res.0.5),
    "0" ~ "microglia_1",
    "1" ~ "microglia_2",
    "2" ~ "microglia_3",
    "3" ~ "microglia_4",
    "4" ~ "microglia_5",
    "5" ~ "microglia_6",
    "6" ~ "microglia_7"
  ))
```

```{r}
table(microglia$annotation_V2)
```

```{r}
save(microglia,file = (paste0(indir,"GBM_RNA_10_imm_V2_microglia.Robj")))
```

```{r}
Idents(microglia) <- "annotation_V2"
microglia_DE <- FindAllMarkers(microglia,test.use = "MAST")
write.table(microglia_DE,file = paste0(outdir,"microglia_res05_DE.tsv"),sep = "\t",col.names = T,row.names = F,quote = F)
```

```{r}

```

### myeloid

```{r}
myeloid <- NormalizeData(myeloid,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
myeloid <- FindVariableFeatures(object = myeloid, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))

VariableFeaturePlot(myeloid,selection.method = "mean.var.plot")

myeloid <- ScaleData(object = myeloid, features = VariableFeatures(object = myeloid), vars.to.regress = c("nCount_RNA", "percent.mt"))
myeloid <- RunPCA(object = myeloid,
                features =  VariableFeatures(object = myeloid),
                dims = 1:40)
gc()

ElbowPlot(myeloid,ndims = 40)
```

```{r}
myeloid <- RunHarmony(object = myeloid, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
myeloid <- RunUMAP(myeloid,dims = 1:30,reduction = "harmony")
myeloid <- RunTSNE(myeloid,dims = 1:30,reduction = "harmony")

myeloid <- FindNeighbors(myeloid, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  myeloid <- FindClusters(object = myeloid, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
myeloid <- JoinLayers(myeloid)
```

```{r}
save(myeloid,file = (paste0(indir,"GBM_RNA_10_imm_V2_myeloid.Robj")))
```

```{r}
DimPlot(myeloid,group.by = "RNA_snn_res.0.6")
Idents(myeloid) <- "RNA_snn_res.0.6"
FeaturePlot(myeloid,features = "Xcr1",label = T)
FeaturePlot(myeloid,features = "Adgre1",label = T)
FeaturePlot(myeloid,features = "Siglech",label = T)
FeaturePlot(myeloid,features = "Sirpa",label = T)
FeaturePlot(myeloid,features = "Cd3e",label = T)
FeaturePlot(myeloid,features = "P2ry12",label = T)
FeaturePlot(myeloid,features = "Batf3",label = T)
FeaturePlot(myeloid,features = "S100a8",label = T)
FeaturePlot(myeloid,features = "Mpo",label = T)
FeaturePlot(myeloid,features = "Lyz2",label = T)
FeaturePlot(myeloid,features = "Ccr2",label = T)
FeaturePlot(myeloid,features = "Mertk",label = T)
FeaturePlot(myeloid,features = "H2-Ab1",label = T)
```

8: cDC2; 5: cDC1 ; 6: pDC; 3: DC-like; 12 and 11 are residual -> remove.

```{r}
table(myeloid$RNA_snn_res.0.6)
```


```{r}
Idents(myeloid) <- "RNA_snn_res.0.6"
myeloid <- subset(myeloid,idents = c(0:10))
```

#### second round

```{r}
myeloid <- NormalizeData(myeloid,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
myeloid <- FindVariableFeatures(object = myeloid, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))

VariableFeaturePlot(myeloid,selection.method = "mean.var.plot")

myeloid <- ScaleData(object = myeloid, features = VariableFeatures(object = myeloid), vars.to.regress = c("nCount_RNA", "percent.mt"))
myeloid <- RunPCA(object = myeloid,
                features =  VariableFeatures(object = myeloid),
                dims = 1:40)
gc()

ElbowPlot(myeloid,ndims = 40)
```


```{r}
myeloid <- RunHarmony(object = myeloid, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
myeloid <- RunUMAP(myeloid,dims = 1:30,reduction = "harmony")
myeloid <- RunTSNE(myeloid,dims = 1:30,reduction = "harmony")

myeloid <- FindNeighbors(myeloid, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  myeloid <- FindClusters(object = myeloid, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
myeloid <- JoinLayers(myeloid)
```

```{r}
save(myeloid,file = (paste0(indir,"GBM_RNA_10_imm_V2_myeloid.Robj")))
```

```{r}
DimPlot(myeloid,group.by = "RNA_snn_res.0.5")
Idents(myeloid) <- "RNA_snn_res.0.5"
FeaturePlot(myeloid,features = "Xcr1",label = T)
FeaturePlot(myeloid,features = "Adgre1",label = T)
FeaturePlot(myeloid,features = "Siglech",label = T)
FeaturePlot(myeloid,features = "Sirpa",label = T)
FeaturePlot(myeloid,features = "Cd3e",label = T)
FeaturePlot(myeloid,features = "P2ry12",label = T)
FeaturePlot(myeloid,features = "Batf3",label = T)
FeaturePlot(myeloid,features = "S100a8",label = T)
FeaturePlot(myeloid,features = "Mpo",label = T)
FeaturePlot(myeloid,features = "Lyz2",label = T)
FeaturePlot(myeloid,features = "Ccr2",label = T)
FeaturePlot(myeloid,features = "Mertk",label = T)
FeaturePlot(myeloid,features = "H2-Ab1",label = T)
```

```{r}
DimPlot(myeloid,group.by = "RNA_snn_res.0.5",split.by = "progress")
DimPlot(myeloid,group.by = "annotation_V1")
```

```{r}
myeloid@meta.data <- myeloid@meta.data %>%
  mutate(annotation_V2 = case_match(
    as.character(RNA_snn_res.0.5),
    "0" ~ "mono-mac_1",
    "1" ~ "mono-mac_2",
    "2" ~ "mono-mac_3",
    "3" ~ "DC-like",
    "4" ~ "mono-mac_4",
    "5" ~ "pDC",
    "6" ~ "cDC1",
    "7" ~ "cDC2",
    "8" ~ "mono-mac_5",
    "9" ~ "mono-mac_6"
  ))
```

```{r}
table(myeloid$annotation_V2)
```

```{r}
Idents(myeloid) <- "annotation_V2"
myeloid_DE <- FindAllMarkers(myeloid,test.use = "MAST")
write.table(myeloid_DE,file = paste0(outdir,"myeloid_res05_DE.tsv"),sep = "\t",col.names = T,row.names = F,quote = F)
```



### lymphoid

```{r}
lymphoid <- NormalizeData(lymphoid,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
lymphoid <- FindVariableFeatures(object = lymphoid, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))

VariableFeaturePlot(lymphoid,selection.method = "mean.var.plot")

lymphoid <- ScaleData(object = lymphoid, features = VariableFeatures(object = lymphoid), vars.to.regress = c("nCount_RNA", "percent.mt"))
lymphoid <- RunPCA(object = lymphoid,
                features =  VariableFeatures(object = lymphoid),
                dims = 1:40)
gc()

ElbowPlot(lymphoid,ndims = 40)
```

```{r}
lymphoid <- RunHarmony(object = lymphoid, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
lymphoid <- RunUMAP(lymphoid,dims = 1:30,reduction = "harmony")
lymphoid <- RunTSNE(lymphoid,dims = 1:30,reduction = "harmony")

lymphoid <- FindNeighbors(lymphoid, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  lymphoid <- FindClusters(object = lymphoid, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
lymphoid <- JoinLayers(lymphoid)
```

```{r}
save(lymphoid,file = (paste0(indir,"GBM_RNA_10_imm_V2_lymphoid.Robj")))
```

```{r}
DimPlot(lymphoid,group.by = "RNA_snn_res.0.5",label = T)
Idents(lymphoid) <- "RNA_snn_res.0.5"
FeaturePlot(lymphoid,features = "Cd79a",label = T)
FeaturePlot(lymphoid,features = "Cd4",label = T)
FeaturePlot(lymphoid,features = "Cd8a",label = T)
FeaturePlot(lymphoid,features = "Klrb1c",label = T)
FeaturePlot(lymphoid,features = "Cd3e",label = T)
```

```{r}
table(lymphoid$RNA_snn_res.0.5)
```

```{r}
lymphoid <- subset(lymphoid,idents = c(0:9))
```

#### round 2

```{r}
lymphoid <- NormalizeData(lymphoid,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
lymphoid <- FindVariableFeatures(object = lymphoid, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))

VariableFeaturePlot(lymphoid,selection.method = "mean.var.plot")

lymphoid <- ScaleData(object = lymphoid, features = VariableFeatures(object = lymphoid), vars.to.regress = c("nCount_RNA", "percent.mt"))
lymphoid <- RunPCA(object = lymphoid,
                features =  VariableFeatures(object = lymphoid),
                dims = 1:40)
gc()

ElbowPlot(lymphoid,ndims = 40)
```

```{r}
lymphoid <- RunHarmony(object = lymphoid, group.by.vars = c("orig.ident"), max.iter.harmony = 20)
lymphoid <- RunUMAP(lymphoid,dims = 1:30,reduction = "harmony")
lymphoid <- RunTSNE(lymphoid,dims = 1:30,reduction = "harmony")

lymphoid <- FindNeighbors(lymphoid, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  lymphoid <- FindClusters(object = lymphoid, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
lymphoid <- JoinLayers(lymphoid)
```

```{r}
save(lymphoid,file = (paste0(indir,"GBM_RNA_10_imm_V2_lymphoid_V2p1.Robj")))
```

```{r}
DimPlot(lymphoid,group.by = "RNA_snn_res.1",label = T)
Idents(lymphoid) <- "RNA_snn_res.1"
FeaturePlot(lymphoid,features = "Cd79a",label = T)
FeaturePlot(lymphoid,features = "Cd4",label = T)
FeaturePlot(lymphoid,features = "Cd8a",label = T)
FeaturePlot(lymphoid,features = "Klrb1c",label = T)
FeaturePlot(lymphoid,features = "Cd3e",label = T)
FeaturePlot(lymphoid,features = "Mki67",label = T)
```

```{r}
DimPlot(lymphoid,group.by = "RNA_snn_res.0.5",split.by = "progress")
```


```{r}
lymphoid@meta.data <- lymphoid@meta.data %>%
  mutate(annotation_V2 = case_match(
    as.character(RNA_snn_res.1),
    "0" ~ "CD4_1",
    "1" ~ "T_cell_1",
    "2" ~ "CD8_1",
    "3" ~ "CD8_2",
    "4" ~ "NK",
    "5" ~ "NKT",
    "6" ~ "unknown_1",
    "7" ~ "B_cell_1",
    "8" ~ "CD4_2",
    "9" ~ "T_cell_2",
    "10" ~ "T_cell_3",
    "11" ~ "B_cell_2",
    "12" ~ "T_cell_4",
    "13" ~ "B_cell_3",
    "14" ~ "T_cell_5",
    "15" ~ "unknown_2"
  ))
```

```{r}
table(lymphoid$annotation_V2)
```

```{r}
Idents(lymphoid) <- "annotation_V2"
lymphoid_DE <- FindAllMarkers(lymphoid,test.use = "MAST")
write.table(lymphoid_DE,file = paste0(outdir,"lymphoid_res1_DE.tsv"),sep = "\t",col.names = T,row.names = F,quote = F)
```


# non-neoplastic and non-immune cells

```{r}
load(paste0(indir,"GBM_RNA_10_stromal_V2.Robj"))
```

## you may use the subsets directly 

```{r}
table(stromal$annotation_V1) # annotation derived from subsets
```

```{r}
stromal@meta.data <- stromal@meta.data %>% 
  mutate(annotation_V1 = case_match(
    annotation_V1,
    "Neutron_1" ~ "Neuron_1",
    "Neutron_2" ~ "Neuron_2",
    .default = annotation_V1
  ),
         cell_lineage = case_match(
    annotation_V1,
    "Astrocyte_1" ~ "neuronal",
    "Astrocyte_2" ~ "neuronal",
    "Astrocyte_3" ~ "neuronal",
    "Astrocyte_4" ~ "neuronal",
    "Endothelial_1" ~ "stromal",
    "Endothelial_2" ~ "stromal",
    "Endothelial_3" ~ "stromal",
    "Neuron_3" ~ "neuronal",
    "Neuron_2" ~ "neuronal",
    "Neuron_1" ~ "neuronal",
    "Oligodendrocyte_1" ~ "neuronal",
    "Oligodendrocyte_2" ~ "neuronal",
    "OPC" ~ "neuronal",
    "Perivascular_1" ~ "stromal",
    "Perivascular_2" ~ "stromal",
    "Progenitor-like_1" ~ "neuronal",
    "Progenitor-like_2" ~ "neuronal"
  ))
```

```{r}
save(stromal,file = paste0(indir,"GBM_RNA_10_stromal_V2.Robj"))
```

## resident/neuronal

```{r}
load(paste0(indir,"GBM_RNA_10_resident_V2p2.Robj"))
```

```{r}
table(resident$annotation_res01)
```
```{r}
resident$annotation_V1 <- resident$annotation_res01
resident$annotation_res01 <- NULL
```

```{r}
Idents(resident) <- "annotation_V1"
resident_DE <- FindAllMarkers(resident,test.use = "MAST")
write.table(resident_DE,file = paste0(outdir,"resident_res01_DE.tsv"),sep = "\t",col.names = T,row.names = F,quote = F)
```

```{r}
save(resident,file = paste0(indir,"GBM_RNA_10_resident_V2p2.Robj"))
```


## stromal

```{r}
load(paste0(indir,"GBM_RNA_10_vascular_V2p1.Robj"))
```

```{r}
table(vascular$annotation_res01)
```

```{r}
vascular$annotation_V1 <- vascular$annotation_res01
vascular$annotation_res01 <- NULL
```

```{r}
save(vascular,file = paste0(indir,"GBM_RNA_10_vascular_V2p1.Robj"))
```


```{r}
Idents(vascular) <- "annotation_V1"
vascular_DE <- FindAllMarkers(vascular,test.use = "MAST")
write.table(vascular_DE,file = paste0(outdir,"vascular_res01_DE.tsv"),sep = "\t",col.names = T,row.names = F,quote = F)
```

```{r}

```


