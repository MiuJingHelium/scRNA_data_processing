---
title: "post-prelim analysis toubleshooting"
output: html_document
date: "2024-05-24"
---

After preliminary annotation, functional analysis, and compartment analysis, there is a doubt that cells may have been overly corrected for batch effect because tumor cell clusters don't reasonable differential enrichment with respect to progression. Specifically, larger clusters are more enriched in LGG and smaller clusters on average are more abundant in LGG after normalization by compartment size. Before normalization, every cluster is simply higher in proportion in the HGG.

In this markdown file, I'm attempting to:
1) add batch information to all subsets
2) re-integrate tumor subsets based on batch instead of sample; if this works, I may re-integrate other compartments as well.
3) re-generate whole dataset for sanity check purposes

```{r}
library(tidyverse)
library(Seurat)
library(harmony)

# for monocle
library(monocle3)
library(SeuratWrappers)
```

# load all subsets (rds) and add metadata information

```{r}
load("data/GBM_RNA_10_glioma_V2.Robj")
load("data/GBM_RNA_10_microglia_V3.Robj")
load("data/GBM_RNA_10_resident_V2p2.Robj")
load("data/GBM_RNA_10_myeloid_V3p2.Robj")
load("data/GBM_RNA_10_vascular_V2p1.Robj")
load("data/GBM_RNA_10_lymphoid_V3p1.Robj")
```

It is possible to vectorize the following steps, but for simplicity, I'll manually add the metadata information; first sanity check number of columns in metadata; some of them may have monocle trajectory calculated.
```{r}
ncol(Glioma@meta.data)
ncol(resident@meta.data)
ncol(vascular@meta.data)
ncol(lymphoid@meta.data)
ncol(myeloid@meta.data)
ncol(microglia@meta.data)
```
```{r}
# rds.list <- list(Glioma,resident,vascular,lymphoid,myeloid,microglia)
```

```{r}
colnames(Glioma@meta.data) # contains monocle3 trajectory
colnames(resident@meta.data) # contains cell cycle score
colnames(vascular@meta.data) 
colnames(lymphoid@meta.data)
colnames(myeloid@meta.data)
colnames(microglia@meta.data) # contains cell cycle score
```



## calculate cell cycle score for all

```{r}
s.genes <- cc.genes$s.genes
g2m.genes <- cc.genes$g2m.genes
```

```{r}
mouse_human_genes <- read.csv("http://www.informatics.jax.org/downloads/reports/HOM_MouseHumanSequence.rpt",sep="\t")

# separate human and mouse 
mouse <- split.data.frame(mouse_human_genes,mouse_human_genes$Common.Organism.Name)[[2]]
human <- split.data.frame(mouse_human_genes,mouse_human_genes$Common.Organism.Name)[[1]]

# remove some columns
mouse <- mouse[,c(1,4)]
human <- human[,c(1,4)]

# merge the 2 dataset  (note that the human list is longer than the mouse one)
mh_data <- merge.data.frame(mouse,human,by = "DB.Class.Key",all.y = TRUE) 
```

```{r}
s.genes <- mh_data[mh_data$Symbol.y %in% s.genes,"Symbol.x"]
g2m.genes <- mh_data[mh_data$Symbol.y %in% g2m.genes,"Symbol.x"]
```


```{r}
# colnames(vascular@meta.data) 
# colnames(lymphoid@meta.data)
# colnames(myeloid@meta.data)

vascular <- CellCycleScoring(vascular, s.features = s.genes, g2m.features = g2m.genes, set.ident = F)
lymphoid <- CellCycleScoring(lymphoid, s.features = s.genes, g2m.features = g2m.genes, set.ident = F)
myeloid <- CellCycleScoring(myeloid, s.features = s.genes, g2m.features = g2m.genes, set.ident = F)
Glioma <- CellCycleScoring(Glioma, s.features = s.genes, g2m.features = g2m.genes, set.ident = F)
```

## add batch information

```{r}
colnames(Glioma@meta.data) # contains monocle3 trajectory
colnames(resident@meta.data) # contains cell cycle score
colnames(vascular@meta.data) # contains cell cycle score
colnames(lymphoid@meta.data)# contains cell cycle score
colnames(myeloid@meta.data) # contains cell cycle score
colnames(microglia@meta.data) # contains cell cycle score
```

```{r}
# Glioma
Glioma@meta.data <- Glioma@meta.data %>% 
  mutate(batch = case_match(
    sample.id,
    "S0087" ~ "CD45_only",
    "S0088" ~ "CD45_only",
    "S0096" ~ "CD45_only",
    "S0130" ~ "All_Percoll",
    "S0129" ~ "All_Percoll",
    "S0108" ~ "All_Papain",
    "S0162" ~ "All_Dissociation",
    "S0163" ~ "All_Dissociation",
    "S0164" ~ "All_Dissociation",
    "S0165" ~ "All_Dissociation"
  ),
  batch_ID = case_match(
    batch,
    "All_Dissociation" ~ "batch_all_dissociation",
    "All_Papain" ~ "batch_all_digestion",
    "All_Percoll" ~ "batch_all_digestion",
    "CD45_only" ~ "batch_CD45"
  )
  )
# resident 
resident@meta.data <- resident@meta.data %>% 
  mutate(batch = case_match(
    sample.id,
    "S0087" ~ "CD45_only",
    "S0088" ~ "CD45_only",
    "S0096" ~ "CD45_only",
    "S0130" ~ "All_Percoll",
    "S0129" ~ "All_Percoll",
    "S0108" ~ "All_Papain",
    "S0162" ~ "All_Dissociation",
    "S0163" ~ "All_Dissociation",
    "S0164" ~ "All_Dissociation",
    "S0165" ~ "All_Dissociation"
  ),
  batch_ID = case_match(
    batch,
    "All_Dissociation" ~ "batch_all_dissociation",
    "All_Papain" ~ "batch_all_digestion",
    "All_Percoll" ~ "batch_all_digestion",
    "CD45_only" ~ "batch_CD45"
  )
  )
# vascular
vascular@meta.data <- vascular@meta.data %>% 
  mutate(batch = case_match(
    sample.id,
    "S0087" ~ "CD45_only",
    "S0088" ~ "CD45_only",
    "S0096" ~ "CD45_only",
    "S0130" ~ "All_Percoll",
    "S0129" ~ "All_Percoll",
    "S0108" ~ "All_Papain",
    "S0162" ~ "All_Dissociation",
    "S0163" ~ "All_Dissociation",
    "S0164" ~ "All_Dissociation",
    "S0165" ~ "All_Dissociation"
  ),
  batch_ID = case_match(
    batch,
    "All_Dissociation" ~ "batch_all_dissociation",
    "All_Papain" ~ "batch_all_digestion",
    "All_Percoll" ~ "batch_all_digestion",
    "CD45_only" ~ "batch_CD45"
  )
  )
# lymphoid
lymphoid@meta.data <- lymphoid@meta.data %>% 
  mutate(batch = case_match(
    sample.id,
    "S0087" ~ "CD45_only",
    "S0088" ~ "CD45_only",
    "S0096" ~ "CD45_only",
    "S0130" ~ "All_Percoll",
    "S0129" ~ "All_Percoll",
    "S0108" ~ "All_Papain",
    "S0162" ~ "All_Dissociation",
    "S0163" ~ "All_Dissociation",
    "S0164" ~ "All_Dissociation",
    "S0165" ~ "All_Dissociation"
  ),
  batch_ID = case_match(
    batch,
    "All_Dissociation" ~ "batch_all_dissociation",
    "All_Papain" ~ "batch_all_digestion",
    "All_Percoll" ~ "batch_all_digestion",
    "CD45_only" ~ "batch_CD45"
  )
  )

# myeloid

myeloid@meta.data <- myeloid@meta.data %>% 
  mutate(batch = case_match(
    sample.id,
    "S0087" ~ "CD45_only",
    "S0088" ~ "CD45_only",
    "S0096" ~ "CD45_only",
    "S0130" ~ "All_Percoll",
    "S0129" ~ "All_Percoll",
    "S0108" ~ "All_Papain",
    "S0162" ~ "All_Dissociation",
    "S0163" ~ "All_Dissociation",
    "S0164" ~ "All_Dissociation",
    "S0165" ~ "All_Dissociation"
  ),
  batch_ID = case_match(
    batch,
    "All_Dissociation" ~ "batch_all_dissociation",
    "All_Papain" ~ "batch_all_digestion",
    "All_Percoll" ~ "batch_all_digestion",
    "CD45_only" ~ "batch_CD45"
  )
  )

# microglia
microglia@meta.data <- microglia@meta.data %>% 
  mutate(batch = case_match(
    sample.id,
    "S0087" ~ "CD45_only",
    "S0088" ~ "CD45_only",
    "S0096" ~ "CD45_only",
    "S0130" ~ "All_Percoll",
    "S0129" ~ "All_Percoll",
    "S0108" ~ "All_Papain",
    "S0162" ~ "All_Dissociation",
    "S0163" ~ "All_Dissociation",
    "S0164" ~ "All_Dissociation",
    "S0165" ~ "All_Dissociation"
  ),
  batch_ID = case_match(
    batch,
    "All_Dissociation" ~ "batch_all_dissociation",
    "All_Papain" ~ "batch_all_digestion",
    "All_Percoll" ~ "batch_all_digestion",
    "CD45_only" ~ "batch_CD45"
  )
  )

```

```{r}
colnames(Glioma@meta.data) # contains monocle3 trajectory (or maybe not)
colnames(resident@meta.data) # contains cell cycle score
colnames(vascular@meta.data) # contains cell cycle score
colnames(lymphoid@meta.data)# contains cell cycle score
colnames(myeloid@meta.data) # contains cell cycle score
colnames(microglia@meta.data) # contains cell cycle score
```

```{r}
save(Glioma, file = "data/GBM_RNA_10_glioma_V2.Robj")
save(microglia, file = "data/GBM_RNA_10_microglia_V3.Robj")
save(resident, file = "data/GBM_RNA_10_resident_V2p2.Robj")
save(myeloid, file = "data/GBM_RNA_10_myeloid_V3p2.Robj")
save(vascular, file = "data/GBM_RNA_10_vascular_V2p1.Robj")
save(lymphoid, file = "data/GBM_RNA_10_lymphoid_V3p1.Robj")
```

# re-integrate tumor subset (test)

```{r}
Glioma <- NormalizeData(Glioma,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
Glioma <- FindVariableFeatures(object = Glioma, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
#VariableFeatures(Glioma) <-  VariableFeatures(Glioma) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(Glioma))]
VariableFeaturePlot(Glioma,selection.method = "mean.var.plot")

Glioma <- ScaleData(object = Glioma, features = VariableFeatures(object = Glioma), vars.to.regress = c("nCount_RNA", "percent.mt"))
Glioma <- RunPCA(object = Glioma,
                features =  VariableFeatures(object = Glioma),
                dims = 1:50)
gc()

ElbowPlot(Glioma,ndims = 50)
```

```{r}
Glioma <- RunHarmony(object = Glioma, group.by.vars = c("batch_ID"), max.iter.harmony = 20)
Glioma <- RunUMAP(Glioma,dims = 1:30,reduction = "harmony")
Glioma <- RunTSNE(Glioma,dims = 1:30,reduction = "harmony")

Glioma <- FindNeighbors(Glioma, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  Glioma <- FindClusters(object = Glioma, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
Glioma <- JoinLayers(Glioma)
```


```{r}
DimPlot(Glioma,reduction = "tsne",group.by = "orig.ident",shuffle = T)
DimPlot(Glioma,reduction = "umap",group.by = "orig.ident",shuffle = T)
DimPlot(Glioma,reduction = "umap",group.by = "RNA_snn_res.0.1",label = T,split.by = "progress")
DimPlot(Glioma,reduction = "umap",group.by = "RNA_snn_res.1",label = T,split.by = "progress")
```
```{r}
DimPlot(Glioma,reduction = "umap",group.by = "annotation_V1",shuffle = T)
DimPlot(Glioma,reduction = "umap",group.by = "Phase",shuffle = T)
DimPlot(Glioma,reduction = "umap",group.by = "batch_ID",shuffle = T)
DimPlot(Glioma,reduction = "umap",group.by = "RNA_snn_res.1",label = T,split.by = "batch_ID")
DimPlot(Glioma,reduction = "umap",group.by = "annotation_V1",label = T,split.by = "batch_ID")
```
The correction seems to be working. Still, in general, there is only limuted number of subsets that are indeed enriched in HGG.
I think integration by batch_ID works better than integration by sample. I also need to increase the resolution such that clusters enriched in HGG can be identified.

```{r}
DimPlot(Glioma,reduction = "umap",group.by = "RNA_snn_res.0.5",label = T,split.by = "progress")
DimPlot(Glioma,reduction = "umap",group.by = "RNA_snn_res.0.7",label = T,split.by = "progress")
```

```{r}
cds <- as.cell_data_set(Glioma)
cds <- cluster_cells(cds, resolution=1e-3)
```

```{r}
plot_cells(cds, color_cells_by = "cluster", show_trajectory_graph = FALSE)
plot_cells(cds, color_cells_by = "partition", show_trajectory_graph = FALSE)
```

```{r}
cds <- learn_graph(cds, use_partition = T, verbose = FALSE)

plot_cells(cds,
           color_cells_by = "cluster",
           label_groups_by_cluster=T,
           label_leaves=FALSE,
           label_branch_points=FALSE)
```
```{r}
plot_cells(cds, color_cells_by = "cluster", show_trajectory_graph = T,label_leaves = F,label_roots = T,label_branch_points = T)
```


```{r}
cds <- order_cells(cds, root_cells = colnames(cds[,clusters(cds) == 3]))

plot_cells(cds,
           color_cells_by = "pseudotime",
           group_cells_by = "cluster",
           label_cell_groups = FALSE,
           label_groups_by_cluster=FALSE,
           label_leaves=F,
           label_branch_points=F,
           label_roots = T,
           trajectory_graph_color = "white")+theme_dark()
```

```{r}
Glioma <- AddMetaData(Glioma,metadata = cds@principal_graph_aux@listData$UMAP$pseudotime,col.name = "monocle3_trajectory")
```


```{r}
Idents(Glioma) <- Glioma$annotation_V1
plts <- lapply(c("Egfr","Gas1", "Smo","Aqp4","Aldh1l1","Aldoc","Fezf2", "Rorb", "Dbx2","Lhx2","Sox9","Sox10","Olig1","Olig2","Mag","Sox4","Sox2","Nes","Foxp2","Igfbp7","Vim","Mki67","Top2a", "Tnfrsf1a","Tradd", "Relb","Notch3","Gli2"),function(x){
  FeaturePlot(Glioma,reduction = "umap",features = x,label = T) +scale_colour_gradientn(colors = c("grey", "red", "purple"))
})
g <- grid.arrange(grobs = plts,nrow = 6)
ggsave(filename = paste0("Glioma_markers_FeaturePlot_pmarkers_labeled.pdf"), plot = g, units = "cm",height = 100,width = 100)

```

```{r}
Glioma@meta.data <- Glioma@meta.data %>%
  mutate(annotation_V1 = case_match(
    as.character(RNA_snn_res.0.7),
    "0" ~ "tumor_1",
    "1" ~ "tumor_2",
    "2" ~ "tumor_3",
    "3" ~ "tumor_4",
    "4" ~ "tumor_5",
    "5" ~ "tumor_6",
    "6" ~ "tumor_7",
    "7" ~ "tumor_8",
    "8" ~ "tumor_9",
    "9" ~ "tumor_10",
    "10" ~ "tumor_11",
    "11" ~ "tumor_12",
    "12" ~ "tumor_13",
    "13" ~ "likely-not-tumor"
  ))
```

```{r}
save(Glioma, file = "data/GBM_RNA_10_glioma_V2_alt.Robj") # I accidentally overwrote V2 :)))
# now the RDS is namaed glioma_V2_alt; I'll try recovering V2 using the Glioma processing markdown
```


# re-integrate tissue subset

## re-integrate neuronal

```{r}
resident <- NormalizeData(resident,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
resident <- FindVariableFeatures(object = resident, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
#VariableFeatures(vascular) <-  VariableFeatures(vascular) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(vascular))]
VariableFeaturePlot(resident,selection.method = "mean.var.plot")

resident <- ScaleData(object = resident, features = VariableFeatures(object = resident), vars.to.regress = c("nCount_RNA", "percent.mt"))
resident <- RunPCA(object = resident,
                features =  VariableFeatures(object = resident),
                dims = 1:50)
gc()

ElbowPlot(resident,ndims = 50)
```


```{r}
resident <- RunHarmony(object = resident, group.by.vars = c("batch_ID"), max.iter.harmony = 20)
resident <- RunUMAP(resident,dims = 1:30,reduction = "harmony")
resident <- RunTSNE(resident,dims = 1:30,reduction = "harmony")

resident <- FindNeighbors(resident, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  resident <- FindClusters(object = resident, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
```

```{r}
DimPlot(resident,group.by = "RNA_snn_res.0.1")
DimPlot(resident,group.by = "RNA_snn_res.0.1",split.by = "progress")
DimPlot(resident,group.by = "RNA_snn_res.0.1",split.by = "batch_ID")
```


```{r}
Idents(resident) <- resident$RNA_snn_res.0.1
DotPlot(resident,features = c("Aqp4","Aldh1l1","Aldoc","Fezf2", "Rorb", "Dbx2","Lhx2","Sox9","Sox10","Olig2","Mag","Pdgfra","Gad2","Bcl11b","Ppp1r1b","Otx2","Pvalb","Sox2","Nes","Foxp2","Igfbp7","Pecam1","Mki67","P2ry12","Ptprc"),cluster.idents = T) + RotatedAxis()
```

1,12,5,10,6 are astrocyte-like because they express Sox9 and some of the astrocyte markers.
2,3 and 8 are neuronal.
9 is progenitor-like with Pdfgra+ weak lineage maturation markers and Sox9, Sox10 expression.
0 and 4 are OLG (Sox10+ Olig2+ Mag+)
7 is also progenitor-like (Pdgfra+ Sox9+)
11: progenitor-like.


```{r}
resident@meta.data <- resident@meta.data %>% 
  mutate(annotation_V1 = case_match(
    as.character(RNA_snn_res.0.1),
    "0" ~ "Oligodendrocyte_1",
    "1" ~ "Astrocyte_1",
    "2" ~ "Neutron_1",
    "3" ~ "Neutron_2",
    "4" ~ "Oligodendrocyte_2",
    "5" ~ "Astrocyte_2",
    "6" ~ "Astrocyte_3",
    "7" ~ "Progenitor-like_1",
    "8" ~ "Neuron_3",
    "9" ~ "Progenitor-like_2",
    "10" ~ "Astrocyte_4",
    "11" ~ "Progenitor-like_3",
    "12" ~ "Astrocyte_5"
  ),
  compartment = rep("neuronal",nrow(resident@meta.data)))
```

```{r}
resident <- JoinLayers(resident)
```


```{r}
save(resident,file = "data/GBM_RNA_10_resident_V2p2_alt.Robj")
```

## re-integrate stromal

```{r}
vascular <- NormalizeData(vascular,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
vascular <- FindVariableFeatures(object = vascular, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
#VariableFeatures(vascular) <-  VariableFeatures(vascular) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(vascular))]
VariableFeaturePlot(vascular,selection.method = "mean.var.plot")

vascular <- ScaleData(object = vascular, features = VariableFeatures(object = vascular), vars.to.regress = c("nCount_RNA", "percent.mt"))
vascular <- RunPCA(object = vascular,
                features =  VariableFeatures(object = vascular),
                dims = 1:50)
gc()

ElbowPlot(vascular,ndims = 50)
```

```{r}
vascular <- RunHarmony(object = vascular, group.by.vars = c("batch_ID"), max.iter.harmony = 20)
vascular <- RunUMAP(vascular,dims = 1:20,reduction = "harmony")
vascular <- RunTSNE(vascular,dims = 1:20,reduction = "harmony")

vascular <- FindNeighbors(vascular, dims = 1:20,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  vascular <- FindClusters(object = vascular, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
```


```{r}
DimPlot(vascular,group.by = "RNA_snn_res.0.2",split.by = "progress")
DimPlot(vascular,group.by = "RNA_snn_res.0.2")
DimPlot(vascular,group.by = "RNA_snn_res.0.2",split.by = "batch_ID")
```
```{r}
DimPlot(vascular,group.by = "RNA_snn_res.0.1",split.by = "progress")
DimPlot(vascular,group.by = "RNA_snn_res.0.1")
DimPlot(vascular,group.by = "RNA_snn_res.0.1",split.by = "batch_ID")
```
The resolution is chosen such that subpopulations enriched in one condition can be identified. Meanwhile, cluster number is restricted to avoid too many clusters.

```{r}
Idents(vascular) <- vascular$RNA_snn_res.0.2
DotPlot(vascular,features = c("Nfib","Sox2","Nes","Foxp2","Igfbp7","Pecam1","Myct1","Col1a1","Col5a2","Dlc1","Pdgfrb","Vtn","Anpep","Acta2","Fos","Bphl","Ttr","Cd63","Mki67"),cluster.idents = T)+RotatedAxis()
```
0,2,4,5 are EC (Pecam1+Myct1+)
1,3,6,7,8 are perivascular; 6 is fibroblast-like, 3 is smooth muscle like. 

```{r}
vascular@meta.data <- vascular@meta.data %>% 
  mutate(annotation_V1 = case_match(
    as.character(RNA_snn_res.0.2),
    "0" ~ "Endothelial_1",
    "1" ~ "Perivascular_1",
    "2" ~ "Endothelial_2",
    "3" ~ "Perivascular_2",
    "4" ~ "Endothelial_3",
    "5" ~ "Endothelial_4",
    "6" ~ "Perivascular_3",
    "7" ~ "Perivascular_4",
    "8" ~ "Perivascular_5"
  ),
  compartment = rep("stromal",nrow(vascular@meta.data)))
```


```{r}
vascular <- JoinLayers(vascular)
```


```{r}
save(vascular,file = "data/GBM_RNA_10_vascular_V2p1_alt.Robj")
```

# re-integrate immune cells

## microglia

```{r}
microglia <- NormalizeData(microglia,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
microglia <- FindVariableFeatures(object = microglia, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))

VariableFeaturePlot(microglia,selection.method = "mean.var.plot")

microglia <- ScaleData(object = microglia, features = VariableFeatures(object = microglia), vars.to.regress = c("nCount_RNA", "percent.mt"))
microglia <- RunPCA(object = microglia,
                features =  VariableFeatures(object = microglia),
                dims = 1:30)
gc()

ElbowPlot(microglia,ndims = 30)
```

```{r}
microglia <- RunHarmony(object = microglia, group.by.vars = c("batch_ID"), max.iter.harmony = 20)
microglia <- RunUMAP(microglia,dims = 1:20,reduction = "harmony")
microglia <- RunTSNE(microglia,dims = 1:20,reduction = "harmony")

microglia <- FindNeighbors(microglia, dims = 1:20,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  microglia <- FindClusters(object = microglia, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
microglia <- JoinLayers(microglia)
```

```{r}
DimPlot(microglia,group.by = "annotation_V1")
DimPlot(microglia,group.by = "RNA_snn_res.0.4",label = T)
```

```{r}
DimPlot(microglia,group.by = "RNA_snn_res.0.4",label = T)
DimPlot(microglia,group.by = "orig.ident")
DimPlot(microglia,group.by = "progress")
DimPlot(microglia,group.by = "RNA_snn_res.0.4",split.by = "progress")
```
0.4 was chosen as the resolution to match pattern of some marker (Ms4a7).

```{r}
FeaturePlot(microglia,features = "Mki67")
FeaturePlot(microglia,features = "Ms4a7")
FeaturePlot(microglia,features = "Hexb")
FeaturePlot(microglia,features = "Sall1")
FeaturePlot(microglia,features = "Cd19")
FeaturePlot(microglia,features = "Lyz2")
FeaturePlot(microglia,features = "P2ry12")
FeaturePlot(microglia,features = "Cd79a")
FeaturePlot(microglia,features = "Cd3e")
FeaturePlot(microglia,features = "Cd4")
FeaturePlot(microglia,features = "Cd8a")
```

```{r}
microglia@meta.data <- microglia@meta.data %>%
  mutate(annotation_V1 = case_match(
    as.character(RNA_snn_res.0.4),
    "0" ~ "microglia_1",
    "1" ~ "microglia_2",
    "2" ~ "microglia_3",
    "3" ~ "microglia_4",
    "4" ~ "microglia_5",
    "5" ~ "microglia_6",
    "6" ~ "microglia_7",
    "7" ~ "proliferating microglia",
    "8" ~ "microglia_8",
    "9" ~ "microglia_9",
    "10" ~ "microglia_10"
  ),
  cell_type = case_match(
    annotation_V1,
    "proliferating microglia" ~ "microglia",
    .default = "microglia"
  ),
  annotation_main = case_match(
    cell_type,
    "proliferating microglia" ~ "microglia",
    .default = "microglia"))
```

```{r}
DimPlot(microglia,group.by = "annotation_V1")
```

```{r}
save(microglia,file ="data/GBM_RNA_10_microglia_V3_alt.Robj")
```


## myeloid

```{r}
myeloid <- FindVariableFeatures(object = myeloid, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))

VariableFeaturePlot(myeloid,selection.method = "mean.var.plot")

myeloid <- ScaleData(object = myeloid, features = VariableFeatures(object = myeloid), vars.to.regress = c("nCount_RNA", "percent.mt"))
myeloid <- RunPCA(object = myeloid,
                features =  VariableFeatures(object = myeloid),
                dims = 1:40)
gc()

ElbowPlot(myeloid,ndims = 40)
```

```{r}
myeloid <- RunHarmony(object = myeloid, group.by.vars = c("batch_ID"), max.iter.harmony = 20)
myeloid <- RunUMAP(myeloid,dims = 1:30,reduction = "harmony")
myeloid <- RunTSNE(myeloid,dims = 1:30,reduction = "harmony")

myeloid <- FindNeighbors(myeloid, dims = 1:30,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  myeloid <- FindClusters(object = myeloid, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
myeloid <- JoinLayers(myeloid)
```


```{r}
DimPlot(myeloid,group.by = "RNA_snn_res.0.1",label = T)
DimPlot(myeloid,group.by = "RNA_snn_res.1",label = T)
DotPlot(myeloid,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.0.1",cluster.idents = T)+RotatedAxis()
DotPlot(myeloid,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Mpo","S100a8","Cd200r3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.1",cluster.idents = T)+RotatedAxis()
```

```{r}
DimPlot(myeloid,group.by = "RNA_snn_res.0.8",label = T,split.by = "progress")
```


```{r}
DimPlot(myeloid,group.by = "RNA_snn_res.0.8",label = T)
DotPlot(myeloid,features = c("Ptprc","Cd3e","Cd4","Cd8a","Ncr1","Klrb1c","Gzma","Cd19","Cd79a","Tyrobp","Adgre1","Mertk","Cd44","Ccr2","Siglech","Sirpa","Batf3","Xcr1","Flt3","Mpo","S100a8","Cd200r3","Enpp3","Lyz2","Sall1","P2ry12","Hexb","Mki67"),group.by = "RNA_snn_res.0.8",cluster.idents = T)+RotatedAxis()
```
Resolution of 0.8 is chosen to isolate mast cells from neutrophil and to isolate condition-specific clusters.
Adgre1+: mono-mac: 0,1,2,3,4,5,6,11,12
S100a8+ neutrophil: 9
Siglech+ Cd4+ Cd8a+ pDC: 10
Xcr1+ cDC1: 7
Batf3+ Flt3+ DC-like: 8
Cd200r3+ Enpp3- mast cells: 13


```{r}
myeloid@meta.data <- myeloid@meta.data %>% 
  mutate(annotation_main = case_match(
    as.character(RNA_snn_res.0.8),
    "0" ~ "mono-mac",
    "1" ~ "mono-mac",
    "2" ~ "mono-mac",
    "3" ~ "mono-mac",
    "4" ~ "mono-mac",
    "5" ~ "mono-mac",
    "6" ~ "mono-mac",
    "7" ~ "DC",
    "8" ~ "DC",
    "9" ~ "Neutrophil",
    "10" ~ "DC",
    "11" ~ "mono-mac",
    "12" ~ "mono-mac",
    "13" ~ "mast cells"
  ),
  annotation_V1 = case_match(
    as.character(RNA_snn_res.0.8),
    "0" ~ "mono-mac_1",
    "1" ~ "mono-mac_2",
    "2" ~ "mono-mac_3",
    "3" ~ "mono-mac_4",
    "4" ~ "mono-mac_5",
    "5" ~ "mono-mac_6",
    "6" ~ "mono-mac_7",
    "7" ~ "cDC1",
    "8" ~ "DC-like",
    "9" ~ "neutrophil",
    "10" ~ "pDC",
    "11" ~ "mono-mac_8",
    "12" ~ "mono-mac_9",
    "13" ~ "mast cells"
    ),
  cell_type = case_match(
    as.character(RNA_snn_res.0.8),
    "1"  ~ "myeloid",
    .default = "myeloid"
  ))
```

```{r}
DimPlot(myeloid,group.by = "annotation_V1",label = T)
DimPlot(myeloid,group.by = "annotation_V1",label = F,split.by = "progress")
```


```{r}
save(myeloid,file = "data/GBM_RNA_10_myeloid_V3p2_alt.Robj")
```

## lymphoid


```{r}
lymphoid <- NormalizeData(lymphoid,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
lymphoid <- FindVariableFeatures(object = lymphoid, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
# TCR gene removal step missing
VariableFeaturePlot(lymphoid,selection.method = "mean.var.plot")
# VariableFeatures(lymphoid) <-  VariableFeatures(lymphoid) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(lymphoid))]
lymphoid <- ScaleData(object = lymphoid, features = VariableFeatures(object = lymphoid), vars.to.regress = c("nCount_RNA", "percent.mt"))
lymphoid <- RunPCA(object = lymphoid,
                features =  VariableFeatures(object = lymphoid),
                dims = 1:40)
gc()

ElbowPlot(lymphoid,ndims = 40)
```

```{r}
lymphoid <- RunHarmony(object = lymphoid, group.by.vars = c("batch_ID"), max.iter.harmony = 20)
lymphoid <- RunUMAP(lymphoid,dims = 1:20,reduction = "harmony")
lymphoid <- RunTSNE(lymphoid,dims = 1:20,reduction = "harmony")

lymphoid <- FindNeighbors(lymphoid, dims = 1:20,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  lymphoid <- FindClusters(object = lymphoid, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
lymphoid <- JoinLayers(lymphoid)
```


```{r}
DimPlot(lymphoid,group.by = "annotation_V1")
DimPlot(lymphoid,group.by = "RNA_snn_res.1",label = T)
DimPlot(lymphoid,group.by = "RNA_snn_res.1",label = T,split.by = "progress")
FeaturePlot(lymphoid,features = "Cd3e")
FeaturePlot(lymphoid,features = "Ncr1")
FeaturePlot(lymphoid,features = "Klrb1c")
FeaturePlot(lymphoid,features = "Gzma")
FeaturePlot(lymphoid,features = "Cd8a")
```

Looks like that NK and NKT can be isolated at high resolution

```{r}
DimPlot(lymphoid,group.by = "RNA_snn_res.0.7",label = T)
DimPlot(lymphoid,group.by = "RNA_snn_res.0.7",label = T,split.by = "progress")
```

```{r}
DotPlot(lymphoid,group.by = "RNA_snn_res.0.7",features = c("Cd3e","Cd4","Cd8a","Ccr7","Lef1","Cd44","Sell","Prf1","Isg15","Il2ra","Il2rb","Il7r","Tnf","Ifng","Gzmb","Lag3","Havcr2","Tox","Tigit","Pdcd1","Ncr1","Klrb1c","Tyrobp","Foxp3","Batf3","Irf4","Il17a","Rorc","Gzma","Zbtb32","Cd19","Cr2","Fcer2a","Cd24a","Cd1d1","Mki67"),dot.scale = 5) + RotatedAxis()+theme(axis.text=element_text(size=8),
        axis.title=element_text(size=8,face="bold"),
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 8))
```

Cd19+ B cells: 7,10, 11; 11 may be transitional B cell
NK: 4 (Cd3- Cd4- Cd8- Gzma+)
NKT: 3 (Cd3+ Ncr1+ Klrb1c+)
0: CD8 T (Cd3e+ Cd8a+)
1: CD4 T
2: exhausted-like/effector-like CD4T (Cd4+ Pdcd1+Cd44high Il2ra+)
5: Proliferating T cells
6: Ifn-responsive T cells (Isg15+)
8: Naive CD4 T (Ccr7+ Lef1+)
9: helper T cell (Foxp3+)
12: exhausted-like DN (Tox+ Pdcd1+)
13: T_cells; doublets?

```{r}
Idents(lymphoid) <- "annotation_V1"
FeaturePlot(lymphoid,features = c("Havcr2"),label = T,label.size = 2)
FeaturePlot(lymphoid,features = c("Lag3"),label = T,label.size = 2)
FeaturePlot(lymphoid,features = c("Cd19"),label = T,label.size = 2)
FeaturePlot(lymphoid,features = c("Cd4"),label = T,label.size = 2)
FeaturePlot(lymphoid,features = c("Cd8a"),label = T,label.size = 2)
```


```{r}
lymphoid@meta.data <- lymphoid@meta.data %>%
  mutate(annotation_V1 = case_match(
    as.character(RNA_snn_res.0.7),
    "0" ~ "CD8_T_1",
    "1" ~ "CD4_T_1",
    "2" ~ "CD4_T_2_exhausted-like",
    "3" ~ "NKT",
    "4" ~ "NK",
    "5" ~ "Proliferating T_cells",
    "6" ~ "T_cells_2_Ifn-responsive",
    "7" ~ "B_cell_1",
    "8" ~ "CD4_T_3_naive",
    "9" ~ "CD4_T_4_helper",
    "10" ~ "B_cell_2",
    "11" ~ "B_cell_3",
    "12" ~ "T_cells_3_DN",
    "13" ~ "T_cells_4"
  ),
  annotation_main = case_match(
    as.character(RNA_snn_res.0.7),
    "0" ~ "T_cells",
    "1" ~ "T_cells",
    "2" ~ "T_cells",
    "3" ~ "T_cells",
    "4" ~ "NK",
    "5" ~ "T_cells",
    "6" ~ "T_cells",
    "7" ~ "B_cells",
    "8" ~ "T_cells",
    "9" ~ "T_cells",
    "10" ~ "B_cells",
    "11" ~ "B_cells",
    "12" ~ "T_cells",
    "13" ~ "T_cells"
  ),
  cell_type = case_match(
    as.character(RNA_snn_res.0.7),
    "1"  ~ "lymphoid",
    .default = "lymphoid"
  ))
```

```{r}
DimPlot(lymphoid,group.by = "annotation_V1",label = F,split.by = "progress")
DimPlot(lymphoid,group.by = "annotation_main",label = F,split.by = "progress")
```

```{r}
# save(lymphoid,file = "data/GBM_RNA_10_lymphoid_V3p1_alt_varFeature_adjusted.Robj")
```

```{r}
save(lymphoid,file = "data/GBM_RNA_10_lymphoid_V3p1_alt.Robj")
```

# re-generate whole for overview purpose

```{r reload alt versions}
load("data/GBM_RNA_10_glioma_V2_alt.Robj")
load("data/GBM_RNA_10_microglia_V3_alt.Robj")
load("data/GBM_RNA_10_resident_V2p2_alt.Robj")
load("data/GBM_RNA_10_myeloid_V3p2_alt.Robj")
load("data/GBM_RNA_10_vascular_V2p1_alt.Robj")
load("data/GBM_RNA_10_lymphoid_V3p1_alt.Robj")
```


```{r}
Glioma$monocle3_trajectory <- NULL
```

```{r}
ncol(Glioma@meta.data)
ncol(resident@meta.data)
ncol(vascular@meta.data)
ncol(lymphoid@meta.data)
ncol(myeloid@meta.data)
ncol(microglia@meta.data)
```

```{r}
whole_meta <- rbind(Glioma@meta.data,microglia@meta.data,lymphoid@meta.data,myeloid@meta.data,resident@meta.data,vascular@meta.data)
```

```{r}
write.table(whole_meta,file = "data/whole_meta_annotation_V1_alt.tsv",sep = "\t",col.names = T,row.names = F,quote = F)
```


```{r}
whole <- merge(x = Glioma, y = c(resident,vascular,lymphoid,myeloid,microglia))
```


```{r}
whole <- NormalizeData(whole,assay = "RNA", normalization.method = "LogNormalize", scale.factor = 10000)
whole <- FindVariableFeatures(object = whole, selection.method = 'mean.var.plot', mean.cutoff = c(0.025, 5), dispersion.cutoff = c(0.55, Inf))
VariableFeatures(whole) <-  VariableFeatures(whole) [!grepl("^Tra|^Trab|^Igh|^Igk|Mamu-a", VariableFeatures(whole))]
VariableFeaturePlot(whole,selection.method = "mean.var.plot")

whole <- ScaleData(object = whole, features = VariableFeatures(object = whole), vars.to.regress = c("nCount_RNA", "percent.mt"))
whole <- RunPCA(object = whole,
                features =  VariableFeatures(object = whole),
                dims = 1:50)
gc()

ElbowPlot(whole,ndims = 50)
```

```{r}
whole <- RunHarmony(object = whole, group.by.vars = c("batch_ID"), max.iter.harmony = 20)
whole <- RunUMAP(whole,dims = 1:40,reduction = "harmony")
whole <- RunTSNE(whole,dims = 1:40,reduction = "harmony")

whole <- FindNeighbors(whole, dims = 1:40,reduction = "harmony")
for(res in seq(0.1, 1, 0.1))  {   
  whole <- FindClusters(object = whole, resolution = res, print.output = 0, save.SNN = TRUE)
} 
gc()
whole <- JoinLayers(whole)
```

```{r}
DimPlot(whole, reduction = "umap",group.by = "cell_type",shuffle = T)
DimPlot(whole, reduction = "umap",group.by = "compartment",shuffle = T)
DimPlot(whole, reduction = "umap",group.by = "annotation_main",shuffle = T)
DimPlot(whole, reduction = "umap",group.by = "annotation_prelim",shuffle = T)
DimPlot(whole, reduction = "umap",group.by = "RNA_snn_res.0.1",shuffle = T)
p1 <- DimPlot(whole, reduction = "umap",group.by = "annotation_V1",shuffle = T)
p2 <- DimPlot(whole, reduction = "umap",group.by = "annotation_V1",split.by = "progress",shuffle = T)
g <- gridExtra::grid.arrange(grobs = list(p1,p2),nrow = 2)
ggsave(filename = "whole_V2_ann_V1_DimPlot.pdf", plot = g, width = 15, height = 10)
```
```{r}
DimPlot(whole, reduction = "umap",group.by = "Phase",shuffle = T)
```

```{r}
save(whole, file = "data/GBM_RNA_10_whole_V2_alt.Robj")
```


# check effect of CD45_only batch on calculation

```{r}
CD45_only_batch <- whole_meta %>% filter(batch_ID == "batch_CD45")
```

```{r}
CD45_only_batch %>% group_by(compartment,cell_type,annotation_main,progress) %>% summarise(n = n())
```
The effect should be trivial...

```{r}

```

