---
title: "post_adjustment_proportion_plot"
output: html_document
date: "2024-05-30"
---


```{r}
library(tidyverse)
library(Seurat)
library(harmony)
# library(fmsb) # for radar chart
library(ggradar)
library(RColorBrewer)
```

```{r}
indir <- "data/"
outdir <- "proportion_plots_alt/"
if (!dir.exists(outdir)){
  dir.create(outdir)
} 
```

```{r}
pal <- c(brewer.pal(n = 12,name = "Set3"),brewer.pal(n = 6,name = "Dark2"))
```




# Create new tables to correct for batch-scope differences

The CD45_only batch will affect the proportion calculation whenever the total cell number is taken into consideration. There will be no effect when proportion were calculated inside the corresponding compartment. Thus, for overview of compartmental composition, CD45_only batch needs to be excluded (because we need to calculate the compartment sizes for the conditions). When looking into specific compartments when compartment size is considered, there may be still some chance that CD45_only batch will have an effect because the total compartment size of non-immune cells in the CD45_only batch is small and the sub-population size may or may not be representative of the actual proportion. 


```{r}
whole_meta <- read.table(file = paste0(indir,"whole_meta_annotation_V1_alt.tsv"),sep = "\t",header = T)
```

```{r}
table(whole_meta$orig.ident)
table(whole_meta$batch_ID)
table(whole_meta$progress)
```


```{r}
all_compartment_meta <- whole_meta %>% filter(batch_ID !="batch_CD45")
immune_cell_meta <- whole_meta %>% filter(compartment == "immune_cells")
```

```{r}
table(all_compartment_meta$orig.ident)
```


```{r}
write.table(all_compartment_meta,file = "data/whole_meta_annotation_V1_alt_all_comp.tsv",sep = "\t",col.names = T,row.names = F,quote = F)
write.table(immune_cell_meta,file = "data/whole_meta_annotation_V1_alt_immune_cells.tsv",sep = "\t",col.names = T,row.names = F,quote = F)
```

# Overview 

## Overview of all comparts

```{r batch-grouping based on batch-ID}
compart_table_batch <- full_join(
  x = all_compartment_meta %>% group_by(compartment,sample.id,batch_ID) %>% summarise(compartment_size = n()),
  y = all_compartment_meta %>% group_by(sample.id,batch_ID) %>% summarise(sample_size = n()),
  by = c("sample.id","batch_ID")) %>%
  mutate(prop_compart_per_sample = compartment_size*100 /sample_size ) 
compart_table_progress <- full_join(
  x = all_compartment_meta %>% group_by(compartment,sample.id,progress) %>% summarise(compartment_size = n()),
  y = all_compartment_meta %>% group_by(sample.id,progress) %>% summarise(sample_size = n()),
  by = c("sample.id","progress")) %>%
  mutate(prop_compart_per_sample = compartment_size*100 /sample_size ) 
```


```{r}
compartment <- "compartment_overview"
outdir <- paste0("proportion_plots_alt/",compartment,"/")
if (!dir.create(outdir)){
  dir.create(outdir)
}
```




### boxplots

```{r}
g <- ggplot(compart_table_progress)+
  geom_boxplot(aes(x = compartment, y = prop_compart_per_sample,fill = progress)) +
  geom_jitter(aes(x = compartment, y = prop_compart_per_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"compartment_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
g <- ggplot(compart_table_batch)+
  geom_boxplot(aes(x = compartment, y = prop_compart_per_sample,fill = batch_ID)) +
  geom_jitter(aes(x = compartment, y = prop_compart_per_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"compartment_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

### barplots (of average)

```{r}
# by sample barplot
g <- ggplot(compart_table_batch) +
  geom_bar(aes(x = sample.id, y = prop_compart_per_sample,fill = compartment),stat = "summary",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
ggsave(filename = paste0(outdir,"compartment_prop_barplots_by_sample_ann_V1.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(compart_table_progress) +
  geom_bar(aes(x = sample.id, y = prop_compart_per_sample,fill = compartment),stat = "summary",position = "stack") +
  facet_wrap(~progress, scales = "free")+
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
ggsave(filename = paste0(outdir,"compartment_prop_barplots_by_sample_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


```{r}
progress_comp_table <- full_join(
  x = all_compartment_meta %>% group_by(compartment,progress) %>% summarise(compartment_size = n()),
  y = all_compartment_meta %>% group_by(progress) %>% summarise(progress_size = n()),
  by = c("progress")) %>%
  mutate(prop_compart_per_progress = compartment_size*100 /progress_size)
```


```{r}
g <- ggplot(progress_comp_table) +
  geom_bar(aes(x = progress, y = prop_compart_per_progress,fill = compartment),stat = "summary",position = "stack") +
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
ggsave(filename = paste0(outdir,"compartment_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


```{r}
batch_ID_comp_table <- full_join(
  x = all_compartment_meta %>% group_by(compartment,batch_ID) %>% summarise(compartment_size = n()),
  y = all_compartment_meta %>% group_by(batch_ID) %>% summarise(batch_ID_size = n()),
  by = c("batch_ID")) %>%
  mutate(prop_compart_per_batch_ID = compartment_size*100 /batch_ID_size)
```

```{r}
g <- ggplot(batch_ID_comp_table) +
  geom_bar(aes(x = batch_ID, y = prop_compart_per_batch_ID,fill = compartment),stat = "summary",position = "stack") +
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
ggsave(filename = paste0(outdir,"compartment_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


### radar/spider chart of proportions

```{r}
radar_df_batch_comp <- matrix(nrow = 2,ncol = 4)
rownames(radar_df_batch_comp) <- unique(batch_ID_comp_table$batch_ID)
colnames(radar_df_batch_comp) <- unique(batch_ID_comp_table$compartment)

for (i in (1:length(batch_ID_comp_table$prop_compart_per_batch_ID))){
  radar_df_batch_comp[batch_ID_comp_table$batch_ID[i],batch_ID_comp_table$compartment[i]] <- batch_ID_comp_table$prop_compart_per_batch_ID[i] 
}
radar_df_batch_comp = as.data.frame(radar_df_batch_comp)
radar_df_batch_comp = cbind(batch_ID = as.data.frame(matrix(rownames(radar_df_batch_comp),byrow = F, ncol = 1)),radar_df_batch_comp)

colnames(radar_df_batch_comp)[1] = "batch_ID"
```


```{r}
ggradar(
  radar_df_batch_comp, 
  values.radar = c("0", "40", "80"),
  grid.min = 0, grid.mid = 40, grid.max = 80,
  # Polygons
  group.line.width = 1, 
  group.point.size = 3,
  group.colours = c("#00AFBB", "#E7B800"),
  # Background and grid lines
  background.circle.colour = "white",
  gridline.mid.colour = "grey",
  legend.position = "bottom"
  )

```

```{r by progress}

radar_df_progress_comp <- matrix(nrow = 3,ncol = 4)
rownames(radar_df_progress_comp) <- unique(progress_comp_table$progress)
colnames(radar_df_progress_comp) <- unique(progress_comp_table$compartment)

for (i in (1:length(progress_comp_table$prop_compart_per_progress))){
  radar_df_progress_comp[progress_comp_table$progress[i],progress_comp_table$compartment[i]] <- progress_comp_table$prop_compart_per_progress[i] 
}
radar_df_progress_comp = as.data.frame(radar_df_progress_comp)
radar_df_progress_comp = cbind(progress = as.data.frame(matrix(rownames(radar_df_progress_comp),byrow = F, ncol = 1)),radar_df_progress_comp)

colnames(radar_df_progress_comp)[1] = "progress"

```

```{r}
ggradar(
  radar_df_progress_comp, 
  values.radar = c("0", "35", "70"),
  grid.min = 0, grid.mid = 35, grid.max = 70,
  # Polygons
  group.line.width = 1, 
  group.point.size = 3,
  group.colours = c("#00AFBB", "#E7B800", "#FC4E07"),
  # Background and grid lines
  background.circle.colour = "white",
  gridline.mid.colour = "grey",
  legend.position = "bottom"
  )
```

```{r}
# try normalizing by NT 
FC_df <- radar_df_progress_comp[1:2,]
FC_df[,2:5] <- as.data.frame(rbind(log2(radar_df_progress_comp["HGG",2:5]) - log2(radar_df_progress_comp["No tumor",2:5]),
               log2(radar_df_progress_comp["LGG",2:5]) - log2(radar_df_progress_comp["No tumor",2:5])))
change_df <- radar_df_progress_comp[1:2,]
change_df[,2:5] <-as.data.frame(rbind(radar_df_progress_comp["HGG",2:5]/radar_df_progress_comp["No tumor",2:5],
               radar_df_progress_comp["LGG",2:5]/radar_df_progress_comp["No tumor",2:5]))

```

```{r}
ggradar(
  FC_df, 
  values.radar = c("-5", "0", "5"),
  grid.min = -5, grid.mid = 0, grid.max = 5,
  # Polygons
  group.line.width = 1, 
  group.point.size = 3,
  group.colours = c("#00AFBB", "#FC4E07"),
  # Background and grid lines
  background.circle.colour = "white",
  gridline.mid.colour = "grey",
  legend.position = "bottom"
  ) # "#E7B800",
```
```{r}
ggradar(
  change_df %>% dplyr::select(-neoplastic), 
  values.radar = c("0", "1", "1.5"),
  grid.min = 0, grid.mid = 1, grid.max = 1.5,
  # Polygons
  group.line.width = 1, 
  group.point.size = 3,
  group.colours = c("#00AFBB", "#FC4E07"),
  # Background and grid lines
  background.circle.colour = "white",
  gridline.mid.colour = "grey",
  legend.position = "bottom"
  )
```


## cell type overview

```{r}
type_table_batch <- full_join(
  x = all_compartment_meta %>% group_by(cell_type,sample.id,batch_ID) %>% summarise(type_size = n()),
  y = all_compartment_meta %>% group_by(sample.id,batch_ID) %>% summarise(sample_size = n()),
  by = c("sample.id","batch_ID")) %>%
  mutate(prop_type_per_sample = type_size*100 /sample_size ) 
type_table_progress <- full_join(
  x = all_compartment_meta %>% group_by(cell_type,sample.id,progress) %>% summarise(type_size = n()),
  y = all_compartment_meta %>% group_by(sample.id,progress) %>% summarise(sample_size = n()),
  by = c("sample.id","progress")) %>%
  mutate(prop_type_per_sample = type_size*100 /sample_size ) 
```


### boxplots

```{r}
g <- ggplot(type_table_progress)+
  geom_boxplot(aes(x = cell_type, y = prop_type_per_sample,fill = progress)) +
  geom_jitter(aes(x = cell_type, y = prop_type_per_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"type_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
g <- ggplot(type_table_batch)+
  geom_boxplot(aes(x = cell_type, y = prop_type_per_sample,fill = batch_ID)) +
  geom_jitter(aes(x = cell_type, y = prop_type_per_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"type_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)
```


### barplots (of average)

```{r}
# by sample barplot
g <- ggplot(type_table_batch) +
  geom_bar(aes(x = sample.id, y = prop_type_per_sample,fill = cell_type),stat = "summary",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
ggsave(filename = paste0(outdir,"type_prop_barplots_by_sample_ann_V1.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(type_table_progress) +
  geom_bar(aes(x = sample.id, y = prop_type_per_sample,fill = cell_type),stat = "summary",position = "stack") +
  facet_wrap(~progress, scales = "free")+
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
ggsave(filename = paste0(outdir,"type_prop_barplots_by_sample_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


```{r}
progress_type_table <- full_join(
  x = all_compartment_meta %>% group_by(cell_type,progress) %>% summarise(cell_type_size = n()),
  y = all_compartment_meta %>% group_by(progress) %>% summarise(progress_size = n()),
  by = c("progress")) %>%
  mutate(prop_type_per_progress = cell_type_size*100 /progress_size)
```


```{r}
g <- ggplot(progress_type_table) +
  geom_bar(aes(x = progress, y = prop_type_per_progress,fill = cell_type),stat = "summary",position = "stack") +
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
ggsave(filename = paste0(outdir,"type_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


```{r}
batch_ID_type_table <- full_join(
  x = all_compartment_meta %>% group_by(cell_type,batch_ID) %>% summarise(cell_type_size = n()),
  y = all_compartment_meta %>% group_by(batch_ID) %>% summarise(batch_ID_size = n()),
  by = c("batch_ID")) %>%
  mutate(prop_type_per_batch_ID = cell_type_size*100 /batch_ID_size)
```

```{r}
g <- ggplot(batch_ID_type_table) +
  geom_bar(aes(x = batch_ID, y = prop_type_per_batch_ID,fill = cell_type),stat = "summary",position = "stack") +
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
ggsave(filename = paste0(outdir,"type_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


### radar/spider chart of proportions

```{r}
radar_df_batch_type <- matrix(nrow = 2,ncol = 12)
rownames(radar_df_batch_type) <- unique(batch_ID_type_table$batch_ID)
colnames(radar_df_batch_type) <- unique(batch_ID_type_table$cell_type)

for (i in (1:length(batch_ID_type_table$prop_type_per_batch_ID))){
  radar_df_batch_type[batch_ID_type_table$batch_ID[i],batch_ID_type_table$cell_type[i]] <- batch_ID_type_table$prop_type_per_batch_ID[i] 
}

radar_df_batch_type = as.data.frame(radar_df_batch_type)
radar_df_batch_type = cbind(batch_ID = as.data.frame(matrix(rownames(radar_df_batch_type),byrow = F, ncol = 1)),radar_df_batch_type)

colnames(radar_df_batch_type)[1] = "batch_ID"
```


```{r}
ggradar(
  radar_df_batch_type, 
  values.radar = c("0", "40", "80"),
  grid.min = 0, grid.mid = 40, grid.max = 80,
  # Polygons
  group.line.width = 1, 
  group.point.size = 3,
  # Background and grid lines
  background.circle.colour = "white",
  gridline.mid.colour = "grey",
  legend.position = "bottom"
  )

```

```{r by progress}

radar_df_progress_type <- matrix(nrow = 3,ncol = 12)
rownames(radar_df_progress_type) <- unique(progress_type_table$progress)
colnames(radar_df_progress_type) <- unique(progress_type_table$cell_type)

for (i in (1:length(progress_type_table$prop_type_per_progress))){
  radar_df_progress_type[progress_type_table$progress[i],progress_type_table$cell_type[i]] <- progress_type_table$prop_type_per_progress[i] 
}
radar_df_progress_type = as.data.frame(radar_df_progress_type)
radar_df_progress_type = cbind(progress = as.data.frame(matrix(rownames(radar_df_progress_type),byrow = F, ncol = 1)),radar_df_progress_type)

colnames(radar_df_progress_type)[1] = "progress"

```

```{r}
ggradar(
  radar_df_progress_type, 
  values.radar = c("0", "35", "70"),
  grid.min = 0, grid.mid = 35, grid.max = 70,
  # Polygons
  group.line.width = 1, 
  group.point.size = 1,
  group.colours = c("#00AFBB", "#E7B800", "#FC4E07"),
  # Background and grid lines
  background.circle.colour = "white",
  gridline.mid.colour = "grey",
  legend.position = "bottom"
  )
```

```{r}
# try normalizing by NT 
FC_df <- radar_df_progress_type[1:2,]
FC_df[,2:ncol(radar_df_progress_type)] <- rbind(log2(radar_df_progress_type["HGG",2:ncol(radar_df_progress_type)]) - log2(radar_df_progress_type["No tumor",2:ncol(radar_df_progress_type)]),
               log2(radar_df_progress_type["LGG",2:ncol(radar_df_progress_type)]) - log2(radar_df_progress_type["No tumor",2:ncol(radar_df_progress_type)]))
radar_df_progress_type <- radar_df_progress_type[1:2,]
radar_df_progress_type[,2:ncol(radar_df_progress_type)] <- rbind(radar_df_progress_type["HGG",2:ncol(radar_df_progress_type)]/radar_df_progress_type["No tumor",2:ncol(radar_df_progress_type)],
               radar_df_progress_type["LGG",2:ncol(radar_df_progress_type)]/radar_df_progress_type["No tumor",2:ncol(radar_df_progress_type)])

```

```{r}
ggradar(
  FC_df, 
  values.radar = c("-5", "0", "5"),
  grid.min = -5, grid.mid = 0, grid.max = 5,
  # Polygons
  group.line.width = 1, 
  group.point.size = 3,
  group.colours = c("#FC4E07","#00AFBB"),
  # Background and grid lines
  background.circle.colour = "white",
  gridline.mid.colour = "grey",
  legend.position = "bottom"
  ) # "#E7B800",
```

```{r}
ggradar(
  FC_df %>% select(-neoplastic), 
  values.radar = c("-3", "0", "3"),
  grid.min = -3, grid.mid = 0, grid.max = 3,
  # Polygons
  group.line.width = 1, 
  group.point.size = 3,
  group.colours = c("#FC4E07","#00AFBB"),
  # Background and grid lines
  background.circle.colour = "white",
  gridline.mid.colour = "grey",
  legend.position = "bottom"
  )
```
#### generate radar plots for all proportions (compartment and celltype)

```{r}
p1 <- ggradar(
  radar_df_batch_comp, 
  values.radar = c("0", "40", "80"),
  grid.min = 0, grid.mid = 40, grid.max = 80,
  base.size = 3,
  # Polygons
  group.line.width = 1, 
  group.point.size = 1,
  axis.label.size = 3,
  grid.label.size = 4,
  legend.text.size = 6,
  # Background and grid lines
  background.circle.colour = "white",
  gridline.mid.colour = "grey",
  legend.position = "bottom"
  )
p2 <- ggradar(
  radar_df_progress_comp, 
  values.radar = c("0", "40", "80"),
  base.size = 3,
  grid.min = 0, grid.mid = 40, grid.max = 80,
  # Polygons
  group.line.width = 1, 
  group.point.size = 1,
  axis.label.size = 3,
  grid.label.size = 4,
  legend.text.size = 6,
  group.colours = c("#FC4E07", "#E7B800","#00AFBB"),
  # Background and grid lines
  background.circle.colour = "white",
  gridline.mid.colour = "grey",
  legend.position = "bottom"
  )
FC_df <- radar_df_progress_comp[1:2,]
FC_df[,2:5] <- rbind(log2(radar_df_progress_comp["HGG",2:5]) - log2(radar_df_progress_comp["No tumor",2:5]),
               log2(radar_df_progress_comp["LGG",2:5]) - log2(radar_df_progress_comp["No tumor",2:5]))
p3 <- ggradar(
  FC_df %>% dplyr::select(-neoplastic), 
  values.radar = c("-1.6", "0", "1"),
  base.size = 3,
  grid.min = -1.6, grid.mid = 0, grid.max = 1,
  # Polygons
  group.line.width = 1, 
  group.point.size = 1,
  axis.label.size = 3,
  grid.label.size = 4,
  legend.text.size = 6,
  group.colours = c("#FC4E07", "#E7B800"),
  # Background and grid lines
  background.circle.colour = "white",
  gridline.mid.colour = "grey",
  legend.position = "bottom"
  )

p4 <- ggradar(
  radar_df_batch_type, 
  values.radar = c("0", "40", "80"),
  base.size = 3,
  grid.min = 0, grid.mid = 40, grid.max = 80,
  # Polygons
  group.line.width = 1, 
  group.point.size = 1,
  axis.label.size = 3,
  grid.label.size = 4,
  legend.text.size = 6,
  # Background and grid lines
  background.circle.colour = "white",
  gridline.mid.colour = "grey",
  legend.position = "bottom"
  )
p5 <- ggradar(
  radar_df_progress_type, 
  values.radar = c("0", "40", "80"),
  base.size = 3,
  grid.min = 0, grid.mid = 40, grid.max = 80,
  # Polygons
  group.line.width = 1, 
  group.point.size = 1,
  axis.label.size = 3,
  grid.label.size = 4,
  legend.text.size = 6,
  group.colours = c("#FC4E07", "#E7B800","#00AFBB"),
  # Background and grid lines
  background.circle.colour = "white",
  gridline.mid.colour = "grey",
  legend.position = "bottom"
  )
FC_df <- radar_df_progress_type[1:2,]
FC_df[,2:ncol(radar_df_progress_type)] <- rbind(log2(radar_df_progress_type["HGG",2:ncol(radar_df_progress_type)]) - log2(radar_df_progress_type["No tumor",2:ncol(radar_df_progress_type)]),
               log2(radar_df_progress_type["LGG",2:ncol(radar_df_progress_type)]) - log2(radar_df_progress_type["No tumor",2:ncol(radar_df_progress_type)]))
p6 <- ggradar(
  FC_df %>% dplyr::select(-neoplastic), 
  values.radar = c("-3", "0", "3"),
  grid.min = -3, grid.mid = 0, grid.max = 3,
  base.size = 3,
  # Polygons
  group.line.width = 1, 
  group.point.size = 1,
  axis.label.size = 3,
  grid.label.size = 4,
  legend.text.size = 6,
  group.colours = c("#FC4E07", "#E7B800"),
  # Background and grid lines
  background.circle.colour = "white",
  gridline.mid.colour = "grey",
  legend.position = "bottom"
  )
p <- gridExtra::grid.arrange(grobs = list(p1,p2,p3,p4,p5,p6),nrow = 2)
ggsave(filename = paste0(outdir,"radar_plot_overview.pdf"),plot = p, width = 15,height = 8)
```


# cluster-based/zooming in

```{r}
c25 <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#CAB2D6", # lt purple
  "#FDBF6F", # lt orange
  "gray70", "khaki2",
  "maroon", "orchid1", "deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown"
)
```



```{r}
cluster_sample_prop_table <- full_join(
                                  x = all_compartment_meta %>% 
                                    group_by(annotation_V1,sample.id,compartment,progress,batch_ID) %>%
                                    summarise(cluster_size = n()),
                                  y = all_compartment_meta %>% 
                                    group_by(sample.id,progress,batch_ID) %>% 
                                    summarise(sample_size = n()),
                                  by = c("sample.id","progress","batch_ID")) %>%
                          mutate(prop_cluster_in_sample = cluster_size*100 /sample_size )

cluster_sample_compart_prop_table <- full_join(
                                  x = all_compartment_meta %>% 
                                    group_by(annotation_V1,compartment,sample.id,progress,batch_ID) %>%
                                    summarise(cluster_size = n()),
                                  y = all_compartment_meta %>% 
                                    group_by(compartment,sample.id,progress,batch_ID) %>% 
                                    summarise(sample_compartment_size = n()),
                                  by = c("compartment","sample.id","progress","batch_ID")) %>%
                          mutate(prop_cluster_in_compartment_per_sample = cluster_size*100 /sample_compartment_size )


cluster_compartment_prop_by_progress <- full_join(
                                  x = all_compartment_meta %>% 
                                    group_by(annotation_V1,compartment,progress) %>%
                                    summarise(cluster_size = n()),
                                  y = all_compartment_meta %>% 
                                    group_by(compartment,progress) %>% 
                                    summarise(progress_compartment_size = n()),
                                  by = c("progress","compartment")) %>%
                          mutate(prop_cluster_in_compartment_per_progress = cluster_size*100 /progress_compartment_size )

# overall in progress: clust/progress
cluster_progress_prop <- full_join(
                                  x = all_compartment_meta %>% 
                                    group_by(annotation_V1,compartment,progress) %>%
                                    summarise(cluster_size = n()),
                                  y = all_compartment_meta %>% 
                                    group_by(progress) %>% 
                                    summarise(progress_size = n()),
                                  by = c("progress")) %>%
                          mutate(prop_cluster_in_progress = cluster_size*100 /progress_size )

cluster_sample_prop_table_batch_ID <- full_join(
                                  x = all_compartment_meta %>% 
                                    group_by(annotation_V1,sample.id,compartment,progress,batch_ID) %>%
                                    summarise(cluster_size = n()),
                                  y = all_compartment_meta %>% 
                                    group_by(sample.id,progress,batch_ID) %>% 
                                    summarise(sample_size = n()),
                                  by = c("sample.id","progress","batch_ID")) %>%
                          mutate(prop_cluster_in_sample = cluster_size*100 /sample_size )
# single sample prop with progress and batch stratifiable labels

cluster_sample_compart_prop_table_batch_ID <- full_join(
                                  x = all_compartment_meta %>% 
                                    group_by(annotation_V1,compartment,sample.id,progress,batch_ID) %>%
                                    summarise(cluster_size = n()),
                                  y = all_compartment_meta %>% 
                                    group_by(compartment,sample.id,progress,batch_ID) %>% 
                                    summarise(sample_compartment_size = n()),
                                  by = c("compartment","sample.id","progress","batch_ID")) %>%
                          mutate(prop_cluster_in_compartment_per_sample = cluster_size*100 /sample_compartment_size )
  
# overall in batch clust/comp
cluster_compartment_prop_by_batch_ID <- full_join(
                                  x = all_compartment_meta %>% 
                                    group_by(annotation_V1,compartment,batch_ID) %>%
                                    summarise(cluster_size = n()),
                                  y = all_compartment_meta %>% 
                                    group_by(compartment,batch_ID) %>% 
                                    summarise(batch_compartment_size = n()),
                                  by = c("compartment","batch_ID")) %>%
                          mutate(prop_cluster_in_compartment_per_batch = cluster_size*100 /batch_compartment_size )

# overall in batch: clust/batch
cluster_batch_prop_batch_ID <- full_join(
                                  x = all_compartment_meta %>% 
                                    group_by(annotation_V1,compartment,batch_ID) %>%
                                    summarise(cluster_size = n()),
                                  y = all_compartment_meta %>% 
                                    group_by(batch_ID) %>% 
                                    summarise(batch_size = n()),
                                  by = c("batch_ID")) %>%
                          mutate(prop_cluster_in_batch = cluster_size*100 /batch_size )
```


## Glioma 

```{r}
compartment <- "neoplastic"
outdir <- paste0("proportion_plots_alt/",compartment,"/")
if (!dir.create(outdir)){
  dir.create(outdir)
}
```

### box plots

#### clust_size / sample_size

```{r}
g <- ggplot(cluster_sample_prop_table %>% filter(compartment == "neoplastic"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_sample,fill = progress)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_cluster_sample_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
g <- ggplot(cluster_sample_prop_table %>% filter(compartment == "neoplastic"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_cluster_sample_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

#### clust_size / compartment_size

```{r}
g <- ggplot(cluster_sample_compart_prop_table %>% filter(compartment == "neoplastic"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,fill = progress)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_cluster_compartment_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
g <- ggplot(cluster_sample_compart_prop_table %>% filter(compartment == "neoplastic"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_cluster_compartment_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 10,height = 10)
```


### bar plots


#### clust_size / progress_size

```{r}
g <- ggplot(cluster_progress_prop %>% filter(compartment == "neoplastic")) +
  geom_bar(aes(x = progress, y = prop_cluster_in_progress,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"neoplastic_progress_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

#### cluster / progress_comp_size

```{r}
g <- ggplot(cluster_compartment_prop_by_progress %>% filter(compartment == "neoplastic")) +
  geom_bar(aes(x = progress, y = prop_cluster_in_compartment_per_progress,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"neoplastic_comp_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

### batch_ID version

```{r}
g <- ggplot(cluster_sample_prop_table_batch_ID %>% filter(compartment == "neoplastic"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_cluster_sample_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)
```


```{r}
# by sample barplot
g <- ggplot(cluster_sample_prop_table_batch_ID %>% filter(compartment == "neoplastic")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"neoplastic_cluster_sample_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(cluster_sample_prop_table_batch_ID %>% filter(compartment == "neoplastic")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~progress, scales = "free")+
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"neoplastic_cluster_sample_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


```{r}
g <- ggplot(cluster_sample_compart_prop_table_batch_ID %>% filter(compartment == "neoplastic"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neoplastic_cluster_compartment_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
# by sample barplot
g <- ggplot(cluster_sample_compart_prop_table_batch_ID %>% filter(compartment == "neoplastic")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_compartment_per_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"neoplastic_cluster_compartment_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(cluster_sample_compart_prop_table_batch_ID %>% filter(compartment == "neoplastic")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_compartment_per_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~progress, scales = "free")+
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"neoplastic_cluster_compartment_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

```{r}
g <- ggplot(cluster_batch_prop_batch_ID %>% filter(compartment == "neoplastic")) +
  geom_bar(aes(x = batch_ID, y = prop_cluster_in_batch,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"neoplastic_batch_ID_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

```{r}
g <- ggplot(cluster_compartment_prop_by_batch_ID %>% filter(compartment == "neoplastic")) +
  geom_bar(aes(x = batch_ID, y = prop_cluster_in_compartment_per_batch,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"neoplastic_comp_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)
```




## Neuronal

```{r}
compartment <- "neuronal"
outdir <- paste0("proportion_plots_alt/",compartment,"/")
if (!dir.create(outdir)){
  dir.create(outdir)
}
```


### box plots

#### clust_size / sample_size

```{r}
g <- ggplot(cluster_sample_prop_table %>% filter(compartment == "neuronal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_sample,fill = progress)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_cluster_sample_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)
```



```{r}
g <- ggplot(cluster_sample_prop_table %>% filter(compartment == "neuronal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_cluster_sample_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

#### clust_size / compartment_size

```{r}
g <- ggplot(cluster_sample_compart_prop_table %>% filter(compartment == "neuronal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,fill = progress)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_cluster_compartment_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
g <- ggplot(cluster_sample_compart_prop_table %>% filter(compartment == "neuronal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_cluster_compartment_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 10,height = 10)
```


### bar plots

#### clust_size / progress_size

```{r}
g <- ggplot(cluster_progress_prop %>% filter(compartment == "neuronal")) +
  geom_bar(aes(x = progress, y = prop_cluster_in_progress,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"neuronal_progress_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

#### cluster / progress_comp_size

```{r}
g <- ggplot(cluster_compartment_prop_by_progress %>% filter(compartment == "neuronal")) +
  geom_bar(aes(x = progress, y = prop_cluster_in_compartment_per_progress,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"neuronal_comp_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

### batch_ID version

```{r}
g <- ggplot(cluster_sample_prop_table_batch_ID %>% filter(compartment == "neuronal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_cluster_sample_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
# by sample barplot
g <- ggplot(cluster_sample_prop_table_batch_ID %>% filter(compartment == "neuronal")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"neuronal_cluster_sample_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(cluster_sample_prop_table_batch_ID %>% filter(compartment == "neuronal")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~progress, scales = "free")+
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"neuronal_cluster_sample_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```



```{r}
g <- ggplot(cluster_sample_compart_prop_table_batch_ID %>% filter(compartment == "neuronal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"neuronal_cluster_compartment_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
# by sample barplot
g <- ggplot(cluster_sample_compart_prop_table_batch_ID %>% filter(compartment == "neuronal")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_compartment_per_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"neuronal_cluster_compartment_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(cluster_sample_compart_prop_table_batch_ID %>% filter(compartment == "neuronal")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_compartment_per_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~progress, scales = "free")+
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"neuronal_cluster_compartment_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

```{r}
g <- ggplot(cluster_batch_prop_batch_ID %>% filter(compartment == "neuronal")) +
  geom_bar(aes(x = batch_ID, y = prop_cluster_in_batch,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"neuronal_batch_ID_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

```{r}
g <- ggplot(cluster_compartment_prop_by_batch_ID %>% filter(compartment == "neuronal")) +
  geom_bar(aes(x = batch_ID, y = prop_cluster_in_compartment_per_batch,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"neuronal_comp_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)
```




## stromal

### box plots

#### clust_size / sample_size

```{r}
compartment <- "stromal"
outdir <- paste0("proportion_plots_alt/",compartment,"/")
if (!dir.create(outdir)){
  dir.create(outdir)
}
```


```{r}
g <- ggplot(cluster_sample_prop_table %>% filter(compartment == "stromal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_sample,fill = progress)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_cluster_sample_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
g <- ggplot(cluster_sample_prop_table %>% filter(compartment == "stromal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_cluster_sample_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

#### clust_size / compartment_size

```{r}
g <- ggplot(cluster_sample_compart_prop_table %>% filter(compartment == "stromal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,fill = progress)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_cluster_compartment_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
g <- ggplot(cluster_sample_compart_prop_table %>% filter(compartment == "stromal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_cluster_compartment_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 10,height = 10)
```


### bar plots


#### clust_size / progress_size

```{r}
g <- ggplot(cluster_progress_prop %>% filter(compartment == "stromal")) +
  geom_bar(aes(x = progress, y = prop_cluster_in_progress,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"stromal_progress_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

#### cluster / progress_comp_size

```{r}
g <- ggplot(cluster_compartment_prop_by_progress %>% filter(compartment == "stromal")) +
  geom_bar(aes(x = progress, y = prop_cluster_in_compartment_per_progress,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"stromal_comp_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

### batch_ID version

```{r}
g <- ggplot(cluster_sample_prop_table_batch_ID %>% filter(compartment == "stromal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_cluster_sample_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
# by sample barplot
g <- ggplot(cluster_sample_prop_table_batch_ID %>% filter(compartment == "stromal")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"stromal_cluster_sample_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(cluster_sample_prop_table_batch_ID %>% filter(compartment == "stromal")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~progress, scales = "free")+
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"stromal_cluster_sample_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

```{r}
g <- ggplot(cluster_sample_compart_prop_table_batch_ID %>% filter(compartment == "stromal"))+
  geom_boxplot(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_cluster_in_compartment_per_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"stromal_cluster_compartment_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)
```

```{r}
# by sample barplot
g <- ggplot(cluster_sample_compart_prop_table_batch_ID %>% filter(compartment == "stromal")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_compartment_per_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"stromal_cluster_compartment_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(cluster_sample_compart_prop_table_batch_ID %>% filter(compartment == "stromal")) +
  geom_bar(aes(x = sample.id, y = prop_cluster_in_compartment_per_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_wrap(~progress, scales = "free")+
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"stromal_cluster_compartment_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

```{r}
g <- ggplot(cluster_batch_prop_batch_ID %>% filter(compartment == "stromal")) +
  geom_bar(aes(x = batch_ID, y = prop_cluster_in_batch,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"stromall_batch_ID_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

```{r}
g <- ggplot(cluster_compartment_prop_by_batch_ID %>% filter(compartment == "stromal")) +
  geom_bar(aes(x = batch_ID, y = prop_cluster_in_compartment_per_batch,fill = annotation_V1),stat = "summary",position = "stack") +
  RotatedAxis()+
  scale_fill_manual(values = pal)+
  theme_classic()
ggsave(filename = paste0(outdir,"stromal_comp_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)
```

## Immune cells


```{r}
compartment <- "immune_cells"
outdir <- paste0("proportion_plots_alt/",compartment,"/")
if (!dir.create(outdir)){
  dir.create(outdir)
}
```

```{r}
# proportion of main celltypes in the immune cell compartment; sum by sample
annMain_compart_prop <- full_join(
                                  x = immune_cell_meta %>% 
                                    group_by(annotation_main,sample.id,compartment,progress,batch) %>%
                                    summarise(annMain_size = n()),
                                  y = immune_cell_meta %>% 
                                    group_by(compartment,sample.id,progress,batch) %>% 
                                    summarise(sample_compartment_size = n()),
                                  by = c("compartment","sample.id","progress","batch")) %>%
                          mutate(prop_annMain_in_compartment_by_sample = annMain_size*100 /sample_compartment_size )


# proportion of subcompartment in the immune cell compartment; sum by sample
subcomp_compart_prop <- full_join(
                                  x = immune_cell_meta %>% 
                                    group_by(cell_type,sample.id,compartment,progress,batch) %>%
                                    summarise(celltype_size = n()),
                                  y = immune_cell_meta %>% 
                                    group_by(compartment,sample.id,progress,batch) %>% 
                                    summarise(sample_compartment_size = n()),
                                  by = c("compartment","sample.id","progress","batch")) %>%
                          mutate(prop_celltype_in_compartment_by_sample = celltype_size*100 /sample_compartment_size )

# proportion of clusters in subcompartment of immune cells; sum by sample

clust_subcomp_prop <- full_join(
                                  x = immune_cell_meta %>% 
                                    group_by(annotation_V1,sample.id,cell_type,progress,batch) %>%
                                    summarise(clust_size = n()),
                                  y = immune_cell_meta %>% 
                                    group_by(cell_type,sample.id,progress,batch) %>% 
                                    summarise(sample_celltype_size = n()),
                                  by = c("cell_type","sample.id","progress","batch")) %>%
                          mutate(prop_clust_in_celltype_by_sample = clust_size*100 /sample_celltype_size )

```

```{r batch_ID version}
# proportion of main celltypes in the immune cell compartment; sum by sample
annMain_compart_prop_batch_ID <- full_join(
                                  x = immune_cell_meta %>% 
                                    group_by(annotation_main,sample.id,compartment,progress,batch_ID) %>%
                                    summarise(annMain_size = n()),
                                  y = immune_cell_meta %>% 
                                    group_by(compartment,sample.id,progress,batch_ID) %>% 
                                    summarise(sample_compartment_size = n()),
                                  by = c("compartment","sample.id","progress","batch_ID")) %>%
                          mutate(prop_annMain_in_compartment_by_sample = annMain_size*100 /sample_compartment_size )


# proportion of subcompartment in the immune cell compartment; sum by sample
subcomp_compart_prop_batch_ID <- full_join(
                                  x = immune_cell_meta %>% 
                                    group_by(cell_type,sample.id,compartment,progress,batch_ID) %>%
                                    summarise(celltype_size = n()),
                                  y = immune_cell_meta %>% 
                                    group_by(compartment,sample.id,progress,batch_ID) %>% 
                                    summarise(sample_compartment_size = n()),
                                  by = c("compartment","sample.id","progress","batch_ID")) %>%
                          mutate(prop_celltype_in_compartment_by_sample = celltype_size*100 /sample_compartment_size )

# proportion of clusters in subcompartment of immune cells; sum by sample

clust_subcomp_prop_batch_ID <- full_join(
                                  x = immune_cell_meta %>% 
                                    group_by(annotation_V1,sample.id,cell_type,progress,batch_ID) %>%
                                    summarise(clust_size = n()),
                                  y = immune_cell_meta %>% 
                                    group_by(cell_type,sample.id,progress,batch_ID) %>% 
                                    summarise(sample_celltype_size = n()),
                                  by = c("cell_type","sample.id","progress","batch_ID")) %>%
                          mutate(prop_clust_in_celltype_by_sample = clust_size*100 /sample_celltype_size )

```



#### proportion of main celltypes in the immune cell compartment; sum by sample

```{r}
g <- ggplot(annMain_compart_prop)+
  geom_boxplot(aes(x = annotation_main, y = prop_annMain_in_compartment_by_sample,fill = progress)) +
  geom_jitter(aes(x = annotation_main, y = prop_annMain_in_compartment_by_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_main_compartment_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)

g <- ggplot(annMain_compart_prop)+
  geom_boxplot(aes(x = annotation_main, y = prop_annMain_in_compartment_by_sample,fill = batch)) +
  geom_jitter(aes(x = annotation_main, y = prop_annMain_in_compartment_by_sample,shape = batch), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_main_compartment_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 10,height = 10)
```


#### proportion of subcompartment in the immune cell compartment; sum by sample

```{r}
g <- ggplot(subcomp_compart_prop)+
  geom_boxplot(aes(x = cell_type, y = prop_celltype_in_compartment_by_sample,fill = progress)) +
  geom_jitter(aes(x = cell_type, y = prop_celltype_in_compartment_by_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_celltype_compartment_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 10,height = 10)

g <- ggplot(subcomp_compart_prop)+
  geom_boxplot(aes(x = cell_type, y = prop_celltype_in_compartment_by_sample,fill = batch)) +
  geom_jitter(aes(x = cell_type, y = prop_celltype_in_compartment_by_sample,shape = batch), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_celltype_compartment_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 10,height = 10)
```


#### proportion of clusters in subcompartment of immune cells; sum by sample

```{r}
cell_types <- unique(clust_subcomp_prop$cell_type)
lapply(cell_types, function(x){
  g <- ggplot(clust_subcomp_prop %>% filter(cell_type == x))+
  geom_boxplot(aes(x = annotation_V1, y = prop_clust_in_celltype_by_sample,fill = progress)) +
  geom_jitter(aes(x = annotation_V1, y = prop_clust_in_celltype_by_sample,shape = progress), size=0.4, alpha=0.9) +
  facet_wrap(~annotation_V1,scales = "free",ncol = 4)+
  RotatedAxis()
  ggsave(filename = paste0(outdir,"immune_cells_clust_",x,"_celltype_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 15,height = 15)
})
g <- ggplot(clust_subcomp_prop)+
  geom_boxplot(aes(x = annotation_V1, y = prop_clust_in_celltype_by_sample,fill = progress)) +
  geom_jitter(aes(x = annotation_V1, y = prop_clust_in_celltype_by_sample,shape = progress), size=0.4, alpha=0.9) +
  RotatedAxis()+
  facet_wrap(~cell_type,scales = "free",ncol = 2)+
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_clust_celltype_prop_boxplots_by_progress_ann_V1.pdf"),plot = g, width = 15,height = 15)

lapply(cell_types, function(x){
  g <- ggplot(clust_subcomp_prop %>% filter(cell_type == x))+
  geom_boxplot(aes(x = annotation_V1, y = prop_clust_in_celltype_by_sample,fill = batch)) +
  geom_jitter(aes(x = annotation_V1, y = prop_clust_in_celltype_by_sample,shape = batch), size=0.4, alpha=0.9) +
  facet_wrap(~annotation_V1,scales = "free",ncol = 4)+
  RotatedAxis()
  ggsave(filename = paste0(outdir,"immune_cells_clust_",x,"_celltype_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 15,height = 15)
})

g <- ggplot(clust_subcomp_prop)+
  geom_boxplot(aes(x = annotation_V1, y = prop_clust_in_celltype_by_sample,fill = batch)) +
  geom_jitter(aes(x = annotation_V1, y = prop_clust_in_celltype_by_sample,shape = batch), size=0.4, alpha=0.9) +
  RotatedAxis()+
  facet_wrap(~cell_type,scales = "free",ncol = 2)+
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_clust_celltype_prop_boxplots_by_batch_ann_V1.pdf"),plot = g, width = 15,height = 15)
```


```{r}

g <- ggplot(annMain_compart_prop_batch_ID)+
  geom_boxplot(aes(x = annotation_main, y = prop_annMain_in_compartment_by_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_main, y = prop_annMain_in_compartment_by_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_main_compartment_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)

g <- ggplot(subcomp_compart_prop_batch_ID)+
  geom_boxplot(aes(x = cell_type, y = prop_celltype_in_compartment_by_sample,fill = batch_ID)) +
  geom_jitter(aes(x = cell_type, y = prop_celltype_in_compartment_by_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_celltype_compartment_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)

cell_types <- unique(clust_subcomp_prop_batch_ID$cell_type)
lapply(cell_types, function(x){
  g <- ggplot(clust_subcomp_prop_batch_ID %>% filter(cell_type == x))+
  geom_boxplot(aes(x = annotation_V1, y = prop_clust_in_celltype_by_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_clust_in_celltype_by_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  facet_wrap(~annotation_V1,scales = "free",ncol = 4)+
  RotatedAxis()
  ggsave(filename = paste0(outdir,"immune_cells_clust_",x,"_celltype_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 15,height = 15)
})
g <- ggplot(clust_subcomp_prop_batch_ID)+
  geom_boxplot(aes(x = annotation_V1, y = prop_clust_in_celltype_by_sample,fill = batch_ID)) +
  geom_jitter(aes(x = annotation_V1, y = prop_clust_in_celltype_by_sample,shape = batch_ID), size=0.4, alpha=0.9) +
  RotatedAxis()+
  facet_wrap(~cell_type,scales = "free",ncol = 2)
ggsave(filename = paste0(outdir,"immune_cells_clust_celltype_prop_boxplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 10,height = 10)


```

```{r}
# ann_main

g <- ggplot(annMain_compart_prop_batch_ID) +
  geom_bar(aes(x = sample.id, y = prop_annMain_in_compartment_by_sample,fill = annotation_main),stat = "summary",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_main_compartment_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)


# by sample barplot
g <- ggplot(annMain_compart_prop_batch_ID) +
  geom_bar(aes(x = sample.id, y = prop_annMain_in_compartment_by_sample,fill = annotation_main),stat = "summary",position = "stack") +
  facet_wrap(~progress, scales = "free")+
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_main_compartment_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)


```


```{r}
# cell_type
g <- ggplot(subcomp_compart_prop_batch_ID) +
  geom_bar(aes(x = sample.id, y = prop_celltype_in_compartment_by_sample,fill = cell_type),stat = "summary",position = "stack") +
  facet_wrap(~batch_ID, scales = "free")+
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_celltype_compartment_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 8,height = 8)

# by sample barplot
g <- ggplot(subcomp_compart_prop_batch_ID) +
  geom_bar(aes(x = sample.id, y = prop_celltype_in_compartment_by_sample,fill = cell_type),stat = "summary",position = "stack") +
  facet_wrap(~progress, scales = "free")+
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_celltype_compartment_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


```{r }
subcomps <- unique(immune_cell_meta$cell_type)
glist <- lapply(subcomps,function(x){
  ggplot(clust_subcomp_prop %>% filter(cell_type == x))+
    geom_bar(aes(x = progress, y = prop_clust_in_celltype_by_sample,fill = annotation_V1),stat = "summary",position = "stack")+
  scale_fill_manual(values = pal)+
  theme_classic()+
    RotatedAxis()
})
g <- gridExtra::grid.arrange(grobs = glist, ncol = 2)
ggsave(filename = paste0(outdir,"immune_cells_progress_cluster_celltype_prop_barplots_ann_V1.pdf"),plot = g, width = 12,height = 12)
```

```{r need gridExtra for the annotation plots}

# ann_V1
subcomps <- unique(immune_cell_meta$cell_type)
glist <- lapply(subcomps,function(x){
  ggplot(clust_subcomp_prop_batch_ID %>% filter(cell_type == x)) +
  geom_bar(aes(x = sample.id, y = prop_clust_in_celltype_by_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_grid(cell_type~batch_ID, scales = "free")+
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
})
g <- gridExtra::grid.arrange(grobs = glist, ncol = 2)
ggsave(filename = paste0(outdir,"immune_cells_celltype_compartment_prop_barplots_by_batch_ID_ann_V1.pdf"),plot = g, width = 12,height = 12)

subcomps <- unique(immune_cell_meta$cell_type)
glist <- lapply(subcomps,function(x){
  ggplot(clust_subcomp_prop_batch_ID %>% filter(cell_type == x)) +
  geom_bar(aes(x = sample.id, y = prop_clust_in_celltype_by_sample,fill = annotation_V1),stat = "summary",position = "stack") +
  facet_grid(cell_type~progress, scales = "free")+
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
})
g <- gridExtra::grid.arrange(grobs = glist, ncol = 2)
ggsave(filename = paste0(outdir,"immune_cells_celltype_compartment_prop_barplots_by_progress_ann_V1.pdf"),plot = g, width = 12,height = 12)

```




### sum by progress; bar plots

```{r}
# proportion of main celltypes in the immune cell compartment; sum by sample
annMain_compart_prop <- full_join(
                                  x = immune_cell_meta %>% 
                                    group_by(annotation_main, compartment,progress) %>%
                                    summarise(annMain_size = n()),
                                  y = immune_cell_meta %>% 
                                    group_by(compartment,progress) %>% 
                                    summarise(compartment_size = n()),
                                  by = c("compartment","progress")) %>%
                          mutate(prop_annMain_in_compartment = annMain_size*100 /compartment_size )


# proportion of subcompartment in the immune cell compartment; sum by sample
subcomp_compart_prop <- full_join(
                                  x = immune_cell_meta %>% 
                                    group_by(cell_type,compartment,progress) %>%
                                    summarise(celltype_size = n()),
                                  y = immune_cell_meta %>% 
                                    group_by(compartment,progress) %>% 
                                    summarise(compartment_size = n()),
                                  by = c("compartment","progress")) %>%
                          mutate(prop_celltype_in_compartment = celltype_size*100 /compartment_size )

# proportion of clusters in subcompartment of immune cells; sum by sample

clust_subcomp_prop <- full_join(
                                  x = immune_cell_meta %>% 
                                    group_by(annotation_V1,cell_type,progress) %>%
                                    summarise(clust_size = n()),
                                  y = immune_cell_meta %>% 
                                    group_by(cell_type,progress) %>% 
                                    summarise(celltype_size = n()),
                                  by = c("cell_type","progress")) %>%
                          mutate(prop_clust_in_celltype = clust_size*100 /celltype_size )

```



#### proportion of main celltypes in the immune cell compartment;

```{r}
g <- ggplot(annMain_compart_prop) +
  geom_bar(aes(x = progress, y = prop_annMain_in_compartment,fill = annotation_main),stat = "summary",position = "stack") +
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_progress_main_comp_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


#### proportion of subcompartment in the immune cell compartment; 

```{r}
g <- ggplot(subcomp_compart_prop) +
  geom_bar(aes(x = progress, y = prop_celltype_in_compartment,fill = cell_type),stat = "summary",position = "stack") +
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_progress_celltype_comp_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


#### proportion of clusters in subcompartment of immune cells; 

```{r}
subcomps <- unique(immune_cell_meta$cell_type)
glist <- lapply(subcomps,function(x){
  ggplot(clust_subcomp_prop %>% filter(cell_type == x))+
    geom_bar(aes(x = progress, y = prop_clust_in_celltype,fill = annotation_V1),stat = "summary",position = "stack")+
  scale_fill_manual(values = pal)+
  theme_classic()+
    RotatedAxis()
})
g <- gridExtra::grid.arrange(grobs = glist, ncol = 2)
ggsave(filename = paste0(outdir,"immune_cells_progress_cluster_celltype_prop_barplots_ann_V1.pdf"),plot = g, width = 12,height = 12)
```



### sum by batch; bar plots


```{r}
# proportion of main celltypes in the immune cell compartment; sum by sample
annMain_compart_prop <- full_join(
                                  x = immune_cell_meta %>% 
                                    group_by(annotation_main, compartment,batch) %>%
                                    summarise(annMain_size = n()),
                                  y = immune_cell_meta %>% 
                                    group_by(compartment,batch) %>% 
                                    summarise(compartment_size = n()),
                                  by = c("compartment","batch")) %>%
                          mutate(prop_annMain_in_compartment = annMain_size*100 /compartment_size )


# proportion of subcompartment in the immune cell compartment; sum by sample
subcomp_compart_prop <- full_join(
                                  x = immune_cell_meta %>% 
                                    group_by(cell_type,compartment,batch) %>%
                                    summarise(celltype_size = n()),
                                  y = immune_cell_meta %>% 
                                    group_by(compartment,batch) %>% 
                                    summarise(compartment_size = n()),
                                  by = c("compartment","batch")) %>%
                          mutate(prop_celltype_in_compartment = celltype_size*100 /compartment_size )

# proportion of clusters in subcompartment of immune cells; sum by sample

clust_subcomp_prop <- full_join(
                                  x = immune_cell_meta %>% 
                                    group_by(annotation_V1,cell_type,batch) %>%
                                    summarise(clust_size = n()),
                                  y = immune_cell_meta %>% 
                                    group_by(cell_type,batch) %>% 
                                    summarise(celltype_size = n()),
                                  by = c("cell_type","batch")) %>%
                          mutate(prop_clust_in_celltype = clust_size*100 /celltype_size )

```

#### proportion of main celltypes in the immune cell compartment;

```{r}
g <- ggplot(annMain_compart_prop) +
  geom_bar(aes(x = batch, y = prop_annMain_in_compartment,fill = annotation_main),stat = "summary",position = "stack") +
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_batch_main_comp_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


#### proportion of subcompartment in the immune cell compartment; 

```{r}
g <- ggplot(subcomp_compart_prop) +
  geom_bar(aes(x = batch, y = prop_celltype_in_compartment,fill = cell_type),stat = "summary",position = "stack") +
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_batch_celltype_comp_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


#### proportion of clusters in subcompartment of immune cells; 

```{r}
subcomps <- unique(immune_cell_meta$cell_type)
glist <- lapply(subcomps,function(x){
  ggplot(clust_subcomp_prop %>% filter(cell_type == x))+
    geom_bar(aes(x = batch, y = prop_clust_in_celltype,fill = annotation_V1),stat = "summary",position = "stack")+
  scale_fill_manual(values = pal)+
  theme_classic()+
    RotatedAxis()
})
g <- gridExtra::grid.arrange(grobs = glist, ncol = 2)
ggsave(filename = paste0(outdir,"immune_cells_batch_cluster_celltype_prop_barplots_ann_V1.pdf"),plot = g, width = 12,height = 12)
```


### sum by batch_ID; bar plots


```{r}
# proportion of main celltypes in the immune cell compartment; sum by sample
annMain_compart_prop <- full_join(
                                  x = immune_cell_meta %>% 
                                    group_by(annotation_main, compartment,batch_ID) %>%
                                    summarise(annMain_size = n()),
                                  y = immune_cell_meta %>% 
                                    group_by(compartment,batch_ID) %>% 
                                    summarise(compartment_size = n()),
                                  by = c("compartment","batch_ID")) %>%
                          mutate(prop_annMain_in_compartment = annMain_size*100 /compartment_size )


# proportion of subcompartment in the immune cell compartment; sum by sample
subcomp_compart_prop <- full_join(
                                  x = immune_cell_meta %>% 
                                    group_by(cell_type,compartment,batch_ID) %>%
                                    summarise(celltype_size = n()),
                                  y = immune_cell_meta %>% 
                                    group_by(compartment,batch_ID) %>% 
                                    summarise(compartment_size = n()),
                                  by = c("compartment","batch_ID")) %>%
                          mutate(prop_celltype_in_compartment = celltype_size*100 /compartment_size )

# proportion of clusters in subcompartment of immune cells; sum by sample

clust_subcomp_prop <- full_join(
                                  x = immune_cell_meta %>% 
                                    group_by(annotation_V1,cell_type,batch_ID) %>%
                                    summarise(clust_size = n()),
                                  y = immune_cell_meta %>% 
                                    group_by(cell_type,batch_ID) %>% 
                                    summarise(celltype_size = n()),
                                  by = c("cell_type","batch_ID")) %>%
                          mutate(prop_clust_in_celltype = clust_size*100 /celltype_size )

```

#### proportion of main celltypes in the immune cell compartment;

```{r}
g <- ggplot(annMain_compart_prop) +
  geom_bar(aes(x = batch_ID, y = prop_annMain_in_compartment,fill = annotation_main),stat = "summary",position = "stack") +
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_batch_ID_main_comp_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


#### proportion of subcompartment in the immune cell compartment; 

```{r}
g <- ggplot(subcomp_compart_prop) +
  geom_bar(aes(x = batch_ID, y = prop_celltype_in_compartment,fill = cell_type),stat = "summary",position = "stack") +
  scale_fill_manual(values = pal)+
  theme_classic()+
  RotatedAxis()
ggsave(filename = paste0(outdir,"immune_cells_batch_ID_celltype_comp_prop_barplots_ann_V1.pdf"),plot = g, width = 8,height = 8)
```


#### proportion of clusters in subcompartment of immune cells; 

```{r}
subcomps <- unique(immune_cell_meta$cell_type)
glist <- lapply(subcomps,function(x){
  ggplot(clust_subcomp_prop %>% filter(cell_type == x))+
    geom_bar(aes(x = batch_ID, y = prop_clust_in_celltype,fill = annotation_V1),stat = "summary",position = "stack")+
  scale_fill_manual(values = pal)+
  theme_classic()+
    RotatedAxis()
})
g <- gridExtra::grid.arrange(grobs = glist, ncol = 2)
ggsave(filename = paste0(outdir,"immune_cells_batch_ID_cluster_celltype_prop_barplots_ann_V1.pdf"),plot = g, width = 12,height = 12)
```




